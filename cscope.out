cscope 15 $HOME/study/apue.3e -q 0000001651 0000224158
	@advio/deadlock.c

1 
	~"≠ue.h
"

2 
	~<f˙é.h
>

5 
	$lockabyã
(c⁄° *
«me
, 
fd
, 
off_t
 
off£t
)

7 i‡(
	`wrôew_lock
(
fd
, 
off£t
, 
SEEK_SET
, 1) < 0)

8 
	`îr_sys
("%s: wrôew_lockÉº‹", 
«me
);

9 
	`¥ötf
("%s: gŸÅhêlock, byã %Œd\n", 
«me
, ()
off£t
);

10 
	}
}

13 
	$maö
()

15 
fd
;

16 
pid_t
 
pid
;

21 i‡((
fd
 = 
	`¸ót
("ãm∂ock", 
FILE_MODE
)) < 0)

22 
	`îr_sys
("creatÉrror");

23 i‡(
	`wrôe
(
fd
, "ab", 2) != 2)

24 
	`îr_sys
("writeÉrror");

26 
	`TELL_WAIT
();

27 i‡((
pid
 = 
	`f‹k
()) < 0) {

28 
	`îr_sys
("forkÉrror");

29 } i‡(
pid
 == 0) {

30 
	`lockabyã
("chûd", 
fd
, 0);

31 
	`TELL_PARENT
(
	`gëµid
());

32 
	`WAIT_PARENT
();

33 
	`lockabyã
("chûd", 
fd
, 1);

35 
	`lockabyã
("∑ª¡", 
fd
, 1);

36 
	`TELL_CHILD
(
pid
);

37 
	`WAIT_CHILD
();

38 
	`lockabyã
("∑ª¡", 
fd
, 0);

40 
	`exô
(0);

41 
	}
}

	@advio/lockfile.c

1 
	~<uni°d.h
>

2 
	~<f˙é.h
>

5 
	$lockfûe
(
fd
)

7 
Êock
 
Ê
;

9 
Ê
.
l_ty≥
 = 
F_WRLCK
;

10 
Ê
.
l_°¨t
 = 0;

11 
Ê
.
l_whí˚
 = 
SEEK_SET
;

12 
Ê
.
l_Àn
 = 0;

13 (
	`f˙é
(
fd
, 
F_SETLK
, &
Ê
));

14 
	}
}

	@advio/mandatory.c

1 
	~"≠ue.h
"

2 
	~<î∫o.h
>

3 
	~<f˙é.h
>

4 
	~<sys/waô.h
>

7 
	$maö
(
¨gc
, *
¨gv
[])

9 
fd
;

10 
pid_t
 
pid
;

11 
buf
[5];

12 
°©
 
°©buf
;

14 i‡(
¨gc
 != 2) {

15 
	`Ârötf
(
°dîr
, "ußge: %†fûíame\n", 
¨gv
[0]);

16 
	`exô
(1);

18 i‡((
fd
 = 
	`›í
(
¨gv
[1], 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
FILE_MODE
)) < 0)

19 
	`îr_sys
("openÉrror");

20 i‡(
	`wrôe
(
fd
, "abcdef", 6) != 6)

21 
	`îr_sys
("writeÉrror");

24 i‡(
	`f°©
(
fd
, &
°©buf
) < 0)

25 
	`îr_sys
("fstatÉrror");

26 i‡(
	`fchmod
(
fd
, (
°©buf
.
°_mode
 & ~
S_IXGRP
Ë| 
S_ISGID
) < 0)

27 
	`îr_sys
("fchmodÉrror");

29 
	`TELL_WAIT
();

31 i‡((
pid
 = 
	`f‹k
()) < 0) {

32 
	`îr_sys
("forkÉrror");

33 } i‡(
pid
 > 0) {

35 i‡(
	`wrôe_lock
(
fd
, 0, 
SEEK_SET
, 0) < 0)

36 
	`îr_sys
("write_lockÉrror");

38 
	`TELL_CHILD
(
pid
);

40 i‡(
	`waôpid
(
pid
, 
NULL
, 0) < 0)

41 
	`îr_sys
("waitpidÉrror");

43 
	`WAIT_PARENT
();

45 
	`£t_Ê
(
fd
, 
O_NONBLOCK
);

48 i‡(
	`ªad_lock
(
fd
, 0, 
SEEK_SET
, 0) != -1)

49 
	`îr_sys
("child:Ñead_lock succeeded");

50 
	`¥ötf
("read_lock ofálready-lockedÑegionÑeturns %d\n",

51 
î∫o
);

54 i‡(
	`l£ek
(
fd
, 0, 
SEEK_SET
) == -1)

55 
	`îr_sys
("lseekÉrror");

56 i‡(
	`ªad
(
fd
, 
buf
, 2) < 0)

57 
	`îr_ªt
("read failed (mandatoryÜocking works)");

59 
	`¥ötf
("read OK (no mandatoryÜocking), buf = %2.2s\n",

60 
buf
);

62 
	`exô
(0);

63 
	}
}

	@advio/mcopy2.c

1 
	~"≠ue.h
"

2 
	~<f˙é.h
>

3 
	~<sys/mm™.h
>

5 
	#COPYINCR
 (1024*1024*1024Ë

	)

8 
	$maö
(
¨gc
, *
¨gv
[])

10 
fdö
, 
fdout
;

11 *
§c
, *
d°
;

12 
size_t
 
c›ysz
;

13 
°©
 
sbuf
;

14 
off_t
 
fsz
 = 0;

16 i‡(
¨gc
 != 3)

17 
	`îr_quô
("ußge: %†<‰omfûe> <tofûe>", 
¨gv
[0]);

19 i‡((
fdö
 = 
	`›í
(
¨gv
[1], 
O_RDONLY
)) < 0)

20 
	`îr_sys
("ˇn'à›í %†f‹Ñódög", 
¨gv
[1]);

22 i‡((
fdout
 = 
	`›í
(
¨gv
[2], 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
,

23 
FILE_MODE
)) < 0)

24 
	`îr_sys
("ˇn'à¸óà%†f‹ wrôög", 
¨gv
[2]);

26 i‡(
	`f°©
(
fdö
, &
sbuf
) < 0)

27 
	`îr_sys
("fstatÉrror");

29 i‡(
	`·runˇã
(
fdout
, 
sbuf
.
°_size
) < 0)

30 
	`îr_sys
("ftruncateÉrror");

32 
fsz
 < 
sbuf
.
°_size
) {

33 i‡((
sbuf
.
°_size
 - 
fsz
Ë> 
COPYINCR
)

34 
c›ysz
 = 
COPYINCR
;

36 
c›ysz
 = 
sbuf
.
°_size
 - 
fsz
;

38 i‡((
§c
 = 
	`mm≠
(0, 
c›ysz
, 
PROT_READ
, 
MAP_SHARED
,

39 
fdö
, 
fsz
)Ë=
MAP_FAILED
)

40 
	`îr_sys
("mmapÉrror for input");

41 i‡((
d°
 = 
	`mm≠
(0, 
c›ysz
, 
PROT_READ
 | 
PROT_WRITE
,

42 
MAP_SHARED
, 
fdout
, 
fsz
)Ë=
MAP_FAILED
)

43 
	`îr_sys
("mmapÉrror for output");

45 
	`mem˝y
(
d°
, 
§c
, 
c›ysz
);

46 
	`munm≠
(
§c
, 
c›ysz
);

47 
	`munm≠
(
d°
, 
c›ysz
);

48 
fsz
 +
c›ysz
;

50 
	`exô
(0);

51 
	}
}

	@advio/nonblockw.c

1 
	~"≠ue.h
"

2 
	~<î∫o.h
>

3 
	~<f˙é.h
>

5 
	gbuf
[500000];

8 
	$maö
()

10 
¡owrôe
, 
nwrôe
;

11 *
±r
;

13 
¡owrôe
 = 
	`ªad
(
STDIN_FILENO
, 
buf
, (buf));

14 
	`Ârötf
(
°dîr
, "ªad %d byãs\n", 
¡owrôe
);

16 
	`£t_Ê
(
STDOUT_FILENO
, 
O_NONBLOCK
);

18 
±r
 = 
buf
;

19 
¡owrôe
 > 0) {

20 
î∫o
 = 0;

21 
nwrôe
 = 
	`wrôe
(
STDOUT_FILENO
, 
±r
, 
¡owrôe
);

22 
	`Ârötf
(
°dîr
, "nwrôê%d,Éºnÿ%d\n", 
nwrôe
, 
î∫o
);

24 i‡(
nwrôe
 > 0) {

25 
±r
 +
nwrôe
;

26 
¡owrôe
 -
nwrôe
;

30 
	`˛r_Ê
(
STDOUT_FILENO
, 
O_NONBLOCK
);

32 
	`exô
(0);

33 
	}
}

	@advio/readn.c

1 
	~"≠ue.h
"

3 
ssize_t


4 
	$ªadn
(
fd
, *
±r
, 
size_t
 
n
)

6 
size_t
 
∆e·
;

7 
ssize_t
 
ƒód
;

9 
∆e·
 = 
n
;

10 
∆e·
 > 0) {

11 i‡((
ƒód
 = 
	`ªad
(
fd
, 
±r
, 
∆e·
)) < 0) {

12 i‡(
∆e·
 =
n
)

16 } i‡(
ƒód
 == 0) {

19 
∆e·
 -
ƒód
;

20 
±r
 +
ƒód
;

22 (
n
 - 
∆e·
);

23 
	}
}

	@advio/rot13a.c

1 
	~"≠ue.h
"

2 
	~<˘y≥.h
>

3 
	~<f˙é.h
>

5 
	#BSZ
 4096

	)

7 
	gbuf
[
BSZ
];

10 
	$å™¶©e
(
c
)

12 i‡(
	`ißÕha
(
c
)) {

13 i‡(
c
 >= 'n')

14 
c
 -= 13;

15 i‡(
c
 >= 'a')

16 
c
 += 13;

17 i‡(
c
 >= 'N')

18 
c
 -= 13;

20 
c
 += 13;

22 (
c
);

23 
	}
}

26 
	$maö
(
¨gc
, * 
¨gv
[])

28 
ifd
, 
ofd
, 
i
, 
n
, 
nw
;

30 i‡(
¨gc
 != 3)

31 
	`îr_quô
("usage:Ñot13 infile outfile");

32 i‡((
ifd
 = 
	`›í
(
¨gv
[1], 
O_RDONLY
)) < 0)

33 
	`îr_sys
("ˇn'à›í %s", 
¨gv
[1]);

34 i‡((
ofd
 = 
	`›í
(
¨gv
[2], 
O_RDWR
|
O_CREAT
|
O_TRUNC
, 
FILE_MODE
)) < 0)

35 
	`îr_sys
("ˇn'à¸óã %s", 
¨gv
[2]);

37 (
n
 = 
	`ªad
(
ifd
, 
buf
, 
BSZ
)) > 0) {

38 
i
 = 0; i < 
n
; i++)

39 
buf
[
i
] = 
	`å™¶©e
(buf[i]);

40 i‡((
nw
 = 
	`wrôe
(
ofd
, 
buf
, 
n
)) !=Ç) {

41 i‡(
nw
 < 0)

42 
	`îr_sys
("write failed");

44 
	`îr_quô
("sh‹àwrôê(%d/%d)", 
nw
, 
n
);

48 
	`fsync
(
ofd
);

49 
	`exô
(0);

50 
	}
}

	@advio/writen.c

1 
	~"≠ue.h
"

3 
ssize_t


4 
	$wrôí
(
fd
, c⁄° *
±r
, 
size_t
 
n
)

6 
size_t
 
∆e·
;

7 
ssize_t
 
nwrôãn
;

9 
∆e·
 = 
n
;

10 
∆e·
 > 0) {

11 i‡((
nwrôãn
 = 
	`wrôe
(
fd
, 
±r
, 
∆e·
)) < 0) {

12 i‡(
∆e·
 =
n
)

16 } i‡(
nwrôãn
 == 0) {

19 
∆e·
 -
nwrôãn
;

20 
±r
 +
nwrôãn
;

22 (
n
 - 
∆e·
);

23 
	}
}

	@daemons/init.c

1 
	~"≠ue.h
"

2 
	~<sy¶og.h
>

3 
	~<f˙é.h
>

4 
	~<sys/ªsour˚.h
>

7 
	$d´m⁄ize
(c⁄° *
cmd
)

9 
i
, 
fd0
, 
fd1
, 
fd2
;

10 
pid_t
 
pid
;

11 
æimô
 
æ
;

12 
siga˘i⁄
 
ß
;

17 
	`umask
(0);

22 i‡(
	`gëæimô
(
RLIMIT_NOFILE
, &
æ
) < 0)

23 
	`îr_quô
("%s: c™'àgë fûêlimô", 
cmd
);

28 i‡((
pid
 = 
	`f‹k
()) < 0)

29 
	`îr_quô
("%s: c™'àf‹k", 
cmd
);

30 i‡(
pid
 != 0)

31 
	`exô
(0);

32 
	`£tsid
();

37 
ß
.
ß_h™dÀr
 = 
SIG_IGN
;

38 
	`sigem±y£t
(&
ß
.
ß_mask
);

39 
ß
.
ß_Êags
 = 0;

40 i‡(
	`siga˘i⁄
(
SIGHUP
, &
ß
, 
NULL
) < 0)

41 
	`îr_quô
("%s: c™'àign‹êSIGHUP", 
cmd
);

42 i‡((
pid
 = 
	`f‹k
()) < 0)

43 
	`îr_quô
("%s: c™'àf‹k", 
cmd
);

44 i‡(
pid
 != 0)

45 
	`exô
(0);

51 i‡(
	`chdú
("/") < 0)

52 
	`îr_quô
("%s: c™'àch™gêdúe˘‹yÅÿ/", 
cmd
);

57 i‡(
æ
.
æim_max
 =
RLIM_INFINITY
)

58 
æ
.
æim_max
 = 1024;

59 
i
 = 0; i < 
æ
.
æim_max
; i++)

60 
	`˛o£
(
i
);

65 
fd0
 = 
	`›í
("/dev/nuŒ", 
O_RDWR
);

66 
fd1
 = 
	`dup
(0);

67 
fd2
 = 
	`dup
(0);

72 
	`›ílog
(
cmd
, 
LOG_CONS
, 
LOG_DAEMON
);

73 i‡(
fd0
 !0 || 
fd1
 !1 || 
fd2
 != 2) {

74 
	`sy¶og
(
LOG_ERR
, "unexpected file descriptors %d %d %d",

75 
fd0
, 
fd1
, 
fd2
);

76 
	`exô
(1);

78 
	}
}

	@daemons/reread.c

1 
	~"≠ue.h
"

2 
	~<±hªad.h
>

3 
	~<sy¶og.h
>

5 
sig£t_t
 
	gmask
;

7 
Æªady_ru¬ög
();

10 
	$ªªad
()

13 
	}
}

16 
	$thr_‚
(*
¨g
)

18 
îr
, 
signo
;

21 
îr
 = 
	`sigwaô
(&
mask
, &
signo
);

22 i‡(
îr
 != 0) {

23 
	`sy¶og
(
LOG_ERR
, "sigwait failed");

24 
	`exô
(1);

27 
signo
) {

28 
SIGHUP
:

29 
	`sy¶og
(
LOG_INFO
, "Re-reading configuration file");

30 
	`ªªad
();

33 
SIGTERM
:

34 
	`sy¶og
(
LOG_INFO
, "got SIGTERM;Éxiting");

35 
	`exô
(0);

38 
	`sy¶og
(
LOG_INFO
, "u√x≥˘ed sig«»%d\n", 
signo
);

42 
	}
}

45 
	$maö
(
¨gc
, *
¨gv
[])

47 
îr
;

48 
±hªad_t
 
tid
;

49 *
cmd
;

50 
siga˘i⁄
 
ß
;

52 i‡((
cmd
 = 
	`°ºchr
(
¨gv
[0], '/')Ë=
NULL
)

53 
cmd
 = 
¨gv
[0];

55 
cmd
++;

60 
	`d´m⁄ize
(
cmd
);

65 i‡(
	`Æªady_ru¬ög
()) {

66 
	`sy¶og
(
LOG_ERR
, "daemonálreadyÑunning");

67 
	`exô
(1);

73 
ß
.
ß_h™dÀr
 = 
SIG_DFL
;

74 
	`sigem±y£t
(&
ß
.
ß_mask
);

75 
ß
.
ß_Êags
 = 0;

76 i‡(
	`siga˘i⁄
(
SIGHUP
, &
ß
, 
NULL
) < 0)

77 
	`îr_quô
("%s: can'tÑestore SIGHUP default");

78 
	`sigfûl£t
(&
mask
);

79 i‡((
îr
 = 
	`±hªad_sigmask
(
SIG_BLOCK
, &
mask
, 
NULL
)) != 0)

80 
	`îr_exô
(
îr
, "SIG_BLOCKÉrror");

85 
îr
 = 
	`±hªad_¸óã
(&
tid
, 
NULL
, 
thr_‚
, 0);

86 i‡(
îr
 != 0)

87 
	`îr_exô
(
îr
, "can't createÅhread");

93 
	`exô
(0);

94 
	}
}

	@daemons/reread2.c

1 
	~"≠ue.h
"

2 
	~<sy¶og.h
>

3 
	~<î∫o.h
>

5 
lockfûe
();

6 
Æªady_ru¬ög
();

9 
	$ªªad
()

12 
	}
}

15 
	$sigãrm
(
signo
)

17 
	`sy¶og
(
LOG_INFO
, "got SIGTERM;Éxiting");

18 
	`exô
(0);

19 
	}
}

22 
	$sighup
(
signo
)

24 
	`sy¶og
(
LOG_INFO
, "Re-reading configuration file");

25 
	`ªªad
();

26 
	}
}

29 
	$maö
(
¨gc
, *
¨gv
[])

31 *
cmd
;

32 
siga˘i⁄
 
ß
;

34 i‡((
cmd
 = 
	`°ºchr
(
¨gv
[0], '/')Ë=
NULL
)

35 
cmd
 = 
¨gv
[0];

37 
cmd
++;

42 
	`d´m⁄ize
(
cmd
);

47 i‡(
	`Æªady_ru¬ög
()) {

48 
	`sy¶og
(
LOG_ERR
, "daemonálreadyÑunning");

49 
	`exô
(1);

55 
ß
.
ß_h™dÀr
 = 
sigãrm
;

56 
	`sigem±y£t
(&
ß
.
ß_mask
);

57 
	`sigadd£t
(&
ß
.
ß_mask
, 
SIGHUP
);

58 
ß
.
ß_Êags
 = 0;

59 i‡(
	`siga˘i⁄
(
SIGTERM
, &
ß
, 
NULL
) < 0) {

60 
	`sy¶og
(
LOG_ERR
, "ˇn'àˇtch SIGTERM: %s", 
	`°ªº‹
(
î∫o
));

61 
	`exô
(1);

63 
ß
.
ß_h™dÀr
 = 
sighup
;

64 
	`sigem±y£t
(&
ß
.
ß_mask
);

65 
	`sigadd£t
(&
ß
.
ß_mask
, 
SIGTERM
);

66 
ß
.
ß_Êags
 = 0;

67 i‡(
	`siga˘i⁄
(
SIGHUP
, &
ß
, 
NULL
) < 0) {

68 
	`sy¶og
(
LOG_ERR
, "ˇn'àˇtch SIGHUP: %s", 
	`°ªº‹
(
î∫o
));

69 
	`exô
(1);

76 
	`exô
(0);

77 
	}
}

	@daemons/single.c

1 
	~<uni°d.h
>

2 
	~<°dlib.h
>

3 
	~<f˙é.h
>

4 
	~<sy¶og.h
>

5 
	~<°rög.h
>

6 
	~<î∫o.h
>

7 
	~<°dio.h
>

8 
	~<sys/°©.h
>

10 
	#LOCKFILE
 "/v¨/run/d´m⁄.pid"

	)

11 
	#LOCKMODE
 (
S_IRUSR
|
S_IWUSR
|
S_IRGRP
|
S_IROTH
)

	)

13 
lockfûe
();

16 
	$Æªady_ru¬ög
()

18 
fd
;

19 
buf
[16];

21 
fd
 = 
	`›í
(
LOCKFILE
, 
O_RDWR
|
O_CREAT
, 
LOCKMODE
);

22 i‡(
fd
 < 0) {

23 
	`sy¶og
(
LOG_ERR
, "ˇn'à›í %s: %s", 
LOCKFILE
, 
	`°ªº‹
(
î∫o
));

24 
	`exô
(1);

26 i‡(
	`lockfûe
(
fd
) < 0) {

27 i‡(
î∫o
 =
EACCES
 ||Éºnÿ=
EAGAIN
) {

28 
	`˛o£
(
fd
);

31 
	`sy¶og
(
LOG_ERR
, "ˇn'àlock %s: %s", 
LOCKFILE
, 
	`°ªº‹
(
î∫o
));

32 
	`exô
(1);

34 
	`·runˇã
(
fd
, 0);

35 
	`•rötf
(
buf
, "%ld", ()
	`gëpid
());

36 
	`wrôe
(
fd
, 
buf
, 
	`°æí
(buf)+1);

38 
	}
}

	@datafiles/getpwnam.c

1 
	~<pwd.h
>

2 
	~<°ddef.h
>

3 
	~<°rög.h
>

5 
∑sswd
 *

6 
	$gëpw«m
(c⁄° *
«me
)

8 
∑sswd
 *
±r
;

10 
	`£çwít
();

11 (
±r
 = 
	`gëpwít
()Ë!
NULL
)

12 i‡(
	`°rcmp
(
«me
, 
±r
->
pw_«me
) == 0)

14 
	`ídpwít
();

15 (
±r
);

16 
	}
}

	@datafiles/strftime.c

1 
	~<°dio.h
>

2 
	~<°dlib.h
>

3 
	~<time.h
>

6 
	$maö
()

8 
time_t
 
t
;

9 
tm
 *
tmp
;

10 
buf1
[16];

11 
buf2
[64];

13 
	`time
(&
t
);

14 
tmp
 = 
	`loˇ…ime
(&
t
);

15 i‡(
	`°r·ime
(
buf1
, 16, "timê™d d©e: %r, %®%b %d, %Y", 
tmp
) == 0)

16 
	`¥ötf
("bufferÜength 16 isÅoo small\n");

18 
	`¥ötf
("%s\n", 
buf1
);

19 i‡(
	`°r·ime
(
buf2
, 64, "timê™d d©e: %r, %®%b %d, %Y", 
tmp
) == 0)

20 
	`¥ötf
("bufferÜength 64 isÅoo small\n");

22 
	`¥ötf
("%s\n", 
buf2
);

23 
	`exô
(0);

24 
	}
}

	@db/apue_db.h

1 #i‚de‡
_APUE_DB_H


2 
	#_APUE_DB_H


	)

4 * 
	tDBHANDLE
;

6 
DBHANDLE
 
db_›í
(const *, , ...);

7 
db_˛o£
(
DBHANDLE
);

8 *
db_„tch
(
DBHANDLE
, const *);

9 
db_°‹e
(
DBHANDLE
, const *, const *, );

10 
db_dñëe
(
DBHANDLE
, const *);

11 
db_ªwöd
(
DBHANDLE
);

12 *
db_√xåec
(
DBHANDLE
, *);

17 
	#DB_INSERT
 1

	)

18 
	#DB_REPLACE
 2

	)

19 
	#DB_STORE
 3

	)

24 
	#IDXLEN_MIN
 6

	)

25 
	#IDXLEN_MAX
 1024

	)

26 
	#DATLEN_MIN
 2

	)

27 
	#DATLEN_MAX
 1024

	)

	@db/db.c

1 
	~"≠ue.h
"

2 
	~"≠ue_db.h
"

3 
	~<f˙é.h
>

4 
	~<°d¨g.h
>

5 
	~<î∫o.h
>

6 
	~<sys/uio.h
>

13 
	#IDXLEN_SZ
 4

	)

14 
	#SEP
 ':'

	)

15 
	#SPACE
 ' '

	)

16 
	#NEWLINE
 '\n'

	)

22 
	#PTR_SZ
 7

	)

23 
	#PTR_MAX
 9999999

	)

24 
	#NHASH_DEF
 137

	)

25 
	#FREE_OFF
 0

	)

26 
	#HASH_OFF
 
PTR_SZ


	)

28 
	tDBHASH
;

29 
	tCOUNT
;

35 
	midxfd
;

36 
	md©fd
;

37 *
	midxbuf
;

38 *
	md©buf
;

39 *
	m«me
;

40 
off_t
 
	midxoff
;

42 
size_t
 
	midxÀn
;

45 
off_t
 
	md©off
;

46 
size_t
 
	md©Àn
;

48 
off_t
 
	m±rvÆ
;

49 
off_t
 
	m±roff
;

50 
off_t
 
	mchaöoff
;

51 
off_t
 
	mhashoff
;

52 
DBHASH
 
	mnhash
;

53 
COUNT
 
	m˙t_dñok
;

54 
COUNT
 
	m˙t_dñîr
;

55 
COUNT
 
	m˙t_„tchok
;

56 
COUNT
 
	m˙t_„tchîr
;

57 
COUNT
 
	m˙t_√xåec
;

58 
COUNT
 
	m˙t_°‹1
;

59 
COUNT
 
	m˙t_°‹2
;

60 
COUNT
 
	m˙t_°‹3
;

61 
COUNT
 
	m˙t_°‹4
;

62 
COUNT
 
	m˙t_°‹îr
;

63 } 
	tDB
;

68 
DB
 *
_db_Æloc
();

69 
_db_dodñëe
(
DB
 *);

70 
_db_föd_™d_lock
(
DB
 *, const *, );

71 
_db_föd‰ì
(
DB
 *, , );

72 
_db_‰ì
(
DB
 *);

73 
DBHASH
 
_db_hash
(
DB
 *, const *);

74 *
_db_ªadd©
(
DB
 *);

75 
off_t
 
_db_ªadidx
(
DB
 *, off_t);

76 
off_t
 
_db_ªad±r
(
DB
 *, off_t);

77 
_db_wrôed©
(
DB
 *, c⁄° *, 
off_t
, );

78 
_db_wrôeidx
(
DB
 *, c⁄° *, 
off_t
, , off_t);

79 
_db_wrôïå
(
DB
 *, 
off_t
, off_t);

84 
DBHANDLE


85 
	$db_›í
(c⁄° *
∑th«me
, 
oÊag
, ...)

87 
DB
 *
db
;

88 
Àn
, 
mode
;

89 
size_t
 
i
;

90 
asciùå
[
PTR_SZ
 + 1],

91 
hash
[(
NHASH_DEF
 + 1Ë* 
PTR_SZ
 + 2];

93 
°©
 
°©buff
;

98 
Àn
 = 
	`°æí
(
∑th«me
);

99 i‡((
db
 = 
	`_db_Æloc
(
Àn
)Ë=
NULL
)

100 
	`îr_dump
("db_open: _db_allocÉrror for DB");

102 
db
->
nhash
 = 
NHASH_DEF
;

103 
db
->
hashoff
 = 
HASH_OFF
;

104 
	`°r˝y
(
db
->
«me
, 
∑th«me
);

105 
	`°rˇt
(
db
->
«me
, ".idx");

107 i‡(
oÊag
 & 
O_CREAT
) {

108 
va_li°
 
≠
;

110 
	`va_°¨t
(
≠
, 
oÊag
);

111 
mode
 = 
	`va_¨g
(
≠
, );

112 
	`va_íd
(
≠
);

117 
db
->
idxfd
 = 
	`›í
(db->
«me
, 
oÊag
, 
mode
);

118 
	`°r˝y
(
db
->
«me
 + 
Àn
, ".dat");

119 
db
->
d©fd
 = 
	`›í
(db->
«me
, 
oÊag
, 
mode
);

124 
db
->
idxfd
 = 
	`›í
(db->
«me
, 
oÊag
);

125 
	`°r˝y
(
db
->
«me
 + 
Àn
, ".dat");

126 
db
->
d©fd
 = 
	`›í
(db->
«me
, 
oÊag
);

129 i‡(
db
->
idxfd
 < 0 || db->
d©fd
 < 0) {

130 
	`_db_‰ì
(
db
);

131 (
NULL
);

134 i‡((
oÊag
 & (
O_CREAT
 | 
O_TRUNC
)) == (O_CREAT | O_TRUNC)) {

140 i‡(
	`wrôew_lock
(
db
->
idxfd
, 0, 
SEEK_SET
, 0) < 0)

141 
	`îr_dump
("db_open: writew_lockÉrror");

143 i‡(
	`f°©
(
db
->
idxfd
, &
°©buff
) < 0)

144 
	`îr_sys
("db_open: fstatÉrror");

146 i‡(
°©buff
.
°_size
 == 0) {

152 
	`•rötf
(
asciùå
, "%*d", 
PTR_SZ
, 0);

153 
hash
[0] = 0;

154 
i
 = 0; i < 
NHASH_DEF
 + 1; i++)

155 
	`°rˇt
(
hash
, 
asciùå
);

156 
	`°rˇt
(
hash
, "\n");

157 
i
 = 
	`°æí
(
hash
);

158 i‡(
	`wrôe
(
db
->
idxfd
, 
hash
, 
i
) != i)

159 
	`îr_dump
("db_open: index file init writeÉrror");

161 i‡(
	`un_lock
(
db
->
idxfd
, 0, 
SEEK_SET
, 0) < 0)

162 
	`îr_dump
("db_open: un_lockÉrror");

164 
	`db_ªwöd
(
db
);

165 (
db
);

166 
	}
}

171 
DB
 *

172 
	$_db_Æloc
(
«mñí
)

174 
DB
 *
db
;

179 i‡((
db
 = 
	`ˇŒoc
(1, (
DB
))Ë=
NULL
)

180 
	`îr_dump
("_db_alloc: callocÉrror for DB");

181 
db
->
idxfd
 = db->
d©fd
 = -1;

187 i‡((
db
->
«me
 = 
	`mÆloc
(
«mñí
 + 5)Ë=
NULL
)

188 
	`îr_dump
("_db_alloc: mallocÉrror forÇame");

194 i‡((
db
->
idxbuf
 = 
	`mÆloc
(
IDXLEN_MAX
 + 2)Ë=
NULL
)

195 
	`îr_dump
("_db_alloc: mallocÉrror for index buffer");

196 i‡((
db
->
d©buf
 = 
	`mÆloc
(
DATLEN_MAX
 + 2)Ë=
NULL
)

197 
	`îr_dump
("_db_alloc: mallocÉrror for data buffer");

198 (
db
);

199 
	}
}

205 
	$db_˛o£
(
DBHANDLE
 
h
)

207 
	`_db_‰ì
((
DB
 *)
h
);

208 
	}
}

215 
	$_db_‰ì
(
DB
 *
db
)

217 i‡(
db
->
idxfd
 >= 0)

218 
	`˛o£
(
db
->
idxfd
);

219 i‡(
db
->
d©fd
 >= 0)

220 
	`˛o£
(
db
->
d©fd
);

221 i‡(
db
->
idxbuf
 !
NULL
)

222 
	`‰ì
(
db
->
idxbuf
);

223 i‡(
db
->
d©buf
 !
NULL
)

224 
	`‰ì
(
db
->
d©buf
);

225 i‡(
db
->
«me
 !
NULL
)

226 
	`‰ì
(
db
->
«me
);

227 
	`‰ì
(
db
);

228 
	}
}

234 
	$db_„tch
(
DBHANDLE
 
h
, c⁄° *
key
)

236 
DB
 *
db
 = 
h
;

237 *
±r
;

239 i‡(
	`_db_föd_™d_lock
(
db
, 
key
, 0) < 0) {

240 
±r
 = 
NULL
;

241 
db
->
˙t_„tchîr
++;

243 
±r
 = 
	`_db_ªadd©
(
db
);

244 
db
->
˙t_„tchok
++;

250 i‡(
	`un_lock
(
db
->
idxfd
, db->
chaöoff
, 
SEEK_SET
, 1) < 0)

251 
	`îr_dump
("db_fetch: un_lockÉrror");

252 (
±r
);

253 
	}
}

260 
	$_db_föd_™d_lock
(
DB
 *
db
, c⁄° *
key
, 
wrôñock
)

262 
off_t
 
off£t
, 
√xtoff£t
;

270 
db
->
chaöoff
 = (
	`_db_hash
(db, 
key
Ë* 
PTR_SZ
Ë+ db->
hashoff
;

271 
db
->
±roff
 = db->
chaöoff
;

277 i‡(
wrôñock
) {

278 i‡(
	`wrôew_lock
(
db
->
idxfd
, db->
chaöoff
, 
SEEK_SET
, 1) < 0)

279 
	`îr_dump
("_db_find_and_lock: writew_lockÉrror");

281 i‡(
	`ªadw_lock
(
db
->
idxfd
, db->
chaöoff
, 
SEEK_SET
, 1) < 0)

282 
	`îr_dump
("_db_find_and_lock:Ñeadw_lockÉrror");

289 
off£t
 = 
	`_db_ªad±r
(
db
, db->
±roff
);

290 
off£t
 != 0) {

291 
√xtoff£t
 = 
	`_db_ªadidx
(
db
, 
off£t
);

292 i‡(
	`°rcmp
(
db
->
idxbuf
, 
key
) == 0)

294 
db
->
±roff
 = 
off£t
;

295 
off£t
 = 
√xtoff£t
;

300 (
off£t
 == 0 ? -1 : 0);

301 
	}
}

306 
DBHASH


307 
	$_db_hash
(
DB
 *
db
, c⁄° *
key
)

309 
DBHASH
 
hvÆ
 = 0;

310 
c
;

311 
i
;

313 
i
 = 1; (
c
 = *
key
++) != 0; i++)

314 
hvÆ
 +
c
 * 
i
;

315 (
hvÆ
 % 
db
->
nhash
);

316 
	}
}

323 
off_t


324 
	$_db_ªad±r
(
DB
 *
db
, 
off_t
 
off£t
)

326 
asciùå
[
PTR_SZ
 + 1];

328 i‡(
	`l£ek
(
db
->
idxfd
, 
off£t
, 
SEEK_SET
) == -1)

329 
	`îr_dump
("_db_readptr:ÜseekÉrrorÅoÖtr field");

330 i‡(
	`ªad
(
db
->
idxfd
, 
asciùå
, 
PTR_SZ
) != PTR_SZ)

331 
	`îr_dump
("_db_readptr:ÑeadÉrror ofÖtr field");

332 
asciùå
[
PTR_SZ
] = 0;

333 (
	`©ﬁ
(
asciùå
));

334 
	}
}

343 
off_t


344 
	$_db_ªadidx
(
DB
 *
db
, 
off_t
 
off£t
)

346 
ssize_t
 
i
;

347 *
±r1
, *
±r2
;

348 
asciùå
[
PTR_SZ
 + 1], 
asciûí
[
IDXLEN_SZ
 + 1];

349 
iovec
 
iov
[2];

356 i‡((
db
->
idxoff
 = 
	`l£ek
(db->
idxfd
, 
off£t
,

357 
off£t
 =0 ? 
SEEK_CUR
 : 
SEEK_SET
)) == -1)

358 
	`îr_dump
("_db_readidx:ÜseekÉrror");

365 
iov
[0].
iov_ba£
 = 
asciùå
;

366 
iov
[0].
iov_Àn
 = 
PTR_SZ
;

367 
iov
[1].
iov_ba£
 = 
asciûí
;

368 
iov
[1].
iov_Àn
 = 
IDXLEN_SZ
;

369 i‡((
i
 = 
	`ªadv
(
db
->
idxfd
, &
iov
[0], 2)Ë!
PTR_SZ
 + 
IDXLEN_SZ
) {

370 i‡(
i
 =0 && 
off£t
 == 0)

372 
	`îr_dump
("_db_readidx:ÑeadvÉrror of indexÑecord");

378 
asciùå
[
PTR_SZ
] = 0;

379 
db
->
±rvÆ
 = 
	`©ﬁ
(
asciùå
);

381 
asciûí
[
IDXLEN_SZ
] = 0;

382 i‡((
db
->
idxÀn
 = 
	`©oi
(
asciûí
)Ë< 
IDXLEN_MIN
 ||

383 
db
->
idxÀn
 > 
IDXLEN_MAX
)

384 
	`îr_dump
("_db_readidx: invalidÜength");

390 i‡((
i
 = 
	`ªad
(
db
->
idxfd
, db->
idxbuf
, db->
idxÀn
)) != db->idxlen)

391 
	`îr_dump
("_db_readidx:ÑeadÉrror of indexÑecord");

392 i‡(
db
->
idxbuf
[db->
idxÀn
-1] !
NEWLINE
)

393 
	`îr_dump
("_db_readidx: missingÇewline");

394 
db
->
idxbuf
[db->
idxÀn
-1] = 0;

399 i‡((
±r1
 = 
	`°rchr
(
db
->
idxbuf
, 
SEP
)Ë=
NULL
)

400 
	`îr_dump
("_db_readidx: missing first separator");

401 *
±r1
++ = 0;

403 i‡((
±r2
 = 
	`°rchr
(
±r1
, 
SEP
)Ë=
NULL
)

404 
	`îr_dump
("_db_readidx: missing second separator");

405 *
±r2
++ = 0;

407 i‡(
	`°rchr
(
±r2
, 
SEP
Ë!
NULL
)

408 
	`îr_dump
("_db_readidx:Åoo many separators");

413 i‡((
db
->
d©off
 = 
	`©ﬁ
(
±r1
)) < 0)

414 
	`îr_dump
("_db_readidx: starting offset < 0");

415 i‡((
db
->
d©Àn
 = 
	`©ﬁ
(
±r2
)Ë<0 || db->d©À¿> 
DATLEN_MAX
)

416 
	`îr_dump
("_db_readidx: invalidÜength");

417 (
db
->
±rvÆ
);

418 
	}
}

425 
	$_db_ªadd©
(
DB
 *
db
)

427 i‡(
	`l£ek
(
db
->
d©fd
, db->
d©off
, 
SEEK_SET
) == -1)

428 
	`îr_dump
("_db_readdat:ÜseekÉrror");

429 i‡(
	`ªad
(
db
->
d©fd
, db->
d©buf
, db->
d©Àn
) != db->datlen)

430 
	`îr_dump
("_db_readdat:ÑeadÉrror");

431 i‡(
db
->
d©buf
[db->
d©Àn
-1] !
NEWLINE
)

432 
	`îr_dump
("_db_readdat: missingÇewline");

433 
db
->
d©buf
[db->
d©Àn
-1] = 0;

434 (
db
->
d©buf
);

435 
	}
}

441 
	$db_dñëe
(
DBHANDLE
 
h
, c⁄° *
key
)

443 
DB
 *
db
 = 
h
;

444 
rc
 = 0;

446 i‡(
	`_db_föd_™d_lock
(
db
, 
key
, 1) == 0) {

447 
	`_db_dodñëe
(
db
);

448 
db
->
˙t_dñok
++;

450 
rc
 = -1;

451 
db
->
˙t_dñîr
++;

453 i‡(
	`un_lock
(
db
->
idxfd
, db->
chaöoff
, 
SEEK_SET
, 1) < 0)

454 
	`îr_dump
("db_delete: un_lockÉrror");

455 (
rc
);

456 
	}
}

464 
	$_db_dodñëe
(
DB
 *
db
)

466 
i
;

467 *
±r
;

468 
off_t
 
‰ì±r
, 
ßvïå
;

473 
±r
 = 
db
->
d©buf
, 
i
 = 0; i < db->
d©Àn
 - 1; i++)

474 *
±r
++ = 
SPACE
;

475 *
±r
 = 0;

476 
±r
 = 
db
->
idxbuf
;

477 *
±r
)

478 *
±r
++ = 
SPACE
;

483 i‡(
	`wrôew_lock
(
db
->
idxfd
, 
FREE_OFF
, 
SEEK_SET
, 1) < 0)

484 
	`îr_dump
("_db_dodelete: writew_lockÉrror");

489 
	`_db_wrôed©
(
db
, db->
d©buf
, db->
d©off
, 
SEEK_SET
);

496 
‰ì±r
 = 
	`_db_ªad±r
(
db
, 
FREE_OFF
);

502 
ßvïå
 = 
db
->
±rvÆ
;

509 
	`_db_wrôeidx
(
db
, db->
idxbuf
, db->
idxoff
, 
SEEK_SET
, 
‰ì±r
);

514 
	`_db_wrôïå
(
db
, 
FREE_OFF
, db->
idxoff
);

522 
	`_db_wrôïå
(
db
, db->
±roff
, 
ßvïå
);

523 i‡(
	`un_lock
(
db
->
idxfd
, 
FREE_OFF
, 
SEEK_SET
, 1) < 0)

524 
	`îr_dump
("_db_dodelete: un_lockÉrror");

525 
	}
}

532 
	$_db_wrôed©
(
DB
 *
db
, c⁄° *
d©a
, 
off_t
 
off£t
, 
whí˚
)

534 
iovec
 
iov
[2];

535 
√wlöe
 = 
NEWLINE
;

542 i‡(
whí˚
 =
SEEK_END
)

543 i‡(
	`wrôew_lock
(
db
->
d©fd
, 0, 
SEEK_SET
, 0) < 0)

544 
	`îr_dump
("_db_writedat: writew_lockÉrror");

546 i‡((
db
->
d©off
 = 
	`l£ek
(db->
d©fd
, 
off£t
, 
whí˚
)) == -1)

547 
	`îr_dump
("_db_writedat:ÜseekÉrror");

548 
db
->
d©Àn
 = 
	`°æí
(
d©a
) + 1;

550 
iov
[0].
iov_ba£
 = (*Ë
d©a
;

551 
iov
[0].
iov_Àn
 = 
db
->
d©Àn
 - 1;

552 
iov
[1].
iov_ba£
 = &
√wlöe
;

553 
iov
[1].
iov_Àn
 = 1;

554 i‡(
	`wrôev
(
db
->
d©fd
, &
iov
[0], 2Ë!db->
d©Àn
)

555 
	`îr_dump
("_db_writedat: writevÉrror of dataÑecord");

557 i‡(
whí˚
 =
SEEK_END
)

558 i‡(
	`un_lock
(
db
->
d©fd
, 0, 
SEEK_SET
, 0) < 0)

559 
	`îr_dump
("_db_writedat: un_lockÉrror");

560 
	}
}

568 
	$_db_wrôeidx
(
DB
 *
db
, c⁄° *
key
,

569 
off_t
 
off£t
, 
whí˚
, off_à
±rvÆ
)

571 
iovec
 
iov
[2];

572 
asciùåÀn
[
PTR_SZ
 + 
IDXLEN_SZ
 + 1];

573 
Àn
;

575 i‡((
db
->
±rvÆ
 =ÖåvÆË< 0 ||ÖåvÆ > 
PTR_MAX
)

576 
	`îr_quô
("_db_wrôeidx: invÆidÖå: %d", 
±rvÆ
);

577 
	`•rötf
(
db
->
idxbuf
, "%s%c%Œd%c%ld\n", 
key
, 
SEP
,

578 ()
db
->
d©off
, 
SEP
, ()db->
d©Àn
);

579 
Àn
 = 
	`°æí
(
db
->
idxbuf
);

580 i‡(
Àn
 < 
IDXLEN_MIN
 ||Üí > 
IDXLEN_MAX
)

581 
	`îr_dump
("_db_writeidx: invalidÜength");

582 
	`•rötf
(
asciùåÀn
, "%*Œd%*d", 
PTR_SZ
, ()
±rvÆ
,

583 
IDXLEN_SZ
, 
Àn
);

590 i‡(
whí˚
 =
SEEK_END
)

591 i‡(
	`wrôew_lock
(
db
->
idxfd
, ((db->
nhash
+1)*
PTR_SZ
)+1,

592 
SEEK_SET
, 0) < 0)

593 
	`îr_dump
("_db_writeidx: writew_lockÉrror");

598 i‡((
db
->
idxoff
 = 
	`l£ek
(db->
idxfd
, 
off£t
, 
whí˚
)) == -1)

599 
	`îr_dump
("_db_writeidx:ÜseekÉrror");

601 
iov
[0].
iov_ba£
 = 
asciùåÀn
;

602 
iov
[0].
iov_Àn
 = 
PTR_SZ
 + 
IDXLEN_SZ
;

603 
iov
[1].
iov_ba£
 = 
db
->
idxbuf
;

604 
iov
[1].
iov_Àn
 = 
Àn
;

605 i‡(
	`wrôev
(
db
->
idxfd
, &
iov
[0], 2Ë!
PTR_SZ
 + 
IDXLEN_SZ
 + 
Àn
)

606 
	`îr_dump
("_db_writeidx: writevÉrror of indexÑecord");

608 i‡(
whí˚
 =
SEEK_END
)

609 i‡(
	`un_lock
(
db
->
idxfd
, ((db->
nhash
+1)*
PTR_SZ
)+1,

610 
SEEK_SET
, 0) < 0)

611 
	`îr_dump
("_db_writeidx: un_lockÉrror");

612 
	}
}

619 
	$_db_wrôïå
(
DB
 *
db
, 
off_t
 
off£t
, off_à
±rvÆ
)

621 
asciùå
[
PTR_SZ
 + 1];

623 i‡(
±rvÆ
 < 0 ||ÖåvÆ > 
PTR_MAX
)

624 
	`îr_quô
("_db_wrôïå: invÆidÖå: %d", 
±rvÆ
);

625 
	`•rötf
(
asciùå
, "%*Œd", 
PTR_SZ
, ()
±rvÆ
);

627 i‡(
	`l£ek
(
db
->
idxfd
, 
off£t
, 
SEEK_SET
) == -1)

628 
	`îr_dump
("_db_writeptr:ÜseekÉrrorÅoÖtr field");

629 i‡(
	`wrôe
(
db
->
idxfd
, 
asciùå
, 
PTR_SZ
) != PTR_SZ)

630 
	`îr_dump
("_db_writeptr: writeÉrror ofÖtr field");

631 
	}
}

638 
	$db_°‹e
(
DBHANDLE
 
h
, c⁄° *
key
, c⁄° *
d©a
, 
Êag
)

640 
DB
 *
db
 = 
h
;

641 
rc
, 
keyÀn
, 
d©Àn
;

642 
off_t
 
±rvÆ
;

644 i‡(
Êag
 !
DB_INSERT
 && fœg !
DB_REPLACE
 &&

645 
Êag
 !
DB_STORE
) {

646 
î∫o
 = 
EINVAL
;

649 
keyÀn
 = 
	`°æí
(
key
);

650 
d©Àn
 = 
	`°æí
(
d©a
) + 1;

651 i‡(
d©Àn
 < 
DATLEN_MIN
 || d©À¿> 
DATLEN_MAX
)

652 
	`îr_dump
("db_store: invalid dataÜength");

661 i‡(
	`_db_föd_™d_lock
(
db
, 
key
, 1) < 0) {

662 i‡(
Êag
 =
DB_REPLACE
) {

663 
rc
 = -1;

664 
db
->
˙t_°‹îr
++;

665 
î∫o
 = 
ENOENT
;

666 
d‹ëu∫
;

673 
±rvÆ
 = 
	`_db_ªad±r
(
db
, db->
chaöoff
);

675 i‡(
	`_db_föd‰ì
(
db
, 
keyÀn
, 
d©Àn
) < 0) {

680 
	`_db_wrôed©
(
db
, 
d©a
, 0, 
SEEK_END
);

681 
	`_db_wrôeidx
(
db
, 
key
, 0, 
SEEK_END
, 
±rvÆ
);

687 
	`_db_wrôïå
(
db
, db->
chaöoff
, db->
idxoff
);

688 
db
->
˙t_°‹1
++;

695 
	`_db_wrôed©
(
db
, 
d©a
, db->
d©off
, 
SEEK_SET
);

696 
	`_db_wrôeidx
(
db
, 
key
, db->
idxoff
, 
SEEK_SET
, 
±rvÆ
);

697 
	`_db_wrôïå
(
db
, db->
chaöoff
, db->
idxoff
);

698 
db
->
˙t_°‹2
++;

701 i‡(
Êag
 =
DB_INSERT
) {

702 
rc
 = 1;

703 
db
->
˙t_°‹îr
++;

704 
d‹ëu∫
;

712 i‡(
d©Àn
 !
db
->datlen) {

713 
	`_db_dodñëe
(
db
);

719 
±rvÆ
 = 
	`_db_ªad±r
(
db
, db->
chaöoff
);

724 
	`_db_wrôed©
(
db
, 
d©a
, 0, 
SEEK_END
);

725 
	`_db_wrôeidx
(
db
, 
key
, 0, 
SEEK_END
, 
±rvÆ
);

730 
	`_db_wrôïå
(
db
, db->
chaöoff
, db->
idxoff
);

731 
db
->
˙t_°‹3
++;

736 
	`_db_wrôed©
(
db
, 
d©a
, db->
d©off
, 
SEEK_SET
);

737 
db
->
˙t_°‹4
++;

740 
rc
 = 0;

742 
d‹ëu∫
:

743 i‡(
	`un_lock
(
db
->
idxfd
, db->
chaöoff
, 
SEEK_SET
, 1) < 0)

744 
	`îr_dump
("db_store: un_lockÉrror");

745 (
rc
);

746 
	}
}

753 
	$_db_föd‰ì
(
DB
 *
db
, 
keyÀn
, 
d©Àn
)

755 
rc
;

756 
off_t
 
off£t
, 
√xtoff£t
, 
ßveoff£t
;

761 i‡(
	`wrôew_lock
(
db
->
idxfd
, 
FREE_OFF
, 
SEEK_SET
, 1) < 0)

762 
	`îr_dump
("_db_findfree: writew_lockÉrror");

767 
ßveoff£t
 = 
FREE_OFF
;

768 
off£t
 = 
	`_db_ªad±r
(
db
, 
ßveoff£t
);

770 
off£t
 != 0) {

771 
√xtoff£t
 = 
	`_db_ªadidx
(
db
, 
off£t
);

772 i‡(
	`°æí
(
db
->
idxbuf
Ë=
keyÀn
 && db->
d©Àn
 == datlen)

774 
ßveoff£t
 = 
off£t
;

775 
off£t
 = 
√xtoff£t
;

778 i‡(
off£t
 == 0) {

779 
rc
 = -1;

789 
	`_db_wrôïå
(
db
, 
ßveoff£t
, db->
±rvÆ
);

790 
rc
 = 0;

802 i‡(
	`un_lock
(
db
->
idxfd
, 
FREE_OFF
, 
SEEK_SET
, 1) < 0)

803 
	`îr_dump
("_db_findfree: un_lockÉrror");

804 (
rc
);

805 
	}
}

813 
	$db_ªwöd
(
DBHANDLE
 
h
)

815 
DB
 *
db
 = 
h
;

816 
off_t
 
off£t
;

818 
off£t
 = (
db
->
nhash
 + 1Ë* 
PTR_SZ
;

825 i‡((
db
->
idxoff
 = 
	`l£ek
(db->
idxfd
, 
off£t
+1, 
SEEK_SET
)) == -1)

826 
	`îr_dump
("db_rewind:ÜseekÉrror");

827 
	}
}

836 
	$db_√xåec
(
DBHANDLE
 
h
, *
key
)

838 
DB
 *
db
 = 
h
;

839 
c
;

840 *
±r
;

846 i‡(
	`ªadw_lock
(
db
->
idxfd
, 
FREE_OFF
, 
SEEK_SET
, 1) < 0)

847 
	`îr_dump
("db_nextrec:Ñeadw_lockÉrror");

853 i‡(
	`_db_ªadidx
(
db
, 0) < 0) {

854 
±r
 = 
NULL
;

855 
d‹ëu∫
;

861 
±r
 = 
db
->
idxbuf
;

862 (
c
 = *
±r
++Ë!0 && c =
SPACE
)

864 } 
c
 == 0);

866 i‡(
key
 !
NULL
)

867 
	`°r˝y
(
key
, 
db
->
idxbuf
);

868 
±r
 = 
	`_db_ªadd©
(
db
);

869 
db
->
˙t_√xåec
++;

871 
d‹ëu∫
:

872 i‡(
	`un_lock
(
db
->
idxfd
, 
FREE_OFF
, 
SEEK_SET
, 1) < 0)

873 
	`îr_dump
("db_nextrec: un_lockÉrror");

874 (
±r
);

875 
	}
}

	@db/t4.c

1 
	~"≠ue.h
"

2 
	~"≠ue_db.h
"

3 
	~<f˙é.h
>

6 
	$maö
()

8 
DBHANDLE
 
db
;

10 i‡((
db
 = 
	`db_›í
("db4", 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
,

11 
FILE_MODE
)Ë=
NULL
)

12 
	`îr_sys
("db_openÉrror");

14 i‡(
	`db_°‹e
(
db
, "AÕha", "d©a1", 
DB_INSERT
) != 0)

15 
	`îr_quô
("db_storeÉrror forálpha");

16 i‡(
	`db_°‹e
(
db
, "bëa", "D©®f‹ bëa", 
DB_INSERT
) != 0)

17 
	`îr_quô
("db_storeÉrror for beta");

18 i‡(
	`db_°‹e
(
db
, "gamma", "ªc‹d3", 
DB_INSERT
) != 0)

19 
	`îr_quô
("db_storeÉrror for gamma");

21 
	`db_˛o£
(
db
);

22 
	`exô
(0);

23 
	}
}

	@environ/cmd1.c

1 
	~"≠ue.h
"

3 
	#TOK_ADD
 5

	)

5 
do_löe
(*);

6 
cmd_add
();

7 
gë_tokí
();

10 
	$maö
()

12 
löe
[
MAXLINE
];

14 
	`fgës
(
löe
, 
MAXLINE
, 
°dö
Ë!
NULL
)

15 
	`do_löe
(
löe
);

16 
	`exô
(0);

17 
	}
}

19 *
	gtok_±r
;

22 
	$do_löe
(*
±r
)

24 
cmd
;

26 
tok_±r
 = 
±r
;

27 (
cmd
 = 
	`gë_tokí
()) > 0) {

28 
cmd
) {

29 
TOK_ADD
:

30 
	`cmd_add
();

34 
	}
}

37 
	$cmd_add
()

39 
tokí
;

41 
tokí
 = 
	`gë_tokí
();

43 
	}
}

46 
	$gë_tokí
()

49 
	}
}

	@environ/cmd2.c

1 
	~"≠ue.h
"

2 
	~<£tjmp.h
>

4 
	#TOK_ADD
 5

	)

6 
jmp_buf
 
	gjmpbuf„r
;

9 
	$maö
()

11 
löe
[
MAXLINE
];

13 i‡(
	`£tjmp
(
jmpbuf„r
) != 0)

14 
	`¥ötf
("error");

15 
	`fgës
(
löe
, 
MAXLINE
, 
°dö
Ë!
NULL
)

16 
	`do_löe
(
löe
);

17 
	`exô
(0);

18 
	}
}

23 
	$cmd_add
()

25 
tokí
;

27 
tokí
 = 
	`gë_tokí
();

28 i‡(
tokí
 < 0)

29 
	`l⁄gjmp
(
jmpbuf„r
, 1);

31 
	}
}

	@environ/doatexit.c

1 
	~"≠ue.h
"

3 
my_exô1
();

4 
my_exô2
();

7 
	$maö
()

9 i‡(
	`©exô
(
my_exô2
) != 0)

10 
	`îr_sys
("can'tÑegister my_exit2");

12 i‡(
	`©exô
(
my_exô1
) != 0)

13 
	`îr_sys
("can'tÑegister my_exit1");

14 i‡(
	`©exô
(
my_exô1
) != 0)

15 
	`îr_sys
("can'tÑegister my_exit1");

17 
	`¥ötf
("main is done\n");

19 
	}
}

22 
	$my_exô1
()

24 
	`¥ötf
("firstÉxit handler\n");

25 
	}
}

28 
	$my_exô2
()

30 
	`¥ötf
("secondÉxit handler\n");

31 
	}
}

	@environ/echoarg.c

1 
	~"≠ue.h
"

4 
	$maö
(
¨gc
, *
¨gv
[])

6 
i
;

8 
i
 = 0; i < 
¨gc
; i++)

9 
	`¥ötf
("¨gv[%d]: %s\n", 
i
, 
¨gv
[i]);

10 
	`exô
(0);

11 
	}
}

	@environ/getrlimit.c

1 
	~"≠ue.h
"

2 
	~<sys/ªsour˚.h
>

4 
	#doô
(
«me
Ë
	`¥_limôs
(#«me,Çame)

	)

6 
¥_limôs
(*, );

9 
	$maö
()

11 #ifdef 
RLIMIT_AS


12 
	`doô
(
RLIMIT_AS
);

15 
	`doô
(
RLIMIT_CORE
);

16 
	`doô
(
RLIMIT_CPU
);

17 
	`doô
(
RLIMIT_DATA
);

18 
	`doô
(
RLIMIT_FSIZE
);

20 #ifdef 
RLIMIT_MEMLOCK


21 
	`doô
(
RLIMIT_MEMLOCK
);

24 #ifde‡
RLIMIT_MSGQUEUE


25 
	`doô
(
RLIMIT_MSGQUEUE
);

28 #ifde‡
RLIMIT_NICE


29 
	`doô
(
RLIMIT_NICE
);

32 
	`doô
(
RLIMIT_NOFILE
);

34 #ifdef 
RLIMIT_NPROC


35 
	`doô
(
RLIMIT_NPROC
);

38 #ifde‡
RLIMIT_NPTS


39 
	`doô
(
RLIMIT_NPTS
);

42 #ifdef 
RLIMIT_RSS


43 
	`doô
(
RLIMIT_RSS
);

46 #ifdef 
RLIMIT_SBSIZE


47 
	`doô
(
RLIMIT_SBSIZE
);

50 #ifde‡
RLIMIT_SIGPENDING


51 
	`doô
(
RLIMIT_SIGPENDING
);

54 
	`doô
(
RLIMIT_STACK
);

56 #ifde‡
RLIMIT_SWAP


57 
	`doô
(
RLIMIT_SWAP
);

60 #ifdef 
RLIMIT_VMEM


61 
	`doô
(
RLIMIT_VMEM
);

64 
	`exô
(0);

65 
	}
}

68 
	$¥_limôs
(*
«me
, 
ªsour˚
)

70 
æimô
 
limô
;

71 
lim
;

73 i‡(
	`gëæimô
(
ªsour˚
, &
limô
) < 0)

74 
	`îr_sys
("gëæimôÉº‹ f‹ %s", 
«me
);

75 
	`¥ötf
("%-14† ", 
«me
);

76 i‡(
limô
.
æim_cur
 =
RLIM_INFINITY
) {

77 
	`¥ötf
("(infinite) ");

79 
lim
 = 
limô
.
æim_cur
;

80 
	`¥ötf
("%10Œd ", 
lim
);

82 i‡(
limô
.
æim_max
 =
RLIM_INFINITY
) {

83 
	`¥ötf
("(infinite)");

85 
lim
 = 
limô
.
æim_max
;

86 
	`¥ötf
("%10Œd", 
lim
);

88 
	`putch¨
(()'\n');

89 
	}
}

	@environ/hello1.c

1 
	~<°dio.h
>

3 
	$maö
()

5 
	`¥ötf
("hello, world\n");

6 
	}
}

	@environ/opendata.c

1 
	~<°dio.h
>

3 
FILE
 *

4 
	$›í_d©a
()

6 
FILE
 *
Â
;

7 
d©abuf
[
BUFSIZ
];

9 i‡((
Â
 = 
	`f›í
("d©afûe", "r")Ë=
NULL
)

10 (
NULL
);

11 i‡(
	`£tvbuf
(
Â
, 
d©abuf
, 
_IOLBF
, 
BUFSIZ
) != 0)

12 (
NULL
);

13 (
Â
);

14 
	}
}

	@environ/scope.c

2 
	$f1
(
vÆ
)

4 
num
 = 0;

5 *
±r
 = &
num
;

7 i‡(
vÆ
 == 0) {

8 
vÆ
;

10 
vÆ
 = 5;

11 
±r
 = &
vÆ
;

13 (*
±r
 + 1);

14 
	}
}

	@environ/testjmp.c

1 
	~"≠ue.h
"

2 
	~<£tjmp.h
>

4 
f1
(, , , );

5 
f2
();

7 
jmp_buf
 
	gjmpbuf„r
;

8 
	gglobvÆ
;

11 
	$maö
()

13 
autovÆ
;

14 
ªgivÆ
;

15 vﬁ©ûê
vﬁavÆ
;

16 
°©vÆ
;

18 
globvÆ
 = 1; 
autovÆ
 = 2; 
ªgivÆ
 = 3; 
vﬁavÆ
 = 4; 
°©vÆ
 = 5;

20 i‡(
	`£tjmp
(
jmpbuf„r
) != 0) {

21 
	`¥ötf
("afterÜongjmp:\n");

22 
	`¥ötf
("globval = %d,áutoval = %d,Ñegival = %d,"

24 
globvÆ
, 
autovÆ
, 
ªgivÆ
, 
vﬁavÆ
, 
°©vÆ
);

25 
	`exô
(0);

31 
globvÆ
 = 95; 
autovÆ
 = 96; 
ªgivÆ
 = 97; 
vﬁavÆ
 = 98;

32 
°©vÆ
 = 99;

34 
	`f1
(
autovÆ
, 
ªgivÆ
, 
vﬁavÆ
, 
°©vÆ
);

35 
	`exô
(0);

36 
	}
}

39 
	$f1
(
i
, 
j
, 
k
, 
l
)

41 
	`¥ötf
("in f1():\n");

42 
	`¥ötf
("globval = %d,áutoval = %d,Ñegival = %d,"

43 " vﬁavÆ = %d, sètvÆ = %d\n", 
globvÆ
, 
i
, 
j
, 
k
, 
l
);

44 
	`f2
();

45 
	}
}

48 
	$f2
()

50 
	`l⁄gjmp
(
jmpbuf„r
, 1);

51 
	}
}

	@exercises/asyncsocket.c

1 
	~"≠ue.h
"

2 
	~<î∫o.h
>

3 
	~<f˙é.h
>

4 
	~<sys/sockë.h
>

5 
	~<sys/io˘l.h
>

6 #i‡
deföed
(
BSD
Ë|| deföed(
MACOS
Ë|| deföed(
SOLARIS
)

7 
	~<sys/fûio.h
>

11 
	$£èsync
(
sockfd
)

13 
n
;

15 i‡(
	`f˙é
(
sockfd
, 
F_SETOWN
, 
	`gëpid
()) < 0)

17 
n
 = 1;

18 i‡(
	`io˘l
(
sockfd
, 
FIOASYNC
, &
n
) < 0)

21 
	}
}

24 
	$˛øsync
(
sockfd
)

26 
n
;

28 
n
 = 0;

29 i‡(
	`io˘l
(
sockfd
, 
FIOASYNC
, &
n
) < 0)

32 
	}
}

	@exercises/bo.c

1 
	~<°dio.h
>

2 
	~<°dlib.h
>

3 
	~<öây≥s.h
>

6 
	$maö
()

8 
uöt32_t
 
i
 = 0x04030201;

9 *
˝
 = (*)&
i
;

11 i‡(*
˝
 == 1)

12 
	`¥ötf
("little-endian\n");

13 i‡(*
˝
 == 4)

14 
	`¥ötf
("big-endian\n");

16 
	`¥ötf
("who knows?\n");

17 
	`exô
(0);

18 
	}
}

	@exercises/fifo1.c

1 
	~"≠ue.h
"

2 
	~<f˙é.h
>

4 
	#FIFO
 "ãmp.fifo"

	)

7 
	$maö
()

9 
fdªad
, 
fdwrôe
;

11 
	`u∆ök
(
FIFO
);

12 i‡(
	`mkfifo
(
FIFO
, 
FILE_MODE
) < 0)

13 
	`îr_sys
("mkfifoÉrror");

14 i‡((
fdªad
 = 
	`›í
(
FIFO
, 
O_RDONLY
 | 
O_NONBLOCK
)) < 0)

15 
	`îr_sys
("openÉrror forÑeading");

16 i‡((
fdwrôe
 = 
	`›í
(
FIFO
, 
O_WRONLY
)) < 0)

17 
	`îr_sys
("openÉrror for writing");

18 
	`˛r_Ê
(
fdªad
, 
O_NONBLOCK
);

19 
	`exô
(0);

20 
	}
}

	@exercises/fmemopen.c

1 
	~<°dio.h
>

2 
	~<°dlib.h
>

3 
	~<°rög.h
>

4 
	~<î∫o.h
>

9 
	smem°ªam


11 *
	mbuf
;

12 
size_t
 
	mrsize
;

13 
size_t
 
	mvsize
;

14 
size_t
 
	mcuΩos
;

15 
	mÊags
;

19 
	#MS_READ
 0x01

	)

20 
	#MS_WRITE
 0x02

	)

21 
	#MS_APPEND
 0x04

	)

22 
	#MS_TRUNCATE
 0x08

	)

23 
	#MS_MYBUF
 0x10

	)

25 #i‚de‡
MIN


26 
	#MIN
(
a
, 
b
Ë(◊Ë< (bË? (aË: (b))

	)

29 
m°ªam_ªad
(*, *, );

30 
m°ªam_wrôe
(*, const *, );

31 
Âos_t
 
m°ªam_£ek
(*, fpos_t, );

32 
m°ªam_˛o£
(*);

33 
ty≥_to_Êags
(c⁄° *
__ª°ri˘
 
ty≥
);

34 
off_t
 
föd_íd
(*
buf
, 
size_t
 
Àn
);

36 
FILE
 *

37 
	$fmem›í
(*
__ª°ri˘
 
buf
, 
size_t
 
size
,

38 c⁄° *
__ª°ri˘
 
ty≥
)

40 
mem°ªam
 *
ms
;

41 
FILE
 *
Â
;

43 i‡(
size
 == 0) {

44 
î∫o
 = 
EINVAL
;

45 (
NULL
);

47 i‡((
ms
 = 
	`mÆloc
((
mem°ªam
))Ë=
NULL
) {

48 
î∫o
 = 
ENOMEM
;

49 (
NULL
);

51 i‡((
ms
->
Êags
 = 
	`ty≥_to_Êags
(
ty≥
)) == 0) {

52 
î∫o
 = 
EINVAL
;

53 
	`‰ì
(
ms
);

54 (
NULL
);

56 i‡(
buf
 =
NULL
) {

57 i‡((
ms
->
Êags
 & (
MS_READ
|
MS_WRITE
)) !=

58 (
MS_READ
|
MS_WRITE
)) {

59 
î∫o
 = 
EINVAL
;

60 
	`‰ì
(
ms
);

61 (
NULL
);

63 i‡((
ms
->
buf
 = 
	`mÆloc
(
size
)Ë=
NULL
) {

64 
î∫o
 = 
ENOMEM
;

65 
	`‰ì
(
ms
);

66 (
NULL
);

68 
ms
->
rsize
 = 
size
;

69 
ms
->
Êags
 |
MS_MYBUF
;

70 
ms
->
cuΩos
 = 0;

72 
ms
->
buf
 = buf;

73 
ms
->
rsize
 = 
size
;

74 i‡(
ms
->
Êags
 & 
MS_APPEND
)

75 
ms
->
cuΩos
 = 
	`föd_íd
(ms->
buf
, ms->
rsize
);

77 
ms
->
cuΩos
 = 0;

79 i‡(
ms
->
Êags
 & 
MS_APPEND
) {

80 
ms
->
vsize
 = ms->
cuΩos
;

81 } i‡(
ms
->
Êags
 & 
MS_TRUNCATE
) {

82 
ms
->
vsize
 = 0;

84 
ms
->
vsize
 = 
size
;

86 
Â
 = 
	`fun›í
(
ms
, 
m°ªam_ªad
, 
m°ªam_wrôe
,

87 
m°ªam_£ek
, 
m°ªam_˛o£
);

88 i‡(
Â
 =
NULL
) {

89 i‡(
ms
->
Êags
 & 
MS_MYBUF
)

90 
	`‰ì
(
ms
->
buf
);

91 
	`‰ì
(
ms
);

93 (
Â
);

94 
	}
}

97 
	$ty≥_to_Êags
(c⁄° *
__ª°ri˘
 
ty≥
)

99 c⁄° *
˝
;

100 
Êags
 = 0;

102 
˝
 = 
ty≥
; *cp != 0; cp++) {

103 *
˝
) {

105 i‡(
Êags
 != 0)

107 
Êags
 |
MS_READ
;

111 i‡(
Êags
 != 0)

113 
Êags
 |
MS_WRITE
|
MS_TRUNCATE
;

117 i‡(
Êags
 != 0)

119 
Êags
 |
MS_APPEND
;

123 i‡(
Êags
 == 0)

125 
Êags
 |
MS_READ
|
MS_WRITE
;

129 i‡(
Êags
 == 0)

137 (
Êags
);

138 
	}
}

140 
off_t


141 
	$föd_íd
(*
buf
, 
size_t
 
Àn
)

143 
off_t
 
off
 = 0;

145 
off
 < 
Àn
) {

146 i‡(
buf
[
off
] == 0)

148 
off
++;

150 (
off
);

151 
	}
}

154 
	$m°ªam_ªad
(*
cookõ
, *
buf
, 
Àn
)

156 
ƒ
;

157 
mem°ªam
 *
ms
 = 
cookõ
;

159 i‡(!(
ms
->
Êags
 & 
MS_READ
)) {

160 
î∫o
 = 
EBADF
;

163 i‡(
ms
->
cuΩos
 >ms->
vsize
)

167 
ƒ
 = 
	`MIN
(
Àn
, 
ms
->
vsize
 - ms->
cuΩos
);

168 
	`mem˝y
(
buf
, 
ms
->bu‡+ ms->
cuΩos
, 
ƒ
);

169 
ms
->
cuΩos
 +
ƒ
;

170 (
ƒ
);

171 
	}
}

174 
	$m°ªam_wrôe
(*
cookõ
, c⁄° *
buf
, 
Àn
)

176 
nw
, 
off
;

177 
mem°ªam
 *
ms
 = 
cookõ
;

179 i‡(!(
ms
->
Êags
 & (
MS_APPEND
|
MS_WRITE
))) {

180 
î∫o
 = 
EBADF
;

183 i‡(
ms
->
Êags
 & 
MS_APPEND
)

184 
off
 = 
ms
->
vsize
;

186 
off
 = 
ms
->
cuΩos
;

187 
nw
 = 
	`MIN
(
Àn
, 
ms
->
rsize
 - 
off
);

188 
	`mem˝y
(
ms
->
buf
 + 
off
, buf, 
nw
);

189 
ms
->
cuΩos
 = 
off
 + 
nw
;

190 i‡(
ms
->
cuΩos
 > ms->
vsize
) {

191 
ms
->
vsize
 = ms->
cuΩos
;

192 i‡(((
ms
->
Êags
 & (
MS_READ
|
MS_WRITE
)) ==

193 (
MS_READ
|
MS_WRITE
)Ë&& (
ms
->
vsize
 < ms->
rsize
))

194 *(
ms
->
buf
 + ms->
vsize
) = 0;

196 i‡((
ms
->
Êags
 & (
MS_WRITE
|
MS_APPEND
)) &&

197 !(
ms
->
Êags
 & 
MS_READ
)) {

198 i‡(
ms
->
cuΩos
 < ms->
rsize
)

199 *(
ms
->
buf
 + ms->
cuΩos
) = 0;

201 *(
ms
->
buf
 + ms->
rsize
 - 1) = 0;

203 (
nw
);

204 
	}
}

206 
Âos_t


207 
	$m°ªam_£ek
(*
cookõ
, 
Âos_t
 
pos
, 
whí˚
)

209 
off
;

210 
mem°ªam
 *
ms
 = 
cookõ
;

212 
whí˚
) {

213 
SEEK_SET
:

214 
off
 = 
pos
;

216 
SEEK_END
:

217 
off
 = 
ms
->
vsize
 + 
pos
;

219 
SEEK_CUR
:

220 
off
 = 
ms
->
cuΩos
 + 
pos
;

223 i‡(
off
 < 0 || of‡> 
ms
->
vsize
) {

224 
î∫o
 = 
EINVAL
;

227 
ms
->
cuΩos
 = 
off
;

228 (
off
);

229 
	}
}

232 
	$m°ªam_˛o£
(*
cookõ
)

234 
mem°ªam
 *
ms
 = 
cookõ
;

236 i‡(
ms
->
Êags
 & 
MS_MYBUF
)

237 
	`‰ì
(
ms
->
buf
);

238 
	`‰ì
(
ms
);

240 
	}
}

	@exercises/getlogin.c

1 
	~"≠ue.h
"

4 
	$maö
()

6 
FILE
 *
Â
;

7 *
p
;

9 
	`d´m⁄ize
("getlog");

10 
p
 = 
	`gëlogö
();

11 
Â
 = 
	`f›í
("/tmp/getlog.out", "w");

12 i‡(
Â
 !
NULL
) {

13 i‡(
p
 =
NULL
)

14 
	`Ârötf
(
Â
, "noÜoginÇame\n");

16 
	`Ârötf
(
Â
, "logöÇame: %s\n", 
p
);

18 
	`exô
(0);

19 
	}
}

	@exercises/getpw44bsd.c

1 
	~"≠ue.h
"

2 
	~<pwd.h
>

5 
	$maö
()

7 
∑sswd
 *
±r
;

9 i‡((
±r
 = 
	`gëpw«m
("ßr")Ë=
NULL
)

10 
	`îr_sys
("getpwnamÉrror");

11 
	`¥ötf
("pw_∑sswd = %s\n", 
±r
->
pw_∑sswd
 =
NULL
 ||

12 
±r
->
pw_∑sswd
[0] == 0 ? "(null)" :Ötr->pw_passwd);

13 
	`exô
(0);

14 
	}
}

	@exercises/getpwsvr4.c

1 
	~"≠ue.h
"

2 
	~<shadow.h
>

5 
	$maö
()

7 
•wd
 *
±r
;

9 i‡((
±r
 = 
	`gë•«m
("ßr")Ë=
NULL
)

10 
	`îr_sys
("getspnamÉrror");

11 
	`¥ötf
("•_pwd∞%s\n", 
±r
->
•_pwdp
 =
NULL
 ||

12 
±r
->
•_pwdp
[0] == 0 ? "(null)" :Ötr->sp_pwdp);

13 
	`exô
(0);

14 
	}
}

	@exercises/goodexit.c

1 
	~"≠ue.h
"

2 
	~<±hªad.h
>

4 
	sfoo
 {

5 
	ma
, 
	mb
, 
	mc
, 
	md
;

9 
	$¥ötfoo
(c⁄° *
s
, c⁄° 
foo
 *
Â
)

11 
	`Âuts
(
s
, 
°dout
);

12 
	`¥ötf
(" såu˘uªáà0x%lx\n", ()
Â
);

13 
	`¥ötf
(" foo.®%d\n", 
Â
->
a
);

14 
	`¥ötf
(" foo.b = %d\n", 
Â
->
b
);

15 
	`¥ötf
(" foo.¯%d\n", 
Â
->
c
);

16 
	`¥ötf
(" foo.d = %d\n", 
Â
->
d
);

17 
	}
}

20 
	$thr_‚1
(*
¨g
)

22 
foo
 *
Â
;

24 i‡((
Â
 = 
	`mÆloc
((
foo
))Ë=
NULL
)

25 
	`îr_sys
("can'tállocate memory");

26 
Â
->
a
 = 1;

27 
Â
->
b
 = 2;

28 
Â
->
c
 = 3;

29 
Â
->
d
 = 4;

30 
	`¥ötfoo
("thªad:\n", 
Â
);

31 ((*)
Â
);

32 
	}
}

35 
	$maö
()

37 
îr
;

38 
±hªad_t
 
tid1
;

39 
foo
 *
Â
;

41 
îr
 = 
	`±hªad_¸óã
(&
tid1
, 
NULL
, 
thr_‚1
, NULL);

42 i‡(
îr
 != 0)

43 
	`îr_exô
(
îr
, "can't createÅhread 1");

44 
îr
 = 
	`±hªad_joö
(
tid1
, (*)&
Â
);

45 i‡(
îr
 != 0)

46 
	`îr_exô
(
îr
, "can't join withÅhread 1");

47 
	`¥ötfoo
("∑ª¡:\n", 
Â
);

48 
	`exô
(0);

49 
	}
}

	@exercises/longpath.c

1 
	~"≠ue.h
"

2 
	~<f˙é.h
>

4 
	#DEPTH
 1000

	)

5 
	#STARTDIR
 "/tmp"

	)

6 
	#NAME
 "Æ⁄gl⁄gl⁄gl⁄gl⁄gl⁄gl⁄gl⁄gl⁄gl⁄g«me"

	)

7 
	#MAXSZ
 (10*8192)

	)

10 
	$maö
()

12 
i
;

13 
size_t
 
size
;

14 *
∑th
;

16 i‡(
	`chdú
(
STARTDIR
) < 0)

17 
	`îr_sys
("chdirÉrror");

19 
i
 = 0; i < 
DEPTH
; i++) {

20 i‡(
	`mkdú
(
NAME
, 
DIR_MODE
) < 0)

21 
	`îr_sys
("mkdú faûed, i = %d", 
i
);

22 i‡(
	`chdú
(
NAME
) < 0)

23 
	`îr_sys
("chdú faûed, i = %d", 
i
);

26 i‡(
	`¸ót
("afûe", 
FILE_MODE
) < 0)

27 
	`îr_sys
("creatÉrror");

33 
∑th
 = 
	`∑th_Æloc
(&
size
);

35 i‡(
	`gëcwd
(
∑th
, 
size
Ë!
NULL
) {

38 
	`îr_ªt
("gëcwd faûed, sizê%ld", ()
size
);

39 
size
 += 100;

40 i‡(
size
 > 
MAXSZ
)

41 
	`îr_quô
("giving up");

42 i‡((
∑th
 = 
	`ªÆloc
’©h, 
size
)Ë=
NULL
)

43 
	`îr_sys
("reallocÉrror");

46 
	`¥ötf
("Àngth = %ld\n%s\n", ()
	`°æí
(
∑th
),Öath);

48 
	`exô
(0);

49 
	}
}

	@exercises/openmax.c

1 
	~"≠ue.h
"

2 
	~<limôs.h
>

3 
	~<sys/ªsour˚.h
>

5 
	#OPEN_MAX_GUESS
 256

	)

8 
	$›í_max
()

10 
›ímax
;

11 
æimô
 
æ
;

13 i‡((
›ímax
 = 
	`sysc⁄f
(
_SC_OPEN_MAX
)) < 0 ||

14 
›ímax
 =
LONG_MAX
) {

15 i‡(
	`gëæimô
(
RLIMIT_NOFILE
, &
æ
) < 0)

16 
	`îr_sys
("can't get fileÜimit");

17 i‡(
æ
.
æim_max
 =
RLIM_INFINITY
)

18 
›ímax
 = 
OPEN_MAX_GUESS
;

20 
›ímax
 = 
æ
.
æim_max
;

22 (
›ímax
);

23 
	}
}

	@exercises/pendlock.c

1 
	~"≠ue.h
"

2 
	~<f˙é.h
>

3 
	~<î∫o.h
>

6 
	$sigöt
(
signo
)

8 
	}
}

11 
	$maö
()

13 
pid_t
 
pid1
, 
pid2
, 
pid3
;

14 
fd
;

16 
	`£tbuf
(
°dout
, 
NULL
);

17 
	`sig«l_öå
(
SIGINT
, 
sigöt
);

22 i‡((
fd
 = 
	`›í
("lockfûe", 
O_RDWR
|
O_CREAT
, 0666)) < 0)

23 
	`îr_sys
("can't open/createÜockfile");

28 i‡((
pid1
 = 
	`f‹k
()) < 0) {

29 
	`îr_sys
("fork failed");

30 } i‡(
pid1
 == 0) {

31 i‡(
	`lock_ªg
(
fd
, 
F_SETLK
, 
F_RDLCK
, 0, 
SEEK_SET
, 0) < 0)

32 
	`îr_sys
("child 1: can'tÑead-lock file");

33 
	`¥ötf
("child 1: obtainedÑeadÜock on file\n");

34 
	`∑u£
();

35 
	`¥ötf
("child 1:ÉxitáfterÖause\n");

36 
	`exô
(0);

38 
	`¶ìp
(2);

44 i‡((
pid2
 = 
	`f‹k
()) < 0) {

45 
	`îr_sys
("fork failed");

46 } i‡(
pid2
 == 0) {

47 i‡(
	`lock_ªg
(
fd
, 
F_SETLK
, 
F_RDLCK
, 0, 
SEEK_SET
, 0) < 0)

48 
	`îr_sys
("child 2: can'tÑead-lock file");

49 
	`¥ötf
("child 2: obtainedÑeadÜock on file\n");

50 
	`∑u£
();

51 
	`¥ötf
("child 2:ÉxitáfterÖause\n");

52 
	`exô
(0);

54 
	`¶ìp
(2);

61 i‡((
pid3
 = 
	`f‹k
()) < 0) {

62 
	`îr_sys
("fork failed");

63 } i‡(
pid3
 == 0) {

64 i‡(
	`lock_ªg
(
fd
, 
F_SETLK
, 
F_WRLCK
, 0, 
SEEK_SET
, 0) < 0)

65 
	`¥ötf
("child 3: can't set writeÜock: %s\n",

66 
	`°ªº‹
(
î∫o
));

67 
	`¥ötf
("child 3áboutÅo block in write-lock...\n");

68 i‡(
	`lock_ªg
(
fd
, 
F_SETLKW
, 
F_WRLCK
, 0, 
SEEK_SET
, 0) < 0)

69 
	`îr_sys
("child 3: can't write-lock file");

70 
	`¥ötf
("child 3Ñeturnedánd got writeÜock????\n");

71 
	`∑u£
();

72 
	`¥ötf
("child 3:ÉxitáfterÖause\n");

73 
	`exô
(0);

75 
	`¶ìp
(2);

82 i‡(
	`lock_ªg
(
fd
, 
F_SETLK
, 
F_RDLCK
, 0, 
SEEK_SET
, 0) < 0)

83 
	`¥ötf
("parent: can't setÑeadÜock: %s\n",

84 
	`°ªº‹
(
î∫o
));

86 
	`¥ötf
("parent: obtainedádditionalÑeadÜock while"

88 
	`¥ötf
("killing child 1...\n");

89 
	`kûl
(
pid1
, 
SIGINT
);

90 
	`¥ötf
("killing child 2...\n");

91 
	`kûl
(
pid2
, 
SIGINT
);

92 
	`¥ötf
("killing child 3...\n");

93 
	`kûl
(
pid3
, 
SIGINT
);

94 
	`exô
(0);

95 
	}
}

	@exercises/pollmsg2.c

1 
	~"≠ue.h
"

2 
	~<pﬁl.h
>

3 
	~<±hªad.h
>

4 
	~<sys/msg.h
>

5 
	~<sys/sockë.h
>

7 
	#NQ
 3

	)

8 
	#MAXMSZ
 512

	)

9 
	#KEY
 0x123

	)

11 
	smymesg
 {

12 
	mmty≥
;

13 
	mmãxt
[
MAXMSZ
+1];

16 
	sthªadöfo
 {

17 
	mqid
;

18 
	mfd
;

19 
	mÀn
;

20 
±hªad_muãx_t
 
	mmuãx
;

21 
±hªad_c⁄d_t
 
	mªady
;

22 
mymesg
 
	mm
;

26 
	$hñ≥r
(*
¨g
)

28 
n
;

29 
thªadöfo
 *
tù
 = 
¨g
;

32 
	`mem£t
(&
tù
->
m
, 0, (
mymsg
));

33 i‡((
n
 = 
	`msgrcv
(
tù
->
qid
, &tù->
m
, 
MAXMSZ
, 0,

34 
MSG_NOERROR
)) < 0)

35 
	`îr_sys
("msgrcvÉrror");

36 
tù
->
Àn
 = 
n
;

37 
	`±hªad_muãx_lock
(&
tù
->
muãx
);

38 i‡(
	`wrôe
(
tù
->
fd
, "a", ()) < 0)

39 
	`îr_sys
("writeÉrror");

40 
	`±hªad_c⁄d_waô
(&
tù
->
ªady
, &tù->
muãx
);

41 
	`±hªad_muãx_u∆ock
(&
tù
->
muãx
);

43 
	}
}

46 
	$maö
()

48 
c
;

49 
i
, 
n
, 
îr
;

50 
fd
[2];

51 
qid
[
NQ
];

52 
pﬁlfd
 
pfd
[
NQ
];

53 
thªadöfo
 
ti
[
NQ
];

54 
±hªad_t
 
tid
[
NQ
];

56 
i
 = 0; i < 
NQ
; i++) {

57 i‡((
qid
[
i
] = 
	`msggë
((
KEY
+i), 
IPC_CREAT
|0666)) < 0)

58 
	`îr_sys
("msggetÉrror");

60 
	`¥ötf
("queuêID %d i†%d\n", 
i
, 
qid
[i]);

62 i‡(
	`sockë∑ú
(
AF_UNIX
, 
SOCK_DGRAM
, 0, 
fd
) < 0)

63 
	`îr_sys
("socketpairÉrror");

64 
pfd
[
i
].
fd
 = fd[0];

65 
pfd
[
i
].
evíts
 = 
POLLIN
;

66 
ti
[
i
].
qid
 = qid[i];

67 
ti
[
i
].
fd
 = fd[1];

68 i‡(
	`±hªad_c⁄d_öô
(&
ti
[
i
].
ªady
, 
NULL
) != 0)

69 
	`îr_sys
("pthread_cond_initÉrror");

70 i‡(
	`±hªad_muãx_öô
(&
ti
[
i
].
muãx
, 
NULL
) != 0)

71 
	`îr_sys
("pthread_mutex_initÉrror");

72 i‡((
îr
 = 
	`±hªad_¸óã
(&
tid
[
i
], 
NULL
, 
hñ≥r
,

73 &
ti
[
i
])) != 0)

74 
	`îr_exô
(
îr
, "pthread_createÉrror");

78 i‡(
	`pﬁl
(
pfd
, 
NQ
, -1) < 0)

79 
	`îr_sys
("pollÉrror");

80 
i
 = 0; i < 
NQ
; i++) {

81 i‡(
pfd
[
i
].
ªvíts
 & 
POLLIN
) {

82 i‡((
n
 = 
	`ªad
(
pfd
[
i
].
fd
, &
c
, ())) < 0)

83 
	`îr_sys
("readÉrror");

84 
ti
[
i
].
m
.
mãxt
[ti[i].
Àn
] = 0;

85 
	`¥ötf
("queuêid %d, mesßgê%s\n", 
qid
[
i
],

86 
ti
[
i
].
m
.
mãxt
);

87 
	`±hªad_muãx_lock
(&
ti
[
i
].
muãx
);

88 
	`±hªad_c⁄d_sig«l
(&
ti
[
i
].
ªady
);

89 
	`±hªad_muãx_u∆ock
(&
ti
[
i
].
muãx
);

94 
	`exô
(0);

95 
	}
}

	@exercises/prtime.c

1 
	~"≠ue.h
"

2 
	~<time.h
>

5 
	$maö
()

7 
time_t
 
ˇ…ime
;

8 
tm
 *tm;

9 
löe
[
MAXLINE
];

11 i‡((
ˇ…ime
 = 
	`time
(
NULL
)) == -1)

12 
	`îr_sys
("timeÉrror");

13 i‡((
tm
 = 
	`loˇ…ime
(&
ˇ…ime
)Ë=
NULL
)

14 
	`îr_sys
("localtimeÉrror");

15 i‡(
	`°r·ime
(
löe
, 
MAXLINE
, "%®%b %d %X %Z %Y\n", 
tm
) == 0)

16 
	`îr_sys
("strftimeÉrror");

17 
	`Âuts
(
löe
, 
°dout
);

18 
	`exô
(0);

19 
	}
}

	@exercises/sizepipe.c

1 
	~"≠ue.h
"

2 
	~<f˙é.h
>

5 
	$maö
()

7 
i
, 
n
;

8 
fd
[2];

10 i‡(
	`pùe
(
fd
) < 0)

11 
	`îr_sys
("pipeÉrror");

12 
	`£t_Ê
(
fd
[1], 
O_NONBLOCK
);

15 
n
 = 0; ;Ç++) {

16 i‡((
i
 = 
	`wrôe
(
fd
[1], "a", 1)) != 1) {

17 
	`¥ötf
("wrôêªà%d, ", 
i
);

21 
	`¥ötf
("pùêˇ∑côy = %d\n", 
n
);

22 
	`exô
(0);

23 
	}
}

	@exercises/sleep.c

1 
	~<uni°d.h
>

2 
	~<time.h
>

3 
	~<sys/£À˘.h
>

6 
	$¶ìp
(
£c⁄ds
)

8 
n
;

9 
¶ït
;

10 
time_t
 
°¨t
, 
íd
;

11 
timevÆ
 
tv
;

13 
tv
.
tv_£c
 = 
£c⁄ds
;

14 
tv
.
tv_u£c
 = 0;

15 
	`time
(&
°¨t
);

16 
n
 = 
	`£À˘
(0, 
NULL
, NULL, NULL, &
tv
);

17 i‡(
n
 == 0)

19 
	`time
(&
íd
);

20 
¶ït
 = 
íd
 - 
°¨t
;

21 i‡(
¶ït
 >
£c⁄ds
)

23 (
£c⁄ds
 - 
¶ït
);

24 
	}
}

	@exercises/sleepus_poll.c

1 
	~<pﬁl.h
>

4 
	$¶ìp_us
(
nu£cs
)

6 
pﬁlfd
 
dummy
;

7 
timeout
;

9 i‡((
timeout
 = 
nu£cs
 / 1000) <= 0)

10 
timeout
 = 1;

11 
	`pﬁl
(&
dummy
, 0, 
timeout
);

12 
	}
}

	@exercises/sleepus_select.c

1 
	~"≠ue.h
"

2 
	~<sys/£À˘.h
>

5 
	$¶ìp_us
(
nu£cs
)

7 
timevÆ
 
tvÆ
;

9 
tvÆ
.
tv_£c
 = 
nu£cs
 / 1000000;

10 
tvÆ
.
tv_u£c
 = 
nu£cs
 % 1000000;

11 
	`£À˘
(0, 
NULL
, NULL, NULL, &
tvÆ
);

12 
	}
}

	@exercises/vfork3.c

1 
	~"≠ue.h
"

3 
f1
(), 
f2
();

6 
	$maö
()

8 
	`f1
();

9 
	`f2
();

10 
	`_exô
(0);

11 
	}
}

14 
	$f1
()

16 
pid_t
 
pid
;

18 i‡((
pid
 = 
	`vf‹k
()) < 0)

19 
	`îr_sys
("vforkÉrror");

21 
	}
}

24 
	$f2
()

26 
buf
[1000];

27 
i
;

29 
i
 = 0; i < (
buf
); i++)

30 
buf
[
i
] = 0;

31 
	}
}

	@exercises/zombie.c

1 
	~"≠ue.h
"

3 #ifde‡
SOLARIS


4 
	#PSCMD
 "p†-®-ÿpid,µid,s,ây,comm"

	)

6 
	#PSCMD
 "p†-ÿpid,µid,°©e,ây,comm™d"

	)

10 
	$maö
()

12 
pid_t
 
pid
;

14 i‡((
pid
 = 
	`f‹k
()) < 0)

15 
	`îr_sys
("forkÉrror");

16 i‡(
pid
 == 0)

17 
	`exô
(0);

20 
	`¶ìp
(4);

21 
	`sy°em
(
PSCMD
);

23 
	`exô
(0);

24 
	}
}

	@filedir/access.c

1 
	~"≠ue.h
"

2 
	~<f˙é.h
>

5 
	$maö
(
¨gc
, *
¨gv
[])

7 i‡(
¨gc
 != 2)

8 
	`îr_quô
("usage:á.out <pathname>");

9 i‡(
	`ac˚ss
(
¨gv
[1], 
R_OK
) < 0)

10 
	`îr_ªt
("ac˚s†îr‹ f‹ %s", 
¨gv
[1]);

12 
	`¥ötf
("readáccess OK\n");

13 i‡(
	`›í
(
¨gv
[1], 
O_RDONLY
) < 0)

14 
	`îr_ªt
("›íÉº‹ f‹ %s", 
¨gv
[1]);

16 
	`¥ötf
("open forÑeading OK\n");

17 
	`exô
(0);

18 
	}
}

	@filedir/cdpwd.c

1 
	~"≠ue.h
"

4 
	$maö
()

6 *
±r
;

7 
size_t
 
size
;

9 i‡(
	`chdú
("/usr/spool/uucppublic") < 0)

10 
	`îr_sys
("chdir failed");

12 
±r
 = 
	`∑th_Æloc
(&
size
);

13 i‡(
	`gëcwd
(
±r
, 
size
Ë=
NULL
)

14 
	`îr_sys
("getcwd failed");

16 
	`¥ötf
("cwd = %s\n", 
±r
);

17 
	`exô
(0);

18 
	}
}

	@filedir/changemod.c

1 
	~"≠ue.h
"

4 
	$maö
()

6 
°©
 
°©buf
;

10 i‡(
	`°©
("foo", &
°©buf
) < 0)

11 
	`îr_sys
("statÉrror for foo");

12 i‡(
	`chmod
("foo", (
°©buf
.
°_mode
 & ~
S_IXGRP
Ë| 
S_ISGID
) < 0)

13 
	`îr_sys
("chmodÉrror for foo");

17 i‡(
	`chmod
("b¨", 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IROTH
) < 0)

18 
	`îr_sys
("chmodÉrror for bar");

20 
	`exô
(0);

21 
	}
}

	@filedir/devrdev.c

1 
	~"≠ue.h
"

2 #ifde‡
SOLARIS


3 
	~<sys/mkdev.h
>

7 
	$maö
(
¨gc
, *
¨gv
[])

9 
i
;

10 
°©
 
buf
;

12 
i
 = 1; i < 
¨gc
; i++) {

13 
	`¥ötf
("%s: ", 
¨gv
[
i
]);

14 i‡(
	`°©
(
¨gv
[
i
], &
buf
) < 0) {

15 
	`îr_ªt
("statÉrror");

19 
	`¥ötf
("dev = %d/%d", 
	`maj‹
(
buf
.
°_dev
), 
	`mö‹
(buf.st_dev));

21 i‡(
	`S_ISCHR
(
buf
.
°_mode
Ë|| 
	`S_ISBLK
(buf.st_mode)) {

22 
	`¥ötf
(" (%s)Ñdev = %d/%d",

23 (
	`S_ISCHR
(
buf
.
°_mode
)) ? "character" : "block",

24 
	`maj‹
(
buf
.
°_rdev
), 
	`mö‹
(buf.st_rdev));

26 
	`¥ötf
("\n");

29 
	`exô
(0);

30 
	}
}

	@filedir/filetype.c

1 
	~"≠ue.h
"

4 
	$maö
(
¨gc
, *
¨gv
[])

6 
i
;

7 
°©
 
buf
;

8 *
±r
;

10 
i
 = 1; i < 
¨gc
; i++) {

11 
	`¥ötf
("%s: ", 
¨gv
[
i
]);

12 i‡(
	`l°©
(
¨gv
[
i
], &
buf
) < 0) {

13 
	`îr_ªt
("lstatÉrror");

16 i‡(
	`S_ISREG
(
buf
.
°_mode
))

17 
±r
 = "regular";

18 i‡(
	`S_ISDIR
(
buf
.
°_mode
))

19 
±r
 = "directory";

20 i‡(
	`S_ISCHR
(
buf
.
°_mode
))

21 
±r
 = "character special";

22 i‡(
	`S_ISBLK
(
buf
.
°_mode
))

23 
±r
 = "block special";

24 i‡(
	`S_ISFIFO
(
buf
.
°_mode
))

25 
±r
 = "fifo";

26 i‡(
	`S_ISLNK
(
buf
.
°_mode
))

27 
±r
 = "symbolicÜink";

28 i‡(
	`S_ISSOCK
(
buf
.
°_mode
))

29 
±r
 = "socket";

31 
±r
 = "** unknown mode **";

32 
	`¥ötf
("%s\n", 
±r
);

34 
	`exô
(0);

35 
	}
}

	@filedir/ftw8.c

1 
	~"≠ue.h
"

2 
	~<dúít.h
>

3 
	~<limôs.h
>

6 
	tMyfunc
(c⁄° *, c⁄° 
	t°©
 *, );

8 
Myfunc
 
	gmyfunc
;

9 
my·w
(*, 
Myfunc
 *);

10 
d›©h
(
Myfunc
 *);

12 
	gƒeg
, 
	gndú
, 
	gnblk
, 
	gnchr
, 
	gnfifo
, 
	gn¶ök
, 
	gnsock
, 
	g¡Ÿ
;

15 
	$maö
(
¨gc
, *
¨gv
[])

17 
ªt
;

19 i‡(
¨gc
 != 2)

20 
	`îr_quô
("usage: ftw <starting-pathname>");

22 
ªt
 = 
	`my·w
(
¨gv
[1], 
myfunc
);

24 
¡Ÿ
 = 
ƒeg
 + 
ndú
 + 
nblk
 + 
nchr
 + 
nfifo
 + 
n¶ök
 + 
nsock
;

25 i‡(
¡Ÿ
 == 0)

26 
¡Ÿ
 = 1;

27 
	`¥ötf
("ªguœ∏fûe† = %7ld, %5.2‡%%\n", 
ƒeg
,

28 
ƒeg
*100.0/
¡Ÿ
);

29 
	`¥ötf
("dúe˘‹õ† = %7ld, %5.2‡%%\n", 
ndú
,

30 
ndú
*100.0/
¡Ÿ
);

31 
	`¥ötf
("block s≥cü» = %7ld, %5.2‡%%\n", 
nblk
,

32 
nblk
*100.0/
¡Ÿ
);

33 
	`¥ötf
("ch¨ s≥cü» = %7ld, %5.2‡%%\n", 
nchr
,

34 
nchr
*100.0/
¡Ÿ
);

35 
	`¥ötf
("FIFO† = %7ld, %5.2‡%%\n", 
nfifo
,

36 
nfifo
*100.0/
¡Ÿ
);

37 
	`¥ötf
("symbﬁi¯lök†%7ld, %5.2‡%%\n", 
n¶ök
,

38 
n¶ök
*100.0/
¡Ÿ
);

39 
	`¥ötf
("sockë† = %7ld, %5.2‡%%\n", 
nsock
,

40 
nsock
*100.0/
¡Ÿ
);

41 
	`exô
(
ªt
);

42 
	}
}

48 
	#FTW_F
 1

	)

49 
	#FTW_D
 2

	)

50 
	#FTW_DNR
 3

	)

51 
	#FTW_NS
 4

	)

53 *
	gfuŒ∑th
;

54 
size_t
 
	g∑thÀn
;

57 
	$my·w
(*
∑th«me
, 
Myfunc
 *
func
)

59 
fuŒ∑th
 = 
	`∑th_Æloc
(&
∑thÀn
);

61 i‡(
∑thÀn
 <
	`°æí
(
∑th«me
)) {

62 
∑thÀn
 = 
	`°æí
(
∑th«me
) * 2;

63 i‡((
fuŒ∑th
 = 
	`ªÆloc
(fuŒ∑th, 
∑thÀn
)Ë=
NULL
)

64 
	`îr_sys
("realloc failed");

66 
	`°r˝y
(
fuŒ∑th
, 
∑th«me
);

67 (
	`d›©h
(
func
));

68 
	}
}

77 
	$d›©h
(
Myfunc
* 
func
)

79 
°©
 
°©buf
;

80 
dúít
 *
dúp
;

81 
DIR
 *
dp
;

82 
ªt
, 
n
;

84 i‡(
	`l°©
(
fuŒ∑th
, &
°©buf
) < 0)

85 (
	`func
(
fuŒ∑th
, &
°©buf
, 
FTW_NS
));

86 i‡(
	`S_ISDIR
(
°©buf
.
°_mode
) == 0)

87 (
	`func
(
fuŒ∑th
, &
°©buf
, 
FTW_F
));

93 i‡((
ªt
 = 
	`func
(
fuŒ∑th
, &
°©buf
, 
FTW_D
)) != 0)

94 (
ªt
);

96 
n
 = 
	`°æí
(
fuŒ∑th
);

97 i‡(
n
 + 
NAME_MAX
 + 2 > 
∑thÀn
) {

98 
∑thÀn
 *= 2;

99 i‡((
fuŒ∑th
 = 
	`ªÆloc
(fuŒ∑th, 
∑thÀn
)Ë=
NULL
)

100 
	`îr_sys
("realloc failed");

102 
fuŒ∑th
[
n
++] = '/';

103 
fuŒ∑th
[
n
] = 0;

105 i‡((
dp
 = 
	`›ídú
(
fuŒ∑th
)Ë=
NULL
)

106 (
	`func
(
fuŒ∑th
, &
°©buf
, 
FTW_DNR
));

108 (
dúp
 = 
	`ªaddú
(
dp
)Ë!
NULL
) {

109 i‡(
	`°rcmp
(
dúp
->
d_«me
, ".") == 0 ||

110 
	`°rcmp
(
dúp
->
d_«me
, "..") == 0)

112 
	`°r˝y
(&
fuŒ∑th
[
n
], 
dúp
->
d_«me
);

113 i‡((
ªt
 = 
	`d›©h
(
func
)) != 0)

116 
fuŒ∑th
[
n
-1] = 0;

118 i‡(
	`˛o£dú
(
dp
) < 0)

119 
	`îr_ªt
("ˇn'à˛o£ dúe˘‹y %s", 
fuŒ∑th
);

120 (
ªt
);

121 
	}
}

124 
	$myfunc
(c⁄° *
∑th«me
, c⁄° 
°©
 *
°©±r
, 
ty≥
)

126 
ty≥
) {

127 
FTW_F
:

128 
°©±r
->
°_mode
 & 
S_IFMT
) {

129 
S_IFREG
: 
ƒeg
++; ;

130 
S_IFBLK
: 
nblk
++; ;

131 
S_IFCHR
: 
nchr
++; ;

132 
S_IFIFO
: 
nfifo
++; ;

133 
S_IFLNK
: 
n¶ök
++; ;

134 
S_IFSOCK
: 
nsock
++; ;

135 
S_IFDIR
:

136 
	`îr_dump
("f‹ S_IFDIR f‹ %s", 
∑th«me
);

139 
FTW_D
:

140 
ndú
++;

142 
FTW_DNR
:

143 
	`îr_ªt
("ˇn'àªad dúe˘‹y %s", 
∑th«me
);

145 
FTW_NS
:

146 
	`îr_ªt
("°©Éº‹ f‹ %s", 
∑th«me
);

149 
	`îr_dump
("unknow¿ty≥ %d f‹Ö©h«mê%s", 
ty≥
, 
∑th«me
);

152 
	}
}

	@filedir/mycd.c

1 
	~"≠ue.h
"

4 
	$maö
()

6 i‡(
	`chdú
("/tmp") < 0)

7 
	`îr_sys
("chdir failed");

8 
	`¥ötf
("chdirÅo /tmp succeeded\n");

9 
	`exô
(0);

10 
	}
}

	@filedir/umask.c

1 
	~"≠ue.h
"

2 
	~<f˙é.h
>

4 
	#RWRWRW
 (
S_IRUSR
|
S_IWUSR
|
S_IRGRP
|
S_IWGRP
|
S_IROTH
|
S_IWOTH
)

	)

7 
	$maö
()

9 
	`umask
(0);

10 i‡(
	`¸ót
("foo", 
RWRWRW
) < 0)

11 
	`îr_sys
("creatÉrror for foo");

12 
	`umask
(
S_IRGRP
 | 
S_IWGRP
 | 
S_IROTH
 | 
S_IWOTH
);

13 i‡(
	`¸ót
("b¨", 
RWRWRW
) < 0)

14 
	`îr_sys
("creatÉrror for bar");

15 
	`exô
(0);

16 
	}
}

	@filedir/unlink.c

1 
	~"≠ue.h
"

2 
	~<f˙é.h
>

5 
	$maö
()

7 i‡(
	`›í
("ãmpfûe", 
O_RDWR
) < 0)

8 
	`îr_sys
("openÉrror");

9 i‡(
	`u∆ök
("tempfile") < 0)

10 
	`îr_sys
("unlinkÉrror");

11 
	`¥ötf
("file unlinked\n");

12 
	`¶ìp
(15);

13 
	`¥ötf
("done\n");

14 
	`exô
(0);

15 
	}
}

	@filedir/zap.c

1 
	~"≠ue.h
"

2 
	~<f˙é.h
>

5 
	$maö
(
¨gc
, *
¨gv
[])

7 
i
, 
fd
;

8 
°©
 
°©buf
;

9 
time•ec
 
times
[2];

11 
i
 = 1; i < 
¨gc
; i++) {

12 i‡(
	`°©
(
¨gv
[
i
], &
°©buf
) < 0) {

13 
	`îr_ªt
("%s: sèàîr‹", 
¨gv
[
i
]);

16 i‡((
fd
 = 
	`›í
(
¨gv
[
i
], 
O_RDWR
 | 
O_TRUNC
)) < 0) {

17 
	`îr_ªt
("%s: o≥¿îr‹", 
¨gv
[
i
]);

20 
times
[0] = 
°©buf
.
°_©im
;

21 
times
[1] = 
°©buf
.
°_mtim
;

22 i‡(
	`futimís
(
fd
, 
times
) < 0)

23 
	`îr_ªt
("%s: futimí†îr‹", 
¨gv
[
i
]);

24 
	`˛o£
(
fd
);

26 
	`exô
(0);

27 
	}
}

	@fileio/fileflags.c

1 
	~"≠ue.h
"

2 
	~<f˙é.h
>

5 
	$maö
(
¨gc
, *
¨gv
[])

7 
vÆ
;

9 i‡(
¨gc
 != 2)

10 
	`îr_quô
("usage:á.out <descriptor#>");

12 i‡((
vÆ
 = 
	`f˙é
(
	`©oi
(
¨gv
[1]), 
F_GETFL
, 0)) < 0)

13 
	`îr_sys
("f˙éÉº‹ f‹ fd %d", 
	`©oi
(
¨gv
[1]));

15 
vÆ
 & 
O_ACCMODE
) {

16 
O_RDONLY
:

17 
	`¥ötf
("read only");

20 
O_WRONLY
:

21 
	`¥ötf
("write only");

24 
O_RDWR
:

25 
	`¥ötf
("read write");

29 
	`îr_dump
("unknownáccess mode");

32 i‡(
vÆ
 & 
O_APPEND
)

33 
	`¥ötf
(",áppend");

34 i‡(
vÆ
 & 
O_NONBLOCK
)

35 
	`¥ötf
(",Çonblocking");

36 i‡(
vÆ
 & 
O_SYNC
)

37 
	`¥ötf
(", synchronous writes");

39 #i‡!
	`deföed
(
_POSIX_C_SOURCE
Ë&& deföed(
O_FSYNC
Ë&& (O_FSYNC !
O_SYNC
)

40 i‡(
vÆ
 & 
O_FSYNC
)

41 
	`¥ötf
(", synchronous writes");

44 
	`putch¨
('\n');

45 
	`exô
(0);

46 
	}
}

	@fileio/hole.c

1 
	~"≠ue.h
"

2 
	~<f˙é.h
>

4 
	gbuf1
[] = "abcdefghij";

5 
	gbuf2
[] = "ABCDEFGHIJ";

8 
	$maö
()

10 
fd
;

12 i‡((
fd
 = 
	`¸ót
("fûe.hﬁe", 
FILE_MODE
)) < 0)

13 
	`îr_sys
("creatÉrror");

15 i‡(
	`wrôe
(
fd
, 
buf1
, 10) != 10)

16 
	`îr_sys
("buf1 writeÉrror");

19 i‡(
	`l£ek
(
fd
, 16384, 
SEEK_SET
) == -1)

20 
	`îr_sys
("lseekÉrror");

23 i‡(
	`wrôe
(
fd
, 
buf2
, 10) != 10)

24 
	`îr_sys
("buf2 writeÉrror");

27 
	`exô
(0);

28 
	}
}

	@fileio/mycat.c

1 
	~"≠ue.h
"

3 
	#BUFFSIZE
 4096

	)

6 
	$maö
()

8 
n
;

9 
buf
[
BUFFSIZE
];

11 (
n
 = 
	`ªad
(
STDIN_FILENO
, 
buf
, 
BUFFSIZE
)) > 0)

12 i‡(
	`wrôe
(
STDOUT_FILENO
, 
buf
, 
n
) !=Ç)

13 
	`îr_sys
("writeÉrror");

15 i‡(
n
 < 0)

16 
	`îr_sys
("readÉrror");

18 
	`exô
(0);

19 
	}
}

	@fileio/seek.c

1 
	~"≠ue.h
"

4 
	$maö
()

6 i‡(
	`l£ek
(
STDIN_FILENO
, 0, 
SEEK_CUR
) == -1)

7 
	`¥ötf
("cannot seek\n");

9 
	`¥ötf
("seek OK\n");

10 
	`exô
(0);

11 
	}
}

	@fileio/setfl.c

1 
	~"≠ue.h
"

2 
	~<f˙é.h
>

5 
	$£t_Ê
(
fd
, 
Êags
)

7 
vÆ
;

9 i‡((
vÆ
 = 
	`f˙é
(
fd
, 
F_GETFL
, 0)) < 0)

10 
	`îr_sys
("fcntl F_GETFLÉrror");

12 
vÆ
 |
Êags
;

14 i‡(
	`f˙é
(
fd
, 
F_SETFL
, 
vÆ
) < 0)

15 
	`îr_sys
("fcntl F_SETFLÉrror");

16 
	}
}

	@include/apue.h

4 #i‚def 
_APUE_H


5 
	#_APUE_H


	)

7 
	#_POSIX_C_SOURCE
 200809L

	)

9 #i‡
deföed
(
SOLARIS
)

10 
	#_XOPEN_SOURCE
 600

	)

12 
	#_XOPEN_SOURCE
 700

	)

15 
	~<sys/ty≥s.h
>

16 
	~<sys/°©.h
>

17 
	~<sys/ãrmios.h
>

18 #i‡
deföed
(
MACOS
Ë|| !deföed(
TIOCGWINSZ
)

19 
	~<sys/io˘l.h
>

22 
	~<°dio.h
>

23 
	~<°dlib.h
>

24 
	~<°ddef.h
>

25 
	~<°rög.h
>

26 
	~<uni°d.h
>

27 
	~<sig«l.h
>

29 
	#MAXLINE
 4096

	)

34 
	#FILE_MODE
 (
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IROTH
)

	)

39 
	#DIR_MODE
 (
FILE_MODE
 | 
S_IXUSR
 | 
S_IXGRP
 | 
S_IXOTH
)

	)

41 
	tSigfunc
();

43 
	#mö
(
a
,
b
Ë(◊Ë< (bË? (aË: (b))

	)

44 
	#max
(
a
,
b
Ë(◊Ë> (bË? (aË: (b))

	)

49 *
∑th_Æloc
(
size_t
 *);

50 
›í_max
();

52 
£t_˛€xec
();

53 
˛r_Ê
(, );

54 
£t_Ê
(, );

56 
¥_exô
();

58 
¥_mask
(const *);

59 
Sigfunc
 *
sig«l_öå
(, Sigfunc *);

61 
d´m⁄ize
(const *);

63 
¶ìp_us
();

64 
ssize_t
 
ªadn
(, *, 
size_t
);

65 
ssize_t
 
wrôí
(, c⁄° *, 
size_t
);

67 
fd_pùe
(*);

68 
ªcv_fd
(, 
	$ssize_t
 (*
func
)(,

69 c⁄° *, 
size_t
));

70 
	`£nd_fd
(, );

71 
	`£nd_îr
(, ,

73 
	`£rv_li°í
(const *);

74 
	`£rv_ac˚±
(, 
uid_t
 *);

75 
	`˛i_c⁄n
(const *);

76 
	`buf_¨gs
(*, (*
func
)(,

79 
	`ây_cbªak
();

80 
	`ây_øw
();

81 
	`ây_ª£t
();

82 
	`ây_©exô
();

83 
ãrmios
 *
	`ây_ãrmios
();

85 
	`±ym_›í
(*, );

86 
	`±ys_›í
(*);

87 #ifdef 
TIOCGWINSZ


88 
pid_t
 
	`±y_f‹k
(*, *, , c⁄° 
ãrmios
 *,

89 c⁄° 
wösize
 *);

92 
	`lock_ªg
(, , , 
off_t
, , off_t);

94 
	#ªad_lock
(
fd
, 
off£t
, 
whí˚
, 
Àn
) \

95 
	`lock_ªg
((
fd
), 
F_SETLK
, 
F_RDLCK
, (
off£t
), (
whí˚
), (
Àn
))

	)

96 
	#ªadw_lock
(
fd
, 
off£t
, 
whí˚
, 
Àn
) \

97 
	`lock_ªg
((
fd
), 
F_SETLKW
, 
F_RDLCK
, (
off£t
), (
whí˚
), (
Àn
))

	)

98 
	#wrôe_lock
(
fd
, 
off£t
, 
whí˚
, 
Àn
) \

99 
	`lock_ªg
((
fd
), 
F_SETLK
, 
F_WRLCK
, (
off£t
), (
whí˚
), (
Àn
))

	)

100 
	#wrôew_lock
(
fd
, 
off£t
, 
whí˚
, 
Àn
) \

101 
	`lock_ªg
((
fd
), 
F_SETLKW
, 
F_WRLCK
, (
off£t
), (
whí˚
), (
Àn
))

	)

102 
	#un_lock
(
fd
, 
off£t
, 
whí˚
, 
Àn
) \

103 
	`lock_ªg
((
fd
), 
F_SETLK
, 
F_UNLCK
, (
off£t
), (
whí˚
), (
Àn
))

	)

105 
pid_t
 
	`lock_ã°
(, , 
off_t
, , off_t);

107 
	#is_ªad_lockabÀ
(
fd
, 
off£t
, 
whí˚
, 
Àn
) \

108 (
	`lock_ã°
((
fd
), 
F_RDLCK
, (
off£t
), (
whí˚
), (
Àn
)Ë=0)

	)

109 
	#is_wrôe_lockabÀ
(
fd
, 
off£t
, 
whí˚
, 
Àn
) \

110 (
	`lock_ã°
((
fd
), 
F_WRLCK
, (
off£t
), (
whí˚
), (
Àn
)Ë=0)

	)

112 
	`îr_msg
(const *, ...);

113 
	$îr_dump
(c⁄° *, ...Ë
	`__©åibuã__
((
n‹ëu∫
));

114 
	$îr_quô
(c⁄° *, ...Ë
	`__©åibuã__
((
n‹ëu∫
));

115 
	`îr_c⁄t
(, const *, ...);

116 
	$îr_exô
(, c⁄° *, ...Ë
	`__©åibuã__
((
n‹ëu∫
));

117 
	`îr_ªt
(const *, ...);

118 
	$îr_sys
(c⁄° *, ...Ë
	`__©åibuã__
((
n‹ëu∫
));

120 
	`log_msg
(const *, ...);

121 
	`log_›í
(const *, , );

122 
	$log_quô
(c⁄° *, ...Ë
	`__©åibuã__
((
n‹ëu∫
));

123 
	`log_ªt
(const *, ...);

124 
	$log_sys
(c⁄° *, ...Ë
	`__©åibuã__
((
n‹ëu∫
));

125 
	$log_exô
(, c⁄° *, ...Ë
	`__©åibuã__
((
n‹ëu∫
));

127 
	`TELL_WAIT
();

128 
	`TELL_PARENT
(
pid_t
);

129 
	`TELL_CHILD
(
pid_t
);

130 
	`WAIT_PARENT
();

131 
	`WAIT_CHILD
();

	@intro/getcputc.c

1 
	~"≠ue.h
"

4 
	$maö
()

6 
c
;

8 (
c
 = 
	`gëc
(
°dö
)Ë!
EOF
)

9 i‡(
	`putc
(
c
, 
°dout
Ë=
EOF
)

10 
	`îr_sys
("outputÉrror");

12 i‡(
	`„º‹
(
°dö
))

13 
	`îr_sys
("inputÉrror");

15 
	`exô
(0);

16 
	}
}

	@intro/hello.c

1 
	~"≠ue.h
"

4 
	$maö
()

6 
	`¥ötf
("hñlÿw‹ld fromÖro˚s†ID %ld\n", ()
	`gëpid
());

7 
	`exô
(0);

8 
	}
}

	@intro/ls1.c

1 
	~"≠ue.h
"

2 
	~<dúít.h
>

5 
	$maö
(
¨gc
, *
¨gv
[])

7 
DIR
 *
dp
;

8 
dúít
 *
dúp
;

10 i‡(
¨gc
 != 2)

11 
	`îr_quô
("usage:Üs directory_name");

13 i‡((
dp
 = 
	`›ídú
(
¨gv
[1])Ë=
NULL
)

14 
	`îr_sys
("ˇn'à›í %s", 
¨gv
[1]);

15 (
dúp
 = 
	`ªaddú
(
dp
)Ë!
NULL
)

16 
	`¥ötf
("%s\n", 
dúp
->
d_«me
);

18 
	`˛o£dú
(
dp
);

19 
	`exô
(0);

20 
	}
}

	@intro/mycat.c

1 
	~"≠ue.h
"

3 
	#BUFFSIZE
 4096

	)

6 
	$maö
()

8 
n
;

9 
buf
[
BUFFSIZE
];

11 (
n
 = 
	`ªad
(
STDIN_FILENO
, 
buf
, 
BUFFSIZE
)) > 0)

12 i‡(
	`wrôe
(
STDOUT_FILENO
, 
buf
, 
n
) !=Ç)

13 
	`îr_sys
("writeÉrror");

15 i‡(
n
 < 0)

16 
	`îr_sys
("readÉrror");

18 
	`exô
(0);

19 
	}
}

	@intro/shell1.c

1 
	~"≠ue.h
"

2 
	~<sys/waô.h
>

5 
	$maö
()

7 
buf
[
MAXLINE
];

8 
pid_t
 
pid
;

9 
°©us
;

11 
	`¥ötf
("%% ");

12 
	`fgës
(
buf
, 
MAXLINE
, 
°dö
Ë!
NULL
) {

13 i‡(
buf
[
	`°æí
(buf) - 1] == '\n')

14 
buf
[
	`°æí
(buf) - 1] = 0;

16 i‡((
pid
 = 
	`f‹k
()) < 0) {

17 
	`îr_sys
("forkÉrror");

18 } i‡(
pid
 == 0) {

19 
	`exe˛p
(
buf
, buf, (*)0);

20 
	`îr_ªt
("couldn'àexecuã: %s", 
buf
);

21 
	`exô
(127);

25 i‡((
pid
 = 
	`waôpid
’id, &
°©us
, 0)) < 0)

26 
	`îr_sys
("waitpidÉrror");

27 
	`¥ötf
("%% ");

29 
	`exô
(0);

30 
	}
}

	@intro/shell2.c

1 
	~"≠ue.h
"

2 
	~<sys/waô.h
>

4 
sig_öt
();

7 
	$maö
()

9 
buf
[
MAXLINE
];

10 
pid_t
 
pid
;

11 
°©us
;

13 i‡(
	`sig«l
(
SIGINT
, 
sig_öt
Ë=
SIG_ERR
)

14 
	`îr_sys
("signalÉrror");

16 
	`¥ötf
("%% ");

17 
	`fgës
(
buf
, 
MAXLINE
, 
°dö
Ë!
NULL
) {

18 i‡(
buf
[
	`°æí
(buf) - 1] == '\n')

19 
buf
[
	`°æí
(buf) - 1] = 0;

21 i‡((
pid
 = 
	`f‹k
()) < 0) {

22 
	`îr_sys
("forkÉrror");

23 } i‡(
pid
 == 0) {

24 
	`exe˛p
(
buf
, buf, (*)0);

25 
	`îr_ªt
("couldn'àexecuã: %s", 
buf
);

26 
	`exô
(127);

30 i‡((
pid
 = 
	`waôpid
’id, &
°©us
, 0)) < 0)

31 
	`îr_sys
("waitpidÉrror");

32 
	`¥ötf
("%% ");

34 
	`exô
(0);

35 
	}
}

38 
	$sig_öt
(
signo
)

40 
	`¥ötf
("interrupt\n%% ");

41 
	}
}

	@intro/testerror.c

1 
	~"≠ue.h
"

2 
	~<î∫o.h
>

5 
	$maö
(
¨gc
, *
¨gv
[])

7 
	`Ârötf
(
°dîr
, "EACCES: %s\n", 
	`°ªº‹
(
EACCES
));

8 
î∫o
 = 
ENOENT
;

9 
	`≥º‹
(
¨gv
[0]);

10 
	`exô
(0);

11 
	}
}

	@intro/uidgid.c

1 
	~"≠ue.h
"

4 
	$maö
()

6 
	`¥ötf
("uid = %d, gid = %d\n", 
	`gëuid
(), 
	`gëgid
());

7 
	`exô
(0);

8 
	}
}

	@ipc1/add2.c

1 
	~"≠ue.h
"

4 
	$maö
()

6 
n
, 
öt1
, 
öt2
;

7 
löe
[
MAXLINE
];

9 (
n
 = 
	`ªad
(
STDIN_FILENO
, 
löe
, 
MAXLINE
)) > 0) {

10 
löe
[
n
] = 0;

11 i‡(
	`ssˇnf
(
löe
, "%d%d", &
öt1
, &
öt2
) == 2) {

12 
	`•rötf
(
löe
, "%d\n", 
öt1
 + 
öt2
);

13 
n
 = 
	`°æí
(
löe
);

14 i‡(
	`wrôe
(
STDOUT_FILENO
, 
löe
, 
n
) !=Ç)

15 
	`îr_sys
("writeÉrror");

17 i‡(
	`wrôe
(
STDOUT_FILENO
, "invalidárgs\n", 13) != 13)

18 
	`îr_sys
("writeÉrror");

21 
	`exô
(0);

22 
	}
}

	@ipc1/add2stdio.c

1 
	~"≠ue.h
"

4 
	$maö
()

6 
öt1
, 
öt2
;

7 
löe
[
MAXLINE
];

9 
	`fgës
(
löe
, 
MAXLINE
, 
°dö
Ë!
NULL
) {

10 i‡(
	`ssˇnf
(
löe
, "%d%d", &
öt1
, &
öt2
) == 2) {

11 i‡(
	`¥ötf
("%d\n", 
öt1
 + 
öt2
Ë=
EOF
)

12 
	`îr_sys
("printfÉrror");

14 i‡(
	`¥ötf
("övÆidárgs\n"Ë=
EOF
)

15 
	`îr_sys
("printfÉrror");

18 
	`exô
(0);

19 
	}
}

	@ipc1/devzero.c

1 
	~"≠ue.h
"

2 
	~<f˙é.h
>

3 
	~<sys/mm™.h
>

5 
	#NLOOPS
 1000

	)

6 
	#SIZE
 (Ë

	)

9 
	$upd©e
(*
±r
)

11 ((*
±r
)++);

12 
	}
}

15 
	$maö
()

17 
fd
, 
i
, 
cou¡î
;

18 
pid_t
 
pid
;

19 *
¨ó
;

21 i‡((
fd
 = 
	`›í
("/dev/zîo", 
O_RDWR
)) < 0)

22 
	`îr_sys
("openÉrror");

23 i‡((
¨ó
 = 
	`mm≠
(0, 
SIZE
, 
PROT_READ
 | 
PROT_WRITE
, 
MAP_SHARED
,

24 
fd
, 0)Ë=
MAP_FAILED
)

25 
	`îr_sys
("mmapÉrror");

26 
	`˛o£
(
fd
);

28 
	`TELL_WAIT
();

30 i‡((
pid
 = 
	`f‹k
()) < 0) {

31 
	`îr_sys
("forkÉrror");

32 } i‡(
pid
 > 0) {

33 
i
 = 0; i < 
NLOOPS
; i += 2) {

34 i‡((
cou¡î
 = 
	`upd©e
((*)
¨ó
)Ë!
i
)

35 
	`îr_quô
("∑ª¡:Éx≥˘ed %d, gŸ %d", 
i
, 
cou¡î
);

37 
	`TELL_CHILD
(
pid
);

38 
	`WAIT_CHILD
();

41 
i
 = 1; i < 
NLOOPS
 + 1; i += 2) {

42 
	`WAIT_PARENT
();

44 i‡((
cou¡î
 = 
	`upd©e
((*)
¨ó
)Ë!
i
)

45 
	`îr_quô
("chûd:Éx≥˘ed %d, gŸ %d", 
i
, 
cou¡î
);

47 
	`TELL_PARENT
(
	`gëµid
());

51 
	`exô
(0);

52 
	}
}

	@ipc1/myuclc.c

1 
	~"≠ue.h
"

2 
	~<˘y≥.h
>

5 
	$maö
()

7 
c
;

9 (
c
 = 
	`gëch¨
()Ë!
EOF
) {

10 i‡(
	`isuµî
(
c
))

11 
c
 = 
	`tﬁowî
(c);

12 i‡(
	`putch¨
(
c
Ë=
EOF
)

13 
	`îr_sys
("outputÉrror");

14 i‡(
c
 == '\n')

15 
	`fÊush
(
°dout
);

17 
	`exô
(0);

18 
	}
}

	@ipc1/pipe1.c

1 
	~"≠ue.h
"

4 
	$maö
()

6 
n
;

7 
fd
[2];

8 
pid_t
 
pid
;

9 
löe
[
MAXLINE
];

11 i‡(
	`pùe
(
fd
) < 0)

12 
	`îr_sys
("pipeÉrror");

13 i‡((
pid
 = 
	`f‹k
()) < 0) {

14 
	`îr_sys
("forkÉrror");

15 } i‡(
pid
 > 0) {

16 
	`˛o£
(
fd
[0]);

17 
	`wrôe
(
fd
[1], "hello world\n", 12);

19 
	`˛o£
(
fd
[1]);

20 
n
 = 
	`ªad
(
fd
[0], 
löe
, 
MAXLINE
);

21 
	`wrôe
(
STDOUT_FILENO
, 
löe
, 
n
);

23 
	`exô
(0);

24 
	}
}

	@ipc1/pipe2.c

1 
	~"≠ue.h
"

2 
	~<sys/waô.h
>

4 
	#DEF_PAGER
 "/bö/m‹e"

	)

7 
	$maö
(
¨gc
, *
¨gv
[])

9 
n
;

10 
fd
[2];

11 
pid_t
 
pid
;

12 *
∑gî
, *
¨gv0
;

13 
löe
[
MAXLINE
];

14 
FILE
 *
Â
;

16 i‡(
¨gc
 != 2)

17 
	`îr_quô
("usage:á.out <pathname>");

19 i‡((
Â
 = 
	`f›í
(
¨gv
[1], "r")Ë=
NULL
)

20 
	`îr_sys
("ˇn'à›í %s", 
¨gv
[1]);

21 i‡(
	`pùe
(
fd
) < 0)

22 
	`îr_sys
("pipeÉrror");

24 i‡((
pid
 = 
	`f‹k
()) < 0) {

25 
	`îr_sys
("forkÉrror");

26 } i‡(
pid
 > 0) {

27 
	`˛o£
(
fd
[0]);

30 
	`fgës
(
löe
, 
MAXLINE
, 
Â
Ë!
NULL
) {

31 
n
 = 
	`°æí
(
löe
);

32 i‡(
	`wrôe
(
fd
[1], 
löe
, 
n
) !=Ç)

33 
	`îr_sys
("writeÉrrorÅoÖipe");

35 i‡(
	`„º‹
(
Â
))

36 
	`îr_sys
("fgetsÉrror");

38 
	`˛o£
(
fd
[1]);

40 i‡(
	`waôpid
(
pid
, 
NULL
, 0) < 0)

41 
	`îr_sys
("waitpidÉrror");

42 
	`exô
(0);

44 
	`˛o£
(
fd
[1]);

45 i‡(
fd
[0] !
STDIN_FILENO
) {

46 i‡(
	`dup2
(
fd
[0], 
STDIN_FILENO
) != STDIN_FILENO)

47 
	`îr_sys
("dup2ÉrrorÅo stdin");

48 
	`˛o£
(
fd
[0]);

52 i‡((
∑gî
 = 
	`gëív
("PAGER")Ë=
NULL
)

53 
∑gî
 = 
DEF_PAGER
;

54 i‡((
¨gv0
 = 
	`°ºchr
(
∑gî
, '/')Ë!
NULL
)

55 
¨gv0
++;

57 
¨gv0
 = 
∑gî
;

59 i‡(
	`exe˛
(
∑gî
, 
¨gv0
, (*)0) < 0)

60 
	`îr_sys
("exe˛Éº‹ f‹ %s", 
∑gî
);

62 
	`exô
(0);

63 
	}
}

	@ipc1/pipe4.c

1 
	~"≠ue.h
"

3 
sig_pùe
();

6 
	$maö
()

8 
n
, 
fd1
[2], 
fd2
[2];

9 
pid_t
 
pid
;

10 
löe
[
MAXLINE
];

12 i‡(
	`sig«l
(
SIGPIPE
, 
sig_pùe
Ë=
SIG_ERR
)

13 
	`îr_sys
("signalÉrror");

15 i‡(
	`pùe
(
fd1
Ë< 0 ||Öùe(
fd2
) < 0)

16 
	`îr_sys
("pipeÉrror");

18 i‡((
pid
 = 
	`f‹k
()) < 0) {

19 
	`îr_sys
("forkÉrror");

20 } i‡(
pid
 > 0) {

21 
	`˛o£
(
fd1
[0]);

22 
	`˛o£
(
fd2
[1]);

24 
	`fgës
(
löe
, 
MAXLINE
, 
°dö
Ë!
NULL
) {

25 
n
 = 
	`°æí
(
löe
);

26 i‡(
	`wrôe
(
fd1
[1], 
löe
, 
n
) !=Ç)

27 
	`îr_sys
("writeÉrrorÅoÖipe");

28 i‡((
n
 = 
	`ªad
(
fd2
[0], 
löe
, 
MAXLINE
)) < 0)

29 
	`îr_sys
("readÉrror fromÖipe");

30 i‡(
n
 == 0) {

31 
	`îr_msg
("child closedÖipe");

34 
löe
[
n
] = 0;

35 i‡(
	`Âuts
(
löe
, 
°dout
Ë=
EOF
)

36 
	`îr_sys
("fputsÉrror");

39 i‡(
	`„º‹
(
°dö
))

40 
	`îr_sys
("fgetsÉrror on stdin");

41 
	`exô
(0);

43 
	`˛o£
(
fd1
[1]);

44 
	`˛o£
(
fd2
[0]);

45 i‡(
fd1
[0] !
STDIN_FILENO
) {

46 i‡(
	`dup2
(
fd1
[0], 
STDIN_FILENO
) != STDIN_FILENO)

47 
	`îr_sys
("dup2ÉrrorÅo stdin");

48 
	`˛o£
(
fd1
[0]);

51 i‡(
fd2
[1] !
STDOUT_FILENO
) {

52 i‡(
	`dup2
(
fd2
[1], 
STDOUT_FILENO
) != STDOUT_FILENO)

53 
	`îr_sys
("dup2ÉrrorÅo stdout");

54 
	`˛o£
(
fd2
[1]);

56 i‡(
	`exe˛
("./add2", "add2", (*)0) < 0)

57 
	`îr_sys
("execlÉrror");

59 
	`exô
(0);

60 
	}
}

63 
	$sig_pùe
(
signo
)

65 
	`¥ötf
("SIGPIPE caught\n");

66 
	`exô
(1);

67 
	}
}

	@ipc1/popen.c

1 
	~"≠ue.h
"

2 
	~<î∫o.h
>

3 
	~<f˙é.h
>

4 
	~<sys/waô.h
>

9 
pid_t
 *
	gchûdpid
 = 
NULL
;

14 
	gmaxfd
;

16 
FILE
 *

17 
	$p›í
(c⁄° *
cmd°rög
, c⁄° *
ty≥
)

19 
i
;

20 
pfd
[2];

21 
pid_t
 
pid
;

22 
FILE
 *
Â
;

25 i‡((
ty≥
[0] != 'r' &&Åype[0] != 'w') ||Åype[1] != 0) {

26 
î∫o
 = 
EINVAL
;

27 (
NULL
);

30 i‡(
chûdpid
 =
NULL
) {

32 
maxfd
 = 
	`›í_max
();

33 i‡((
chûdpid
 = 
	`ˇŒoc
(
maxfd
, (
pid_t
))Ë=
NULL
)

34 (
NULL
);

37 i‡(
	`pùe
(
pfd
) < 0)

38 (
NULL
);

39 i‡(
pfd
[0] >
maxfd
 ||Öfd[1] >= maxfd) {

40 
	`˛o£
(
pfd
[0]);

41 
	`˛o£
(
pfd
[1]);

42 
î∫o
 = 
EMFILE
;

43 (
NULL
);

46 i‡((
pid
 = 
	`f‹k
()) < 0) {

47 (
NULL
);

48 } i‡(
pid
 == 0) {

49 i‡(*
ty≥
 == 'r') {

50 
	`˛o£
(
pfd
[0]);

51 i‡(
pfd
[1] !
STDOUT_FILENO
) {

52 
	`dup2
(
pfd
[1], 
STDOUT_FILENO
);

53 
	`˛o£
(
pfd
[1]);

56 
	`˛o£
(
pfd
[1]);

57 i‡(
pfd
[0] !
STDIN_FILENO
) {

58 
	`dup2
(
pfd
[0], 
STDIN_FILENO
);

59 
	`˛o£
(
pfd
[0]);

64 
i
 = 0; i < 
maxfd
; i++)

65 i‡(
chûdpid
[
i
] > 0)

66 
	`˛o£
(
i
);

68 
	`exe˛
("/bö/sh", "sh", "-c", 
cmd°rög
, (*)0);

69 
	`_exô
(127);

73 i‡(*
ty≥
 == 'r') {

74 
	`˛o£
(
pfd
[1]);

75 i‡((
Â
 = 
	`fd›í
(
pfd
[0], 
ty≥
)Ë=
NULL
)

76 (
NULL
);

78 
	`˛o£
(
pfd
[0]);

79 i‡((
Â
 = 
	`fd›í
(
pfd
[1], 
ty≥
)Ë=
NULL
)

80 (
NULL
);

83 
chûdpid
[
	`fûío
(
Â
)] = 
pid
;

84 (
Â
);

85 
	}
}

88 
	$p˛o£
(
FILE
 *
Â
)

90 
fd
, 
°©
;

91 
pid_t
 
pid
;

93 i‡(
chûdpid
 =
NULL
) {

94 
î∫o
 = 
EINVAL
;

98 
fd
 = 
	`fûío
(
Â
);

99 i‡(
fd
 >
maxfd
) {

100 
î∫o
 = 
EINVAL
;

103 i‡((
pid
 = 
chûdpid
[
fd
]) == 0) {

104 
î∫o
 = 
EINVAL
;

108 
chûdpid
[
fd
] = 0;

109 i‡(
	`f˛o£
(
Â
Ë=
EOF
)

112 
	`waôpid
(
pid
, &
°©
, 0) < 0)

113 i‡(
î∫o
 !
EINTR
)

116 (
°©
);

117 
	}
}

	@ipc1/popen1.c

1 
	~"≠ue.h
"

2 
	~<sys/waô.h
>

5 
	$maö
()

7 
löe
[
MAXLINE
];

8 
FILE
 *
Âö
;

10 i‡((
Âö
 = 
	`p›í
("myu˛c", "r")Ë=
NULL
)

11 
	`îr_sys
("popenÉrror");

13 
	`Âuts
("¥om±> ", 
°dout
);

14 
	`fÊush
(
°dout
);

15 i‡(
	`fgës
(
löe
, 
MAXLINE
, 
Âö
Ë=
NULL
)

17 i‡(
	`Âuts
(
löe
, 
°dout
Ë=
EOF
)

18 
	`îr_sys
("fputsÉrrorÅoÖipe");

20 i‡(
	`p˛o£
(
Âö
) == -1)

21 
	`îr_sys
("pcloseÉrror");

22 
	`putch¨
('\n');

23 
	`exô
(0);

24 
	}
}

	@ipc1/popen2.c

1 
	~"≠ue.h
"

2 
	~<sys/waô.h
>

4 
	#PAGER
 "${PAGER:-m‹e}"

	)

7 
	$maö
(
¨gc
, *
¨gv
[])

9 
löe
[
MAXLINE
];

10 
FILE
 *
Âö
, *
Âout
;

12 i‡(
¨gc
 != 2)

13 
	`îr_quô
("usage:á.out <pathname>");

14 i‡((
Âö
 = 
	`f›í
(
¨gv
[1], "r")Ë=
NULL
)

15 
	`îr_sys
("ˇn'à›í %s", 
¨gv
[1]);

17 i‡((
Âout
 = 
	`p›í
(
PAGER
, "w")Ë=
NULL
)

18 
	`îr_sys
("popenÉrror");

21 
	`fgës
(
löe
, 
MAXLINE
, 
Âö
Ë!
NULL
) {

22 i‡(
	`Âuts
(
löe
, 
Âout
Ë=
EOF
)

23 
	`îr_sys
("fputsÉrrorÅoÖipe");

25 i‡(
	`„º‹
(
Âö
))

26 
	`îr_sys
("fgetsÉrror");

27 i‡(
	`p˛o£
(
Âout
) == -1)

28 
	`îr_sys
("pcloseÉrror");

30 
	`exô
(0);

31 
	}
}

	@ipc1/slock.c

1 
	~"¶ock.h
"

2 
	~<°dlib.h
>

3 
	~<°dio.h
>

4 
	~<uni°d.h
>

5 
	~<î∫o.h
>

7 
¶ock
 *

8 
	$s_Æloc
()

10 
¶ock
 *
•
;

11 
˙t
;

13 i‡((
•
 = 
	`mÆloc
((
¶ock
))Ë=
NULL
)

14 (
NULL
);

16 
	`¢¥ötf
(
•
->
«me
, (•->«me), "/%ld.%d", ()
	`gëpid
(),

17 
˙t
++);

18 
•
->
£mp
 = 
	`£m_›í
(•->
«me
, 
O_CREAT
|
O_EXCL
, 
S_IRWXU
, 1);

19 } (
•
->
£mp
 =
SEM_FAILED
Ë&& (
î∫o
 =
EEXIST
));

20 i‡(
•
->
£mp
 =
SEM_FAILED
) {

21 
	`‰ì
(
•
);

22 (
NULL
);

24 
	`£m_u∆ök
(
•
->
«me
);

25 (
•
);

26 
	}
}

29 
	$s_‰ì
(
¶ock
 *
•
)

31 
	`£m_˛o£
(
•
->
£mp
);

32 
	`‰ì
(
•
);

33 
	}
}

36 
	$s_lock
(
¶ock
 *
•
)

38 (
	`£m_waô
(
•
->
£mp
));

39 
	}
}

42 
	$s_åylock
(
¶ock
 *
•
)

44 (
	`£m_åywaô
(
•
->
£mp
));

45 
	}
}

48 
	$s_u∆ock
(
¶ock
 *
•
)

50 (
	`£m_po°
(
•
->
£mp
));

51 
	}
}

	@ipc1/slock.h

1 
	~<£m≠h‹e.h
>

2 
	~<f˙é.h
>

3 
	~<limôs.h
>

4 
	~<sys/°©.h
>

6 
	s¶ock
 {

7 
£m_t
 *
	m£mp
;

8 
	m«me
[
_POSIX_NAME_MAX
];

11 
¶ock
 * 
s_Æloc
();

12 
s_‰ì
(
¶ock
 *);

13 
s_lock
(
¶ock
 *);

14 
s_åylock
(
¶ock
 *);

15 
s_u∆ock
(
¶ock
 *);

	@ipc1/tellwait.c

1 
	~"≠ue.h
"

3 
	gpfd1
[2], 
	gpfd2
[2];

6 
	$TELL_WAIT
()

8 i‡(
	`pùe
(
pfd1
Ë< 0 ||Öùe(
pfd2
) < 0)

9 
	`îr_sys
("pipeÉrror");

10 
	}
}

13 
	$TELL_PARENT
(
pid_t
 
pid
)

15 i‡(
	`wrôe
(
pfd2
[1], "c", 1) != 1)

16 
	`îr_sys
("writeÉrror");

17 
	}
}

20 
	$WAIT_PARENT
()

22 
c
;

24 i‡(
	`ªad
(
pfd1
[0], &
c
, 1) != 1)

25 
	`îr_sys
("readÉrror");

27 i‡(
c
 != 'p')

28 
	`îr_quô
("WAIT_PARENT: incorrect data");

29 
	}
}

32 
	$TELL_CHILD
(
pid_t
 
pid
)

34 i‡(
	`wrôe
(
pfd1
[1], "p", 1) != 1)

35 
	`îr_sys
("writeÉrror");

36 
	}
}

39 
	$WAIT_CHILD
()

41 
c
;

43 i‡(
	`ªad
(
pfd2
[0], &
c
, 1) != 1)

44 
	`îr_sys
("readÉrror");

46 i‡(
c
 != 'c')

47 
	`îr_quô
("WAIT_CHILD: incorrect data");

48 
	}
}

	@ipc1/tshm.c

1 
	~"≠ue.h
"

2 
	~<sys/shm.h
>

4 
	#ARRAY_SIZE
 40000

	)

5 
	#MALLOC_SIZE
 100000

	)

6 
	#SHM_SIZE
 100000

	)

7 
	#SHM_MODE
 0600

	)

9 
	g¨øy
[
ARRAY_SIZE
];

12 
	$maö
()

14 
shmid
;

15 *
±r
, *
shm±r
;

17 
	`¥ötf
("¨øy[] from %∞tÿ%p\n", (*)&
¨øy
[0],

18 (*)&
¨øy
[
ARRAY_SIZE
]);

19 
	`¥ötf
("°ackáround %p\n", (*)&
shmid
);

21 i‡((
±r
 = 
	`mÆloc
(
MALLOC_SIZE
)Ë=
NULL
)

22 
	`îr_sys
("mallocÉrror");

23 
	`¥ötf
("mÆlo˚d from %∞tÿ%p\n", (*)
±r
,

24 (*)
±r
+
MALLOC_SIZE
);

26 i‡((
shmid
 = 
	`shmgë
(
IPC_PRIVATE
, 
SHM_SIZE
, 
SHM_MODE
)) < 0)

27 
	`îr_sys
("shmgetÉrror");

28 i‡((
shm±r
 = 
	`shm©
(
shmid
, 0, 0)) == (*)-1)

29 
	`îr_sys
("shmatÉrror");

30 
	`¥ötf
("sh¨ed mem‹yáâached from %∞tÿ%p\n", (*)
shm±r
,

31 (*)
shm±r
+
SHM_SIZE
);

33 i‡(
	`shm˘l
(
shmid
, 
IPC_RMID
, 0) < 0)

34 
	`îr_sys
("shmctlÉrror");

36 
	`exô
(0);

37 
	}
}

	@ipc2/bindunix.c

1 
	~"≠ue.h
"

2 
	~<sys/sockë.h
>

3 
	~<sys/un.h
>

6 
	$maö
()

8 
fd
, 
size
;

9 
sockaddr_un
 
un
;

11 
un
.
sun_Ámûy
 = 
AF_UNIX
;

12 
	`°r˝y
(
un
.
sun_∑th
, "foo.socket");

13 i‡((
fd
 = 
	`sockë
(
AF_UNIX
, 
SOCK_STREAM
, 0)) < 0)

14 
	`îr_sys
("socket failed");

15 
size
 = 
	`off£tof
(
sockaddr_un
, 
sun_∑th
Ë+ 
	`°æí
(
un
.sun_path);

16 i‡(
	`böd
(
fd
, (
sockaddr
 *)&
un
, 
size
) < 0)

17 
	`îr_sys
("bind failed");

18 
	`¥ötf
("UNIX domain socket bound\n");

19 
	`exô
(0);

20 
	}
}

	@ipc2/open.fe/main.c

1 
	~"›í.h
"

2 
	~<f˙é.h
>

4 
	#BUFFSIZE
 8192

	)

7 
	$maö
(
¨gc
, *
¨gv
[])

9 
n
, 
fd
;

10 
buf
[
BUFFSIZE
];

11 
löe
[
MAXLINE
];

14 
	`fgës
(
löe
, 
MAXLINE
, 
°dö
Ë!
NULL
) {

15 i‡(
löe
[
	`°æí
(line) - 1] == '\n')

16 
löe
[
	`°æí
(line) - 1] = 0;

19 i‡((
fd
 = 
	`cs›í
(
löe
, 
O_RDONLY
)) < 0)

23 (
n
 = 
	`ªad
(
fd
, 
buf
, 
BUFFSIZE
)) > 0)

24 i‡(
	`wrôe
(
STDOUT_FILENO
, 
buf
, 
n
) !=Ç)

25 
	`îr_sys
("writeÉrror");

26 i‡(
n
 < 0)

27 
	`îr_sys
("readÉrror");

28 
	`˛o£
(
fd
);

31 
	`exô
(0);

32 
	}
}

	@ipc2/open.fe/open.c

1 
	~"›í.h
"

2 
	~<sys/uio.h
>

9 
	$cs›í
(*
«me
, 
oÊag
)

11 
pid_t
 
pid
;

12 
Àn
;

13 
buf
[10];

14 
iovec
 
iov
[3];

15 
fd
[2] = { -1, -1 };

17 i‡(
fd
[0] < 0) {

18 i‡(
	`fd_pùe
(
fd
) < 0) {

19 
	`îr_ªt
("fd_pipeÉrror");

22 i‡((
pid
 = 
	`f‹k
()) < 0) {

23 
	`îr_ªt
("forkÉrror");

25 } i‡(
pid
 == 0) {

26 
	`˛o£
(
fd
[0]);

27 i‡(
fd
[1] !
STDIN_FILENO
 &&

28 
	`dup2
(
fd
[1], 
STDIN_FILENO
) != STDIN_FILENO)

29 
	`îr_sys
("dup2ÉrrorÅo stdin");

30 i‡(
fd
[1] !
STDOUT_FILENO
 &&

31 
	`dup2
(
fd
[1], 
STDOUT_FILENO
) != STDOUT_FILENO)

32 
	`îr_sys
("dup2ÉrrorÅo stdout");

33 i‡(
	`exe˛
("./opend", "opend", (*)0) < 0)

34 
	`îr_sys
("execlÉrror");

36 
	`˛o£
(
fd
[1]);

38 
	`•rötf
(
buf
, " %d", 
oÊag
);

39 
iov
[0].
iov_ba£
 = 
CL_OPEN
 " ";

40 
iov
[0].
iov_Àn
 = 
	`°æí
(
CL_OPEN
) + 1;

41 
iov
[1].
iov_ba£
 = 
«me
;

42 
iov
[1].
iov_Àn
 = 
	`°æí
(
«me
);

43 
iov
[2].
iov_ba£
 = 
buf
;

44 
iov
[2].
iov_Àn
 = 
	`°æí
(
buf
) + 1;

45 
Àn
 = 
iov
[0].
iov_Àn
 + iov[1].iov_len + iov[2].iov_len;

46 i‡(
	`wrôev
(
fd
[0], &
iov
[0], 3Ë!
Àn
) {

47 
	`îr_ªt
("writevÉrror");

52 (
	`ªcv_fd
(
fd
[0], 
wrôe
));

53 
	}
}

	@ipc2/open.fe/open.h

1 
	~"≠ue.h
"

2 
	~<î∫o.h
>

4 
	#CL_OPEN
 "›í"

	)

6 
cs›í
(*, );

	@ipc2/open/main.c

1 
	~"›í.h
"

2 
	~<f˙é.h
>

4 
	#BUFFSIZE
 8192

	)

7 
	$maö
(
¨gc
, *
¨gv
[])

9 
n
, 
fd
;

10 
buf
[
BUFFSIZE
], 
löe
[
MAXLINE
];

13 
	`fgës
(
löe
, 
MAXLINE
, 
°dö
Ë!
NULL
) {

14 i‡(
löe
[
	`°æí
(line) - 1] == '\n')

15 
löe
[
	`°æí
(line) - 1] = 0;

18 i‡((
fd
 = 
	`cs›í
(
löe
, 
O_RDONLY
)) < 0)

22 (
n
 = 
	`ªad
(
fd
, 
buf
, 
BUFFSIZE
)) > 0)

23 i‡(
	`wrôe
(
STDOUT_FILENO
, 
buf
, 
n
) !=Ç)

24 
	`îr_sys
("writeÉrror");

25 i‡(
n
 < 0)

26 
	`îr_sys
("readÉrror");

27 
	`˛o£
(
fd
);

30 
	`exô
(0);

31 
	}
}

	@ipc2/open/open.c

1 
	~"›í.h
"

2 
	~<sys/uio.h
>

9 
	$cs›í
(*
«me
, 
oÊag
)

11 
Àn
;

12 
buf
[12];

13 
iovec
 
iov
[3];

14 
csfd
 = -1;

16 i‡(
csfd
 < 0) {

17 i‡((
csfd
 = 
	`˛i_c⁄n
(
CS_OPEN
)) < 0) {

18 
	`îr_ªt
("cli_connÉrror");

23 
	`•rötf
(
buf
, " %d", 
oÊag
);

24 
iov
[0].
iov_ba£
 = 
CL_OPEN
 " ";

25 
iov
[0].
iov_Àn
 = 
	`°æí
(
CL_OPEN
) + 1;

26 
iov
[1].
iov_ba£
 = 
«me
;

27 
iov
[1].
iov_Àn
 = 
	`°æí
(
«me
);

28 
iov
[2].
iov_ba£
 = 
buf
;

29 
iov
[2].
iov_Àn
 = 
	`°æí
(
buf
) + 1;

30 
Àn
 = 
iov
[0].
iov_Àn
 + iov[1].iov_len + iov[2].iov_len;

31 i‡(
	`wrôev
(
csfd
, &
iov
[0], 3Ë!
Àn
) {

32 
	`îr_ªt
("writevÉrror");

37 (
	`ªcv_fd
(
csfd
, 
wrôe
));

38 
	}
}

	@ipc2/open/open.h

1 
	~"≠ue.h
"

2 
	~<î∫o.h
>

4 
	#CL_OPEN
 "›í"

	)

5 
	#CS_OPEN
 "/tmp/›íd.sockë"

	)

7 
cs›í
(*, );

	@ipc2/opend.fe/cliargs.c

1 
	~"›íd.h
"

9 
	$˛i_¨gs
(
¨gc
, **
¨gv
)

11 i‡(
¨gc
 !3 || 
	`°rcmp
(
¨gv
[0], 
CL_OPEN
) != 0) {

12 
	`°r˝y
(
îrmsg
, "usage: <pathname> <oflag>\n");

15 
∑th«me
 = 
¨gv
[1];

16 
oÊag
 = 
	`©oi
(
¨gv
[2]);

18 
	}
}

	@ipc2/opend.fe/main.c

1 
	~"›íd.h
"

3 
	gîrmsg
[
MAXLINE
];

4 
	goÊag
;

5 *
	g∑th«me
;

8 
	$maö
()

10 
ƒód
;

11 
buf
[
MAXLINE
];

14 i‡((
ƒód
 = 
	`ªad
(
STDIN_FILENO
, 
buf
, 
MAXLINE
)) < 0)

15 
	`îr_sys
("readÉrror on streamÖipe");

16 i‡(
ƒód
 == 0)

18 
	`h™dÀ_ªque°
(
buf
, 
ƒód
, 
STDOUT_FILENO
);

20 
	`exô
(0);

21 
	}
}

	@ipc2/opend.fe/opend.h

1 
	~"≠ue.h
"

2 
	~<î∫o.h
>

4 
	#CL_OPEN
 "›í"

	)

6 
îrmsg
[];

7 
oÊag
;

8 *
∑th«me
;

10 
˛i_¨gs
(, **);

11 
h™dÀ_ªque°
(*, , );

	@ipc2/opend.fe/request.c

1 
	~"›íd.h
"

2 
	~<f˙é.h
>

5 
	$h™dÀ_ªque°
(*
buf
, 
ƒód
, 
fd
)

7 
√wfd
;

9 i‡(
buf
[
ƒód
-1] != 0) {

10 
	`¢¥ötf
(
îrmsg
, 
MAXLINE
-1,

11 "ªque°ÇŸÇuŒÅîmö©ed: %*.*s\n", 
ƒód
,Çªad, 
buf
);

12 
	`£nd_îr
(
fd
, -1, 
îrmsg
);

15 i‡(
	`buf_¨gs
(
buf
, 
˛i_¨gs
) < 0) {

16 
	`£nd_îr
(
fd
, -1, 
îrmsg
);

19 i‡((
√wfd
 = 
	`›í
(
∑th«me
, 
oÊag
)) < 0) {

20 
	`¢¥ötf
(
îrmsg
, 
MAXLINE
-1, "ˇn'à›í %s: %s\n", 
∑th«me
,

21 
	`°ªº‹
(
î∫o
));

22 
	`£nd_îr
(
fd
, -1, 
îrmsg
);

25 i‡(
	`£nd_fd
(
fd
, 
√wfd
) < 0)

26 
	`îr_sys
("send_fdÉrror");

27 
	`˛o£
(
√wfd
);

28 
	}
}

	@ipc2/opend/cliargs.c

1 
	~"›íd.h
"

9 
	$˛i_¨gs
(
¨gc
, **
¨gv
)

11 i‡(
¨gc
 !3 || 
	`°rcmp
(
¨gv
[0], 
CL_OPEN
) != 0) {

12 
	`°r˝y
(
îrmsg
, "usage: <pathname> <oflag>\n");

15 
∑th«me
 = 
¨gv
[1];

16 
oÊag
 = 
	`©oi
(
¨gv
[2]);

18 
	}
}

	@ipc2/opend/client.c

1 
	~"›íd.h
"

3 
	#NALLOC
 10

	)

6 
	$˛õ¡_Æloc
()

8 
i
;

10 i‡(
˛õ¡
 =
NULL
)

11 
˛õ¡
 = 
	`mÆloc
(
NALLOC
 * (
Clõ¡
));

13 
˛õ¡
 = 
	`ªÆloc
(˛õ¡, (
˛õ¡_size
+
NALLOC
)*(
Clõ¡
));

14 i‡(
˛õ¡
 =
NULL
)

15 
	`îr_sys
("can'tálloc for clientárray");

18 
i
 = 
˛õ¡_size
; i < clõ¡_sizê+ 
NALLOC
; i++)

19 
˛õ¡
[
i
].
fd
 = -1;

21 
˛õ¡_size
 +
NALLOC
;

22 
	}
}

28 
	$˛õ¡_add
(
fd
, 
uid_t
 
uid
)

30 
i
;

32 i‡(
˛õ¡
 =
NULL
)

33 
	`˛õ¡_Æloc
();

34 
agaö
:

35 
i
 = 0; i < 
˛õ¡_size
; i++) {

36 i‡(
˛õ¡
[
i
].
fd
 == -1) {

37 
˛õ¡
[
i
].
fd
 = fd;

38 
˛õ¡
[
i
].
uid
 = uid;

39 (
i
);

44 
	`˛õ¡_Æloc
();

45 
agaö
;

46 
	}
}

52 
	$˛õ¡_dñ
(
fd
)

54 
i
;

56 
i
 = 0; i < 
˛õ¡_size
; i++) {

57 i‡(
˛õ¡
[
i
].
fd
 == fd) {

58 
˛õ¡
[
i
].
fd
 = -1;

62 
	`log_quô
("ˇn'àföd clõ¡É¡ry f‹ fd %d", 
fd
);

63 
	}
}

	@ipc2/opend/loop.poll.c

1 
	~"›íd.h
"

2 
	~<pﬁl.h
>

4 
	#NALLOC
 10

	)

6 
pﬁlfd
 *

7 
	$grow_pﬁlfd
(
pﬁlfd
 *
pfd
, *
maxfd
)

9 
i
;

10 
ﬁdmax
 = *
maxfd
;

11 
√wmax
 = 
ﬁdmax
 + 
NALLOC
;

13 i‡((
pfd
 = 
	`ªÆloc
’fd, 
√wmax
 * (
pﬁlfd
))Ë=
NULL
)

14 
	`îr_sys
("reallocÉrror");

15 
i
 = 
ﬁdmax
; i < 
√wmax
; i++) {

16 
pfd
[
i
].
fd
 = -1;

17 
pfd
[
i
].
evíts
 = 
POLLIN
;

18 
pfd
[
i
].
ªvíts
 = 0;

20 *
maxfd
 = 
√wmax
;

21 (
pfd
);

22 
	}
}

25 
	$lo›
()

27 
i
, 
li°ífd
, 
˛ifd
, 
ƒód
;

28 
buf
[
MAXLINE
];

29 
uid_t
 
uid
;

30 
pﬁlfd
 *pollfd;

31 
numfd
 = 1;

32 
maxfd
 = 
NALLOC
;

34 i‡((
pﬁlfd
 = 
	`mÆloc
(
NALLOC
 * (pﬁlfd))Ë=
NULL
)

35 
	`îr_sys
("mallocÉrror");

36 
i
 = 0; i < 
NALLOC
; i++) {

37 
pﬁlfd
[
i
].
fd
 = -1;

38 
pﬁlfd
[
i
].
evíts
 = 
POLLIN
;

39 
pﬁlfd
[
i
].
ªvíts
 = 0;

43 i‡((
li°ífd
 = 
	`£rv_li°í
(
CS_OPEN
)) < 0)

44 
	`log_sys
("serv_listenÉrror");

45 
	`˛õ¡_add
(
li°ífd
, 0);

46 
pﬁlfd
[0].
fd
 = 
li°ífd
;

49 i‡(
	`pﬁl
(
pﬁlfd
, 
numfd
, -1) < 0)

50 
	`log_sys
("pollÉrror");

52 i‡(
pﬁlfd
[0].
ªvíts
 & 
POLLIN
) {

54 i‡((
˛ifd
 = 
	`£rv_ac˚±
(
li°ífd
, &
uid
)) < 0)

55 
	`log_sys
("£rv_ac˚±Éº‹: %d", 
˛ifd
);

56 
	`˛õ¡_add
(
˛ifd
, 
uid
);

59 i‡(
numfd
 =
maxfd
)

60 
pﬁlfd
 = 
	`grow_pﬁlfd
’ﬁlfd, &
maxfd
);

61 
pﬁlfd
[
numfd
].
fd
 = 
˛ifd
;

62 
pﬁlfd
[
numfd
].
evíts
 = 
POLLIN
;

63 
pﬁlfd
[
numfd
].
ªvíts
 = 0;

64 
numfd
++;

65 
	`log_msg
("√w c⁄√˘i⁄: uid %d, fd %d", 
uid
, 
˛ifd
);

68 
i
 = 1; i < 
numfd
; i++) {

69 i‡(
pﬁlfd
[
i
].
ªvíts
 & 
POLLHUP
) {

70 
hungup
;

71 } i‡(
pﬁlfd
[
i
].
ªvíts
 & 
POLLIN
) {

73 i‡((
ƒód
 = 
	`ªad
(
pﬁlfd
[
i
].
fd
, 
buf
, 
MAXLINE
)) < 0) {

74 
	`log_sys
("ªadÉº‹ o¿fd %d", 
pﬁlfd
[
i
].
fd
);

75 } i‡(
ƒód
 == 0) {

76 
hungup
:

78 
	`log_msg
("closed: uid %d, fd %d",

79 
˛õ¡
[
i
].
uid
, 
pﬁlfd
[i].
fd
);

80 
	`˛õ¡_dñ
(
pﬁlfd
[
i
].
fd
);

81 
	`˛o£
(
pﬁlfd
[
i
].
fd
);

82 i‡(
i
 < (
numfd
-1)) {

84 
pﬁlfd
[
i
].
fd
 =Öﬁlfd[
numfd
-1].fd;

85 
pﬁlfd
[
i
].
evíts
 =Öﬁlfd[
numfd
-1].events;

86 
pﬁlfd
[
i
].
ªvíts
 =Öﬁlfd[
numfd
-1].revents;

87 
i
--;

89 
numfd
--;

91 
	`h™dÀ_ªque°
(
buf
, 
ƒód
, 
pﬁlfd
[
i
].
fd
,

92 
˛õ¡
[
i
].
uid
);

97 
	}
}

	@ipc2/opend/loop.select.c

1 
	~"›íd.h
"

2 
	~<sys/£À˘.h
>

5 
	$lo›
()

7 
i
, 
n
, 
maxfd
, 
maxi
, 
li°ífd
, 
˛ifd
, 
ƒód
;

8 
buf
[
MAXLINE
];

9 
uid_t
 
uid
;

10 
fd_£t
 
r£t
, 
Æl£t
;

12 
	`FD_ZERO
(&
Æl£t
);

15 i‡((
li°ífd
 = 
	`£rv_li°í
(
CS_OPEN
)) < 0)

16 
	`log_sys
("serv_listenÉrror");

17 
	`FD_SET
(
li°ífd
, &
Æl£t
);

18 
maxfd
 = 
li°ífd
;

19 
maxi
 = -1;

22 
r£t
 = 
Æl£t
;

23 i‡((
n
 = 
	`£À˘
(
maxfd
 + 1, &
r£t
, 
NULL
, NULL, NULL)) < 0)

24 
	`log_sys
("selectÉrror");

26 i‡(
	`FD_ISSET
(
li°ífd
, &
r£t
)) {

28 i‡((
˛ifd
 = 
	`£rv_ac˚±
(
li°ífd
, &
uid
)) < 0)

29 
	`log_sys
("£rv_ac˚±Éº‹: %d", 
˛ifd
);

30 
i
 = 
	`˛õ¡_add
(
˛ifd
, 
uid
);

31 
	`FD_SET
(
˛ifd
, &
Æl£t
);

32 i‡(
˛ifd
 > 
maxfd
)

33 
maxfd
 = 
˛ifd
;

34 i‡(
i
 > 
maxi
)

35 
maxi
 = 
i
;

36 
	`log_msg
("√w c⁄√˘i⁄: uid %d, fd %d", 
uid
, 
˛ifd
);

40 
i
 = 0; i <
maxi
; i++) {

41 i‡((
˛ifd
 = 
˛õ¡
[
i
].
fd
) < 0)

43 i‡(
	`FD_ISSET
(
˛ifd
, &
r£t
)) {

45 i‡((
ƒód
 = 
	`ªad
(
˛ifd
, 
buf
, 
MAXLINE
)) < 0) {

46 
	`log_sys
("ªadÉº‹ o¿fd %d", 
˛ifd
);

47 } i‡(
ƒód
 == 0) {

48 
	`log_msg
("closed: uid %d, fd %d",

49 
˛õ¡
[
i
].
uid
, 
˛ifd
);

50 
	`˛õ¡_dñ
(
˛ifd
);

51 
	`FD_CLR
(
˛ifd
, &
Æl£t
);

52 
	`˛o£
(
˛ifd
);

54 
	`h™dÀ_ªque°
(
buf
, 
ƒód
, 
˛ifd
, 
˛õ¡
[
i
].
uid
);

59 
	}
}

	@ipc2/opend/main.c

1 
	~"›íd.h
"

2 
	~<sy¶og.h
>

4 
	gdebug
, 
	goÊag
, 
	g˛õ¡_size
, 
	glog_to_°dîr
;

5 
	gîrmsg
[
MAXLINE
];

6 *
	g∑th«me
;

7 
Clõ¡
 *
	g˛õ¡
 = 
NULL
;

10 
	$maö
(
¨gc
, *
¨gv
[])

12 
c
;

14 
	`log_›í
("›í.£rv", 
LOG_PID
, 
LOG_USER
);

16 
›ãº
 = 0;

17 (
c
 = 
	`gë›t
(
¨gc
, 
¨gv
, "d")Ë!
EOF
) {

18 
c
) {

20 
debug
 = 
log_to_°dîr
 = 1;

24 
	`îr_quô
("uƒecognized o±i⁄: -%c", 
›t›t
);

28 i‡(
debug
 == 0)

29 
	`d´m⁄ize
("opend");

31 
	`lo›
();

32 
	}
}

	@ipc2/opend/opend.h

1 
	~"≠ue.h
"

2 
	~<î∫o.h
>

4 
	#CS_OPEN
 "/tmp/›íd.sockë"

	)

5 
	#CL_OPEN
 "›í"

	)

7 
debug
;

8 
îrmsg
[];

9 
oÊag
;

10 *
∑th«me
;

13 
	mfd
;

14 
uid_t
 
	muid
;

15 } 
	tClõ¡
;

17 
Clõ¡
 *
˛õ¡
;

18 
˛õ¡_size
;

20 
˛i_¨gs
(, **);

21 
˛õ¡_add
(, 
uid_t
);

22 
˛õ¡_dñ
();

23 
lo›
();

24 
h™dÀ_ªque°
(*, , , 
uid_t
);

	@ipc2/opend/request.c

1 
	~"›íd.h
"

2 
	~<f˙é.h
>

5 
	$h™dÀ_ªque°
(*
buf
, 
ƒód
, 
˛ifd
, 
uid_t
 
uid
)

7 
√wfd
;

9 i‡(
buf
[
ƒód
-1] != 0) {

10 
	`¢¥ötf
(
îrmsg
, 
MAXLINE
-1,

12 
uid
, 
ƒód
,Çªad, 
buf
);

13 
	`£nd_îr
(
˛ifd
, -1, 
îrmsg
);

16 
	`log_msg
("ªque°: %s, from uid %d", 
buf
, 
uid
);

19 i‡(
	`buf_¨gs
(
buf
, 
˛i_¨gs
) < 0) {

20 
	`£nd_îr
(
˛ifd
, -1, 
îrmsg
);

21 
	`log_msg
(
îrmsg
);

25 i‡((
√wfd
 = 
	`›í
(
∑th«me
, 
oÊag
)) < 0) {

26 
	`¢¥ötf
(
îrmsg
, 
MAXLINE
-1, "can't open %s: %s\n",

27 
∑th«me
, 
	`°ªº‹
(
î∫o
));

28 
	`£nd_îr
(
˛ifd
, -1, 
îrmsg
);

29 
	`log_msg
(
îrmsg
);

34 i‡(
	`£nd_fd
(
˛ifd
, 
√wfd
) < 0)

35 
	`log_sys
("send_fdÉrror");

36 
	`log_msg
("£¡ fd %d ovî fd %d f‹ %s", 
√wfd
, 
˛ifd
, 
∑th«me
);

37 
	`˛o£
(
√wfd
);

38 
	}
}

	@ipc2/pollmsg.c

1 
	~"≠ue.h
"

2 
	~<pﬁl.h
>

3 
	~<±hªad.h
>

4 
	~<sys/msg.h
>

5 
	~<sys/sockë.h
>

7 
	#NQ
 3

	)

8 
	#MAXMSZ
 512

	)

9 
	#KEY
 0x123

	)

11 
	sthªadöfo
 {

12 
	mqid
;

13 
	mfd
;

16 
	smymesg
 {

17 
	mmty≥
;

18 
	mmãxt
[
MAXMSZ
];

22 
	$hñ≥r
(*
¨g
)

24 
n
;

25 
mymesg
 
m
;

26 
thªadöfo
 *
tù
 = 
¨g
;

29 
	`mem£t
(&
m
, 0, (m));

30 i‡((
n
 = 
	`msgrcv
(
tù
->
qid
, &
m
, 
MAXMSZ
, 0, 
MSG_NOERROR
)) < 0)

31 
	`îr_sys
("msgrcvÉrror");

32 i‡(
	`wrôe
(
tù
->
fd
, 
m
.
mãxt
, 
n
) < 0)

33 
	`îr_sys
("writeÉrror");

35 
	}
}

38 
	$maö
()

40 
i
, 
n
, 
îr
;

41 
fd
[2];

42 
qid
[
NQ
];

43 
pﬁlfd
 
pfd
[
NQ
];

44 
thªadöfo
 
ti
[
NQ
];

45 
±hªad_t
 
tid
[
NQ
];

46 
buf
[
MAXMSZ
];

48 
i
 = 0; i < 
NQ
; i++) {

49 i‡((
qid
[
i
] = 
	`msggë
((
KEY
+i), 
IPC_CREAT
|0666)) < 0)

50 
	`îr_sys
("msggetÉrror");

52 
	`¥ötf
("queuêID %d i†%d\n", 
i
, 
qid
[i]);

54 i‡(
	`sockë∑ú
(
AF_UNIX
, 
SOCK_DGRAM
, 0, 
fd
) < 0)

55 
	`îr_sys
("socketpairÉrror");

56 
pfd
[
i
].
fd
 = fd[0];

57 
pfd
[
i
].
evíts
 = 
POLLIN
;

58 
ti
[
i
].
qid
 = qid[i];

59 
ti
[
i
].
fd
 = fd[1];

60 i‡((
îr
 = 
	`±hªad_¸óã
(&
tid
[
i
], 
NULL
, 
hñ≥r
, &
ti
[i])) != 0)

61 
	`îr_exô
(
îr
, "pthread_createÉrror");

65 i‡(
	`pﬁl
(
pfd
, 
NQ
, -1) < 0)

66 
	`îr_sys
("pollÉrror");

67 
i
 = 0; i < 
NQ
; i++) {

68 i‡(
pfd
[
i
].
ªvíts
 & 
POLLIN
) {

69 i‡((
n
 = 
	`ªad
(
pfd
[
i
].
fd
, 
buf
, (buf))) < 0)

70 
	`îr_sys
("readÉrror");

71 
buf
[
n
] = 0;

72 
	`¥ötf
("queuêid %d, mesßgê%s\n", 
qid
[
i
], 
buf
);

77 
	`exô
(0);

78 
	}
}

	@ipc2/recvfd2.c

1 
	~"≠ue.h
"

2 
	~<sys/sockë.h
>

3 
	~<sys/un.h
>

5 #i‡
deföed
(
SCM_CREDS
)

6 
	#CREDSTRUCT
 
cmsg¸ed


	)

7 
	#CR_UID
 
cm¸ed_uid


	)

8 
	#SCM_CREDTYPE
 
SCM_CREDS


	)

9 #ñi‡
deföed
(
SCM_CREDENTIALS
)

10 
	#CREDSTRUCT
 
u¸ed


	)

11 
	#CR_UID
 
uid


	)

12 
	#CREDOPT
 
SO_PASSCRED


	)

13 
	#SCM_CREDTYPE
 
SCM_CREDENTIALS


	)

15 #îr‹ 
∑ssög
 
¸edítüls
 
is
 
unsuµ‹ãd
!

19 
	#RIGHTSLEN
 
	`CMSG_LEN
(())

	)

20 
	#CREDSLEN
 
	`CMSG_LEN
((
CREDSTRUCT
))

	)

21 
	#CONTROLLEN
 (
RIGHTSLEN
 + 
CREDSLEN
)

	)

23 
cmsghdr
 *
	gcm±r
 = 
NULL
;

31 
ªcv_ufd
(
fd
, 
uid_t
 *
uid±r
,

32 
	$ssize_t
 (*
u£rfunc
)(, c⁄° *, 
size_t
))

34 
cmsghdr
 *
cmp
;

35 
CREDSTRUCT
 *
¸edp
;

36 *
±r
;

37 
buf
[
MAXLINE
];

38 
iovec
 
iov
[1];

39 
msghdr
 
msg
;

40 
ƒ
;

41 
√wfd
 = -1;

42 
°©us
 = -1;

43 #i‡
	`deföed
(
CREDOPT
)

44 c⁄° 
⁄
 = 1;

46 i‡(
	`£tsock›t
(
fd
, 
SOL_SOCKET
, 
CREDOPT
, &
⁄
, ()) < 0) {

47 
	`îr_ªt
("setsockoptÉrror");

52 
iov
[0].
iov_ba£
 = 
buf
;

53 
iov
[0].
iov_Àn
 = (
buf
);

54 
msg
.
msg_iov
 = 
iov
;

55 
msg
.
msg_iovÀn
 = 1;

56 
msg
.
msg_«me
 = 
NULL
;

57 
msg
.
msg_«mñí
 = 0;

58 i‡(
cm±r
 =
NULL
 && (cm±∏
	`mÆloc
(
CONTROLLEN
)) == NULL)

60 
msg
.
msg_c⁄åﬁ
 = 
cm±r
;

61 
msg
.
msg_c⁄åﬁÀn
 = 
CONTROLLEN
;

62 i‡((
ƒ
 = 
	`ªcvmsg
(
fd
, &
msg
, 0)) < 0) {

63 
	`îr_ªt
("recvmsgÉrror");

65 } i‡(
ƒ
 == 0) {

66 
	`îr_ªt
("connection closed by server");

75 
±r
 = 
buf
;Öå < &buf[
ƒ
]; ) {

76 i‡(*
±r
++ == 0) {

77 i‡(
±r
 !&
buf
[
ƒ
-1])

78 
	`îr_dump
("message formatÉrror");

79 
°©us
 = *
±r
 & 0xFF;

80 i‡(
°©us
 == 0) {

81 i‡(
msg
.
msg_c⁄åﬁÀn
 !
CONTROLLEN
)

82 
	`îr_dump
("status = 0 butÇo fd");

85 
cmp
 = 
	`CMSG_FIRSTHDR
(&
msg
);

86 
cmp
 !
NULL
; cm∞
	`CMSG_NXTHDR
(&
msg
, cmp)) {

87 i‡(
cmp
->
cmsg_Àvñ
 !
SOL_SOCKET
)

89 
cmp
->
cmsg_ty≥
) {

90 
SCM_RIGHTS
:

91 
√wfd
 = *(*)
	`CMSG_DATA
(
cmp
);

93 
SCM_CREDTYPE
:

94 
¸edp
 = (
CREDSTRUCT
 *)
	`CMSG_DATA
(
cmp
);

95 *
uid±r
 = 
¸edp
->
CR_UID
;

99 
√wfd
 = -
°©us
;

101 
ƒ
 -= 2;

104 i‡(
ƒ
 > 0 && (*
u£rfunc
)(
STDERR_FILENO
, 
buf
,Çr) !=Çr)

106 i‡(
°©us
 >= 0)

107 (
√wfd
);

109 
	}
}

	@ipc2/sendfd2.c

1 
	~"≠ue.h
"

2 
	~<sys/sockë.h
>

4 #i‡
deföed
(
SCM_CREDS
)

5 
	#CREDSTRUCT
 
cmsg¸ed


	)

6 
	#SCM_CREDTYPE
 
SCM_CREDS


	)

7 #ñi‡
deföed
(
SCM_CREDENTIALS
)

8 
	#CREDSTRUCT
 
u¸ed


	)

9 
	#SCM_CREDTYPE
 
SCM_CREDENTIALS


	)

11 #îr‹ 
∑ssög
 
¸edítüls
 
is
 
unsuµ‹ãd
!

15 
	#RIGHTSLEN
 
	`CMSG_LEN
(())

	)

16 
	#CREDSLEN
 
	`CMSG_LEN
((
CREDSTRUCT
))

	)

17 
	#CONTROLLEN
 (
RIGHTSLEN
 + 
CREDSLEN
)

	)

19 
cmsghdr
 *
	gcm±r
 = 
NULL
;

26 
	$£nd_fd
(
fd
, 
fd_to_£nd
)

28 
CREDSTRUCT
 *
¸edp
;

29 
cmsghdr
 *
cmp
;

30 
iovec
 
iov
[1];

31 
msghdr
 
msg
;

32 
buf
[2];

34 
iov
[0].
iov_ba£
 = 
buf
;

35 
iov
[0].
iov_Àn
 = 2;

36 
msg
.
msg_iov
 = 
iov
;

37 
msg
.
msg_iovÀn
 = 1;

38 
msg
.
msg_«me
 = 
NULL
;

39 
msg
.
msg_«mñí
 = 0;

40 
msg
.
msg_Êags
 = 0;

41 i‡(
fd_to_£nd
 < 0) {

42 
msg
.
msg_c⁄åﬁ
 = 
NULL
;

43 
msg
.
msg_c⁄åﬁÀn
 = 0;

44 
buf
[1] = -
fd_to_£nd
;

45 i‡(
buf
[1] == 0)

46 
buf
[1] = 1;

48 i‡(
cm±r
 =
NULL
 && (cm±∏
	`mÆloc
(
CONTROLLEN
)) == NULL)

50 
msg
.
msg_c⁄åﬁ
 = 
cm±r
;

51 
msg
.
msg_c⁄åﬁÀn
 = 
CONTROLLEN
;

52 
cmp
 = 
cm±r
;

53 
cmp
->
cmsg_Àvñ
 = 
SOL_SOCKET
;

54 
cmp
->
cmsg_ty≥
 = 
SCM_RIGHTS
;

55 
cmp
->
cmsg_Àn
 = 
RIGHTSLEN
;

56 *(*)
	`CMSG_DATA
(
cmp
Ë
fd_to_£nd
;

57 
cmp
 = 
	`CMSG_NXTHDR
(&
msg
, cmp);

58 
cmp
->
cmsg_Àvñ
 = 
SOL_SOCKET
;

59 
cmp
->
cmsg_ty≥
 = 
SCM_CREDTYPE
;

60 
cmp
->
cmsg_Àn
 = 
CREDSLEN
;

61 
¸edp
 = (
CREDSTRUCT
 *)
	`CMSG_DATA
(
cmp
);

62 #i‡
	`deföed
(
SCM_CREDENTIALS
)

63 
¸edp
->
uid
 = 
	`gëeuid
();

64 
¸edp
->
gid
 = 
	`gëegid
();

65 
¸edp
->
pid
 = 
	`gëpid
();

67 
buf
[1] = 0;

69 
buf
[0] = 0;

70 i‡(
	`£ndmsg
(
fd
, &
msg
, 0) != 2)

73 
	}
}

	@ipc2/sendmsg.c

1 
	~"≠ue.h
"

2 
	~<sys/msg.h
>

4 
	#MAXMSZ
 512

	)

6 
	smymesg
 {

7 
	mmty≥
;

8 
	mmãxt
[
MAXMSZ
];

12 
	$maö
(
¨gc
, *
¨gv
[])

14 
key_t
 
key
;

15 
qid
;

16 
size_t
 
nbyãs
;

17 
mymesg
 
m
;

19 i‡(
¨gc
 != 3) {

20 
	`Ârötf
(
°dîr
, "usage: sendmsg KEY message\n");

21 
	`exô
(1);

23 
key
 = 
	`°πﬁ
(
¨gv
[1], 
NULL
, 0);

24 i‡((
qid
 = 
	`msggë
(
key
, 0)) < 0)

25 
	`îr_sys
("ˇn'à›í queuêkey %s", 
¨gv
[1]);

26 
	`mem£t
(&
m
, 0, (m));

27 
	`°∫˝y
(
m
.
mãxt
, 
¨gv
[2], 
MAXMSZ
-1);

28 
nbyãs
 = 
	`°æí
(
m
.
mãxt
);

29 
m
.
mty≥
 = 1;

30 i‡(
	`msg¢d
(
qid
, &
m
, 
nbyãs
, 0) < 0)

31 
	`îr_sys
("can't send message");

32 
	`exô
(0);

33 
	}
}

	@lib/Orecvfd.c

1 
	~"≠ue.h
"

2 
	~<sys/sockë.h
>

5 
	#CONTROLLEN
 
	`CMSG_LEN
(())

	)

7 
cmsghdr
 *
	gcm±r
 = 
NULL
;

15 
ªcv_fd
(
fd
, 
	$ssize_t
 (*
u£rfunc
)(, c⁄° *, 
size_t
))

17 
√wfd
, 
ƒ
, 
°©us
;

18 *
±r
;

19 
buf
[
MAXLINE
];

20 
iovec
 
iov
[1];

21 
msghdr
 
msg
;

23 
°©us
 = -1;

25 
iov
[0].
iov_ba£
 = 
buf
;

26 
iov
[0].
iov_Àn
 = (
buf
);

27 
msg
.
msg_iov
 = 
iov
;

28 
msg
.
msg_iovÀn
 = 1;

29 
msg
.
msg_«me
 = 
NULL
;

30 
msg
.
msg_«mñí
 = 0;

31 i‡(
cm±r
 =
NULL
 && (cm±∏
	`mÆloc
(
CONTROLLEN
)) == NULL)

33 
msg
.
msg_c⁄åﬁ
 = 
cm±r
;

34 
msg
.
msg_c⁄åﬁÀn
 = 
CONTROLLEN
;

35 i‡((
ƒ
 = 
	`ªcvmsg
(
fd
, &
msg
, 0)) < 0) {

36 
	`îr_ªt
("recvmsgÉrror");

38 } i‡(
ƒ
 == 0) {

39 
	`îr_ªt
("connection closed by server");

48 
±r
 = 
buf
;Öå < &buf[
ƒ
]; ) {

49 i‡(*
±r
++ == 0) {

50 i‡(
±r
 !&
buf
[
ƒ
-1])

51 
	`îr_dump
("message formatÉrror");

52 
°©us
 = *
±r
 & 0xFF;

53 i‡(
°©us
 == 0) {

54 i‡(
msg
.
msg_c⁄åﬁÀn
 !
CONTROLLEN
)

55 
	`îr_dump
("status = 0 butÇo fd");

56 
√wfd
 = *(*)
	`CMSG_DATA
(
cm±r
);

58 
√wfd
 = -
°©us
;

60 
ƒ
 -= 2;

63 i‡(
ƒ
 > 0 && (*
u£rfunc
)(
STDERR_FILENO
, 
buf
,Çr) !=Çr)

65 i‡(
°©us
 >= 0)

66 (
√wfd
);

68 
	}
}

	@lib/bufargs.c

1 
	~"≠ue.h
"

3 
	#MAXARGC
 50

	)

4 
	#WHITE
 " \t\n"

	)

14 
buf_¨gs
(*
buf
, (*
›tfunc
)(, **))

16 *
±r
, *
¨gv
[
MAXARGC
];

17 
¨gc
;

19 i‡(
	`°πok
(
buf
, 
WHITE
Ë=
NULL
)

21 
¨gv
[
¨gc
 = 0] = 
buf
;

22 (
±r
 = 
	`°πok
(
NULL
, 
WHITE
)) != NULL) {

23 i‡(++
¨gc
 >
MAXARGC
-1)

25 
¨gv
[
¨gc
] = 
±r
;

27 
¨gv
[++
¨gc
] = 
NULL
;

34 ((*
›tfunc
)(
¨gc
, 
¨gv
));

35 
	}
}

	@lib/cliconn.c

1 
	~"≠ue.h
"

2 
	~<sys/sockë.h
>

3 
	~<sys/un.h
>

4 
	~<î∫o.h
>

6 
	#CLI_PATH
 "/v¨/tmp/"

	)

7 
	#CLI_PERM
 
S_IRWXU


	)

14 
	$˛i_c⁄n
(c⁄° *
«me
)

16 
fd
, 
Àn
, 
îr
, 
rvÆ
;

17 
sockaddr_un
 
un
, 
sun
;

18 
do_u∆ök
 = 0;

20 i‡(
	`°æí
(
«me
Ë>(
un
.
sun_∑th
)) {

21 
î∫o
 = 
ENAMETOOLONG
;

26 i‡((
fd
 = 
	`sockë
(
AF_UNIX
, 
SOCK_STREAM
, 0)) < 0)

30 
	`mem£t
(&
un
, 0, (un));

31 
un
.
sun_Ámûy
 = 
AF_UNIX
;

32 
	`•rötf
(
un
.
sun_∑th
, "%s%05ld", 
CLI_PATH
, ()
	`gëpid
());

33 
	`¥ötf
("fûêi†%s\n", 
un
.
sun_∑th
);

34 
Àn
 = 
	`off£tof
(
sockaddr_un
, 
sun_∑th
Ë+ 
	`°æí
(
un
.sun_path);

36 
	`u∆ök
(
un
.
sun_∑th
);

37 i‡(
	`böd
(
fd
, (
sockaddr
 *)&
un
, 
Àn
) < 0) {

38 
rvÆ
 = -2;

39 
îrout
;

41 i‡(
	`chmod
(
un
.
sun_∑th
, 
CLI_PERM
) < 0) {

42 
rvÆ
 = -3;

43 
do_u∆ök
 = 1;

44 
îrout
;

48 
	`mem£t
(&
sun
, 0, (sun));

49 
sun
.
sun_Ámûy
 = 
AF_UNIX
;

50 
	`°r˝y
(
sun
.
sun_∑th
, 
«me
);

51 
Àn
 = 
	`off£tof
(
sockaddr_un
, 
sun_∑th
Ë+ 
	`°æí
(
«me
);

52 i‡(
	`c⁄√˘
(
fd
, (
sockaddr
 *)&
sun
, 
Àn
) < 0) {

53 
rvÆ
 = -4;

54 
do_u∆ök
 = 1;

55 
îrout
;

57 (
fd
);

59 
îrout
:

60 
îr
 = 
î∫o
;

61 
	`˛o£
(
fd
);

62 i‡(
do_u∆ök
)

63 
	`u∆ök
(
un
.
sun_∑th
);

64 
î∫o
 = 
îr
;

65 (
rvÆ
);

66 
	}
}

	@lib/clrfl.c

1 
	~"≠ue.h
"

2 
	~<f˙é.h
>

5 
	$˛r_Ê
(
fd
, 
Êags
)

8 
vÆ
;

10 i‡((
vÆ
 = 
	`f˙é
(
fd
, 
F_GETFL
, 0)) < 0)

11 
	`îr_sys
("fcntl F_GETFLÉrror");

13 
vÆ
 &~
Êags
;

15 i‡(
	`f˙é
(
fd
, 
F_SETFL
, 
vÆ
) < 0)

16 
	`îr_sys
("fcntl F_SETFLÉrror");

17 
	}
}

	@lib/daemonize.c

1 
	~"≠ue.h
"

2 
	~<sy¶og.h
>

3 
	~<f˙é.h
>

4 
	~<sys/ªsour˚.h
>

7 
	$d´m⁄ize
(c⁄° *
cmd
)

9 
i
, 
fd0
, 
fd1
, 
fd2
;

10 
pid_t
 
pid
;

11 
æimô
 
æ
;

12 
siga˘i⁄
 
ß
;

17 
	`umask
(0);

22 i‡(
	`gëæimô
(
RLIMIT_NOFILE
, &
æ
) < 0)

23 
	`îr_quô
("%s: c™'àgë fûêlimô", 
cmd
);

28 i‡((
pid
 = 
	`f‹k
()) < 0)

29 
	`îr_quô
("%s: c™'àf‹k", 
cmd
);

30 i‡(
pid
 != 0)

31 
	`exô
(0);

32 
	`£tsid
();

37 
ß
.
ß_h™dÀr
 = 
SIG_IGN
;

38 
	`sigem±y£t
(&
ß
.
ß_mask
);

39 
ß
.
ß_Êags
 = 0;

40 i‡(
	`siga˘i⁄
(
SIGHUP
, &
ß
, 
NULL
) < 0)

41 
	`îr_quô
("%s: c™'àign‹êSIGHUP", 
cmd
);

42 i‡((
pid
 = 
	`f‹k
()) < 0)

43 
	`îr_quô
("%s: c™'àf‹k", 
cmd
);

44 i‡(
pid
 != 0)

45 
	`exô
(0);

51 i‡(
	`chdú
("/") < 0)

52 
	`îr_quô
("%s: c™'àch™gêdúe˘‹yÅÿ/", 
cmd
);

57 i‡(
æ
.
æim_max
 =
RLIM_INFINITY
)

58 
æ
.
æim_max
 = 1024;

59 
i
 = 0; i < 
æ
.
æim_max
; i++)

60 
	`˛o£
(
i
);

65 
fd0
 = 
	`›í
("/dev/nuŒ", 
O_RDWR
);

66 
fd1
 = 
	`dup
(0);

67 
fd2
 = 
	`dup
(0);

72 
	`›ílog
(
cmd
, 
LOG_CONS
, 
LOG_DAEMON
);

73 i‡(
fd0
 !0 || 
fd1
 !1 || 
fd2
 != 2) {

74 
	`sy¶og
(
LOG_ERR
, "unexpected file descriptors %d %d %d",

75 
fd0
, 
fd1
, 
fd2
);

76 
	`exô
(1);

78 
	}
}

	@lib/error.c

1 
	~"≠ue.h
"

2 
	~<î∫o.h
>

3 
	~<°d¨g.h
>

5 
îr_doô
(, , c⁄° *, 
va_li°
);

12 
	$îr_ªt
(c⁄° *
fmt
, ...)

14 
va_li°
 
≠
;

16 
	`va_°¨t
(
≠
, 
fmt
);

17 
	`îr_doô
(1, 
î∫o
, 
fmt
, 
≠
);

18 
	`va_íd
(
≠
);

19 
	}
}

26 
	$îr_sys
(c⁄° *
fmt
, ...)

28 
va_li°
 
≠
;

30 
	`va_°¨t
(
≠
, 
fmt
);

31 
	`îr_doô
(1, 
î∫o
, 
fmt
, 
≠
);

32 
	`va_íd
(
≠
);

33 
	`exô
(1);

34 
	}
}

42 
	$îr_c⁄t
(
îr‹
, c⁄° *
fmt
, ...)

44 
va_li°
 
≠
;

46 
	`va_°¨t
(
≠
, 
fmt
);

47 
	`îr_doô
(1, 
îr‹
, 
fmt
, 
≠
);

48 
	`va_íd
(
≠
);

49 
	}
}

57 
	$îr_exô
(
îr‹
, c⁄° *
fmt
, ...)

59 
va_li°
 
≠
;

61 
	`va_°¨t
(
≠
, 
fmt
);

62 
	`îr_doô
(1, 
îr‹
, 
fmt
, 
≠
);

63 
	`va_íd
(
≠
);

64 
	`exô
(1);

65 
	}
}

72 
	$îr_dump
(c⁄° *
fmt
, ...)

74 
va_li°
 
≠
;

76 
	`va_°¨t
(
≠
, 
fmt
);

77 
	`îr_doô
(1, 
î∫o
, 
fmt
, 
≠
);

78 
	`va_íd
(
≠
);

79 
	`ab‹t
();

80 
	`exô
(1);

81 
	}
}

88 
	$îr_msg
(c⁄° *
fmt
, ...)

90 
va_li°
 
≠
;

92 
	`va_°¨t
(
≠
, 
fmt
);

93 
	`îr_doô
(0, 0, 
fmt
, 
≠
);

94 
	`va_íd
(
≠
);

95 
	}
}

102 
	$îr_quô
(c⁄° *
fmt
, ...)

104 
va_li°
 
≠
;

106 
	`va_°¨t
(
≠
, 
fmt
);

107 
	`îr_doô
(0, 0, 
fmt
, 
≠
);

108 
	`va_íd
(
≠
);

109 
	`exô
(1);

110 
	}
}

117 
	$îr_doô
(
î∫oÊag
, 
îr‹
, c⁄° *
fmt
, 
va_li°
 
≠
)

119 
buf
[
MAXLINE
];

121 
	`v¢¥ötf
(
buf
, 
MAXLINE
-1, 
fmt
, 
≠
);

122 i‡(
î∫oÊag
)

123 
	`¢¥ötf
(
buf
+
	`°æí
(buf), 
MAXLINE
-strlen(buf)-1, ": %s",

124 
	`°ªº‹
(
îr‹
));

125 
	`°rˇt
(
buf
, "\n");

126 
	`fÊush
(
°dout
);

127 
	`Âuts
(
buf
, 
°dîr
);

128 
	`fÊush
(
NULL
);

129 
	}
}

	@lib/errorlog.c

5 
	~"≠ue.h
"

6 
	~<î∫o.h
>

7 
	~<°d¨g.h
>

8 
	~<sy¶og.h
>

10 
log_doô
(, , , c⁄° *, 
va_li°
 
≠
);

16 
log_to_°dîr
;

22 
	$log_›í
(c⁄° *
idít
, 
›ti⁄
, 
Ácûôy
)

24 i‡(
log_to_°dîr
 == 0)

25 
	`›ílog
(
idít
, 
›ti⁄
, 
Ácûôy
);

26 
	}
}

33 
	$log_ªt
(c⁄° *
fmt
, ...)

35 
va_li°
 
≠
;

37 
	`va_°¨t
(
≠
, 
fmt
);

38 
	`log_doô
(1, 
î∫o
, 
LOG_ERR
, 
fmt
, 
≠
);

39 
	`va_íd
(
≠
);

40 
	}
}

47 
	$log_sys
(c⁄° *
fmt
, ...)

49 
va_li°
 
≠
;

51 
	`va_°¨t
(
≠
, 
fmt
);

52 
	`log_doô
(1, 
î∫o
, 
LOG_ERR
, 
fmt
, 
≠
);

53 
	`va_íd
(
≠
);

54 
	`exô
(2);

55 
	}
}

62 
	$log_msg
(c⁄° *
fmt
, ...)

64 
va_li°
 
≠
;

66 
	`va_°¨t
(
≠
, 
fmt
);

67 
	`log_doô
(0, 0, 
LOG_ERR
, 
fmt
, 
≠
);

68 
	`va_íd
(
≠
);

69 
	}
}

76 
	$log_quô
(c⁄° *
fmt
, ...)

78 
va_li°
 
≠
;

80 
	`va_°¨t
(
≠
, 
fmt
);

81 
	`log_doô
(0, 0, 
LOG_ERR
, 
fmt
, 
≠
);

82 
	`va_íd
(
≠
);

83 
	`exô
(2);

84 
	}
}

92 
	$log_exô
(
îr‹
, c⁄° *
fmt
, ...)

94 
va_li°
 
≠
;

96 
	`va_°¨t
(
≠
, 
fmt
);

97 
	`log_doô
(1, 
îr‹
, 
LOG_ERR
, 
fmt
, 
≠
);

98 
	`va_íd
(
≠
);

99 
	`exô
(2);

100 
	}
}

107 
	$log_doô
(
î∫oÊag
, 
îr‹
, 
¥i‹ôy
, c⁄° *
fmt
,

108 
va_li°
 
≠
)

110 
buf
[
MAXLINE
];

112 
	`v¢¥ötf
(
buf
, 
MAXLINE
-1, 
fmt
, 
≠
);

113 i‡(
î∫oÊag
)

114 
	`¢¥ötf
(
buf
+
	`°æí
(buf), 
MAXLINE
-strlen(buf)-1, ": %s",

115 
	`°ªº‹
(
îr‹
));

116 
	`°rˇt
(
buf
, "\n");

117 i‡(
log_to_°dîr
) {

118 
	`fÊush
(
°dout
);

119 
	`Âuts
(
buf
, 
°dîr
);

120 
	`fÊush
(
°dîr
);

122 
	`sy¶og
(
¥i‹ôy
, "%s", 
buf
);

124 
	}
}

	@lib/lockreg.c

1 
	~"≠ue.h
"

2 
	~<f˙é.h
>

5 
	$lock_ªg
(
fd
, 
cmd
, 
ty≥
, 
off_t
 
off£t
, 
whí˚
, off_à
Àn
)

7 
Êock
 
lock
;

9 
lock
.
l_ty≥
 = 
ty≥
;

10 
lock
.
l_°¨t
 = 
off£t
;

11 
lock
.
l_whí˚
 = 
whí˚
;

12 
lock
.
l_Àn
 = 
Àn
;

14 (
	`f˙é
(
fd
, 
cmd
, &
lock
));

15 
	}
}

	@lib/locktest.c

1 
	~"≠ue.h
"

2 
	~<f˙é.h
>

4 
pid_t


5 
	$lock_ã°
(
fd
, 
ty≥
, 
off_t
 
off£t
, 
whí˚
, off_à
Àn
)

7 
Êock
 
lock
;

9 
lock
.
l_ty≥
 = 
ty≥
;

10 
lock
.
l_°¨t
 = 
off£t
;

11 
lock
.
l_whí˚
 = 
whí˚
;

12 
lock
.
l_Àn
 = 
Àn
;

14 i‡(
	`f˙é
(
fd
, 
F_GETLK
, &
lock
) < 0)

15 
	`îr_sys
("fcntlÉrror");

17 i‡(
lock
.
l_ty≥
 =
F_UNLCK
)

19 (
lock
.
l_pid
);

20 
	}
}

	@lib/nspipe.c

3 
	~"≠ue.h
"

4 
	~<sys/sockë.h
>

5 
	~<sys/un.h
>

8 
	$ns_pùe
(c⁄° *
«me
, 
fd
[2])

10 
Àn
;

11 
sockaddr_un
 
unix_addr
;

13 i‡(
	`fd_pùe
(
fd
) < 0)

16 
	`u∆ök
(
«me
);

18 
	`mem£t
(&
unix_addr
, 0, (unix_addr));

19 
unix_addr
.
sun_Ámûy
 = 
AF_UNIX
;

20 
	`°r˝y
(
unix_addr
.
sun_∑th
, 
«me
);

21 
Àn
 = 
	`°æí
(
unix_addr
.
sun_∑th
Ë+ (unix_addr.
sun_Ámûy
);

23 (
	`böd
(
fd
[0], (
sockaddr
 *Ë&
unix_addr
, 
Àn
));

25 
	}
}

	@lib/openmax.c

1 
	~"≠ue.h
"

2 
	~<î∫o.h
>

3 
	~<limôs.h
>

5 #ifdef 
OPEN_MAX


6 
	g›ímax
 = 
OPEN_MAX
;

8 
	g›ímax
 = 0;

14 
	#OPEN_MAX_GUESS
 256

	)

17 
	$›í_max
()

19 i‡(
›ímax
 == 0) {

20 
î∫o
 = 0;

21 i‡((
›ímax
 = 
	`sysc⁄f
(
_SC_OPEN_MAX
)) < 0) {

22 i‡(
î∫o
 == 0)

23 
›ímax
 = 
OPEN_MAX_GUESS
;

25 
	`îr_sys
("sysconfÉrror for _SC_OPEN_MAX");

28 (
›ímax
);

29 
	}
}

	@lib/pathalloc.c

1 
	~"≠ue.h
"

2 
	~<î∫o.h
>

3 
	~<limôs.h
>

5 #ifdef 
PATH_MAX


6 
	g∑thmax
 = 
PATH_MAX
;

8 
	g∑thmax
 = 0;

11 
	gposix_vîsi⁄
 = 0;

12 
	gxsi_vîsi⁄
 = 0;

15 
	#PATH_MAX_GUESS
 1024

	)

18 
	$∑th_Æloc
(
size_t
 *
sizï
)

20 *
±r
;

21 
size_t
 
size
;

23 i‡(
posix_vîsi⁄
 == 0)

24 
posix_vîsi⁄
 = 
	`sysc⁄f
(
_SC_VERSION
);

26 i‡(
xsi_vîsi⁄
 == 0)

27 
xsi_vîsi⁄
 = 
	`sysc⁄f
(
_SC_XOPEN_VERSION
);

29 i‡(
∑thmax
 == 0) {

30 
î∫o
 = 0;

31 i‡((
∑thmax
 = 
	`∑thc⁄f
("/", 
_PC_PATH_MAX
)) < 0) {

32 i‡(
î∫o
 == 0)

33 
∑thmax
 = 
PATH_MAX_GUESS
;

35 
	`îr_sys
("pathconfÉrror for _PC_PATH_MAX");

37 
∑thmax
++;

45 i‡((
posix_vîsi⁄
 < 200112LË&& (
xsi_vîsi⁄
 < 4))

46 
size
 = 
∑thmax
 + 1;

48 
size
 = 
∑thmax
;

50 i‡((
±r
 = 
	`mÆloc
(
size
)Ë=
NULL
)

51 
	`îr_sys
("mallocÉrror forÖathname");

53 i‡(
sizï
 !
NULL
)

54 *
sizï
 = 
size
;

55 (
±r
);

56 
	}
}

	@lib/popen.c

1 
	~"≠ue.h
"

2 
	~<î∫o.h
>

3 
	~<f˙é.h
>

4 
	~<sys/waô.h
>

9 
pid_t
 *
	gchûdpid
 = 
NULL
;

14 
	gmaxfd
;

16 
FILE
 *

17 
	$p›í
(c⁄° *
cmd°rög
, c⁄° *
ty≥
)

19 
i
;

20 
pfd
[2];

21 
pid_t
 
pid
;

22 
FILE
 *
Â
;

25 i‡((
ty≥
[0] != 'r' &&Åype[0] != 'w') ||Åype[1] != 0) {

26 
î∫o
 = 
EINVAL
;

27 (
NULL
);

30 i‡(
chûdpid
 =
NULL
) {

32 
maxfd
 = 
	`›í_max
();

33 i‡((
chûdpid
 = 
	`ˇŒoc
(
maxfd
, (
pid_t
))Ë=
NULL
)

34 (
NULL
);

37 i‡(
	`pùe
(
pfd
) < 0)

38 (
NULL
);

39 i‡(
pfd
[0] >
maxfd
 ||Öfd[1] >= maxfd) {

40 
	`˛o£
(
pfd
[0]);

41 
	`˛o£
(
pfd
[1]);

42 
î∫o
 = 
EMFILE
;

43 (
NULL
);

46 i‡((
pid
 = 
	`f‹k
()) < 0) {

47 (
NULL
);

48 } i‡(
pid
 == 0) {

49 i‡(*
ty≥
 == 'r') {

50 
	`˛o£
(
pfd
[0]);

51 i‡(
pfd
[1] !
STDOUT_FILENO
) {

52 
	`dup2
(
pfd
[1], 
STDOUT_FILENO
);

53 
	`˛o£
(
pfd
[1]);

56 
	`˛o£
(
pfd
[1]);

57 i‡(
pfd
[0] !
STDIN_FILENO
) {

58 
	`dup2
(
pfd
[0], 
STDIN_FILENO
);

59 
	`˛o£
(
pfd
[0]);

64 
i
 = 0; i < 
maxfd
; i++)

65 i‡(
chûdpid
[
i
] > 0)

66 
	`˛o£
(
i
);

68 
	`exe˛
("/bö/sh", "sh", "-c", 
cmd°rög
, (*)0);

69 
	`_exô
(127);

73 i‡(*
ty≥
 == 'r') {

74 
	`˛o£
(
pfd
[1]);

75 i‡((
Â
 = 
	`fd›í
(
pfd
[0], 
ty≥
)Ë=
NULL
)

76 (
NULL
);

78 
	`˛o£
(
pfd
[0]);

79 i‡((
Â
 = 
	`fd›í
(
pfd
[1], 
ty≥
)Ë=
NULL
)

80 (
NULL
);

83 
chûdpid
[
	`fûío
(
Â
)] = 
pid
;

84 (
Â
);

85 
	}
}

88 
	$p˛o£
(
FILE
 *
Â
)

90 
fd
, 
°©
;

91 
pid_t
 
pid
;

93 i‡(
chûdpid
 =
NULL
) {

94 
î∫o
 = 
EINVAL
;

98 
fd
 = 
	`fûío
(
Â
);

99 i‡(
fd
 >
maxfd
) {

100 
î∫o
 = 
EINVAL
;

103 i‡((
pid
 = 
chûdpid
[
fd
]) == 0) {

104 
î∫o
 = 
EINVAL
;

108 
chûdpid
[
fd
] = 0;

109 i‡(
	`f˛o£
(
Â
Ë=
EOF
)

112 
	`waôpid
(
pid
, &
°©
, 0) < 0)

113 i‡(
î∫o
 !
EINTR
)

116 (
°©
);

117 
	}
}

	@lib/prexit.c

1 
	~"≠ue.h
"

2 
	~<sys/waô.h
>

5 
	$¥_exô
(
°©us
)

7 i‡(
	`WIFEXITED
(
°©us
))

8 
	`¥ötf
("normalÅermination,Éxit status = %d\n",

9 
	`WEXITSTATUS
(
°©us
));

10 i‡(
	`WIFSIGNALED
(
°©us
))

11 
	`¥ötf
("abnormalÅermination, signalÇumber = %d%s\n",

12 
	`WTERMSIG
(
°©us
),

13 #ifdef 
WCOREDUMP


14 
	`WCOREDUMP
(
°©us
) ? " (core file generated)" : "");

18 i‡(
	`WIFSTOPPED
(
°©us
))

19 
	`¥ötf
("child stopped, signalÇumber = %d\n",

20 
	`WSTOPSIG
(
°©us
));

21 
	}
}

	@lib/prmask.c

1 
	~"≠ue.h
"

2 
	~<î∫o.h
>

5 
	$¥_mask
(c⁄° *
°r
)

7 
sig£t_t
 
sig£t
;

8 
î∫o_ßve
;

10 
î∫o_ßve
 = 
î∫o
;

11 i‡(
	`sig¥ocmask
(0, 
NULL
, &
sig£t
) < 0) {

12 
	`îr_ªt
("sigprocmaskÉrror");

14 
	`¥ötf
("%s", 
°r
);

15 i‡(
	`sigismembî
(&
sig£t
, 
SIGINT
))

16 
	`¥ötf
(" SIGINT");

17 i‡(
	`sigismembî
(&
sig£t
, 
SIGQUIT
))

18 
	`¥ötf
(" SIGQUIT");

19 i‡(
	`sigismembî
(&
sig£t
, 
SIGUSR1
))

20 
	`¥ötf
(" SIGUSR1");

21 i‡(
	`sigismembî
(&
sig£t
, 
SIGALRM
))

22 
	`¥ötf
(" SIGALRM");

26 
	`¥ötf
("\n");

29 
î∫o
 = 
î∫o_ßve
;

30 
	}
}

	@lib/ptyfork.c

1 
	~"≠ue.h
"

2 
	~<ãrmios.h
>

4 
pid_t


5 
	$±y_f‹k
(*
±rfdm
, *
¶ave_«me
, 
¶ave_«mesz
,

6 c⁄° 
ãrmios
 *
¶ave_ãrmios
,

7 c⁄° 
wösize
 *
¶ave_wösize
)

9 
fdm
, 
fds
;

10 
pid_t
 
pid
;

11 
±s_«me
[20];

13 i‡((
fdm
 = 
	`±ym_›í
(
±s_«me
, (pts_name))) < 0)

14 
	`îr_sys
("ˇn'à›í ma°îÖty: %s,Éº‹ %d", 
±s_«me
, 
fdm
);

16 i‡(
¶ave_«me
 !
NULL
) {

21 
	`°∫˝y
(
¶ave_«me
, 
±s_«me
, 
¶ave_«mesz
);

22 
¶ave_«me
[
¶ave_«mesz
 - 1] = '\0';

25 i‡((
pid
 = 
	`f‹k
()) < 0) {

27 } i‡(
pid
 == 0) {

28 i‡(
	`£tsid
() < 0)

29 
	`îr_sys
("setsidÉrror");

34 i‡((
fds
 = 
	`±ys_›í
(
±s_«me
)) < 0)

35 
	`îr_sys
("can't open slaveÖty");

36 
	`˛o£
(
fdm
);

38 #if 
	`deföed
(
BSD
)

42 i‡(
	`io˘l
(
fds
, 
TIOCSCTTY
, (*)0) < 0)

43 
	`îr_sys
("TIOCSCTTYÉrror");

48 i‡(
¶ave_ãrmios
 !
NULL
) {

49 i‡(
	`tc£èâr
(
fds
, 
TCSANOW
, 
¶ave_ãrmios
) < 0)

50 
	`îr_sys
("tcsetattrÉrror on slaveÖty");

52 i‡(
¶ave_wösize
 !
NULL
) {

53 i‡(
	`io˘l
(
fds
, 
TIOCSWINSZ
, 
¶ave_wösize
) < 0)

54 
	`îr_sys
("TIOCSWINSZÉrror on slaveÖty");

60 i‡(
	`dup2
(
fds
, 
STDIN_FILENO
) != STDIN_FILENO)

61 
	`îr_sys
("dup2ÉrrorÅo stdin");

62 i‡(
	`dup2
(
fds
, 
STDOUT_FILENO
) != STDOUT_FILENO)

63 
	`îr_sys
("dup2ÉrrorÅo stdout");

64 i‡(
	`dup2
(
fds
, 
STDERR_FILENO
) != STDERR_FILENO)

65 
	`îr_sys
("dup2ÉrrorÅo stderr");

66 i‡(
fds
 !
STDIN_FILENO
 && fd†!
STDOUT_FILENO
 &&

67 
fds
 !
STDERR_FILENO
)

68 
	`˛o£
(
fds
);

71 *
±rfdm
 = 
fdm
;

72 (
pid
);

74 
	}
}

	@lib/ptyopen.c

1 
	~"≠ue.h
"

2 
	~<î∫o.h
>

3 
	~<f˙é.h
>

4 #i‡
deföed
(
SOLARIS
)

5 
	~<°r›ts.h
>

9 
	$±ym_›í
(*
±s_«me
, 
±s_«mesz
)

11 *
±r
;

12 
fdm
, 
îr
;

14 i‡((
fdm
 = 
	`posix_›í±
(
O_RDWR
)) < 0)

16 i‡(
	`gø¡±
(
fdm
) < 0)

17 
îrout
;

18 i‡(
	`u∆ock±
(
fdm
) < 0)

19 
îrout
;

20 i‡((
±r
 = 
	`±¢ame
(
fdm
)Ë=
NULL
)

21 
îrout
;

27 
	`°∫˝y
(
±s_«me
, 
±r
, 
±s_«mesz
);

28 
±s_«me
[
±s_«mesz
 - 1] = '\0';

29 (
fdm
);

30 
îrout
:

31 
îr
 = 
î∫o
;

32 
	`˛o£
(
fdm
);

33 
î∫o
 = 
îr
;

35 
	}
}

38 
	$±ys_›í
(*
±s_«me
)

40 
fds
;

41 #i‡
	`deföed
(
SOLARIS
)

42 
îr
, 
£tup
;

45 i‡((
fds
 = 
	`›í
(
±s_«me
, 
O_RDWR
)) < 0)

48 #i‡
	`deföed
(
SOLARIS
)

52 i‡((
£tup
 = 
	`io˘l
(
fds
, 
I_FIND
, "ldterm")) < 0)

53 
îrout
;

55 i‡(
£tup
 == 0) {

56 i‡(
	`io˘l
(
fds
, 
I_PUSH
, "ptem") < 0)

57 
îrout
;

58 i‡(
	`io˘l
(
fds
, 
I_PUSH
, "ldterm") < 0)

59 
îrout
;

60 i‡(
	`io˘l
(
fds
, 
I_PUSH
, "ttcompat") < 0) {

61 
îrout
:

62 
îr
 = 
î∫o
;

63 
	`˛o£
(
fds
);

64 
î∫o
 = 
îr
;

69 (
fds
);

70 
	}
}

	@lib/readn.c

1 
	~"≠ue.h
"

3 
ssize_t


4 
	$ªadn
(
fd
, *
±r
, 
size_t
 
n
)

6 
size_t
 
∆e·
;

7 
ssize_t
 
ƒód
;

9 
∆e·
 = 
n
;

10 
∆e·
 > 0) {

11 i‡((
ƒód
 = 
	`ªad
(
fd
, 
±r
, 
∆e·
)) < 0) {

12 i‡(
∆e·
 =
n
)

16 } i‡(
ƒód
 == 0) {

19 
∆e·
 -
ƒód
;

20 
±r
 +
ƒód
;

22 (
n
 - 
∆e·
);

23 
	}
}

	@lib/recvfd.c

1 
	~"≠ue.h
"

2 
	~<sys/sockë.h
>

5 
	#CONTROLLEN
 
	`CMSG_LEN
(())

	)

7 #ifde‡
LINUX


8 
	#RELOP
 <

	)

10 
	#RELOP
 !=

	)

13 
cmsghdr
 *
	gcm±r
 = 
NULL
;

21 
ªcv_fd
(
fd
, 
	$ssize_t
 (*
u£rfunc
)(, c⁄° *, 
size_t
))

23 
√wfd
, 
ƒ
, 
°©us
;

24 *
±r
;

25 
buf
[
MAXLINE
];

26 
iovec
 
iov
[1];

27 
msghdr
 
msg
;

29 
°©us
 = -1;

31 
iov
[0].
iov_ba£
 = 
buf
;

32 
iov
[0].
iov_Àn
 = (
buf
);

33 
msg
.
msg_iov
 = 
iov
;

34 
msg
.
msg_iovÀn
 = 1;

35 
msg
.
msg_«me
 = 
NULL
;

36 
msg
.
msg_«mñí
 = 0;

37 i‡(
cm±r
 =
NULL
 && (cm±∏
	`mÆloc
(
CONTROLLEN
)) == NULL)

39 
msg
.
msg_c⁄åﬁ
 = 
cm±r
;

40 
msg
.
msg_c⁄åﬁÀn
 = 
CONTROLLEN
;

41 i‡((
ƒ
 = 
	`ªcvmsg
(
fd
, &
msg
, 0)) < 0) {

42 
	`îr_ªt
("recvmsgÉrror");

44 } i‡(
ƒ
 == 0) {

45 
	`îr_ªt
("connection closed by server");

54 
±r
 = 
buf
;Öå < &buf[
ƒ
]; ) {

55 i‡(*
±r
++ == 0) {

56 i‡(
±r
 !&
buf
[
ƒ
-1])

57 
	`îr_dump
("message formatÉrror");

58 
°©us
 = *
±r
 & 0xFF;

59 i‡(
°©us
 == 0) {

60 i‡(
msg
.
msg_c⁄åﬁÀn
 
RELOP
 
CONTROLLEN
)

61 
	`îr_dump
("status = 0 butÇo fd");

62 
√wfd
 = *(*)
	`CMSG_DATA
(
cm±r
);

64 
√wfd
 = -
°©us
;

66 
ƒ
 -= 2;

69 i‡(
ƒ
 > 0 && (*
u£rfunc
)(
STDERR_FILENO
, 
buf
,Çr) !=Çr)

71 i‡(
°©us
 >= 0)

72 (
√wfd
);

74 
	}
}

	@lib/semaph.c

30 
	~"≠ue.h
"

31 
	~<sys/ùc.h
>

32 
	~<sys/£m.h
>

33 
	~<î∫o.h
>

35 
£m_›
(, );

36 
£m_¸óã
(
key_t
, );

37 
£m_›í
(
key_t
);

38 
£m_rm
();

39 
£m_˛o£
();

40 
£m_waô
();

41 
£m_sig«l
();

43 
	#BIGCOUNT
 10000

	)

49 
£mbuf
 
	g›_lock
[2] = {

51 {2, 1, 
SEM_UNDO
}

56 
£mbuf
 
	g›_íd¸óã
[2] = {

57 {1, -1, 
SEM_UNDO
},

60 {2, -1, 
SEM_UNDO
}

63 
£mbuf
 
	g›_›í
[1] = {

64 {1, -1, 
SEM_UNDO
}

67 
£mbuf
 
	g›_˛o£
[3] = {

69 {2, 1, 
SEM_UNDO
},

70 {1, 1, 
SEM_UNDO
}

73 
£mbuf
 
	g›_u∆ock
[1] = {

74 {2, -1, 
SEM_UNDO
}

77 
£mbuf
 
	g›_›
[1] = {

78 {0, 99, 
SEM_UNDO
}

90 
	$£m_¸óã
(
key_t
 
key
, 
öôvÆ
)

92 
id
, 
£mvÆ
;

93 
	u£mun
 {

94 
vÆ
;

95 
£mid_ds
 *
buf
;

96 *
¨øy
;

97 } 
£m˘l_¨g
;

99 i‡(
key
 =
IPC_PRIVATE
)

102 i‡(
key
 =(
key_t
) -1)

105 
agaö
:

106 i‡((
id
 = 
	`£mgë
(
key
, 3, 0666 | 
IPC_CREAT
)) < 0)

124 i‡(
	`£m›
(
id
, &
›_lock
[0], 2) < 0) {

125 i‡(
î∫o
 =
EINVAL
)

126 
agaö
;

127 
	`îr_sys
("can'tÜock");

135 i‡((
£mvÆ
 = 
	`£m˘l
(
id
, 1, 
GETVAL
, 0)) < 0)

136 
	`îr_sys
("can't GETVAL");

138 i‡(
£mvÆ
 == 0) {

146 
£m˘l_¨g
.
vÆ
 = 
öôvÆ
;

147 i‡(
	`£m˘l
(
id
, 0, 
SETVAL
, 
£m˘l_¨g
) < 0)

148 
	`îr_sys
("can SETVAL[0]");

150 
£m˘l_¨g
.
vÆ
 = 
BIGCOUNT
;

151 i‡(
	`£m˘l
(
id
, 1, 
SETVAL
, 
£m˘l_¨g
) < 0)

152 
	`îr_sys
("can SETVAL[1]");

159 i‡(
	`£m›
(
id
, &
›_íd¸óã
[0], 2) < 0)

160 
	`îr_sys
("can'tÉnd create");

162 (
id
);

163 
	}
}

175 
	$£m_›í
(
key_t
 
key
)

177 
id
;

179 i‡(
key
 =
IPC_PRIVATE
)

182 i‡(
key
 =(
key_t
) -1)

185 i‡((
id
 = 
	`£mgë
(
key
, 3, 0)) < 0)

193 i‡(
	`£m›
(
id
, &
›_›í
[0], 1) < 0)

194 
	`îr_sys
("can't open");

196 (
id
);

197 
	}
}

208 
	$£m_rm
(
id
)

210 i‡(
	`£m˘l
(
id
, 0, 
IPC_RMID
, 0) < 0)

211 
	`îr_sys
("can't IPC_RMID");

212 
	}
}

223 
	$£m_˛o£
(
id
)

225 
£mvÆ
;

232 i‡(
	`£m›
(
id
, &
›_˛o£
[0], 3) < 0)

233 
	`îr_sys
("can't semop");

243 i‡((
£mvÆ
 = 
	`£m˘l
(
id
, 1, 
GETVAL
, 0)) < 0)

244 
	`îr_sys
("can't GETVAL");

246 i‡(
£mvÆ
 > 
BIGCOUNT
)

247 
	`îr_dump
("sem[1] > BIGCOUNT");

248 i‡(
£mvÆ
 =
BIGCOUNT
)

249 
	`£m_rm
(
id
);

251 i‡(
	`£m›
(
id
, &
›_u∆ock
[0], 1) < 0)

252 
	`îr_sys
("can't unlock");

253 
	}
}

262 
	$£m_waô
(
id
)

264 
	`£m_›
(
id
, -1);

265 
	}
}

273 
	$£m_sig«l
(
id
)

275 
	`£m_›
(
id
, 1);

276 
	}
}

284 
	$£m_›
(
id
, 
vÆue
)

286 i‡((
›_›
[0].
£m_›
 = 
vÆue
) == 0)

287 
	`îr_sys
("can't have value == 0");

289 i‡(
	`£m›
(
id
, &
›_›
[0], 1) < 0)

290 
	`îr_sys
("sem_opÉrror");

291 
	}
}

	@lib/senderr.c

1 
	~"≠ue.h
"

9 
	$£nd_îr
(
fd
, 
îrcode
, c⁄° *
msg
)

11 
n
;

13 i‡((
n
 = 
	`°æí
(
msg
)) > 0)

14 i‡(
	`wrôí
(
fd
, 
msg
, 
n
) !=Ç)

17 i‡(
îrcode
 >= 0)

18 
îrcode
 = -1;

20 i‡(
	`£nd_fd
(
fd
, 
îrcode
) < 0)

24 
	}
}

	@lib/sendfd.c

1 
	~"≠ue.h
"

2 
	~<sys/sockë.h
>

5 
	#CONTROLLEN
 
	`CMSG_LEN
(())

	)

7 
cmsghdr
 *
	gcm±r
 = 
NULL
;

14 
	$£nd_fd
(
fd
, 
fd_to_£nd
)

16 
iovec
 
iov
[1];

17 
msghdr
 
msg
;

18 
buf
[2];

20 
iov
[0].
iov_ba£
 = 
buf
;

21 
iov
[0].
iov_Àn
 = 2;

22 
msg
.
msg_iov
 = 
iov
;

23 
msg
.
msg_iovÀn
 = 1;

24 
msg
.
msg_«me
 = 
NULL
;

25 
msg
.
msg_«mñí
 = 0;

27 i‡(
fd_to_£nd
 < 0) {

28 
msg
.
msg_c⁄åﬁ
 = 
NULL
;

29 
msg
.
msg_c⁄åﬁÀn
 = 0;

30 
buf
[1] = -
fd_to_£nd
;

31 i‡(
buf
[1] == 0)

32 
buf
[1] = 1;

34 i‡(
cm±r
 =
NULL
 && (cm±∏
	`mÆloc
(
CONTROLLEN
)) == NULL)

36 
cm±r
->
cmsg_Àvñ
 = 
SOL_SOCKET
;

37 
cm±r
->
cmsg_ty≥
 = 
SCM_RIGHTS
;

38 
cm±r
->
cmsg_Àn
 = 
CONTROLLEN
;

39 
msg
.
msg_c⁄åﬁ
 = 
cm±r
;

40 
msg
.
msg_c⁄åﬁÀn
 = 
CONTROLLEN
;

41 *(*)
	`CMSG_DATA
(
cm±r
Ë
fd_to_£nd
;

42 
buf
[1] = 0;

45 
buf
[0] = 0;

46 i‡(
	`£ndmsg
(
fd
, &
msg
, 0) != 2)

49 
	}
}

	@lib/servaccept.c

1 
	~"≠ue.h
"

2 
	~<sys/sockë.h
>

3 
	~<sys/un.h
>

4 
	~<time.h
>

5 
	~<î∫o.h
>

7 
	#STALE
 30

	)

16 
	$£rv_ac˚±
(
li°ífd
, 
uid_t
 *
uid±r
)

18 
˛ifd
, 
îr
, 
rvÆ
;

19 
sockÀn_t
 
Àn
;

20 
time_t
 
°Æëime
;

21 
sockaddr_un
 
un
;

22 
°©
 
°©buf
;

23 *
«me
;

26 i‡((
«me
 = 
	`mÆloc
((
un
.
sun_∑th
 + 1))Ë=
NULL
)

28 
Àn
 = (
un
);

29 i‡((
˛ifd
 = 
	`ac˚±
(
li°ífd
, (
sockaddr
 *)&
un
, &
Àn
)) < 0) {

30 
	`‰ì
(
«me
);

35 
Àn
 -
	`off£tof
(
sockaddr_un
, 
sun_∑th
);

36 
	`mem˝y
(
«me
, 
un
.
sun_∑th
, 
Àn
);

37 
«me
[
Àn
] = 0;

38 i‡(
	`°©
(
«me
, &
°©buf
) < 0) {

39 
rvÆ
 = -3;

40 
îrout
;

43 #ifdef 
S_ISSOCK


44 i‡(
	`S_ISSOCK
(
°©buf
.
°_mode
) == 0) {

45 
rvÆ
 = -4;

46 
îrout
;

50 i‡((
°©buf
.
°_mode
 & (
S_IRWXG
 | 
S_IRWXO
)) ||

51 (
°©buf
.
°_mode
 & 
S_IRWXU
) != S_IRWXU) {

52 
rvÆ
 = -5;

53 
îrout
;

56 
°Æëime
 = 
	`time
(
NULL
Ë- 
STALE
;

57 i‡(
°©buf
.
°_©ime
 < 
°Æëime
 ||

58 
°©buf
.
°_˘ime
 < 
°Æëime
 ||

59 
°©buf
.
°_mtime
 < 
°Æëime
) {

60 
rvÆ
 = -6;

61 
îrout
;

64 i‡(
uid±r
 !
NULL
)

65 *
uid±r
 = 
°©buf
.
°_uid
;

66 
	`u∆ök
(
«me
);

67 
	`‰ì
(
«me
);

68 (
˛ifd
);

70 
îrout
:

71 
îr
 = 
î∫o
;

72 
	`˛o£
(
˛ifd
);

73 
	`‰ì
(
«me
);

74 
î∫o
 = 
îr
;

75 (
rvÆ
);

76 
	}
}

	@lib/servlisten.c

1 
	~"≠ue.h
"

2 
	~<sys/sockë.h
>

3 
	~<sys/un.h
>

4 
	~<î∫o.h
>

6 
	#QLEN
 10

	)

13 
	$£rv_li°í
(c⁄° *
«me
)

15 
fd
, 
Àn
, 
îr
, 
rvÆ
;

16 
sockaddr_un
 
un
;

18 i‡(
	`°æí
(
«me
Ë>(
un
.
sun_∑th
)) {

19 
î∫o
 = 
ENAMETOOLONG
;

24 i‡((
fd
 = 
	`sockë
(
AF_UNIX
, 
SOCK_STREAM
, 0)) < 0)

27 
	`u∆ök
(
«me
);

30 
	`mem£t
(&
un
, 0, (un));

31 
un
.
sun_Ámûy
 = 
AF_UNIX
;

32 
	`°r˝y
(
un
.
sun_∑th
, 
«me
);

33 
Àn
 = 
	`off£tof
(
sockaddr_un
, 
sun_∑th
Ë+ 
	`°æí
(
«me
);

36 i‡(
	`böd
(
fd
, (
sockaddr
 *)&
un
, 
Àn
) < 0) {

37 
rvÆ
 = -3;

38 
îrout
;

41 i‡(
	`li°í
(
fd
, 
QLEN
) < 0) {

42 
rvÆ
 = -4;

43 
îrout
;

45 (
fd
);

47 
îrout
:

48 
îr
 = 
î∫o
;

49 
	`˛o£
(
fd
);

50 
î∫o
 = 
îr
;

51 (
rvÆ
);

52 
	}
}

	@lib/setfd.c

1 
	~"≠ue.h
"

2 
	~<f˙é.h
>

5 
	$£t_˛€xec
(
fd
)

7 
vÆ
;

9 i‡((
vÆ
 = 
	`f˙é
(
fd
, 
F_GETFD
, 0)) < 0)

12 
vÆ
 |
FD_CLOEXEC
;

14 (
	`f˙é
(
fd
, 
F_SETFD
, 
vÆ
));

15 
	}
}

	@lib/setfl.c

1 
	~"≠ue.h
"

2 
	~<f˙é.h
>

5 
	$£t_Ê
(
fd
, 
Êags
)

7 
vÆ
;

9 i‡((
vÆ
 = 
	`f˙é
(
fd
, 
F_GETFL
, 0)) < 0)

10 
	`îr_sys
("fcntl F_GETFLÉrror");

12 
vÆ
 |
Êags
;

14 i‡(
	`f˙é
(
fd
, 
F_SETFL
, 
vÆ
) < 0)

15 
	`îr_sys
("fcntl F_SETFLÉrror");

16 
	}
}

	@lib/signal.c

1 
	~"≠ue.h
"

4 
Sigfunc
 *

5 
	$sig«l
(
signo
, 
Sigfunc
 *
func
)

7 
siga˘i⁄
 
a˘
, 
ﬂ˘
;

9 
a˘
.
ß_h™dÀr
 = 
func
;

10 
	`sigem±y£t
(&
a˘
.
ß_mask
);

11 
a˘
.
ß_Êags
 = 0;

12 i‡(
signo
 =
SIGALRM
) {

13 #ifdef 
SA_INTERRUPT


14 
a˘
.
ß_Êags
 |
SA_INTERRUPT
;

17 
a˘
.
ß_Êags
 |
SA_RESTART
;

19 i‡(
	`siga˘i⁄
(
signo
, &
a˘
, &
ﬂ˘
) < 0)

20 (
SIG_ERR
);

21 (
ﬂ˘
.
ß_h™dÀr
);

22 
	}
}

	@lib/signalintr.c

1 
	~"≠ue.h
"

3 
Sigfunc
 *

4 
	$sig«l_öå
(
signo
, 
Sigfunc
 *
func
)

6 
siga˘i⁄
 
a˘
, 
ﬂ˘
;

8 
a˘
.
ß_h™dÀr
 = 
func
;

9 
	`sigem±y£t
(&
a˘
.
ß_mask
);

10 
a˘
.
ß_Êags
 = 0;

11 #ifdef 
SA_INTERRUPT


12 
a˘
.
ß_Êags
 |
SA_INTERRUPT
;

14 i‡(
	`siga˘i⁄
(
signo
, &
a˘
, &
ﬂ˘
) < 0)

15 (
SIG_ERR
);

16 (
ﬂ˘
.
ß_h™dÀr
);

17 
	}
}

	@lib/sleep.c

1 
	~"≠ue.h
"

4 
	$sig_Ærm
(
signo
)

7 
	}
}

10 
	$¶ìp
(
£c⁄ds
)

12 
siga˘i⁄
 
√wa˘
, 
ﬁda˘
;

13 
sig£t_t
 
√wmask
, 
ﬁdmask
, 
su•mask
;

14 
un¶ït
;

17 
√wa˘
.
ß_h™dÀr
 = 
sig_Ærm
;

18 
	`sigem±y£t
(&
√wa˘
.
ß_mask
);

19 
√wa˘
.
ß_Êags
 = 0;

20 
	`siga˘i⁄
(
SIGALRM
, &
√wa˘
, &
ﬁda˘
);

23 
	`sigem±y£t
(&
√wmask
);

24 
	`sigadd£t
(&
√wmask
, 
SIGALRM
);

25 
	`sig¥ocmask
(
SIG_BLOCK
, &
√wmask
, &
ﬁdmask
);

27 
	`Æ¨m
(
£c⁄ds
);

28 
su•mask
 = 
ﬁdmask
;

31 
	`sigdñ£t
(&
su•mask
, 
SIGALRM
);

34 
	`sigsu•íd
(&
su•mask
);

38 
un¶ït
 = 
	`Æ¨m
(0);

41 
	`siga˘i⁄
(
SIGALRM
, &
ﬁda˘
, 
NULL
);

44 
	`sig¥ocmask
(
SIG_SETMASK
, &
ﬁdmask
, 
NULL
);

45 (
un¶ït
);

46 
	}
}

	@lib/sleepus.c

1 
	~"≠ue.h
"

2 
	~<sys/time.h
>

5 
	$¶ìp_us
(
nu£cs
)

7 
timevÆ
 
tvÆ
;

9 
tvÆ
.
tv_£c
 = 
nu£cs
 / 1000000;

10 
tvÆ
.
tv_u£c
 = 
nu£cs
 % 1000000;

11 
	`£À˘
(0, 
NULL
, NULL, NULL, &
tvÆ
);

12 
	}
}

	@lib/spipe.c

1 
	~"≠ue.h
"

2 
	~<sys/sockë.h
>

9 
	$fd_pùe
(
fd
[2])

11 (
	`sockë∑ú
(
AF_UNIX
, 
SOCK_STREAM
, 0, 
fd
));

12 
	}
}

	@lib/strerror.c

1 
	~<°dio.h
>

3 #i‚de‡
LINUX


4 *
sys_îæi°
[];

5 
sys_√º
;

9 
	$°ªº‹
(
îr‹
)

11 
mesg
[30];

13 i‡(
îr‹
 >0 &&Éº‹ <
sys_√º
)

14 ((*)
sys_îæi°
[
îr‹
]);

16 
	`•rötf
(
mesg
, "Unknow¿îr‹ (%d)", 
îr‹
);

17 (
mesg
);

18 
	}
}

	@lib/tellwait.c

1 
	~"≠ue.h
"

3 vﬁ©ûê
sig_©omic_t
 
	gsigÊag
;

4 
sig£t_t
 
	g√wmask
, 
	gﬁdmask
, 
	gzîomask
;

7 
	$sig_u§
(
signo
)

9 
sigÊag
 = 1;

10 
	}
}

13 
	$TELL_WAIT
()

15 i‡(
	`sig«l
(
SIGUSR1
, 
sig_u§
Ë=
SIG_ERR
)

16 
	`îr_sys
("signal(SIGUSR1)Érror");

17 i‡(
	`sig«l
(
SIGUSR2
, 
sig_u§
Ë=
SIG_ERR
)

18 
	`îr_sys
("signal(SIGUSR2)Érror");

19 
	`sigem±y£t
(&
zîomask
);

20 
	`sigem±y£t
(&
√wmask
);

21 
	`sigadd£t
(&
√wmask
, 
SIGUSR1
);

22 
	`sigadd£t
(&
√wmask
, 
SIGUSR2
);

25 i‡(
	`sig¥ocmask
(
SIG_BLOCK
, &
√wmask
, &
ﬁdmask
) < 0)

26 
	`îr_sys
("SIG_BLOCKÉrror");

27 
	}
}

30 
	$TELL_PARENT
(
pid_t
 
pid
)

32 
	`kûl
(
pid
, 
SIGUSR2
);

33 
	}
}

36 
	$WAIT_PARENT
()

38 
sigÊag
 == 0)

39 
	`sigsu•íd
(&
zîomask
);

40 
sigÊag
 = 0;

43 i‡(
	`sig¥ocmask
(
SIG_SETMASK
, &
ﬁdmask
, 
NULL
) < 0)

44 
	`îr_sys
("SIG_SETMASKÉrror");

45 
	}
}

48 
	$TELL_CHILD
(
pid_t
 
pid
)

50 
	`kûl
(
pid
, 
SIGUSR1
);

51 
	}
}

54 
	$WAIT_CHILD
()

56 
sigÊag
 == 0)

57 
	`sigsu•íd
(&
zîomask
);

58 
sigÊag
 = 0;

61 i‡(
	`sig¥ocmask
(
SIG_SETMASK
, &
ﬁdmask
, 
NULL
) < 0)

62 
	`îr_sys
("SIG_SETMASKÉrror");

63 
	}
}

	@lib/ttymodes.c

1 
	~"≠ue.h
"

2 
	~<ãrmios.h
>

3 
	~<î∫o.h
>

5 
ãrmios
 
	gßve_ãrmios
;

6 
	gâyßvefd
 = -1;

7 íum { 
	mRESET
, 
	mRAW
, 
	mCBREAK
 } 
	gây°©e
 = 
RESET
;

10 
	$ây_cbªak
(
fd
)

12 
îr
;

13 
ãrmios
 
buf
;

15 i‡(
ây°©e
 !
RESET
) {

16 
î∫o
 = 
EINVAL
;

19 i‡(
	`tcgë©å
(
fd
, &
buf
) < 0)

21 
ßve_ãrmios
 = 
buf
;

26 
buf
.
c_lÊag
 &~(
ECHO
 | 
ICANON
);

31 
buf
.
c_cc
[
VMIN
] = 1;

32 
buf
.
c_cc
[
VTIME
] = 0;

33 i‡(
	`tc£èâr
(
fd
, 
TCSAFLUSH
, &
buf
) < 0)

40 i‡(
	`tcgë©å
(
fd
, &
buf
) < 0) {

41 
îr
 = 
î∫o
;

42 
	`tc£èâr
(
fd
, 
TCSAFLUSH
, &
ßve_ãrmios
);

43 
î∫o
 = 
îr
;

46 i‡((
buf
.
c_lÊag
 & (
ECHO
 | 
ICANON
)Ë|| buf.
c_cc
[
VMIN
] != 1 ||

47 
buf
.
c_cc
[
VTIME
] != 0) {

52 
	`tc£èâr
(
fd
, 
TCSAFLUSH
, &
ßve_ãrmios
);

53 
î∫o
 = 
EINVAL
;

57 
ây°©e
 = 
CBREAK
;

58 
âyßvefd
 = 
fd
;

60 
	}
}

63 
	$ây_øw
(
fd
)

65 
îr
;

66 
ãrmios
 
buf
;

68 i‡(
ây°©e
 !
RESET
) {

69 
î∫o
 = 
EINVAL
;

72 i‡(
	`tcgë©å
(
fd
, &
buf
) < 0)

74 
ßve_ãrmios
 = 
buf
;

80 
buf
.
c_lÊag
 &~(
ECHO
 | 
ICANON
 | 
IEXTEN
 | 
ISIG
);

87 
buf
.
c_iÊag
 &~(
BRKINT
 | 
ICRNL
 | 
INPCK
 | 
ISTRIP
 | 
IXON
);

92 
buf
.
c_cÊag
 &~(
CSIZE
 | 
PARENB
);

97 
buf
.
c_cÊag
 |
CS8
;

102 
buf
.
c_oÊag
 &~(
OPOST
);

107 
buf
.
c_cc
[
VMIN
] = 1;

108 
buf
.
c_cc
[
VTIME
] = 0;

109 i‡(
	`tc£èâr
(
fd
, 
TCSAFLUSH
, &
buf
) < 0)

116 i‡(
	`tcgë©å
(
fd
, &
buf
) < 0) {

117 
îr
 = 
î∫o
;

118 
	`tc£èâr
(
fd
, 
TCSAFLUSH
, &
ßve_ãrmios
);

119 
î∫o
 = 
îr
;

122 i‡((
buf
.
c_lÊag
 & (
ECHO
 | 
ICANON
 | 
IEXTEN
 | 
ISIG
)) ||

123 (
buf
.
c_iÊag
 & (
BRKINT
 | 
ICRNL
 | 
INPCK
 | 
ISTRIP
 | 
IXON
)) ||

124 (
buf
.
c_cÊag
 & (
CSIZE
 | 
PARENB
 | 
CS8
)) != CS8 ||

125 (
buf
.
c_oÊag
 & 
OPOST
Ë|| buf.
c_cc
[
VMIN
] != 1 ||

126 
buf
.
c_cc
[
VTIME
] != 0) {

131 
	`tc£èâr
(
fd
, 
TCSAFLUSH
, &
ßve_ãrmios
);

132 
î∫o
 = 
EINVAL
;

136 
ây°©e
 = 
RAW
;

137 
âyßvefd
 = 
fd
;

139 
	}
}

142 
	$ây_ª£t
(
fd
)

144 i‡(
ây°©e
 =
RESET
)

146 i‡(
	`tc£èâr
(
fd
, 
TCSAFLUSH
, &
ßve_ãrmios
) < 0)

148 
ây°©e
 = 
RESET
;

150 
	}
}

153 
	$ây_©exô
()

155 i‡(
âyßvefd
 >= 0)

156 
	`ây_ª£t
(
âyßvefd
);

157 
	}
}

159 
ãrmios
 *

160 
	$ây_ãrmios
()

162 (&
ßve_ãrmios
);

163 
	}
}

	@lib/writen.c

1 
	~"≠ue.h
"

3 
ssize_t


4 
	$wrôí
(
fd
, c⁄° *
±r
, 
size_t
 
n
)

6 
size_t
 
∆e·
;

7 
ssize_t
 
nwrôãn
;

9 
∆e·
 = 
n
;

10 
∆e·
 > 0) {

11 i‡((
nwrôãn
 = 
	`wrôe
(
fd
, 
±r
, 
∆e·
)) < 0) {

12 i‡(
∆e·
 =
n
)

16 } i‡(
nwrôãn
 == 0) {

19 
∆e·
 -
nwrôãn
;

20 
±r
 +
nwrôãn
;

22 (
n
 - 
∆e·
);

23 
	}
}

	@printer/ipp.h

1 #i‚de‡
_IPP_H


2 
	#_IPP_H


	)

12 
	#STATCLASS_OK
(
x
Ë((xË>0x0000 && (xË<0x00ff)

	)

13 
	#STATCLASS_INFO
(
x
Ë((xË>0x0100 && (xË<0x01ff)

	)

14 
	#STATCLASS_REDIR
(
x
Ë((xË>0x0300 && (xË<0x03ff)

	)

15 
	#STATCLASS_CLIERR
(
x
Ë((xË>0x0400 && (xË<0x04ff)

	)

16 
	#STATCLASS_SRVERR
(
x
Ë((xË>0x0500 && (xË<0x05ff)

	)

21 
	#STAT_OK
 0x0000

	)

22 
	#STAT_OK_ATTRIGN
 0x0001

	)

23 
	#STAT_OK_ATTRCON
 0x0002

	)

25 
	#STAT_CLI_BADREQ
 0x0400

	)

26 
	#STAT_CLI_FORBID
 0x0401

	)

27 
	#STAT_CLI_NOAUTH
 0x0402

	)

28 
	#STAT_CLI_NOPERM
 0x0403

	)

29 
	#STAT_CLI_NOTPOS
 0x0404

	)

30 
	#STAT_CLI_TIMOUT
 0x0405

	)

31 
	#STAT_CLI_NOTFND
 0x0406

	)

32 
	#STAT_CLI_OBJGONE
 0x0407

	)

33 
	#STAT_CLI_TOOBIG
 0x0408

	)

34 
	#STAT_CLI_TOOLNG
 0x0409

	)

35 
	#STAT_CLI_BADFMT
 0x040®

	)

36 
	#STAT_CLI_NOTSUP
 0x040b

	)

37 
	#STAT_CLI_NOSCHM
 0x040¯

	)

38 
	#STAT_CLI_NOCHAR
 0x040d

	)

39 
	#STAT_CLI_ATTRCON
 0x040ê

	)

40 
	#STAT_CLI_NOCOMP
 0x040‡

	)

41 
	#STAT_CLI_COMPERR
 0x0410

	)

42 
	#STAT_CLI_FMTERR
 0x0411

	)

43 
	#STAT_CLI_ACCERR
 0x0412

	)

45 
	#STAT_SRV_INTERN
 0x0500

	)

46 
	#STAT_SRV_NOTSUP
 0x0501

	)

47 
	#STAT_SRV_UNAVAIL
 0x0502

	)

48 
	#STAT_SRV_BADVER
 0x0503

	)

49 
	#STAT_SRV_DEVERR
 0x0504

	)

50 
	#STAT_SRV_TMPERR
 0x0505

	)

51 
	#STAT_SRV_REJECT
 0x0506

	)

52 
	#STAT_SRV_TOOBUSY
 0x0507

	)

53 
	#STAT_SRV_CANCEL
 0x0508

	)

54 
	#STAT_SRV_NOMULTI
 0x0509

	)

59 
	#OP_PRINT_JOB
 0x02

	)

60 
	#OP_PRINT_URI
 0x03

	)

61 
	#OP_VALIDATE_JOB
 0x04

	)

62 
	#OP_CREATE_JOB
 0x05

	)

63 
	#OP_SEND_DOC
 0x06

	)

64 
	#OP_SEND_URI
 0x07

	)

65 
	#OP_CANCEL_JOB
 0x08

	)

66 
	#OP_GET_JOB_ATTR
 0x09

	)

67 
	#OP_GET_JOBS
 0x0a

	)

68 
	#OP_GET_PRINTER_ATTR
 0x0b

	)

69 
	#OP_HOLD_JOB
 0x0c

	)

70 
	#OP_RELEASE_JOB
 0x0d

	)

71 
	#OP_RESTART_JOB
 0x0e

	)

72 
	#OP_PAUSE_PRINTER
 0x10

	)

73 
	#OP_RESUME_PRINTER
 0x11

	)

74 
	#OP_PURGE_JOBS
 0x12

	)

79 
	#TAG_OPERATION_ATTR
 0x01

	)

80 
	#TAG_JOB_ATTR
 0x02

	)

81 
	#TAG_END_OF_ATTR
 0x03

	)

82 
	#TAG_PRINTER_ATTR
 0x04

	)

83 
	#TAG_UNSUPP_ATTR
 0x05

	)

88 
	#TAG_UNSUPPORTED
 0x10

	)

89 
	#TAG_UNKNOWN
 0x12

	)

90 
	#TAG_NONE
 0x13

	)

91 
	#TAG_INTEGER
 0x21

	)

92 
	#TAG_BOOLEAN
 0x22

	)

93 
	#TAG_ENUM
 0x23

	)

94 
	#TAG_OCTSTR
 0x30

	)

95 
	#TAG_DATETIME
 0x31

	)

96 
	#TAG_RESOLUTION
 0x32

	)

97 
	#TAG_INTRANGE
 0x33

	)

98 
	#TAG_TEXTWLANG
 0x35

	)

99 
	#TAG_NAMEWLANG
 0x36

	)

100 
	#TAG_TEXTWOLANG
 0x41

	)

101 
	#TAG_NAMEWOLANG
 0x42

	)

102 
	#TAG_KEYWORD
 0x44

	)

103 
	#TAG_URI
 0x45

	)

104 
	#TAG_URISCHEME
 0x46

	)

105 
	#TAG_CHARSET
 0x47

	)

106 
	#TAG_NATULANG
 0x48

	)

107 
	#TAG_MIMETYPE
 0x49

	)

109 
	sùp_hdr
 {

110 
öt8_t
 
	mmaj‹_vîsi⁄
;

111 
öt8_t
 
	mmö‹_vîsi⁄
;

113 
öt16_t
 
	m›
;

114 
öt16_t
 
	m°
;

115 } 
	mu
;

116 
öt32_t
 
	mªque°_id
;

117 
	m©å_group
[1];

121 
	#›î©i⁄
 
u
.
›


	)

122 
	#°©us
 
u
.
°


	)

	@printer/print.c

6 
	~"≠ue.h
"

7 
	~"¥öt.h
"

8 
	~<f˙é.h
>

9 
	~<pwd.h
>

14 
	glog_to_°dîr
 = 1;

16 
submô_fûe
(, , c⁄° *, 
size_t
, );

19 
	$maö
(
¨gc
, *
¨gv
[])

21 
fd
, 
sfd
, 
îr
, 
ãxt
, 
c
;

22 
°©
 
sbuf
;

23 *
ho°
;

24 
addröfo
 *
aûi°
, *
aù
;

26 
îr
 = 0;

27 
ãxt
 = 0;

28 (
c
 = 
	`gë›t
(
¨gc
, 
¨gv
, "t")) != -1) {

29 
c
) {

31 
ãxt
 = 1;

35 
îr
 = 1;

39 i‡(
îr
 || (
›töd
 !
¨gc
 - 1))

40 
	`îr_quô
("usage:Örint [-t] filename");

41 i‡((
fd
 = 
	`›í
(
¨gv
[
›töd
], 
O_RDONLY
)) < 0)

42 
	`îr_sys
("¥öt: c™'à›í %s", 
¨gv
[
›töd
]);

43 i‡(
	`f°©
(
fd
, &
sbuf
) < 0)

44 
	`îr_sys
("¥öt: c™'à°© %s", 
¨gv
[
›töd
]);

45 i‡(!
	`S_ISREG
(
sbuf
.
°_mode
))

46 
	`îr_quô
("¥öt: %†mu° bê®ªguœ∏fûe", 
¨gv
[
›töd
]);

51 i‡((
ho°
 = 
	`gë_¥öt£rvî
()Ë=
NULL
)

52 
	`îr_quô
("print:ÇoÖrint server defined");

53 i‡((
îr
 = 
	`gëaddæi°
(
ho°
, "¥öt", &
aûi°
)) != 0)

54 
	`îr_quô
("¥öt: gëaddröfÿîr‹: %s", 
	`gai_°ªº‹
(
îr
));

56 
aù
 = 
aûi°
;áù !
NULL
;áù =áù->
ai_√xt
) {

57 i‡((
sfd
 = 
	`c⁄√˘_ªåy
(
AF_INET
, 
SOCK_STREAM
, 0,

58 
aù
->
ai_addr
,áù->
ai_addæí
)) < 0) {

59 
îr
 = 
î∫o
;

61 
	`submô_fûe
(
fd
, 
sfd
, 
¨gv
[
›töd
], 
sbuf
.
°_size
, 
ãxt
);

62 
	`exô
(0);

65 
	`îr_exô
(
îr
, "¥öt: c™'àc⁄è˘ %s", 
ho°
);

66 
	}
}

72 
	$submô_fûe
(
fd
, 
sockfd
, c⁄° *
‚ame
, 
size_t
 
nbyãs
,

73 
ãxt
)

75 
ƒ
, 
nw
, 
Àn
;

76 
∑sswd
 *
pwd
;

77 
¥öåeq
 
ªq
;

78 
¥öåe•
 
ªs
;

79 
buf
[
IOBUFSZ
];

84 i‡((
pwd
 = 
	`gëpwuid
(
	`gëeuid
())Ë=
NULL
) {

85 
	`°r˝y
(
ªq
.
u£∫m
, "unknown");

87 
	`°∫˝y
(
ªq
.
u£∫m
, 
pwd
->
pw_«me
, 
USERNM_MAX
-1);

88 
ªq
.
u£∫m
[
USERNM_MAX
-1] = '\0';

90 
ªq
.
size
 = 
	`ht⁄l
(
nbyãs
);

92 i‡(
ãxt
)

93 
ªq
.
Êags
 = 
	`ht⁄l
(
PR_TEXT
);

95 
ªq
.
Êags
 = 0;

97 i‡((
Àn
 = 
	`°æí
(
‚ame
)Ë>
JOBNM_MAX
) {

102 
	`°r˝y
(
ªq
.
jobnm
, "... ");

103 
	`°∫ˇt
(
ªq
.
jobnm
, &
‚ame
[
Àn
-
JOBNM_MAX
+5], JOBNM_MAX-5);

105 
	`°r˝y
(
ªq
.
jobnm
, 
‚ame
);

111 
nw
 = 
	`wrôí
(
sockfd
, &
ªq
, (
¥öåeq
));

112 i‡(
nw
 !(
¥öåeq
)) {

113 i‡(
nw
 < 0)

114 
	`îr_sys
("can't writeÅoÖrint server");

116 
	`îr_quô
("short write (%d/%d)ÅoÖrint server",

117 
nw
, (
¥öåeq
));

123 (
ƒ
 = 
	`ªad
(
fd
, 
buf
, 
IOBUFSZ
)) != 0) {

124 
nw
 = 
	`wrôí
(
sockfd
, 
buf
, 
ƒ
);

125 i‡(
nw
 !
ƒ
) {

126 i‡(
nw
 < 0)

127 
	`îr_sys
("can't writeÅoÖrint server");

129 
	`îr_quô
("short write (%d/%d)ÅoÖrint server",

130 
nw
, 
ƒ
);

137 i‡((
ƒ
 = 
	`ªadn
(
sockfd
, &
ªs
, (
¥öåe•
))) !=

138 (
¥öåe•
))

139 
	`îr_sys
("can'tÑeadÑesponse from server");

140 i‡(
ªs
.
ªtcode
 != 0) {

141 
	`¥ötf
("ªje˘ed: %s\n", 
ªs
.
msg
);

142 
	`exô
(1);

144 
	`¥ötf
("job ID %ld\n", ()
	`¡ohl
(
ªs
.
jobid
));

146 
	}
}

	@printer/print.h

1 #i‚de‡
_PRINT_H


2 
	#_PRINT_H


	)

7 
	~<sys/sockë.h
>

8 
	~<¨∑/öë.h
>

9 
	~<√tdb.h
>

10 
	~<î∫o.h
>

12 
	#CONFIG_FILE
 "/ëc/¥öãr.c⁄f"

	)

13 
	#SPOOLDIR
 "/v¨/•oﬁ/¥öãr"

	)

14 
	#JOBFILE
 "jobno"

	)

15 
	#DATADIR
 "d©a"

	)

16 
	#REQDIR
 "ªqs"

	)

18 #i‡
deföed
(
BSD
)

19 
	#LPNAME
 "d´m⁄"

	)

20 #ñi‡
deföed
(
MACOS
)

21 
	#LPNAME
 "_Õ"

	)

23 
	#LPNAME
 "Õ"

	)

26 
	#FILENMSZ
 64

	)

27 
	#FILEPERM
 (
S_IRUSR
|
S_IWUSR
)

	)

29 
	#USERNM_MAX
 64

	)

30 
	#JOBNM_MAX
 256

	)

31 
	#MSGLEN_MAX
 512

	)

33 #i‚de‡
HOST_NAME_MAX


34 
	#HOST_NAME_MAX
 256

	)

37 
	#IPP_PORT
 631

	)

38 
	#QLEN
 10

	)

40 
	#IBUFSZ
 512

	)

41 
	#HBUFSZ
 512

	)

42 
	#IOBUFSZ
 8192

	)

44 #i‚de‡
ETIME


45 
	#ETIME
 
ETIMEDOUT


	)

48 
gëaddæi°
(const *, const *,

49 
addröfo
 **);

50 *
gë_¥öt£rvî
();

51 
addröfo
 *
gë_¥öèddr
();

52 
ssize_t
 
åód
(, *, 
size_t
, );

53 
ssize_t
 
åódn
(, *, 
size_t
, );

54 
c⁄√˘_ªåy
(, , , c⁄° 
sockaddr
 *,

55 
sockÀn_t
);

56 
öô£rvî
(, c⁄° 
sockaddr
 *, 
sockÀn_t
,

62 
	s¥öåeq
 {

63 
uöt32_t
 
	msize
;

64 
uöt32_t
 
	mÊags
;

65 
	mu£∫m
[
USERNM_MAX
];

66 
	mjobnm
[
JOBNM_MAX
];

72 
	#PR_TEXT
 0x01

	)

77 
	s¥öåe•
 {

78 
uöt32_t
 
	mªtcode
;

79 
uöt32_t
 
	mjobid
;

80 
	mmsg
[
MSGLEN_MAX
];

	@printer/printd.c

4 
	~"≠ue.h
"

5 
	~<f˙é.h
>

6 
	~<dúít.h
>

7 
	~<˘y≥.h
>

8 
	~<pwd.h
>

9 
	~<±hªad.h
>

10 
	~<°rögs.h
>

11 
	~<sys/£À˘.h
>

12 
	~<sys/uio.h
>

14 
	~"¥öt.h
"

15 
	~"ùp.h
"

20 
	#HTTP_INFO
(
x
Ë((xË>100 && (xË<199)

	)

21 
	#HTTP_SUCCESS
(
x
Ë((xË>200 && (xË<299)

	)

26 
	sjob
 {

27 
job
 *
	m√xt
;

28 
job
 *
	m¥ev
;

29 
öt32_t
 
	mjobid
;

30 
¥öåeq
 
	mªq
;

36 
	sw‹kî_thªad
 {

37 
w‹kî_thªad
 *
	m√xt
;

38 
w‹kî_thªad
 *
	m¥ev
;

39 
±hªad_t
 
	mtid
;

40 
	msockfd
;

46 
	glog_to_°dîr
 = 0;

51 
addröfo
 *
	g¥öãr
;

52 *
	g¥öãr_«me
;

53 
±hªad_muãx_t
 
	gc⁄figlock
 = 
PTHREAD_MUTEX_INITIALIZER
;

54 
	gªªad
;

59 
w‹kî_thªad
 *
	gw‹kîs
;

60 
±hªad_muãx_t
 
	gw‹kîlock
 = 
PTHREAD_MUTEX_INITIALIZER
;

61 
sig£t_t
 
	gmask
;

66 
job
 *
	gjobhód
, *
	gjobèû
;

67 
	gjobfd
;

68 
öt32_t
 
	g√xtjob
;

69 
±hªad_muãx_t
 
	gjoblock
 = 
PTHREAD_MUTEX_INITIALIZER
;

70 
±hªad_c⁄d_t
 
	gjobwaô
 = 
PTHREAD_COND_INITIALIZER
;

75 
öô_ªque°
();

76 
öô_¥öãr
();

77 
upd©e_jobno
();

78 
öt32_t
 
gë_√wjobno
();

79 
add_job
(
¥öåeq
 *, 
öt32_t
);

80 
ª∂a˚_job
(
job
 *);

81 
ªmove_job
(
job
 *);

82 
buûd_q⁄°¨t
();

83 *
˛õ¡_thªad
(*);

84 *
¥öãr_thªad
(*);

85 *
sig«l_thªad
(*);

86 
ssize_t
 
ªadm‹e
(, **, , *);

87 
¥öãr_°©us
(, 
job
 *);

88 
add_w‹kî
(
±hªad_t
, );

89 
kûl_w‹kîs
();

90 
˛õ¡_˛ónup
(*);

99 
	$maö
(
¨gc
, *
¨gv
[])

101 
±hªad_t
 
tid
;

102 
addröfo
 *
aûi°
, *
aù
;

103 
sockfd
, 
îr
, 
i
, 
n
, 
maxfd
;

104 *
ho°
;

105 
fd_£t
 
ªndezvous
, 
r£t
;

106 
siga˘i⁄
 
ß
;

107 
∑sswd
 *
pwdp
;

109 i‡(
¨gc
 != 1)

110 
	`îr_quô
("usage:Örintd");

111 
	`d´m⁄ize
("printd");

113 
	`sigem±y£t
(&
ß
.
ß_mask
);

114 
ß
.
ß_Êags
 = 0;

115 
ß
.
ß_h™dÀr
 = 
SIG_IGN
;

116 i‡(
	`siga˘i⁄
(
SIGPIPE
, &
ß
, 
NULL
) < 0)

117 
	`log_sys
("sigaction failed");

118 
	`sigem±y£t
(&
mask
);

119 
	`sigadd£t
(&
mask
, 
SIGHUP
);

120 
	`sigadd£t
(&
mask
, 
SIGTERM
);

121 i‡((
îr
 = 
	`±hªad_sigmask
(
SIG_BLOCK
, &
mask
, 
NULL
)) != 0)

122 
	`log_sys
("pthread_sigmask failed");

124 
n
 = 
	`sysc⁄f
(
_SC_HOST_NAME_MAX
);

125 i‡(
n
 < 0)

126 
n
 = 
HOST_NAME_MAX
;

127 i‡((
ho°
 = 
	`mÆloc
(
n
)Ë=
NULL
)

128 
	`log_sys
("mallocÉrror");

129 i‡(
	`gëho°«me
(
ho°
, 
n
) < 0)

130 
	`log_sys
("gethostnameÉrror");

132 i‡((
îr
 = 
	`gëaddæi°
(
ho°
, "¥öt", &
aûi°
)) != 0) {

133 
	`log_quô
("gëaddröfÿîr‹: %s", 
	`gai_°ªº‹
(
îr
));

134 
	`exô
(1);

136 
	`FD_ZERO
(&
ªndezvous
);

137 
maxfd
 = -1;

138 
aù
 = 
aûi°
;áù !
NULL
;áù =áù->
ai_√xt
) {

139 i‡((
sockfd
 = 
	`öô£rvî
(
SOCK_STREAM
, 
aù
->
ai_addr
,

140 
aù
->
ai_addæí
, 
QLEN
)) >= 0) {

141 
	`FD_SET
(
sockfd
, &
ªndezvous
);

142 i‡(
sockfd
 > 
maxfd
)

143 
maxfd
 = 
sockfd
;

146 i‡(
maxfd
 == -1)

147 
	`log_quô
("serviceÇotÉnabled");

149 
pwdp
 = 
	`gëpw«m
(
LPNAME
);

150 i‡(
pwdp
 =
NULL
)

151 
	`log_sys
("ˇn'àföd u£∏%s", 
LPNAME
);

152 i‡(
pwdp
->
pw_uid
 == 0)

153 
	`log_quô
("u£∏%†i†¥ivûeged", 
LPNAME
);

154 i‡(
	`£tgid
(
pwdp
->
pw_gid
Ë< 0 || 
	`£tuid
’wdp->
pw_uid
) < 0)

155 
	`log_sys
("ˇn'àch™gêID†tÿu£∏%s", 
LPNAME
);

157 
	`öô_ªque°
();

158 
	`öô_¥öãr
();

160 
îr
 = 
	`±hªad_¸óã
(&
tid
, 
NULL
, 
¥öãr_thªad
, NULL);

161 i‡(
îr
 == 0)

162 
îr
 = 
	`±hªad_¸óã
(&
tid
, 
NULL
, 
sig«l_thªad
, NULL);

163 i‡(
îr
 != 0)

164 
	`log_exô
(
îr
, "can't createÅhread");

165 
	`buûd_q⁄°¨t
();

167 
	`log_msg
("daemon initialized");

170 
r£t
 = 
ªndezvous
;

171 i‡(
	`£À˘
(
maxfd
+1, &
r£t
, 
NULL
, NULL, NULL) < 0)

172 
	`log_sys
("select failed");

173 
i
 = 0; i <
maxfd
; i++) {

174 i‡(
	`FD_ISSET
(
i
, &
r£t
)) {

178 i‡((
sockfd
 = 
	`ac˚±
(
i
, 
NULL
, NULL)) < 0)

179 
	`log_ªt
("accept failed");

180 
	`±hªad_¸óã
(&
tid
, 
NULL
, 
˛õ¡_thªad
,

181 (*)(()
sockfd
));

185 
	`exô
(1);

186 
	}
}

195 
	$öô_ªque°
()

197 
n
;

198 
«me
[
FILENMSZ
];

200 
	`•rötf
(
«me
, "%s/%s", 
SPOOLDIR
, 
JOBFILE
);

201 
jobfd
 = 
	`›í
(
«me
, 
O_CREAT
|
O_RDWR
, 
S_IRUSR
|
S_IWUSR
);

202 i‡(
	`wrôe_lock
(
jobfd
, 0, 
SEEK_SET
, 0) < 0)

203 
	`log_quô
("daemonálreadyÑunning");

208 i‡((
n
 = 
	`ªad
(
jobfd
, 
«me
, 
FILENMSZ
)) < 0)

209 
	`log_sys
("can'tÑead job file");

210 i‡(
n
 == 0)

211 
√xtjob
 = 1;

213 
√xtjob
 = 
	`©ﬁ
(
«me
);

214 
	}
}

222 
	$öô_¥öãr
()

224 
¥öãr
 = 
	`gë_¥öèddr
();

225 i‡(
¥öãr
 =
NULL
)

226 
	`exô
(1);

227 
¥öãr_«me
 = 
¥öãr
->
ai_ˇn⁄«me
;

228 i‡(
¥öãr_«me
 =
NULL
)

229 
¥öãr_«me
 = "printer";

230 
	`log_msg
("¥öã∏i†%s", 
¥öãr_«me
);

231 
	}
}

240 
	$upd©e_jobno
()

242 
buf
[32];

244 i‡(
	`l£ek
(
jobfd
, 0, 
SEEK_SET
) == -1)

245 
	`log_sys
("can't seek in job file");

246 
	`•rötf
(
buf
, "%d", 
√xtjob
);

247 i‡(
	`wrôe
(
jobfd
, 
buf
, 
	`°æí
(buf)) < 0)

248 
	`log_sys
("can't update job file");

249 
	}
}

256 
öt32_t


257 
	$gë_√wjobno
()

259 
öt32_t
 
jobid
;

261 
	`±hªad_muãx_lock
(&
joblock
);

262 
jobid
 = 
√xtjob
++;

263 i‡(
√xtjob
 <= 0)

264 
√xtjob
 = 1;

265 
	`±hªad_muãx_u∆ock
(&
joblock
);

266 (
jobid
);

267 
	}
}

276 
	$add_job
(
¥öåeq
 *
ªqp
, 
öt32_t
 
jobid
)

278 
job
 *
jp
;

280 i‡((
jp
 = 
	`mÆloc
((
job
))Ë=
NULL
)

281 
	`log_sys
("malloc failed");

282 
	`mem˝y
(&
jp
->
ªq
, 
ªqp
, (
¥öåeq
));

283 
jp
->
jobid
 = jobid;

284 
jp
->
√xt
 = 
NULL
;

285 
	`±hªad_muãx_lock
(&
joblock
);

286 
jp
->
¥ev
 = 
jobèû
;

287 i‡(
jobèû
 =
NULL
)

288 
jobhód
 = 
jp
;

290 
jobèû
->
√xt
 = 
jp
;

291 
jobèû
 = 
jp
;

292 
	`±hªad_muãx_u∆ock
(&
joblock
);

293 
	`±hªad_c⁄d_sig«l
(&
jobwaô
);

294 
	}
}

302 
	$ª∂a˚_job
(
job
 *
jp
)

304 
	`±hªad_muãx_lock
(&
joblock
);

305 
jp
->
¥ev
 = 
NULL
;

306 
jp
->
√xt
 = 
jobhód
;

307 i‡(
jobhód
 =
NULL
)

308 
jobèû
 = 
jp
;

310 
jobhód
->
¥ev
 = 
jp
;

311 
jobhód
 = 
jp
;

312 
	`±hªad_muãx_u∆ock
(&
joblock
);

313 
	}
}

321 
	$ªmove_job
(
job
 *
èrgë
)

323 i‡(
èrgë
->
√xt
 !
NULL
)

324 
èrgë
->
√xt
->
¥ev
 =Åarget->prev;

326 
jobèû
 = 
èrgë
->
¥ev
;

327 i‡(
èrgë
->
¥ev
 !
NULL
)

328 
èrgë
->
¥ev
->
√xt
 =Åarget->next;

330 
jobhód
 = 
èrgë
->
√xt
;

331 
	}
}

339 
	$buûd_q⁄°¨t
()

341 
fd
, 
îr
, 
ƒ
;

342 
öt32_t
 
jobid
;

343 
DIR
 *
dúp
;

344 
dúít
 *
íç
;

345 
¥öåeq
 
ªq
;

346 
d«me
[
FILENMSZ
], 
‚ame
[FILENMSZ];

348 
	`•rötf
(
d«me
, "%s/%s", 
SPOOLDIR
, 
REQDIR
);

349 i‡((
dúp
 = 
	`›ídú
(
d«me
)Ë=
NULL
)

351 (
íç
 = 
	`ªaddú
(
dúp
)Ë!
NULL
) {

355 i‡(
	`°rcmp
(
íç
->
d_«me
, ".") == 0 ||

356 
	`°rcmp
(
íç
->
d_«me
, "..") == 0)

362 
	`•rötf
(
‚ame
, "%s/%s/%s", 
SPOOLDIR
, 
REQDIR
, 
íç
->
d_«me
);

363 i‡((
fd
 = 
	`›í
(
‚ame
, 
O_RDONLY
)) < 0)

365 
ƒ
 = 
	`ªad
(
fd
, &
ªq
, (
¥öåeq
));

366 i‡(
ƒ
 !(
¥öåeq
)) {

367 i‡(
ƒ
 < 0)

368 
îr
 = 
î∫o
;

370 
îr
 = 
EIO
;

371 
	`˛o£
(
fd
);

372 
	`log_msg
("build_qonstart: can'tÑead %s: %s",

373 
‚ame
, 
	`°ªº‹
(
îr
));

374 
	`u∆ök
(
‚ame
);

375 
	`•rötf
(
‚ame
, "%s/%s/%s", 
SPOOLDIR
, 
DATADIR
,

376 
íç
->
d_«me
);

377 
	`u∆ök
(
‚ame
);

380 
jobid
 = 
	`©ﬁ
(
íç
->
d_«me
);

381 
	`log_msg
("addög job %dÅÿqueue", 
jobid
);

382 
	`add_job
(&
ªq
, 
jobid
);

384 
	`˛o£dú
(
dúp
);

385 
	}
}

393 
	$˛õ¡_thªad
(*
¨g
)

395 
n
, 
fd
, 
sockfd
, 
ƒ
, 
nw
, 
fú°
;

396 
öt32_t
 
jobid
;

397 
±hªad_t
 
tid
;

398 
¥öåeq
 
ªq
;

399 
¥öåe•
 
ªs
;

400 
«me
[
FILENMSZ
];

401 
buf
[
IOBUFSZ
];

403 
tid
 = 
	`±hªad_£lf
();

404 
	`±hªad_˛ónup_push
(
˛õ¡_˛ónup
, (*)(()
tid
));

405 
sockfd
 = ()
¨g
;

406 
	`add_w‹kî
(
tid
, 
sockfd
);

411 i‡((
n
 = 
	`åódn
(
sockfd
, &
ªq
, (
¥öåeq
), 10)) !=

412 (
¥öåeq
)) {

413 
ªs
.
jobid
 = 0;

414 i‡(
n
 < 0)

415 
ªs
.
ªtcode
 = 
	`ht⁄l
(
î∫o
);

417 
ªs
.
ªtcode
 = 
	`ht⁄l
(
EIO
);

418 
	`°∫˝y
(
ªs
.
msg
, 
	`°ªº‹
‘es.
ªtcode
), 
MSGLEN_MAX
);

419 
	`wrôí
(
sockfd
, &
ªs
, (
¥öåe•
));

420 
	`±hªad_exô
((*)1);

422 
ªq
.
size
 = 
	`¡ohl
(req.size);

423 
ªq
.
Êags
 = 
	`¡ohl
(req.flags);

428 
jobid
 = 
	`gë_√wjobno
();

429 
	`•rötf
(
«me
, "%s/%s/%d", 
SPOOLDIR
, 
DATADIR
, 
jobid
);

430 
fd
 = 
	`¸ót
(
«me
, 
FILEPERM
);

431 i‡(
fd
 < 0) {

432 
ªs
.
jobid
 = 0;

433 
ªs
.
ªtcode
 = 
	`ht⁄l
(
î∫o
);

434 
	`log_msg
("˛õ¡_thªad: c™'à¸óã %s: %s", 
«me
,

435 
	`°ªº‹
(
ªs
.
ªtcode
));

436 
	`°∫˝y
(
ªs
.
msg
, 
	`°ªº‹
‘es.
ªtcode
), 
MSGLEN_MAX
);

437 
	`wrôí
(
sockfd
, &
ªs
, (
¥öåe•
));

438 
	`±hªad_exô
((*)1);

446 
fú°
 = 1;

447 (
ƒ
 = 
	`åód
(
sockfd
, 
buf
, 
IOBUFSZ
, 20)) > 0) {

448 i‡(
fú°
) {

449 
fú°
 = 0;

450 i‡(
	`°∫cmp
(
buf
, "%!PS", 4) != 0)

451 
ªq
.
Êags
 |
PR_TEXT
;

453 
nw
 = 
	`wrôe
(
fd
, 
buf
, 
ƒ
);

454 i‡(
nw
 !
ƒ
) {

455 
ªs
.
jobid
 = 0;

456 i‡(
nw
 < 0)

457 
ªs
.
ªtcode
 = 
	`ht⁄l
(
î∫o
);

459 
ªs
.
ªtcode
 = 
	`ht⁄l
(
EIO
);

460 
	`log_msg
("˛õ¡_thªad: c™'àwrôê%s: %s", 
«me
,

461 
	`°ªº‹
(
ªs
.
ªtcode
));

462 
	`˛o£
(
fd
);

463 
	`°∫˝y
(
ªs
.
msg
, 
	`°ªº‹
‘es.
ªtcode
), 
MSGLEN_MAX
);

464 
	`wrôí
(
sockfd
, &
ªs
, (
¥öåe•
));

465 
	`u∆ök
(
«me
);

466 
	`±hªad_exô
((*)1);

469 
	`˛o£
(
fd
);

476 
	`•rötf
(
«me
, "%s/%s/%d", 
SPOOLDIR
, 
REQDIR
, 
jobid
);

477 
fd
 = 
	`¸ót
(
«me
, 
FILEPERM
);

478 i‡(
fd
 < 0) {

479 
ªs
.
jobid
 = 0;

480 
ªs
.
ªtcode
 = 
	`ht⁄l
(
î∫o
);

481 
	`log_msg
("˛õ¡_thªad: c™'à¸óã %s: %s", 
«me
,

482 
	`°ªº‹
(
ªs
.
ªtcode
));

483 
	`°∫˝y
(
ªs
.
msg
, 
	`°ªº‹
‘es.
ªtcode
), 
MSGLEN_MAX
);

484 
	`wrôí
(
sockfd
, &
ªs
, (
¥öåe•
));

485 
	`•rötf
(
«me
, "%s/%s/%d", 
SPOOLDIR
, 
DATADIR
, 
jobid
);

486 
	`u∆ök
(
«me
);

487 
	`±hªad_exô
((*)1);

489 
nw
 = 
	`wrôe
(
fd
, &
ªq
, (
¥öåeq
));

490 i‡(
nw
 !(
¥öåeq
)) {

491 
ªs
.
jobid
 = 0;

492 i‡(
nw
 < 0)

493 
ªs
.
ªtcode
 = 
	`ht⁄l
(
î∫o
);

495 
ªs
.
ªtcode
 = 
	`ht⁄l
(
EIO
);

496 
	`log_msg
("˛õ¡_thªad: c™'àwrôê%s: %s", 
«me
,

497 
	`°ªº‹
(
ªs
.
ªtcode
));

498 
	`˛o£
(
fd
);

499 
	`°∫˝y
(
ªs
.
msg
, 
	`°ªº‹
‘es.
ªtcode
), 
MSGLEN_MAX
);

500 
	`wrôí
(
sockfd
, &
ªs
, (
¥öåe•
));

501 
	`u∆ök
(
«me
);

502 
	`•rötf
(
«me
, "%s/%s/%d", 
SPOOLDIR
, 
DATADIR
, 
jobid
);

503 
	`u∆ök
(
«me
);

504 
	`±hªad_exô
((*)1);

506 
	`˛o£
(
fd
);

511 
ªs
.
ªtcode
 = 0;

512 
ªs
.
jobid
 = 
	`ht⁄l
(jobid);

513 
	`•rötf
(
ªs
.
msg
, "ªque° ID %d", 
jobid
);

514 
	`wrôí
(
sockfd
, &
ªs
, (
¥öåe•
));

519 
	`log_msg
("addög job %dÅÿqueue", 
jobid
);

520 
	`add_job
(&
ªq
, 
jobid
);

521 
	`±hªad_˛ónup_p›
(1);

523 
	}
}

531 
	$add_w‹kî
(
±hªad_t
 
tid
, 
sockfd
)

533 
w‹kî_thªad
 *
wç
;

535 i‡((
wç
 = 
	`mÆloc
((
w‹kî_thªad
))Ë=
NULL
) {

536 
	`log_ªt
("add_worker: can't malloc");

537 
	`±hªad_exô
((*)1);

539 
wç
->
tid
 =Åid;

540 
wç
->
sockfd
 = sockfd;

541 
	`±hªad_muãx_lock
(&
w‹kîlock
);

542 
wç
->
¥ev
 = 
NULL
;

543 
wç
->
√xt
 = 
w‹kîs
;

544 i‡(
w‹kîs
 =
NULL
)

545 
w‹kîs
 = 
wç
;

547 
w‹kîs
->
¥ev
 = 
wç
;

548 
	`±hªad_muãx_u∆ock
(&
w‹kîlock
);

549 
	}
}

557 
	$kûl_w‹kîs
()

559 
w‹kî_thªad
 *
wç
;

561 
	`±hªad_muãx_lock
(&
w‹kîlock
);

562 
wç
 = 
w‹kîs
; wç !
NULL
; wç = wç->
√xt
)

563 
	`±hªad_ˇn˚l
(
wç
->
tid
);

564 
	`±hªad_muãx_u∆ock
(&
w‹kîlock
);

565 
	}
}

573 
	$˛õ¡_˛ónup
(*
¨g
)

575 
w‹kî_thªad
 *
wç
;

576 
±hªad_t
 
tid
;

578 
tid
 = (
±hªad_t
)(()
¨g
);

579 
	`±hªad_muãx_lock
(&
w‹kîlock
);

580 
wç
 = 
w‹kîs
; wç !
NULL
; wç = wç->
√xt
) {

581 i‡(
wç
->
tid
 ==Åid) {

582 i‡(
wç
->
√xt
 !
NULL
)

583 
wç
->
√xt
->
¥ev
 = wtp->prev;

584 i‡(
wç
->
¥ev
 !
NULL
)

585 
wç
->
¥ev
->
√xt
 = wtp->next;

587 
w‹kîs
 = 
wç
->
√xt
;

591 
	`±hªad_muãx_u∆ock
(&
w‹kîlock
);

592 i‡(
wç
 !
NULL
) {

593 
	`˛o£
(
wç
->
sockfd
);

594 
	`‰ì
(
wç
);

596 
	}
}

604 
	$sig«l_thªad
(*
¨g
)

606 
îr
, 
signo
;

609 
îr
 = 
	`sigwaô
(&
mask
, &
signo
);

610 i‡(
îr
 != 0)

611 
	`log_quô
("sigwaô faûed: %s", 
	`°ªº‹
(
îr
));

612 
signo
) {

613 
SIGHUP
:

617 
	`±hªad_muãx_lock
(&
c⁄figlock
);

618 
ªªad
 = 1;

619 
	`±hªad_muãx_u∆ock
(&
c⁄figlock
);

622 
SIGTERM
:

623 
	`kûl_w‹kîs
();

624 
	`log_msg
("ãrmö©êwôh sig«»%s", 
	`°rsig«l
(
signo
));

625 
	`exô
(0);

628 
	`kûl_w‹kîs
();

629 
	`log_quô
("u√x≥˘ed sig«»%d", 
signo
);

632 
	}
}

640 
	$add_›ti⁄
(*
˝
, 
èg
, *
›äame
, *
›tvÆ
)

642 
n
;

644 
öt16_t
 
s
;

645 
c
[2];

646 } 
u
;

648 *
˝
++ = 
èg
;

649 
n
 = 
	`°æí
(
›äame
);

650 
u
.
s
 = 
	`ht⁄s
(
n
);

651 *
˝
++ = 
u
.
c
[0];

652 *
˝
++ = 
u
.
c
[1];

653 
	`°r˝y
(
˝
, 
›äame
);

654 
˝
 +
n
;

655 
n
 = 
	`°æí
(
›tvÆ
);

656 
u
.
s
 = 
	`ht⁄s
(
n
);

657 *
˝
++ = 
u
.
c
[0];

658 *
˝
++ = 
u
.
c
[1];

659 
	`°r˝y
(
˝
, 
›tvÆ
);

660 (
˝
 + 
n
);

661 
	}
}

669 
	$¥öãr_thªad
(*
¨g
)

671 
job
 *
jp
;

672 
hÀn
, 
ûí
, 
sockfd
, 
fd
, 
ƒ
, 
nw
, 
exåa
;

673 *
i˝
, *
h˝
, *
p
;

674 
ùp_hdr
 *
hp
;

675 
°©
 
sbuf
;

676 
iovec
 
iov
[2];

677 
«me
[
FILENMSZ
];

678 
hbuf
[
HBUFSZ
];

679 
ibuf
[
IBUFSZ
];

680 
buf
[
IOBUFSZ
];

681 
°r
[64];

682 
time•ec
 
ts
 = { 60, 0 };

688 
	`±hªad_muãx_lock
(&
joblock
);

689 
jobhód
 =
NULL
) {

690 
	`log_msg
("printer_thread: waiting...");

691 
	`±hªad_c⁄d_waô
(&
jobwaô
, &
joblock
);

693 
	`ªmove_job
(
jp
 = 
jobhód
);

694 
	`log_msg
("¥öãr_thªad:Öicked u∞job %d", 
jp
->
jobid
);

695 
	`±hªad_muãx_u∆ock
(&
joblock
);

696 
	`upd©e_jobno
();

701 
	`±hªad_muãx_lock
(&
c⁄figlock
);

702 i‡(
ªªad
) {

703 
	`‰ìaddröfo
(
¥öãr
);

704 
¥öãr
 = 
NULL
;

705 
¥öãr_«me
 = 
NULL
;

706 
ªªad
 = 0;

707 
	`±hªad_muãx_u∆ock
(&
c⁄figlock
);

708 
	`öô_¥öãr
();

710 
	`±hªad_muãx_u∆ock
(&
c⁄figlock
);

716 
	`•rötf
(
«me
, "%s/%s/%d", 
SPOOLDIR
, 
DATADIR
, 
jp
->
jobid
);

717 i‡((
fd
 = 
	`›í
(
«me
, 
O_RDONLY
)) < 0) {

718 
	`log_msg
("job %d canceled - can't open %s: %s",

719 
jp
->
jobid
, 
«me
, 
	`°ªº‹
(
î∫o
));

720 
	`‰ì
(
jp
);

723 i‡(
	`f°©
(
fd
, &
sbuf
) < 0) {

724 
	`log_msg
("job %d canceled - can't fstat %s: %s",

725 
jp
->
jobid
, 
«me
, 
	`°ªº‹
(
î∫o
));

726 
	`‰ì
(
jp
);

727 
	`˛o£
(
fd
);

730 i‡((
sockfd
 = 
	`c⁄√˘_ªåy
(
AF_INET
, 
SOCK_STREAM
, 0,

731 
¥öãr
->
ai_addr
,Öröãr->
ai_addæí
)) < 0) {

732 
	`log_msg
("job %d deferred - can't contactÖrinter: %s",

733 
jp
->
jobid
, 
	`°ªº‹
(
î∫o
));

734 
de„r
;

740 
i˝
 = 
ibuf
;

741 
hp
 = (
ùp_hdr
 *)
i˝
;

742 
hp
->
maj‹_vîsi⁄
 = 1;

743 
hp
->
mö‹_vîsi⁄
 = 1;

744 
hp
->
›î©i⁄
 = 
	`ht⁄s
(
OP_PRINT_JOB
);

745 
hp
->
ªque°_id
 = 
	`ht⁄l
(
jp
->
jobid
);

746 
i˝
 +
	`off£tof
(
ùp_hdr
, 
©å_group
);

747 *
i˝
++ = 
TAG_OPERATION_ATTR
;

748 
i˝
 = 
	`add_›ti⁄
(i˝, 
TAG_CHARSET
, "attributes-charset",

750 
i˝
 = 
	`add_›ti⁄
(i˝, 
TAG_NATULANG
,

752 
	`•rötf
(
°r
, "hâp://%s/ùp", 
¥öãr_«me
);

753 
i˝
 = 
	`add_›ti⁄
(i˝, 
TAG_URI
, "¥öãr-uri", 
°r
);

754 
i˝
 = 
	`add_›ti⁄
(i˝, 
TAG_NAMEWOLANG
,

755 "ªque°ög-u£r-«me", 
jp
->
ªq
.
u£∫m
);

756 
i˝
 = 
	`add_›ti⁄
(i˝, 
TAG_NAMEWOLANG
, "job-name",

757 
jp
->
ªq
.
jobnm
);

758 i‡(
jp
->
ªq
.
Êags
 & 
PR_TEXT
) {

759 
p
 = "text/plain";

760 
exåa
 = 1;

762 
p
 = "application/postscript";

763 
exåa
 = 0;

765 
i˝
 = 
	`add_›ti⁄
(i˝, 
TAG_MIMETYPE
, "documít-f‹m©", 
p
);

766 *
i˝
++ = 
TAG_END_OF_ATTR
;

767 
ûí
 = 
i˝
 - 
ibuf
;

772 
h˝
 = 
hbuf
;

773 
	`•rötf
(
h˝
, "POST /ipp HTTP/1.1\r\n");

774 
h˝
 +
	`°æí
(hcp);

775 
	`•rötf
(
h˝
, "Content-Length: %ld\r\n",

776 ()
sbuf
.
°_size
 + 
ûí
 + 
exåa
);

777 
h˝
 +
	`°æí
(hcp);

778 
	`°r˝y
(
h˝
, "Content-Type:ápplication/ipp\r\n");

779 
h˝
 +
	`°æí
(hcp);

780 
	`•rötf
(
h˝
, "Ho°: %s:%d\r\n", 
¥öãr_«me
, 
IPP_PORT
);

781 
h˝
 +
	`°æí
(hcp);

782 *
h˝
++ = '\r';

783 *
h˝
++ = '\n';

784 
hÀn
 = 
h˝
 - 
hbuf
;

789 
iov
[0].
iov_ba£
 = 
hbuf
;

790 
iov
[0].
iov_Àn
 = 
hÀn
;

791 
iov
[1].
iov_ba£
 = 
ibuf
;

792 
iov
[1].
iov_Àn
 = 
ûí
;

793 i‡(
	`wrôev
(
sockfd
, 
iov
, 2Ë!
hÀn
 + 
ûí
) {

794 
	`log_ªt
("can't writeÅoÖrinter");

795 
de„r
;

798 i‡(
jp
->
ªq
.
Êags
 & 
PR_TEXT
) {

802 i‡(
	`wrôe
(
sockfd
, "\b", 1) != 1) {

803 
	`log_ªt
("can't writeÅoÖrinter");

804 
de„r
;

808 (
ƒ
 = 
	`ªad
(
fd
, 
buf
, 
IOBUFSZ
)) > 0) {

809 i‡((
nw
 = 
	`wrôí
(
sockfd
, 
buf
, 
ƒ
)) !=Çr) {

810 i‡(
nw
 < 0)

811 
	`log_ªt
("can't writeÅoÖrinter");

813 
	`log_msg
("sh‹àwrôê(%d/%dËtÿ¥öãr", 
nw
, 
ƒ
);

814 
de„r
;

817 i‡(
ƒ
 < 0) {

818 
	`log_ªt
("ˇn'àªad %s", 
«me
);

819 
de„r
;

825 i‡(
	`¥öãr_°©us
(
sockfd
, 
jp
)) {

826 
	`u∆ök
(
«me
);

827 
	`•rötf
(
«me
, "%s/%s/%d", 
SPOOLDIR
, 
REQDIR
, 
jp
->
jobid
);

828 
	`u∆ök
(
«me
);

829 
	`‰ì
(
jp
);

830 
jp
 = 
NULL
;

832 
de„r
:

833 
	`˛o£
(
fd
);

834 i‡(
sockfd
 >= 0)

835 
	`˛o£
(
sockfd
);

836 i‡(
jp
 !
NULL
) {

837 
	`ª∂a˚_job
(
jp
);

838 
	`«no¶ìp
(&
ts
, 
NULL
);

841 
	}
}

849 
ssize_t


850 
	$ªadm‹e
(
sockfd
, **
bµ
, 
off
, *
bszp
)

852 
ssize_t
 
ƒ
;

853 *
bp
 = *
bµ
;

854 
bsz
 = *
bszp
;

856 i‡(
off
 >
bsz
) {

857 
bsz
 +
IOBUFSZ
;

858 i‡((
bp
 = 
	`ªÆloc
(*
bµ
, 
bsz
)Ë=
NULL
)

859 
	`log_sys
("readmore: can'tállocate biggerÑead buffer");

860 *
bszp
 = 
bsz
;

861 *
bµ
 = 
bp
;

863 i‡((
ƒ
 = 
	`åód
(
sockfd
, &
bp
[
off
], 
bsz
-off, 1)) > 0)

864 (
off
+
ƒ
);

867 
	}
}

876 
	$¥öãr_°©us
(
sfd
, 
job
 *
jp
)

878 
i
, 
suc˚ss
, 
code
, 
Àn
, 
found
, 
bufsz
, 
d©sz
;

879 
öt32_t
 
jobid
;

880 
ssize_t
 
ƒ
;

881 *
bp
, *
˝
, *
°©code
, *
ªas⁄
, *
c⁄ã¡Àn
;

882 
ùp_hdr
 *
hp
;

889 
suc˚ss
 = 0;

890 
bufsz
 = 
IOBUFSZ
;

891 i‡((
bp
 = 
	`mÆloc
(
IOBUFSZ
)Ë=
NULL
)

892 
	`log_sys
("printer_status: can'tállocateÑead buffer");

894 (
ƒ
 = 
	`åód
(
sfd
, 
bp
, 
bufsz
, 5)) > 0) {

899 
˝
 = 
bp
 + 8;

900 
d©sz
 = 
ƒ
;

901 
	`is•a˚
(()*
˝
))

902 
˝
++;

903 
°©code
 = 
˝
;

904 
	`isdigô
(()*
˝
))

905 
˝
++;

906 i‡(
˝
 =
°©code
) {

907 
	`log_msg
(
bp
);

909 *
˝
++ = '\0';

910 
ªas⁄
 = 
˝
;

911 *
˝
 != '\r' && *cp != '\n')

912 
˝
++;

913 *
˝
 = '\0';

914 
code
 = 
	`©oi
(
°©code
);

915 i‡(
	`HTTP_INFO
(
code
))

917 i‡(!
	`HTTP_SUCCESS
(
code
)) {

918 
bp
[
d©sz
] = '\0';

919 
	`log_msg
("îr‹: %s", 
ªas⁄
);

927 
i
 = 
˝
 - 
bp
;

929 *
˝
 !'C' && *˝ !'c' && 
i
 < 
d©sz
) {

930 
˝
++;

931 
i
++;

933 i‡(
i
 >
d©sz
) {

934 i‡((
ƒ
 = 
	`ªadm‹e
(
sfd
, &
bp
, 
i
, &
bufsz
)) < 0) {

935 
out
;

937 
˝
 = &
bp
[
i
];

938 
d©sz
 +
ƒ
;

942 i‡(
	`°∫ˇ£cmp
(
˝
, "Content-Length:", 15) == 0) {

943 
˝
 += 15;

944 
	`is•a˚
(()*
˝
))

945 
˝
++;

946 
c⁄ã¡Àn
 = 
˝
;

947 
	`isdigô
(()*
˝
))

948 
˝
++;

949 *
˝
++ = '\0';

950 
i
 = 
˝
 - 
bp
;

951 
Àn
 = 
	`©oi
(
c⁄ã¡Àn
);

954 
˝
++;

955 
i
++;

958 i‡(
i
 >
d©sz
) {

959 i‡((
ƒ
 = 
	`ªadm‹e
(
sfd
, &
bp
, 
i
, &
bufsz
)) < 0) {

960 
out
;

962 
˝
 = &
bp
[
i
];

963 
d©sz
 +
ƒ
;

967 
found
 = 0;

968 !
found
) {

969 
i
 < 
d©sz
 - 2) {

970 i‡(*
˝
 == '\n' && *(cp + 1) == '\r' &&

971 *(
˝
 + 2) == '\n') {

972 
found
 = 1;

973 
˝
 += 3;

974 
i
 += 3;

977 
˝
++;

978 
i
++;

980 i‡(
i
 >
d©sz
) {

981 i‡((
ƒ
 = 
	`ªadm‹e
(
sfd
, &
bp
, 
i
, &
bufsz
)) < 0) {

982 
out
;

984 
˝
 = &
bp
[
i
];

985 
d©sz
 +
ƒ
;

990 i‡(
d©sz
 - 
i
 < 
Àn
) {

991 i‡((
ƒ
 = 
	`ªadm‹e
(
sfd
, &
bp
, 
i
, &
bufsz
)) < 0) {

992 
out
;

994 
˝
 = &
bp
[
i
];

995 
d©sz
 +
ƒ
;

999 
hp
 = (
ùp_hdr
 *)
˝
;

1000 
i
 = 
	`¡ohs
(
hp
->
°©us
);

1001 
jobid
 = 
	`¡ohl
(
hp
->
ªque°_id
);

1003 i‡(
jobid
 !
jp
->jobid) {

1007 
	`log_msg
("jobid %d sètu†codê%d", 
jobid
, 
i
);

1011 i‡(
	`STATCLASS_OK
(
i
))

1012 
suc˚ss
 = 1;

1017 
out
:

1018 
	`‰ì
(
bp
);

1019 i‡(
ƒ
 < 0) {

1020 
	`log_msg
("jobid %d:ÉrrorÑeadingÖrinterÑesponse: %s",

1021 
jobid
, 
	`°ªº‹
(
î∫o
));

1023 (
suc˚ss
);

1024 
	}
}

	@printer/util.c

1 
	~"≠ue.h
"

2 
	~"¥öt.h
"

3 
	~<˘y≥.h
>

4 
	~<sys/£À˘.h
>

6 
	#MAXCFGLINE
 512

	)

7 
	#MAXKWLEN
 16

	)

8 
	#MAXFMTLEN
 16

	)

19 
	$gëaddæi°
(c⁄° *
ho°
, c⁄° *
£rvi˚
,

20 
addröfo
 **
aûi°µ
)

22 
îr
;

23 
addröfo
 
höt
;

25 
höt
.
ai_Êags
 = 
AI_CANONNAME
;

26 
höt
.
ai_Ámûy
 = 
AF_INET
;

27 
höt
.
ai_sockty≥
 = 
SOCK_STREAM
;

28 
höt
.
ai_¥Ÿocﬁ
 = 0;

29 
höt
.
ai_addæí
 = 0;

30 
höt
.
ai_ˇn⁄«me
 = 
NULL
;

31 
höt
.
ai_addr
 = 
NULL
;

32 
höt
.
ai_√xt
 = 
NULL
;

33 
îr
 = 
	`gëaddröfo
(
ho°
, 
£rvi˚
, &
höt
, 
aûi°µ
);

34 (
îr
);

35 
	}
}

44 
	$sˇn_c⁄figfûe
(*
keyw‹d
)

46 
n
, 
m©ch
;

47 
FILE
 *
Â
;

48 
keybuf
[
MAXKWLEN
], 
∑âîn
[
MAXFMTLEN
];

49 
löe
[
MAXCFGLINE
];

50 
vÆbuf
[
MAXCFGLINE
];

52 i‡((
Â
 = 
	`f›í
(
CONFIG_FILE
, "r")Ë=
NULL
)

53 
	`log_sys
("ˇn'à›í %s", 
CONFIG_FILE
);

54 
	`•rötf
(
∑âîn
, "%%%d†%%%ds", 
MAXKWLEN
-1, 
MAXCFGLINE
-1);

55 
m©ch
 = 0;

56 
	`fgës
(
löe
, 
MAXCFGLINE
, 
Â
Ë!
NULL
) {

57 
n
 = 
	`ssˇnf
(
löe
, 
∑âîn
, 
keybuf
, 
vÆbuf
);

58 i‡(
n
 =2 && 
	`°rcmp
(
keyw‹d
, 
keybuf
) == 0) {

59 
m©ch
 = 1;

63 
	`f˛o£
(
Â
);

64 i‡(
m©ch
 != 0)

65 (
vÆbuf
);

67 (
NULL
);

68 
	}
}

76 
	$gë_¥öt£rvî
()

78 (
	`sˇn_c⁄figfûe
("printserver"));

79 
	}
}

86 
addröfo
 *

87 
	$gë_¥öèddr
()

89 
îr
;

90 *
p
;

91 
addröfo
 *
aûi°
;

93 i‡((
p
 = 
	`sˇn_c⁄figfûe
("¥öãr")Ë!
NULL
) {

94 i‡((
îr
 = 
	`gëaddæi°
(
p
, "ùp", &
aûi°
)) != 0) {

95 
	`log_msg
("nÿaddªs†öf‹m©i⁄ f‹ %s", 
p
);

96 (
NULL
);

98 (
aûi°
);

100 
	`log_msg
("noÖrinteráddress specified");

101 (
NULL
);

102 
	}
}

111 
ssize_t


112 
	$åód
(
fd
, *
buf
, 
size_t
 
nbyãs
, 
timout
)

114 
nfds
;

115 
fd_£t
 
ªadfds
;

116 
timevÆ
 
tv
;

118 
tv
.
tv_£c
 = 
timout
;

119 
tv
.
tv_u£c
 = 0;

120 
	`FD_ZERO
(&
ªadfds
);

121 
	`FD_SET
(
fd
, &
ªadfds
);

122 
nfds
 = 
	`£À˘
(
fd
+1, &
ªadfds
, 
NULL
, NULL, &
tv
);

123 i‡(
nfds
 <= 0) {

124 i‡(
nfds
 == 0)

125 
î∫o
 = 
ETIME
;

128 (
	`ªad
(
fd
, 
buf
, 
nbyãs
));

129 
	}
}

138 
ssize_t


139 
	$åódn
(
fd
, *
buf
, 
size_t
 
nbyãs
, 
timout
)

141 
size_t
 
∆e·
;

142 
ssize_t
 
ƒód
;

144 
∆e·
 = 
nbyãs
;

145 
∆e·
 > 0) {

146 i‡((
ƒód
 = 
	`åód
(
fd
, 
buf
, 
∆e·
, 
timout
)) < 0) {

147 i‡(
∆e·
 =
nbyãs
)

151 } i‡(
ƒód
 == 0) {

154 
∆e·
 -
ƒód
;

155 
buf
 +
ƒód
;

157 (
nbyãs
 - 
∆e·
);

158 
	}
}

	@proc/echoall.c

1 
	~"≠ue.h
"

4 
	$maö
(
¨gc
, *
¨gv
[])

6 
i
;

7 **
±r
;

8 **
ívú⁄
;

10 
i
 = 0; i < 
¨gc
; i++)

11 
	`¥ötf
("¨gv[%d]: %s\n", 
i
, 
¨gv
[i]);

13 
±r
 = 
ívú⁄
; *ptr != 0;Ötr++)

14 
	`¥ötf
("%s\n", *
±r
);

16 
	`exô
(0);

17 
	}
}

	@proc/exec1.c

1 
	~"≠ue.h
"

2 
	~<sys/waô.h
>

4 *
	gív_öô
[] = { "USER=unknown", "PATH=/tmp", 
NULL
 };

7 
	$maö
()

9 
pid_t
 
pid
;

11 i‡((
pid
 = 
	`f‹k
()) < 0) {

12 
	`îr_sys
("forkÉrror");

13 } i‡(
pid
 == 0) {

14 i‡(
	`exe˛e
("/home/sar/bin/echoall", "echoall", "myarg1",

15 "MY ARG2", (*)0, 
ív_öô
) < 0)

16 
	`îr_sys
("execleÉrror");

19 i‡(
	`waôpid
(
pid
, 
NULL
, 0) < 0)

20 
	`îr_sys
("waitÉrror");

22 i‡((
pid
 = 
	`f‹k
()) < 0) {

23 
	`îr_sys
("forkÉrror");

24 } i‡(
pid
 == 0) {

25 i‡(
	`exe˛p
("echoall", "echoall", "only 1árg", (*)0) < 0)

26 
	`îr_sys
("execlpÉrror");

29 
	`exô
(0);

30 
	}
}

	@proc/exec2.c

1 
	~"≠ue.h
"

2 
	~<sys/waô.h
>

5 
	$maö
()

7 
pid_t
 
pid
;

9 i‡((
pid
 = 
	`f‹k
()) < 0) {

10 
	`îr_sys
("forkÉrror");

11 } i‡(
pid
 == 0) {

12 i‡(
	`exe˛
("/home/sar/bin/testinterp",

14 
	`îr_sys
("execlÉrror");

16 i‡(
	`waôpid
(
pid
, 
NULL
, 0) < 0)

17 
	`îr_sys
("waitpidÉrror");

18 
	`exô
(0);

19 
	}
}

	@proc/fork1.c

1 
	~"≠ue.h
"

3 
	gglobv¨
 = 6;

4 
	gbuf
[] = "a writeÅo stdout\n";

7 
	$maö
()

9 
v¨
;

10 
pid_t
 
pid
;

12 
v¨
 = 88;

13 i‡(
	`wrôe
(
STDOUT_FILENO
, 
buf
, (buf)-1) != (buf)-1)

14 
	`îr_sys
("writeÉrror");

15 
	`¥ötf
("before fork\n");

17 i‡((
pid
 = 
	`f‹k
()) < 0) {

18 
	`îr_sys
("forkÉrror");

19 } i‡(
pid
 == 0) {

20 
globv¨
++;

21 
v¨
++;

23 
	`¶ìp
(2);

26 
	`¥ötf
("pid = %ld, glob = %d, v¨ = %d\n", ()
	`gëpid
(), 
globv¨
,

27 
v¨
);

28 
	`exô
(0);

29 
	}
}

	@proc/fork2.c

1 
	~"≠ue.h
"

2 
	~<sys/waô.h
>

5 
	$maö
()

7 
pid_t
 
pid
;

9 i‡((
pid
 = 
	`f‹k
()) < 0) {

10 
	`îr_sys
("forkÉrror");

11 } i‡(
pid
 == 0) {

12 i‡((
pid
 = 
	`f‹k
()) < 0)

13 
	`îr_sys
("forkÉrror");

14 i‡(
pid
 > 0)

15 
	`exô
(0);

23 
	`¶ìp
(2);

24 
	`¥ötf
("£c⁄d chûd,Ö¨íàpid = %ld\n", ()
	`gëµid
());

25 
	`exô
(0);

28 i‡(
	`waôpid
(
pid
, 
NULL
, 0) !=Öid)

29 
	`îr_sys
("waitpidÉrror");

35 
	`exô
(0);

36 
	}
}

	@proc/nice.c

1 
	~"≠ue.h
"

2 
	~<î∫o.h
>

3 
	~<sys/time.h
>

5 #i‡
deföed
(
MACOS
)

6 
	~<sys/sy¶imôs.h
>

7 #ñi‡
deföed
(
SOLARIS
)

8 
	~<limôs.h
>

9 #ñi‡
deföed
(
BSD
)

10 
	~<sys/∑øm.h
>

13 
	gcou¡
;

14 
timevÆ
 
	gíd
;

17 
	$checktime
(*
°r
)

19 
timevÆ
 
tv
;

21 
	`gëtimeofday
(&
tv
, 
NULL
);

22 i‡(
tv
.
tv_£c
 >
íd
.tv_£¯&&Åv.
tv_u£c
 >=Énd.tv_usec) {

23 
	`¥ötf
("%†cou¡ = %Œd\n", 
°r
, 
cou¡
);

24 
	`exô
(0);

26 
	}
}

29 
	$maö
(
¨gc
, *
¨gv
[])

31 
pid_t
 
pid
;

32 *
s
;

33 
nzîo
, 
ªt
;

34 
adj
 = 0;

36 
	`£tbuf
(
°dout
, 
NULL
);

37 #i‡
	`deföed
(
NZERO
)

38 
nzîo
 = 
NZERO
;

39 #ñi‡
	`deföed
(
_SC_NZERO
)

40 
nzîo
 = 
	`sysc⁄f
(
_SC_NZERO
);

42 #îr‹ 
NZERO
 
undeföed


44 
	`¥ötf
("NZERO = %d\n", 
nzîo
);

45 i‡(
¨gc
 == 2)

46 
adj
 = 
	`°πﬁ
(
¨gv
[1], 
NULL
, 10);

47 
	`gëtimeofday
(&
íd
, 
NULL
);

48 
íd
.
tv_£c
 += 10;

50 i‡((
pid
 = 
	`f‹k
()) < 0) {

51 
	`îr_sys
("fork failed");

52 } i‡(
pid
 == 0) {

53 
s
 = "child";

54 
	`¥ötf
("currentÇice value in child is %d,ádjusting by %d\n",

55 
	`ni˚
(0)+
nzîo
, 
adj
);

56 
î∫o
 = 0;

57 i‡((
ªt
 = 
	`ni˚
(
adj
)Ë=-1 && 
î∫o
 != 0)

58 
	`îr_sys
("child set schedulingÖriority");

59 
	`¥ötf
("now chûdÇi˚ vÆuêi†%d\n", 
ªt
+
nzîo
);

61 
s
 = "parent";

62 
	`¥ötf
("cuºíàni˚ vÆuêöÖ¨íài†%d\n", 
	`ni˚
(0)+
nzîo
);

65 i‡(++
cou¡
 == 0)

66 
	`îr_quô
("%†cou¡î wøp", 
s
);

67 
	`checktime
(
s
);

69 
	}
}

	@proc/pracct.c

1 
	~"≠ue.h
"

2 
	~<sys/ac˘.h
>

4 #i‡
deföed
(
BSD
)

5 
	#ac˘
 
ac˘v2


	)

6 
	#ac_Êag
 
ac_åaûî
.
ac_Êag


	)

7 
	#FMT
 "%-*.*†É = %.0f, ch¨†%.0f, %¯%¯%¯%c\n"

	)

8 #ñi‡
deföed
(
HAS_AC_STAT
)

9 
	#FMT
 "%-*.*†É = %6ld, ch¨†%7ld, sèà%3u: %¯%¯%¯%c\n"

	)

11 
	#FMT
 "%-*.*†É = %6ld, ch¨†%7ld, %¯%¯%¯%c\n"

	)

13 #i‡
deföed
(
LINUX
)

14 
	#ac˘
 
ac˘_v3


	)

17 #i‡!
deföed
(
HAS_ACORE
)

18 
	#ACORE
 0

	)

20 #i‡!
deföed
(
HAS_AXSIG
)

21 
	#AXSIG
 0

	)

24 #i‡!
deföed
(
BSD
)

26 
	$com±2ul⁄g
(
comp_t
 
com±ime
)

28 
vÆ
;

29 
exp
;

31 
vÆ
 = 
com±ime
 & 0x1fff;

32 
exp
 = (
com±ime
 >> 13) & 7;

33 
exp
-- > 0)

34 
vÆ
 *= 8;

35 (
vÆ
);

36 
	}
}

40 
	$maö
(
¨gc
, *
¨gv
[])

42 
ac˘
 
acd©a
;

43 
FILE
 *
Â
;

45 i‡(
¨gc
 != 2)

46 
	`îr_quô
("usage:Öracct filename");

47 i‡((
Â
 = 
	`f›í
(
¨gv
[1], "r")Ë=
NULL
)

48 
	`îr_sys
("ˇn'à›í %s", 
¨gv
[1]);

49 
	`‰ód
(&
acd©a
, ◊cd©a), 1, 
Â
) == 1) {

50 
	`¥ötf
(
FMT
, ()(
acd©a
.
ac_comm
),

51 ()(
acd©a
.
ac_comm
),ácdata.ac_comm,

52 #i‡
	`deföed
(
BSD
)

53 
acd©a
.
ac_ëime
,ácd©a.
ac_io
,

55 
	`com±2ul⁄g
(
acd©a
.
ac_ëime
), com±2ul⁄g◊cd©a.
ac_io
),

57 #i‡
	`deföed
(
HAS_AC_STAT
)

58 (Ë
acd©a
.
ac_°©
,

60 
acd©a
.
ac_Êag
 & 
ACORE
 ? 'D' : ' ',

61 
acd©a
.
ac_Êag
 & 
AXSIG
 ? 'X' : ' ',

62 
acd©a
.
ac_Êag
 & 
AFORK
 ? 'F' : ' ',

63 
acd©a
.
ac_Êag
 & 
ASU
 ? 'S' : ' ');

65 i‡(
	`„º‹
(
Â
))

66 
	`îr_sys
("readÉrror");

67 
	`exô
(0);

68 
	}
}

	@proc/pruids.c

1 
	~"≠ue.h
"

4 
	$maö
()

6 
	`¥ötf
("ªÆ uid = %d,Éf„˘ivêuid = %d\n", 
	`gëuid
(), 
	`gëeuid
());

7 
	`exô
(0);

8 
	}
}

	@proc/system.c

1 
	~<sys/waô.h
>

2 
	~<î∫o.h
>

3 
	~<uni°d.h
>

6 
	$sy°em
(c⁄° *
cmd°rög
)

8 
pid_t
 
pid
;

9 
°©us
;

11 i‡(
cmd°rög
 =
NULL
)

14 i‡((
pid
 = 
	`f‹k
()) < 0) {

15 
°©us
 = -1;

16 } i‡(
pid
 == 0) {

17 
	`exe˛
("/bö/sh", "sh", "-c", 
cmd°rög
, (*)0);

18 
	`_exô
(127);

20 
	`waôpid
(
pid
, &
°©us
, 0) < 0) {

21 i‡(
î∫o
 !
EINTR
) {

22 
°©us
 = -1;

28 (
°©us
);

29 
	}
}

	@proc/systest1.c

1 
	~"≠ue.h
"

2 
	~<sys/waô.h
>

5 
	$maö
()

7 
°©us
;

9 i‡((
°©us
 = 
	`sy°em
("date")) < 0)

10 
	`îr_sys
("system()Érror");

12 
	`¥_exô
(
°©us
);

14 i‡((
°©us
 = 
	`sy°em
("nosuchcommand")) < 0)

15 
	`îr_sys
("system()Érror");

17 
	`¥_exô
(
°©us
);

19 i‡((
°©us
 = 
	`sy°em
("who;Éxit 44")) < 0)

20 
	`îr_sys
("system()Érror");

22 
	`¥_exô
(
°©us
);

24 
	`exô
(0);

25 
	}
}

	@proc/systest3.c

1 
	~"≠ue.h
"

4 
	$maö
(
¨gc
, *
¨gv
[])

6 
°©us
;

8 i‡(
¨gc
 < 2)

9 
	`îr_quô
("command-lineárgumentÑequired");

11 i‡((
°©us
 = 
	`sy°em
(
¨gv
[1])) < 0)

12 
	`îr_sys
("system()Érror");

14 
	`¥_exô
(
°©us
);

16 
	`exô
(0);

17 
	}
}

	@proc/tellwait1.c

1 
	~"≠ue.h
"

3 
ch¨©©ime
(*);

6 
	$maö
()

8 
pid_t
 
pid
;

10 i‡((
pid
 = 
	`f‹k
()) < 0) {

11 
	`îr_sys
("forkÉrror");

12 } i‡(
pid
 == 0) {

13 
	`ch¨©©ime
("output from child\n");

15 
	`ch¨©©ime
("output fromÖarent\n");

17 
	`exô
(0);

18 
	}
}

21 
	$ch¨©©ime
(*
°r
)

23 *
±r
;

24 
c
;

26 
	`£tbuf
(
°dout
, 
NULL
);

27 
±r
 = 
°r
; (
c
 = *ptr++) != 0; )

28 
	`putc
(
c
, 
°dout
);

29 
	}
}

	@proc/tellwait2.c

1 
	~"≠ue.h
"

3 
ch¨©©ime
(*);

6 
	$maö
()

8 
pid_t
 
pid
;

10 
	`TELL_WAIT
();

12 i‡((
pid
 = 
	`f‹k
()) < 0) {

13 
	`îr_sys
("forkÉrror");

14 } i‡(
pid
 == 0) {

15 
	`WAIT_PARENT
();

16 
	`ch¨©©ime
("output from child\n");

18 
	`ch¨©©ime
("output fromÖarent\n");

19 
	`TELL_CHILD
(
pid
);

21 
	`exô
(0);

22 
	}
}

25 
	$ch¨©©ime
(*
°r
)

27 *
±r
;

28 
c
;

30 
	`£tbuf
(
°dout
, 
NULL
);

31 
±r
 = 
°r
; (
c
 = *ptr++) != 0; )

32 
	`putc
(
c
, 
°dout
);

33 
	}
}

	@proc/test1.c

1 
	~"≠ue.h
"

4 
	$maö
()

6 
pid_t
 
pid
;

8 i‡((
pid
 = 
	`f‹k
()) < 0)

9 
	`îr_sys
("forkÉrror");

10 i‡(
pid
 != 0) {

11 
	`¶ìp
(2);

12 
	`exô
(2);

15 i‡((
pid
 = 
	`f‹k
()) < 0)

16 
	`îr_sys
("forkÉrror");

17 i‡(
pid
 != 0) {

18 
	`¶ìp
(4);

19 
	`ab‹t
();

22 i‡((
pid
 = 
	`f‹k
()) < 0)

23 
	`îr_sys
("forkÉrror");

24 i‡(
pid
 != 0) {

25 
	`exe˛
("/bö/dd", "dd", "if=/ëc/∑sswd", "of=/dev/nuŒ", 
NULL
);

26 
	`exô
(7);

29 i‡((
pid
 = 
	`f‹k
()) < 0)

30 
	`îr_sys
("forkÉrror");

31 i‡(
pid
 != 0) {

32 
	`¶ìp
(8);

33 
	`exô
(0);

36 
	`¶ìp
(6);

37 
	`kûl
(
	`gëpid
(), 
SIGKILL
);

38 
	`exô
(6);

39 
	}
}

	@proc/times1.c

1 
	~"≠ue.h
"

2 
	~<sys/times.h
>

4 
¥_times
(
˛ock_t
, 
tms
 *, tms *);

5 
do_cmd
(*);

8 
	$maö
(
¨gc
, *
¨gv
[])

10 
i
;

12 
	`£tbuf
(
°dout
, 
NULL
);

13 
i
 = 1; i < 
¨gc
; i++)

14 
	`do_cmd
(
¨gv
[
i
]);

15 
	`exô
(0);

16 
	}
}

19 
	$do_cmd
(*
cmd
)

21 
tms
 
tms°¨t
, 
tm£nd
;

22 
˛ock_t
 
°¨t
, 
íd
;

23 
°©us
;

25 
	`¥ötf
("\ncomm™d: %s\n", 
cmd
);

27 i‡((
°¨t
 = 
	`times
(&
tms°¨t
)) == -1)

28 
	`îr_sys
("timesÉrror");

30 i‡((
°©us
 = 
	`sy°em
(
cmd
)) < 0)

31 
	`îr_sys
("system()Érror");

33 i‡((
íd
 = 
	`times
(&
tm£nd
)) == -1)

34 
	`îr_sys
("timesÉrror");

36 
	`¥_times
(
íd
-
°¨t
, &
tms°¨t
, &
tm£nd
);

37 
	`¥_exô
(
°©us
);

38 
	}
}

41 
	$¥_times
(
˛ock_t
 
ªÆ
, 
tms
 *
tms°¨t
, tm†*
tm£nd
)

43 
˛ktck
 = 0;

45 i‡(
˛ktck
 == 0)

46 i‡((
˛ktck
 = 
	`sysc⁄f
(
_SC_CLK_TCK
)) < 0)

47 
	`îr_sys
("sysconfÉrror");

49 
	`¥ötf
("Ñól: %7.2f\n", 
ªÆ
 / (Ë
˛ktck
);

50 
	`¥ötf
(" user: %7.2f\n",

51 (
tm£nd
->
tms_utime
 - 
tms°¨t
->tms_utimeË/ (Ë
˛ktck
);

52 
	`¥ötf
(" sys: %7.2f\n",

53 (
tm£nd
->
tms_°ime
 - 
tms°¨t
->tms_°imeË/ (Ë
˛ktck
);

54 
	`¥ötf
(" child user: %7.2f\n",

55 (
tm£nd
->
tms_cutime
 - 
tms°¨t
->tms_cutimeË/ (Ë
˛ktck
);

56 
	`¥ötf
(" child sys: %7.2f\n",

57 (
tm£nd
->
tms_c°ime
 - 
tms°¨t
->tms_c°imeË/ (Ë
˛ktck
);

58 
	}
}

	@proc/vfork1.c

1 
	~"≠ue.h
"

3 
	gglobv¨
 = 6;

6 
	$maö
()

8 
v¨
;

9 
pid_t
 
pid
;

11 
v¨
 = 88;

12 
	`¥ötf
("before vfork\n");

13 i‡((
pid
 = 
	`vf‹k
()) < 0) {

14 
	`îr_sys
("vforkÉrror");

15 } i‡(
pid
 == 0) {

16 
globv¨
++;

17 
v¨
++;

18 
	`_exô
(0);

22 
	`¥ötf
("pid = %ld, glob = %d, v¨ = %d\n", ()
	`gëpid
(), 
globv¨
,

23 
v¨
);

24 
	`exô
(0);

25 
	}
}

	@proc/wait1.c

1 
	~"≠ue.h
"

2 
	~<sys/waô.h
>

5 
	$maö
()

7 
pid_t
 
pid
;

8 
°©us
;

10 i‡((
pid
 = 
	`f‹k
()) < 0)

11 
	`îr_sys
("forkÉrror");

12 i‡(
pid
 == 0)

13 
	`exô
(7);

15 i‡(
	`waô
(&
°©us
Ë!
pid
)

16 
	`îr_sys
("waitÉrror");

17 
	`¥_exô
(
°©us
);

19 i‡((
pid
 = 
	`f‹k
()) < 0)

20 
	`îr_sys
("forkÉrror");

21 i‡(
pid
 == 0)

22 
	`ab‹t
();

24 i‡(
	`waô
(&
°©us
Ë!
pid
)

25 
	`îr_sys
("waitÉrror");

26 
	`¥_exô
(
°©us
);

28 i‡((
pid
 = 
	`f‹k
()) < 0)

29 
	`îr_sys
("forkÉrror");

30 i‡(
pid
 == 0)

31 
°©us
 /= 0;

33 i‡(
	`waô
(&
°©us
Ë!
pid
)

34 
	`îr_sys
("waitÉrror");

35 
	`¥_exô
(
°©us
);

37 
	`exô
(0);

38 
	}
}

	@pty/driver.c

1 
	~"≠ue.h
"

4 
	$do_drivî
(*
drivî
)

6 
pid_t
 
chûd
;

7 
pùe
[2];

12 i‡(
	`fd_pùe
(
pùe
) < 0)

13 
	`îr_sys
("can't create streamÖipe");

15 i‡((
chûd
 = 
	`f‹k
()) < 0) {

16 
	`îr_sys
("forkÉrror");

17 } i‡(
chûd
 == 0) {

18 
	`˛o£
(
pùe
[1]);

21 i‡(
	`dup2
(
pùe
[0], 
STDIN_FILENO
) != STDIN_FILENO)

22 
	`îr_sys
("dup2ÉrrorÅo stdin");

25 i‡(
	`dup2
(
pùe
[0], 
STDOUT_FILENO
) != STDOUT_FILENO)

26 
	`îr_sys
("dup2ÉrrorÅo stdout");

27 i‡(
pùe
[0] !
STDIN_FILENO
 &&Öùe[0] !
STDOUT_FILENO
)

28 
	`˛o£
(
pùe
[0]);

31 
	`exe˛p
(
drivî
, driver, (*)0);

32 
	`îr_sys
("exe˛∞îr‹ f‹: %s", 
drivî
);

35 
	`˛o£
(
pùe
[0]);

36 i‡(
	`dup2
(
pùe
[1], 
STDIN_FILENO
) != STDIN_FILENO)

37 
	`îr_sys
("dup2ÉrrorÅo stdin");

38 i‡(
	`dup2
(
pùe
[1], 
STDOUT_FILENO
) != STDOUT_FILENO)

39 
	`îr_sys
("dup2ÉrrorÅo stdout");

40 i‡(
pùe
[1] !
STDIN_FILENO
 &&Öùe[1] !
STDOUT_FILENO
)

41 
	`˛o£
(
pùe
[1]);

47 
	}
}

	@pty/loop.c

1 
	~"≠ue.h
"

3 
	#BUFFSIZE
 512

	)

5 
sig_ãrm
();

6 vﬁ©ûê
sig_©omic_t
 
	gsigˇught
;

9 
	$lo›
(
±ym
, 
ign‹ìof
)

11 
pid_t
 
chûd
;

12 
ƒód
;

13 
buf
[
BUFFSIZE
];

15 i‡((
chûd
 = 
	`f‹k
()) < 0) {

16 
	`îr_sys
("forkÉrror");

17 } i‡(
chûd
 == 0) {

19 i‡((
ƒód
 = 
	`ªad
(
STDIN_FILENO
, 
buf
, 
BUFFSIZE
)) < 0)

20 
	`îr_sys
("readÉrror from stdin");

21 i‡(
ƒód
 == 0)

23 i‡(
	`wrôí
(
±ym
, 
buf
, 
ƒód
) !=Çread)

24 
	`îr_sys
("writenÉrrorÅo masterÖty");

31 i‡(
ign‹ìof
 == 0)

32 
	`kûl
(
	`gëµid
(), 
SIGTERM
);

33 
	`exô
(0);

39 i‡(
	`sig«l_öå
(
SIGTERM
, 
sig_ãrm
Ë=
SIG_ERR
)

40 
	`îr_sys
("signal_intrÉrror for SIGTERM");

43 i‡((
ƒód
 = 
	`ªad
(
±ym
, 
buf
, 
BUFFSIZE
)) <= 0)

45 i‡(
	`wrôí
(
STDOUT_FILENO
, 
buf
, 
ƒód
) !=Çread)

46 
	`îr_sys
("writenÉrrorÅo stdout");

54 i‡(
sigˇught
 == 0)

55 
	`kûl
(
chûd
, 
SIGTERM
);

60 
	}
}

67 
	$sig_ãrm
(
signo
)

69 
sigˇught
 = 1;

70 
	}
}

	@pty/main.c

1 
	~"≠ue.h
"

2 
	~<ãrmios.h
>

4 #ifde‡
LINUX


5 
	#OPTSTR
 "+d:eöv"

	)

7 
	#OPTSTR
 "d:eöv"

	)

10 
£t_n€cho
();

11 
do_drivî
(*);

12 
lo›
(, );

15 
	$maö
(
¨gc
, *
¨gv
[])

17 
fdm
, 
c
, 
ign‹ìof
, 
öãø˘ive
, 
n€cho
, 
vîbo£
;

18 
pid_t
 
pid
;

19 *
drivî
;

20 
¶ave_«me
[20];

21 
ãrmios
 
‹ig_ãrmios
;

22 
wösize
 
size
;

24 
öãø˘ive
 = 
	`ißây
(
STDIN_FILENO
);

25 
ign‹ìof
 = 0;

26 
n€cho
 = 0;

27 
vîbo£
 = 0;

28 
drivî
 = 
NULL
;

30 
›ãº
 = 0;

31 (
c
 = 
	`gë›t
(
¨gc
, 
¨gv
, 
OPTSTR
)Ë!
EOF
) {

32 
c
) {

34 
drivî
 = 
›èrg
;

38 
n€cho
 = 1;

42 
ign‹ìof
 = 1;

46 
öãø˘ive
 = 0;

50 
vîbo£
 = 1;

54 
	`îr_quô
("uƒecognized o±i⁄: -%c", 
›t›t
);

57 i‡(
›töd
 >
¨gc
)

58 
	`îr_quô
("usage:Öty [ -d driver -einv ]Örogram [árg ... ]");

60 i‡(
öãø˘ive
) {

61 i‡(
	`tcgë©å
(
STDIN_FILENO
, &
‹ig_ãrmios
) < 0)

62 
	`îr_sys
("tcgetattrÉrror on stdin");

63 i‡(
	`io˘l
(
STDIN_FILENO
, 
TIOCGWINSZ
, (*Ë&
size
) < 0)

64 
	`îr_sys
("TIOCGWINSZÉrror");

65 
pid
 = 
	`±y_f‹k
(&
fdm
, 
¶ave_«me
, (slave_name),

66 &
‹ig_ãrmios
, &
size
);

68 
pid
 = 
	`±y_f‹k
(&
fdm
, 
¶ave_«me
, (slave_name),

69 
NULL
, NULL);

72 i‡(
pid
 < 0) {

73 
	`îr_sys
("forkÉrror");

74 } i‡(
pid
 == 0) {

75 i‡(
n€cho
)

76 
	`£t_n€cho
(
STDIN_FILENO
);

78 i‡(
	`execvp
(
¨gv
[
›töd
], &argv[optind]) < 0)

79 
	`îr_sys
("ˇn'àexecuã: %s", 
¨gv
[
›töd
]);

82 i‡(
vîbo£
) {

83 
	`Ârötf
(
°dîr
, "¶avê«mê%s\n", 
¶ave_«me
);

84 i‡(
drivî
 !
NULL
)

85 
	`Ârötf
(
°dîr
, "drivî = %s\n", 
drivî
);

88 i‡(
öãø˘ive
 && 
drivî
 =
NULL
) {

89 i‡(
	`ây_øw
(
STDIN_FILENO
) < 0)

90 
	`îr_sys
("tty_rawÉrror");

91 i‡(
	`©exô
(
ây_©exô
) < 0)

92 
	`îr_sys
("atexitÉrror");

95 i‡(
drivî
)

96 
	`do_drivî
(
drivî
);

98 
	`lo›
(
fdm
, 
ign‹ìof
);

100 
	`exô
(0);

101 
	}
}

104 
	$£t_n€cho
(
fd
)

106 
ãrmios
 
°îmios
;

108 i‡(
	`tcgë©å
(
fd
, &
°îmios
) < 0)

109 
	`îr_sys
("tcgetattrÉrror");

111 
°îmios
.
c_lÊag
 &~(
ECHO
 | 
ECHOE
 | 
ECHOK
 | 
ECHONL
);

116 
°îmios
.
c_oÊag
 &~(
ONLCR
);

118 i‡(
	`tc£èâr
(
fd
, 
TCSANOW
, &
°îmios
) < 0)

119 
	`îr_sys
("tcsetattrÉrror");

120 
	}
}

	@relation/orphan3.c

1 
	~"≠ue.h
"

2 
	~<î∫o.h
>

5 
	$sig_hup
(
signo
)

7 
	`¥ötf
("SIGHUPÑe˚ived,Öid = %ld\n", ()
	`gëpid
());

8 
	}
}

11 
	$¥_ids
(*
«me
)

13 
	`¥ötf
("%s:Öid = %ld,Öpid = %ld,Ögrp = %ld,Åpgrp = %ld\n",

14 
«me
, ()
	`gëpid
(), ()
	`gëµid
(), ()
	`gëpgΩ
(),

15 ()
	`tcgëpgΩ
(
STDIN_FILENO
));

16 
	`fÊush
(
°dout
);

17 
	}
}

20 
	$maö
()

22 
c
;

23 
pid_t
 
pid
;

25 
	`¥_ids
("parent");

26 i‡((
pid
 = 
	`f‹k
()) < 0) {

27 
	`îr_sys
("forkÉrror");

28 } i‡(
pid
 > 0) {

29 
	`¶ìp
(5);

31 
	`¥_ids
("child");

32 
	`sig«l
(
SIGHUP
, 
sig_hup
);

33 
	`kûl
(
	`gëpid
(), 
SIGTSTP
);

34 
	`¥_ids
("child");

35 i‡(
	`ªad
(
STDIN_FILENO
, &
c
, 1) != 1)

36 
	`¥ötf
("ªadÉº‹ %d o¿c⁄åﬁlög TTY\n", 
î∫o
);

38 
	`exô
(0);

39 
	}
}

	@signals/abort.c

1 
	~<sig«l.h
>

2 
	~<°dio.h
>

3 
	~<°dlib.h
>

4 
	~<uni°d.h
>

7 
	$ab‹t
()

9 
sig£t_t
 
mask
;

10 
siga˘i⁄
 
a˘i⁄
;

13 
	`siga˘i⁄
(
SIGABRT
, 
NULL
, &
a˘i⁄
);

14 i‡(
a˘i⁄
.
ß_h™dÀr
 =
SIG_IGN
) {

15 
a˘i⁄
.
ß_h™dÀr
 = 
SIG_DFL
;

16 
	`siga˘i⁄
(
SIGABRT
, &
a˘i⁄
, 
NULL
);

18 i‡(
a˘i⁄
.
ß_h™dÀr
 =
SIG_DFL
)

19 
	`fÊush
(
NULL
);

22 
	`sigfûl£t
(&
mask
);

23 
	`sigdñ£t
(&
mask
, 
SIGABRT
);

24 
	`sig¥ocmask
(
SIG_SETMASK
, &
mask
, 
NULL
);

25 
	`kûl
(
	`gëpid
(), 
SIGABRT
);

28 
	`fÊush
(
NULL
);

29 
a˘i⁄
.
ß_h™dÀr
 = 
SIG_DFL
;

30 
	`siga˘i⁄
(
SIGABRT
, &
a˘i⁄
, 
NULL
);

31 
	`sig¥ocmask
(
SIG_SETMASK
, &
mask
, 
NULL
);

32 
	`kûl
(
	`gëpid
(), 
SIGABRT
);

33 
	`exô
(1);

34 
	}
}

	@signals/child.c

1 
	~"≠ue.h
"

2 
	~<sys/waô.h
>

4 
sig_˛d
();

7 
	$maö
()

9 
pid_t
 
pid
;

11 i‡(
	`sig«l
(
SIGCLD
, 
sig_˛d
Ë=
SIG_ERR
)

12 
	`≥º‹
("signalÉrror");

13 i‡((
pid
 = 
	`f‹k
()) < 0) {

14 
	`≥º‹
("forkÉrror");

15 } i‡(
pid
 == 0) {

16 
	`¶ìp
(2);

17 
	`_exô
(0);

20 
	`∑u£
();

21 
	`exô
(0);

22 
	}
}

25 
	$sig_˛d
(
signo
)

27 
pid_t
 
pid
;

28 
°©us
;

30 
	`¥ötf
("SIGCLDÑeceived\n");

32 i‡(
	`sig«l
(
SIGCLD
, 
sig_˛d
Ë=
SIG_ERR
)

33 
	`≥º‹
("signalÉrror");

35 i‡((
pid
 = 
	`waô
(&
°©us
)) < 0)

36 
	`≥º‹
("waitÉrror");

38 
	`¥ötf
("pid = %d\n", 
pid
);

39 
	}
}

	@signals/critical.c

1 
	~"≠ue.h
"

3 
sig_quô
();

6 
	$maö
()

8 
sig£t_t
 
√wmask
, 
ﬁdmask
, 
≥ndmask
;

10 i‡(
	`sig«l
(
SIGQUIT
, 
sig_quô
Ë=
SIG_ERR
)

11 
	`îr_sys
("can't catch SIGQUIT");

16 
	`sigem±y£t
(&
√wmask
);

17 
	`sigadd£t
(&
√wmask
, 
SIGQUIT
);

18 i‡(
	`sig¥ocmask
(
SIG_BLOCK
, &
√wmask
, &
ﬁdmask
) < 0)

19 
	`îr_sys
("SIG_BLOCKÉrror");

21 
	`¶ìp
(5);

23 i‡(
	`sig≥ndög
(&
≥ndmask
) < 0)

24 
	`îr_sys
("sigpendingÉrror");

25 i‡(
	`sigismembî
(&
≥ndmask
, 
SIGQUIT
))

26 
	`¥ötf
("\nSIGQUITÖending\n");

31 i‡(
	`sig¥ocmask
(
SIG_SETMASK
, &
ﬁdmask
, 
NULL
) < 0)

32 
	`îr_sys
("SIG_SETMASKÉrror");

33 
	`¥ötf
("SIGQUIT unblocked\n");

35 
	`¶ìp
(5);

36 
	`exô
(0);

37 
	}
}

40 
	$sig_quô
(
signo
)

42 
	`¥ötf
("caught SIGQUIT\n");

43 i‡(
	`sig«l
(
SIGQUIT
, 
SIG_DFL
Ë=
SIG_ERR
)

44 
	`îr_sys
("can'tÑeset SIGQUIT");

45 
	}
}

	@signals/mask.c

1 
	~"≠ue.h
"

2 
	~<£tjmp.h
>

3 
	~<time.h
>

5 
sig_u§1
();

6 
sig_Ærm
();

7 
sigjmp_buf
 
	gjmpbuf
;

8 vﬁ©ûê
sig_©omic_t
 
	gˇnjump
;

11 
	$maö
()

13 i‡(
	`sig«l
(
SIGUSR1
, 
sig_u§1
Ë=
SIG_ERR
)

14 
	`îr_sys
("signal(SIGUSR1)Érror");

15 i‡(
	`sig«l
(
SIGALRM
, 
sig_Ærm
Ë=
SIG_ERR
)

16 
	`îr_sys
("signal(SIGALRM)Érror");

18 
	`¥_mask
("starting main: ");

20 i‡(
	`sig£tjmp
(
jmpbuf
, 1)) {

22 
	`¥_mask
("ending main: ");

24 
	`exô
(0);

26 
ˇnjump
 = 1;

29 
	`∑u£
();

30 
	}
}

33 
	$sig_u§1
(
signo
)

35 
time_t
 
°¨âime
;

37 i‡(
ˇnjump
 == 0)

40 
	`¥_mask
("starting sig_usr1: ");

42 
	`Æ¨m
(3);

43 
°¨âime
 = 
	`time
(
NULL
);

45 i‡(
	`time
(
NULL
Ë> 
°¨âime
 + 5)

48 
	`¥_mask
("finishing sig_usr1: ");

50 
ˇnjump
 = 0;

51 
	`sigl⁄gjmp
(
jmpbuf
, 1);

52 
	}
}

55 
	$sig_Ærm
(
signo
)

57 
	`¥_mask
("in sig_alrm: ");

58 
	}
}

	@signals/read1.c

1 
	~"≠ue.h
"

3 
sig_Ærm
();

6 
	$maö
()

8 
n
;

9 
löe
[
MAXLINE
];

11 i‡(
	`sig«l
(
SIGALRM
, 
sig_Ærm
Ë=
SIG_ERR
)

12 
	`îr_sys
("signal(SIGALRM)Érror");

14 
	`Æ¨m
(10);

15 i‡((
n
 = 
	`ªad
(
STDIN_FILENO
, 
löe
, 
MAXLINE
)) < 0)

16 
	`îr_sys
("readÉrror");

17 
	`Æ¨m
(0);

19 
	`wrôe
(
STDOUT_FILENO
, 
löe
, 
n
);

20 
	`exô
(0);

21 
	}
}

24 
	$sig_Ærm
(
signo
)

27 
	}
}

	@signals/read2.c

1 
	~"≠ue.h
"

2 
	~<£tjmp.h
>

4 
sig_Ærm
();

5 
jmp_buf
 
	gív_Ærm
;

8 
	$maö
()

10 
n
;

11 
löe
[
MAXLINE
];

13 i‡(
	`sig«l
(
SIGALRM
, 
sig_Ærm
Ë=
SIG_ERR
)

14 
	`îr_sys
("signal(SIGALRM)Érror");

15 i‡(
	`£tjmp
(
ív_Ærm
) != 0)

16 
	`îr_quô
("readÅimeout");

18 
	`Æ¨m
(10);

19 i‡((
n
 = 
	`ªad
(
STDIN_FILENO
, 
löe
, 
MAXLINE
)) < 0)

20 
	`îr_sys
("readÉrror");

21 
	`Æ¨m
(0);

23 
	`wrôe
(
STDOUT_FILENO
, 
löe
, 
n
);

24 
	`exô
(0);

25 
	}
}

28 
	$sig_Ærm
(
signo
)

30 
	`l⁄gjmp
(
ív_Ærm
, 1);

31 
	}
}

	@signals/reenter.c

1 
	~"≠ue.h
"

2 
	~<pwd.h
>

5 
	$my_Æ¨m
(
signo
)

7 
∑sswd
 *
roŸ±r
;

9 
	`¥ötf
("in signal handler\n");

10 i‡((
roŸ±r
 = 
	`gëpw«m
("roŸ")Ë=
NULL
)

11 
	`îr_sys
("getpwnam(root)Érror");

12 
	`Æ¨m
(1);

13 
	}
}

16 
	$maö
()

18 
∑sswd
 *
±r
;

20 
	`sig«l
(
SIGALRM
, 
my_Æ¨m
);

21 
	`Æ¨m
(1);

23 i‡((
±r
 = 
	`gëpw«m
("ßr")Ë=
NULL
)

24 
	`îr_sys
("getpwnamÉrror");

25 i‡(
	`°rcmp
(
±r
->
pw_«me
, "sar") != 0)

26 
	`¥ötf
("return value corrupted!,Öw_name = %s\n",

27 
±r
->
pw_«me
);

29 
	}
}

	@signals/setops.c

1 
	~<sig«l.h
>

2 
	~<î∫o.h
>

7 
	#SIGBAD
(
signo
Ë((signoË<0 || (signoË>
NSIG
)

	)

10 
	$sigadd£t
(
sig£t_t
 *
£t
, 
signo
)

12 i‡(
	`SIGBAD
(
signo
)) {

13 
î∫o
 = 
EINVAL
;

16 *
£t
 |1 << (
signo
 - 1);

18 
	}
}

21 
	$sigdñ£t
(
sig£t_t
 *
£t
, 
signo
)

23 i‡(
	`SIGBAD
(
signo
)) {

24 
î∫o
 = 
EINVAL
;

27 *
£t
 &~(1 << (
signo
 - 1));

29 
	}
}

32 
	$sigismembî
(c⁄° 
sig£t_t
 *
£t
, 
signo
)

34 i‡(
	`SIGBAD
(
signo
)) {

35 
î∫o
 = 
EINVAL
;

38 ((*
£t
 & (1 << (
signo
 - 1))) != 0);

39 
	}
}

	@signals/sigtstp.c

1 
	~"≠ue.h
"

3 
	#BUFFSIZE
 1024

	)

6 
	$sig_t°p
(
signo
)

8 
sig£t_t
 
mask
;

15 
	`sigem±y£t
(&
mask
);

16 
	`sigadd£t
(&
mask
, 
SIGTSTP
);

17 
	`sig¥ocmask
(
SIG_UNBLOCK
, &
mask
, 
NULL
);

19 
	`sig«l
(
SIGTSTP
, 
SIG_DFL
);

21 
	`kûl
(
	`gëpid
(), 
SIGTSTP
);

25 
	`sig«l
(
SIGTSTP
, 
sig_t°p
);

28 
	}
}

31 
	$maö
()

33 
n
;

34 
buf
[
BUFFSIZE
];

39 i‡(
	`sig«l
(
SIGTSTP
, 
SIG_IGN
Ë=
SIG_DFL
)

40 
	`sig«l
(
SIGTSTP
, 
sig_t°p
);

42 (
n
 = 
	`ªad
(
STDIN_FILENO
, 
buf
, 
BUFFSIZE
)) > 0)

43 i‡(
	`wrôe
(
STDOUT_FILENO
, 
buf
, 
n
) !=Ç)

44 
	`îr_sys
("writeÉrror");

46 i‡(
n
 < 0)

47 
	`îr_sys
("readÉrror");

49 
	`exô
(0);

50 
	}
}

	@signals/sigusr.c

1 
	~"≠ue.h
"

3 
sig_u§
();

6 
	$maö
()

8 i‡(
	`sig«l
(
SIGUSR1
, 
sig_u§
Ë=
SIG_ERR
)

9 
	`îr_sys
("can't catch SIGUSR1");

10 i‡(
	`sig«l
(
SIGUSR2
, 
sig_u§
Ë=
SIG_ERR
)

11 
	`îr_sys
("can't catch SIGUSR2");

13 
	`∑u£
();

14 
	}
}

17 
	$sig_u§
(
signo
)

19 i‡(
signo
 =
SIGUSR1
)

20 
	`¥ötf
("received SIGUSR1\n");

21 i‡(
signo
 =
SIGUSR2
)

22 
	`¥ötf
("received SIGUSR2\n");

24 
	`îr_dump
("ª˚ived sig«»%d\n", 
signo
);

25 
	}
}

	@signals/sleep1.c

1 
	~<sig«l.h
>

2 
	~<uni°d.h
>

5 
	$sig_Ærm
(
signo
)

8 
	}
}

11 
	$¶ìp1
(
£c⁄ds
)

13 i‡(
	`sig«l
(
SIGALRM
, 
sig_Ærm
Ë=
SIG_ERR
)

14 (
£c⁄ds
);

15 
	`Æ¨m
(
£c⁄ds
);

16 
	`∑u£
();

17 (
	`Æ¨m
(0));

18 
	}
}

	@signals/sleep2.c

1 
	~<£tjmp.h
>

2 
	~<sig«l.h
>

3 
	~<uni°d.h
>

5 
jmp_buf
 
	gív_Ærm
;

8 
	$sig_Ærm
(
signo
)

10 
	`l⁄gjmp
(
ív_Ærm
, 1);

11 
	}
}

14 
	$¶ìp2
(
£c⁄ds
)

16 i‡(
	`sig«l
(
SIGALRM
, 
sig_Ærm
Ë=
SIG_ERR
)

17 (
£c⁄ds
);

18 i‡(
	`£tjmp
(
ív_Ærm
) == 0) {

19 
	`Æ¨m
(
£c⁄ds
);

20 
	`∑u£
();

22 (
	`Æ¨m
(0));

23 
	}
}

	@signals/suspend1.c

1 
	~"≠ue.h
"

3 
sig_öt
();

6 
	$maö
()

8 
sig£t_t
 
√wmask
, 
ﬁdmask
, 
waômask
;

10 
	`¥_mask
("program start: ");

12 i‡(
	`sig«l
(
SIGINT
, 
sig_öt
Ë=
SIG_ERR
)

13 
	`îr_sys
("signal(SIGINT)Érror");

14 
	`sigem±y£t
(&
waômask
);

15 
	`sigadd£t
(&
waômask
, 
SIGUSR1
);

16 
	`sigem±y£t
(&
√wmask
);

17 
	`sigadd£t
(&
√wmask
, 
SIGINT
);

22 i‡(
	`sig¥ocmask
(
SIG_BLOCK
, &
√wmask
, &
ﬁdmask
) < 0)

23 
	`îr_sys
("SIG_BLOCKÉrror");

28 
	`¥_mask
("in criticalÑegion: ");

33 i‡(
	`sigsu•íd
(&
waômask
) != -1)

34 
	`îr_sys
("sigsuspendÉrror");

36 
	`¥_mask
("afterÑeturn from sigsuspend: ");

41 i‡(
	`sig¥ocmask
(
SIG_SETMASK
, &
ﬁdmask
, 
NULL
) < 0)

42 
	`îr_sys
("SIG_SETMASKÉrror");

47 
	`¥_mask
("programÉxit: ");

49 
	`exô
(0);

50 
	}
}

53 
	$sig_öt
(
signo
)

55 
	`¥_mask
("\nin sig_int: ");

56 
	}
}

	@signals/suspend2.c

1 
	~"≠ue.h
"

3 vﬁ©ûê
sig_©omic_t
 
	gquôÊag
;

6 
	$sig_öt
(
signo
)

8 i‡(
signo
 =
SIGINT
)

9 
	`¥ötf
("\ninterrupt\n");

10 i‡(
signo
 =
SIGQUIT
)

11 
quôÊag
 = 1;

12 
	}
}

15 
	$maö
()

17 
sig£t_t
 
√wmask
, 
ﬁdmask
, 
zîomask
;

19 i‡(
	`sig«l
(
SIGINT
, 
sig_öt
Ë=
SIG_ERR
)

20 
	`îr_sys
("signal(SIGINT)Érror");

21 i‡(
	`sig«l
(
SIGQUIT
, 
sig_öt
Ë=
SIG_ERR
)

22 
	`îr_sys
("signal(SIGQUIT)Érror");

24 
	`sigem±y£t
(&
zîomask
);

25 
	`sigem±y£t
(&
√wmask
);

26 
	`sigadd£t
(&
√wmask
, 
SIGQUIT
);

31 i‡(
	`sig¥ocmask
(
SIG_BLOCK
, &
√wmask
, &
ﬁdmask
) < 0)

32 
	`îr_sys
("SIG_BLOCKÉrror");

34 
quôÊag
 == 0)

35 
	`sigsu•íd
(&
zîomask
);

40 
quôÊag
 = 0;

45 i‡(
	`sig¥ocmask
(
SIG_SETMASK
, &
ﬁdmask
, 
NULL
) < 0)

46 
	`îr_sys
("SIG_SETMASKÉrror");

48 
	`exô
(0);

49 
	}
}

	@signals/system.c

1 
	~<sys/waô.h
>

2 
	~<î∫o.h
>

3 
	~<sig«l.h
>

4 
	~<uni°d.h
>

7 
	$sy°em
(c⁄° *
cmd°rög
)

9 
pid_t
 
pid
;

10 
°©us
;

11 
siga˘i⁄
 
ign‹e
, 
ßveöå
, 
ßvequô
;

12 
sig£t_t
 
chldmask
, 
ßvemask
;

14 i‡(
cmd°rög
 =
NULL
)

17 
ign‹e
.
ß_h™dÀr
 = 
SIG_IGN
;

18 
	`sigem±y£t
(&
ign‹e
.
ß_mask
);

19 
ign‹e
.
ß_Êags
 = 0;

20 i‡(
	`siga˘i⁄
(
SIGINT
, &
ign‹e
, &
ßveöå
) < 0)

22 i‡(
	`siga˘i⁄
(
SIGQUIT
, &
ign‹e
, &
ßvequô
) < 0)

24 
	`sigem±y£t
(&
chldmask
);

25 
	`sigadd£t
(&
chldmask
, 
SIGCHLD
);

26 i‡(
	`sig¥ocmask
(
SIG_BLOCK
, &
chldmask
, &
ßvemask
) < 0)

29 i‡((
pid
 = 
	`f‹k
()) < 0) {

30 
°©us
 = -1;

31 } i‡(
pid
 == 0) {

33 
	`siga˘i⁄
(
SIGINT
, &
ßveöå
, 
NULL
);

34 
	`siga˘i⁄
(
SIGQUIT
, &
ßvequô
, 
NULL
);

35 
	`sig¥ocmask
(
SIG_SETMASK
, &
ßvemask
, 
NULL
);

37 
	`exe˛
("/bö/sh", "sh", "-c", 
cmd°rög
, (*)0);

38 
	`_exô
(127);

40 
	`waôpid
(
pid
, &
°©us
, 0) < 0)

41 i‡(
î∫o
 !
EINTR
) {

42 
°©us
 = -1;

48 i‡(
	`siga˘i⁄
(
SIGINT
, &
ßveöå
, 
NULL
) < 0)

50 i‡(
	`siga˘i⁄
(
SIGQUIT
, &
ßvequô
, 
NULL
) < 0)

52 i‡(
	`sig¥ocmask
(
SIG_SETMASK
, &
ßvemask
, 
NULL
) < 0)

55 (
°©us
);

56 
	}
}

	@signals/systest2.c

1 
	~"≠ue.h
"

4 
	$sig_öt
(
signo
)

6 
	`¥ötf
("caught SIGINT\n");

7 
	}
}

10 
	$sig_chld
(
signo
)

12 
	`¥ötf
("caught SIGCHLD\n");

13 
	}
}

16 
	$maö
()

18 i‡(
	`sig«l
(
SIGINT
, 
sig_öt
Ë=
SIG_ERR
)

19 
	`îr_sys
("signal(SIGINT)Érror");

20 i‡(
	`sig«l
(
SIGCHLD
, 
sig_chld
Ë=
SIG_ERR
)

21 
	`îr_sys
("signal(SIGCHLD)Érror");

22 i‡(
	`sy°em
("/bin/ed") < 0)

23 
	`îr_sys
("system()Érror");

24 
	`exô
(0);

25 
	}
}

	@signals/tsleep2.c

1 
	~"≠ue.h
"

3 
¶ìp2
();

4 
sig_öt
();

7 
	$maö
()

9 
un¶ït
;

11 i‡(
	`sig«l
(
SIGINT
, 
sig_öt
Ë=
SIG_ERR
)

12 
	`îr_sys
("signal(SIGINT)Érror");

13 
un¶ït
 = 
	`¶ìp2
(5);

14 
	`¥ötf
("¶ìp2Ñëu∫ed: %u\n", 
un¶ït
);

15 
	`exô
(0);

16 
	}
}

19 
	$sig_öt
(
signo
)

21 
i
, 
j
;

22 vﬁ©ûê
k
;

28 
	`¥ötf
("\nsig_int starting\n");

29 
i
 = 0; i < 300000; i++)

30 
j
 = 0; j < 4000; j++)

31 
k
 +
i
 * 
j
;

32 
	`¥ötf
("sig_int finished\n");

33 
	}
}

	@sockets/clconn.c

1 
	~"≠ue.h
"

2 
	~<sys/sockë.h
>

4 
	#MAXSLEEP
 128

	)

7 
	$c⁄√˘_ªåy
(
sockfd
, c⁄° 
sockaddr
 *
addr
, 
sockÀn_t
 
Æí
)

9 
num£c
;

14 
num£c
 = 1;Çum£¯<
MAXSLEEP
;Çumsec <<= 1) {

15 i‡(
	`c⁄√˘
(
sockfd
, 
addr
, 
Æí
) == 0) {

25 i‡(
num£c
 <
MAXSLEEP
/2)

26 
	`¶ìp
(
num£c
);

29 
	}
}

	@sockets/clconn2.c

1 
	~"≠ue.h
"

2 
	~<sys/sockë.h
>

4 
	#MAXSLEEP
 128

	)

7 
	$c⁄√˘_ªåy
(
domaö
, 
ty≥
, 
¥Ÿocﬁ
,

8 c⁄° 
sockaddr
 *
addr
, 
sockÀn_t
 
Æí
)

10 
num£c
, 
fd
;

15 
num£c
 = 1;Çum£¯<
MAXSLEEP
;Çumsec <<= 1) {

16 i‡((
fd
 = 
	`sockë
(
domaö
, 
ty≥
, 
¥Ÿocﬁ
)) < 0)

18 i‡(
	`c⁄√˘
(
fd
, 
addr
, 
Æí
) == 0) {

22 (
fd
);

24 
	`˛o£
(
fd
);

29 i‡(
num£c
 <
MAXSLEEP
/2)

30 
	`¶ìp
(
num£c
);

33 
	}
}

	@sockets/findsvc.c

1 
	~"≠ue.h
"

2 #i‡
deföed
(
SOLARIS
)

3 
	~<√töë/ö.h
>

5 
	~<√tdb.h
>

6 
	~<¨∑/öë.h
>

7 #i‡
deföed
(
BSD
)

8 
	~<sys/sockë.h
>

9 
	~<√töë/ö.h
>

13 
	$¥öt_Ámûy
(
addröfo
 *
aù
)

15 
	`¥ötf
(" family ");

16 
aù
->
ai_Ámûy
) {

17 
AF_INET
:

18 
	`¥ötf
("inet");

20 
AF_INET6
:

21 
	`¥ötf
("inet6");

23 
AF_UNIX
:

24 
	`¥ötf
("unix");

26 
AF_UNSPEC
:

27 
	`¥ötf
("unspecified");

30 
	`¥ötf
("unknown");

32 
	}
}

35 
	$¥öt_ty≥
(
addröfo
 *
aù
)

37 
	`¥ötf
("Åype ");

38 
aù
->
ai_sockty≥
) {

39 
SOCK_STREAM
:

40 
	`¥ötf
("stream");

42 
SOCK_DGRAM
:

43 
	`¥ötf
("datagram");

45 
SOCK_SEQPACKET
:

46 
	`¥ötf
("seqpacket");

48 
SOCK_RAW
:

49 
	`¥ötf
("raw");

52 
	`¥ötf
("unknow¿(%d)", 
aù
->
ai_sockty≥
);

54 
	}
}

57 
	$¥öt_¥Ÿocﬁ
(
addröfo
 *
aù
)

59 
	`¥ötf
("Örotocol ");

60 
aù
->
ai_¥Ÿocﬁ
) {

62 
	`¥ötf
("default");

64 
IPPROTO_TCP
:

65 
	`¥ötf
("TCP");

67 
IPPROTO_UDP
:

68 
	`¥ötf
("UDP");

70 
IPPROTO_RAW
:

71 
	`¥ötf
("raw");

74 
	`¥ötf
("unknow¿(%d)", 
aù
->
ai_¥Ÿocﬁ
);

76 
	}
}

79 
	$¥öt_Êags
(
addröfo
 *
aù
)

81 
	`¥ötf
("flags");

82 i‡(
aù
->
ai_Êags
 == 0) {

83 
	`¥ötf
(" 0");

85 i‡(
aù
->
ai_Êags
 & 
AI_PASSIVE
)

86 
	`¥ötf
("Öassive");

87 i‡(
aù
->
ai_Êags
 & 
AI_CANONNAME
)

88 
	`¥ötf
(" canon");

89 i‡(
aù
->
ai_Êags
 & 
AI_NUMERICHOST
)

90 
	`¥ötf
("Çumhost");

91 i‡(
aù
->
ai_Êags
 & 
AI_NUMERICSERV
)

92 
	`¥ötf
("Çumserv");

93 i‡(
aù
->
ai_Êags
 & 
AI_V4MAPPED
)

94 
	`¥ötf
(" v4mapped");

95 i‡(
aù
->
ai_Êags
 & 
AI_ALL
)

96 
	`¥ötf
("áll");

98 
	}
}

101 
	$maö
(
¨gc
, *
¨gv
[])

103 
addröfo
 *
aûi°
, *
aù
;

104 
addröfo
 
höt
;

105 
sockaddr_ö
 *
söp
;

106 c⁄° *
addr
;

107 
îr
;

108 
abuf
[
INET_ADDRSTRLEN
];

110 i‡(
¨gc
 != 3)

111 
	`îr_quô
("ußge: %†nodíamê£rvi˚", 
¨gv
[0]);

112 
höt
.
ai_Êags
 = 
AI_CANONNAME
;

113 
höt
.
ai_Ámûy
 = 0;

114 
höt
.
ai_sockty≥
 = 0;

115 
höt
.
ai_¥Ÿocﬁ
 = 0;

116 
höt
.
ai_addæí
 = 0;

117 
höt
.
ai_ˇn⁄«me
 = 
NULL
;

118 
höt
.
ai_addr
 = 
NULL
;

119 
höt
.
ai_√xt
 = 
NULL
;

120 i‡((
îr
 = 
	`gëaddröfo
(
¨gv
[1],árgv[2], &
höt
, &
aûi°
)) != 0)

121 
	`îr_quô
("gëaddröfÿîr‹: %s", 
	`gai_°ªº‹
(
îr
));

122 
aù
 = 
aûi°
;áù !
NULL
;áù =áù->
ai_√xt
) {

123 
	`¥öt_Êags
(
aù
);

124 
	`¥öt_Ámûy
(
aù
);

125 
	`¥öt_ty≥
(
aù
);

126 
	`¥öt_¥Ÿocﬁ
(
aù
);

127 
	`¥ötf
("\n\tho° %s", 
aù
->
ai_ˇn⁄«me
?aip->ai_canonname:"-");

128 i‡(
aù
->
ai_Ámûy
 =
AF_INET
) {

129 
söp
 = (
sockaddr_ö
 *)
aù
->
ai_addr
;

130 
addr
 = 
	`öë_¡›
(
AF_INET
, &
söp
->
sö_addr
, 
abuf
,

131 
INET_ADDRSTRLEN
);

132 
	`¥ötf
("áddªs†%s", 
addr
?addr:"unknown");

133 
	`¥ötf
("Ö‹à%d", 
	`¡ohs
(
söp
->
sö_p‹t
));

135 
	`¥ötf
("\n");

137 
	`exô
(0);

138 
	}
}

	@sockets/initsrv1.c

1 
	~"≠ue.h
"

2 
	~<î∫o.h
>

3 
	~<sys/sockë.h
>

6 
	$öô£rvî
(
ty≥
, c⁄° 
sockaddr
 *
addr
, 
sockÀn_t
 
Æí
,

7 
qÀn
)

9 
fd
;

10 
îr
 = 0;

12 i‡((
fd
 = 
	`sockë
(
addr
->
ß_Ámûy
, 
ty≥
, 0)) < 0)

14 i‡(
	`böd
(
fd
, 
addr
, 
Æí
) < 0)

15 
îrout
;

16 i‡(
ty≥
 =
SOCK_STREAM
 ||Åy≥ =
SOCK_SEQPACKET
) {

17 i‡(
	`li°í
(
fd
, 
qÀn
) < 0)

18 
îrout
;

20 (
fd
);

22 
îrout
:

23 
îr
 = 
î∫o
;

24 
	`˛o£
(
fd
);

25 
î∫o
 = 
îr
;

27 
	}
}

	@sockets/initsrv2.c

1 
	~"≠ue.h
"

2 
	~<î∫o.h
>

3 
	~<sys/sockë.h
>

6 
	$öô£rvî
(
ty≥
, c⁄° 
sockaddr
 *
addr
, 
sockÀn_t
 
Æí
,

7 
qÀn
)

9 
fd
, 
îr
;

10 
ªu£
 = 1;

12 i‡((
fd
 = 
	`sockë
(
addr
->
ß_Ámûy
, 
ty≥
, 0)) < 0)

14 i‡(
	`£tsock›t
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
ªu£
,

16 
îrout
;

17 i‡(
	`böd
(
fd
, 
addr
, 
Æí
) < 0)

18 
îrout
;

19 i‡(
ty≥
 =
SOCK_STREAM
 ||Åy≥ =
SOCK_SEQPACKET
)

20 i‡(
	`li°í
(
fd
, 
qÀn
) < 0)

21 
îrout
;

22 (
fd
);

24 
îrout
:

25 
îr
 = 
î∫o
;

26 
	`˛o£
(
fd
);

27 
î∫o
 = 
îr
;

29 
	}
}

	@sockets/ruptime-dg.c

1 
	~"≠ue.h
"

2 
	~<√tdb.h
>

3 
	~<î∫o.h
>

4 
	~<sys/sockë.h
>

6 
	#BUFLEN
 128

	)

7 
	#TIMEOUT
 20

	)

10 
	$sigÆrm
(
signo
)

12 
	}
}

15 
	$¥öt_u±ime
(
sockfd
, 
addröfo
 *
aù
)

17 
n
;

18 
buf
[
BUFLEN
];

20 
buf
[0] = 0;

21 i‡(
	`£ndto
(
sockfd
, 
buf
, 1, 0, 
aù
->
ai_addr
,áù->
ai_addæí
) < 0)

22 
	`îr_sys
("sendtoÉrror");

23 
	`Æ¨m
(
TIMEOUT
);

24 i‡((
n
 = 
	`ªcv‰om
(
sockfd
, 
buf
, 
BUFLEN
, 0, 
NULL
, NULL)) < 0) {

25 i‡(
î∫o
 !
EINTR
)

26 
	`Æ¨m
(0);

27 
	`îr_sys
("recvÉrror");

29 
	`Æ¨m
(0);

30 
	`wrôe
(
STDOUT_FILENO
, 
buf
, 
n
);

31 
	}
}

34 
	$maö
(
¨gc
, *
¨gv
[])

36 
addröfo
 *
aûi°
, *
aù
;

37 
addröfo
 
höt
;

38 
sockfd
, 
îr
;

39 
siga˘i⁄
 
ß
;

41 i‡(
¨gc
 != 2)

42 
	`îr_quô
("usage:Ñuptime hostname");

43 
ß
.
ß_h™dÀr
 = 
sigÆrm
;

44 
ß
.
ß_Êags
 = 0;

45 
	`sigem±y£t
(&
ß
.
ß_mask
);

46 i‡(
	`siga˘i⁄
(
SIGALRM
, &
ß
, 
NULL
) < 0)

47 
	`îr_sys
("sigactionÉrror");

48 
	`mem£t
(&
höt
, 0, (hint));

49 
höt
.
ai_sockty≥
 = 
SOCK_DGRAM
;

50 
höt
.
ai_ˇn⁄«me
 = 
NULL
;

51 
höt
.
ai_addr
 = 
NULL
;

52 
höt
.
ai_√xt
 = 
NULL
;

53 i‡((
îr
 = 
	`gëaddröfo
(
¨gv
[1], "ru±ime", &
höt
, &
aûi°
)) != 0)

54 
	`îr_quô
("gëaddröfÿîr‹: %s", 
	`gai_°ªº‹
(
îr
));

56 
aù
 = 
aûi°
;áù !
NULL
;áù =áù->
ai_√xt
) {

57 i‡((
sockfd
 = 
	`sockë
(
aù
->
ai_Ámûy
, 
SOCK_DGRAM
, 0)) < 0) {

58 
îr
 = 
î∫o
;

60 
	`¥öt_u±ime
(
sockfd
, 
aù
);

61 
	`exô
(0);

65 
	`Ârötf
(
°dîr
, "ˇn'àc⁄è˘ %s: %s\n", 
¨gv
[1], 
	`°ªº‹
(
îr
));

66 
	`exô
(1);

67 
	}
}

	@sockets/ruptime.c

1 
	~"≠ue.h
"

2 
	~<√tdb.h
>

3 
	~<î∫o.h
>

4 
	~<sys/sockë.h
>

6 
	#BUFLEN
 128

	)

8 
c⁄√˘_ªåy
(, , , c⁄° 
sockaddr
 *,

9 
sockÀn_t
);

12 
	$¥öt_u±ime
(
sockfd
)

14 
n
;

15 
buf
[
BUFLEN
];

17 (
n
 = 
	`ªcv
(
sockfd
, 
buf
, 
BUFLEN
, 0)) > 0)

18 
	`wrôe
(
STDOUT_FILENO
, 
buf
, 
n
);

19 i‡(
n
 < 0)

20 
	`îr_sys
("recvÉrror");

21 
	}
}

24 
	$maö
(
¨gc
, *
¨gv
[])

26 
addröfo
 *
aûi°
, *
aù
;

27 
addröfo
 
höt
;

28 
sockfd
, 
îr
;

30 i‡(
¨gc
 != 2)

31 
	`îr_quô
("usage:Ñuptime hostname");

32 
	`mem£t
(&
höt
, 0, (hint));

33 
höt
.
ai_sockty≥
 = 
SOCK_STREAM
;

34 
höt
.
ai_ˇn⁄«me
 = 
NULL
;

35 
höt
.
ai_addr
 = 
NULL
;

36 
höt
.
ai_√xt
 = 
NULL
;

37 i‡((
îr
 = 
	`gëaddröfo
(
¨gv
[1], "ru±ime", &
höt
, &
aûi°
)) != 0)

38 
	`îr_quô
("gëaddröfÿîr‹: %s", 
	`gai_°ªº‹
(
îr
));

39 
aù
 = 
aûi°
;áù !
NULL
;áù =áù->
ai_√xt
) {

40 i‡((
sockfd
 = 
	`c⁄√˘_ªåy
(
aù
->
ai_Ámûy
, 
SOCK_STREAM
, 0,

41 
aù
->
ai_addr
,áù->
ai_addæí
)) < 0) {

42 
îr
 = 
î∫o
;

44 
	`¥öt_u±ime
(
sockfd
);

45 
	`exô
(0);

48 
	`îr_exô
(
îr
, "ˇn'àc⁄√˘Åÿ%s", 
¨gv
[1]);

49 
	}
}

	@sockets/ruptimed-dg.c

1 
	~"≠ue.h
"

2 
	~<√tdb.h
>

3 
	~<î∫o.h
>

4 
	~<sy¶og.h
>

5 
	~<sys/sockë.h
>

7 
	#BUFLEN
 128

	)

8 
	#MAXADDRLEN
 256

	)

10 #i‚de‡
HOST_NAME_MAX


11 
	#HOST_NAME_MAX
 256

	)

14 
öô£rvî
(, c⁄° 
sockaddr
 *, 
sockÀn_t
, );

17 
	$£rve
(
sockfd
)

19 
n
;

20 
sockÀn_t
 
Æí
;

21 
FILE
 *
Â
;

22 
buf
[
BUFLEN
];

23 
abuf
[
MAXADDRLEN
];

24 
sockaddr
 *
addr
 = (sockadd∏*)
abuf
;

26 
	`£t_˛€xec
(
sockfd
);

28 
Æí
 = 
MAXADDRLEN
;

29 i‡((
n
 = 
	`ªcv‰om
(
sockfd
, 
buf
, 
BUFLEN
, 0, 
addr
, &
Æí
)) < 0) {

30 
	`sy¶og
(
LOG_ERR
, "ruptimed:ÑecvfromÉrror: %s",

31 
	`°ªº‹
(
î∫o
));

32 
	`exô
(1);

34 i‡((
Â
 = 
	`p›í
("/u§/bö/u±ime", "r")Ë=
NULL
) {

35 
	`•rötf
(
buf
, "îr‹: %s\n", 
	`°ªº‹
(
î∫o
));

36 
	`£ndto
(
sockfd
, 
buf
, 
	`°æí
(buf), 0, 
addr
, 
Æí
);

38 i‡(
	`fgës
(
buf
, 
BUFLEN
, 
Â
Ë!
NULL
)

39 
	`£ndto
(
sockfd
, 
buf
, 
	`°æí
(buf), 0, 
addr
, 
Æí
);

40 
	`p˛o£
(
Â
);

43 
	}
}

46 
	$maö
(
¨gc
, *
¨gv
[])

48 
addröfo
 *
aûi°
, *
aù
;

49 
addröfo
 
höt
;

50 
sockfd
, 
îr
, 
n
;

51 *
ho°
;

53 i‡(
¨gc
 != 1)

54 
	`îr_quô
("usage:Ñuptimed");

55 i‡((
n
 = 
	`sysc⁄f
(
_SC_HOST_NAME_MAX
)) < 0)

56 
n
 = 
HOST_NAME_MAX
;

57 i‡((
ho°
 = 
	`mÆloc
(
n
)Ë=
NULL
)

58 
	`îr_sys
("mallocÉrror");

59 i‡(
	`gëho°«me
(
ho°
, 
n
) < 0)

60 
	`îr_sys
("gethostnameÉrror");

61 
	`d´m⁄ize
("ruptimed");

62 
	`mem£t
(&
höt
, 0, (hint));

63 
höt
.
ai_Êags
 = 
AI_CANONNAME
;

64 
höt
.
ai_sockty≥
 = 
SOCK_DGRAM
;

65 
höt
.
ai_ˇn⁄«me
 = 
NULL
;

66 
höt
.
ai_addr
 = 
NULL
;

67 
höt
.
ai_√xt
 = 
NULL
;

68 i‡((
îr
 = 
	`gëaddröfo
(
ho°
, "ru±ime", &
höt
, &
aûi°
)) != 0) {

69 
	`sy¶og
(
LOG_ERR
, "ruptimed: getaddrinfoÉrror: %s",

70 
	`gai_°ªº‹
(
îr
));

71 
	`exô
(1);

73 
aù
 = 
aûi°
;áù !
NULL
;áù =áù->
ai_√xt
) {

74 i‡((
sockfd
 = 
	`öô£rvî
(
SOCK_DGRAM
, 
aù
->
ai_addr
,

75 
aù
->
ai_addæí
, 0)) >= 0) {

76 
	`£rve
(
sockfd
);

77 
	`exô
(0);

80 
	`exô
(1);

81 
	}
}

	@sockets/ruptimed-fd.c

1 
	~"≠ue.h
"

2 
	~<√tdb.h
>

3 
	~<î∫o.h
>

4 
	~<sy¶og.h
>

5 
	~<f˙é.h
>

6 
	~<sys/sockë.h
>

7 
	~<sys/waô.h
>

9 
	#QLEN
 10

	)

11 #i‚de‡
HOST_NAME_MAX


12 
	#HOST_NAME_MAX
 256

	)

15 
öô£rvî
(, c⁄° 
sockaddr
 *, 
sockÀn_t
, );

18 
	$£rve
(
sockfd
)

20 
˛fd
, 
°©us
;

21 
pid_t
 
pid
;

23 
	`£t_˛€xec
(
sockfd
);

25 i‡((
˛fd
 = 
	`ac˚±
(
sockfd
, 
NULL
, NULL)) < 0) {

26 
	`sy¶og
(
LOG_ERR
, "ruptimed:ácceptÉrror: %s",

27 
	`°ªº‹
(
î∫o
));

28 
	`exô
(1);

30 i‡((
pid
 = 
	`f‹k
()) < 0) {

31 
	`sy¶og
(
LOG_ERR
, "ruptimed: forkÉrror: %s",

32 
	`°ªº‹
(
î∫o
));

33 
	`exô
(1);

34 } i‡(
pid
 == 0) {

42 i‡(
	`dup2
(
˛fd
, 
STDOUT_FILENO
) != STDOUT_FILENO ||

43 
	`dup2
(
˛fd
, 
STDERR_FILENO
) != STDERR_FILENO) {

44 
	`sy¶og
(
LOG_ERR
, "ruptimed: unexpectedÉrror");

45 
	`exô
(1);

47 
	`˛o£
(
˛fd
);

48 
	`exe˛
("/usr/bin/uptime", "uptime", (*)0);

49 
	`sy¶og
(
LOG_ERR
, "ruptimed: unexpectedÑeturn fromÉxec: %s",

50 
	`°ªº‹
(
î∫o
));

52 
	`˛o£
(
˛fd
);

53 
	`waôpid
(
pid
, &
°©us
, 0);

56 
	}
}

59 
	$maö
(
¨gc
, *
¨gv
[])

61 
addröfo
 *
aûi°
, *
aù
;

62 
addröfo
 
höt
;

63 
sockfd
, 
îr
, 
n
;

64 *
ho°
;

66 i‡(
¨gc
 != 1)

67 
	`îr_quô
("usage:Ñuptimed");

68 i‡((
n
 = 
	`sysc⁄f
(
_SC_HOST_NAME_MAX
)) < 0)

69 
n
 = 
HOST_NAME_MAX
;

70 i‡((
ho°
 = 
	`mÆloc
(
n
)Ë=
NULL
)

71 
	`îr_sys
("mallocÉrror");

72 i‡(
	`gëho°«me
(
ho°
, 
n
) < 0)

73 
	`îr_sys
("gethostnameÉrror");

74 
	`d´m⁄ize
("ruptimed");

75 
	`mem£t
(&
höt
, 0, (hint));

76 
höt
.
ai_Êags
 = 
AI_CANONNAME
;

77 
höt
.
ai_sockty≥
 = 
SOCK_STREAM
;

78 
höt
.
ai_ˇn⁄«me
 = 
NULL
;

79 
höt
.
ai_addr
 = 
NULL
;

80 
höt
.
ai_√xt
 = 
NULL
;

81 i‡((
îr
 = 
	`gëaddröfo
(
ho°
, "ru±ime", &
höt
, &
aûi°
)) != 0) {

82 
	`sy¶og
(
LOG_ERR
, "ruptimed: getaddrinfoÉrror: %s",

83 
	`gai_°ªº‹
(
îr
));

84 
	`exô
(1);

86 
aù
 = 
aûi°
;áù !
NULL
;áù =áù->
ai_√xt
) {

87 i‡((
sockfd
 = 
	`öô£rvî
(
SOCK_STREAM
, 
aù
->
ai_addr
,

88 
aù
->
ai_addæí
, 
QLEN
)) >= 0) {

89 
	`£rve
(
sockfd
);

90 
	`exô
(0);

93 
	`exô
(1);

94 
	}
}

	@sockets/ruptimed.c

1 
	~"≠ue.h
"

2 
	~<√tdb.h
>

3 
	~<î∫o.h
>

4 
	~<sy¶og.h
>

5 
	~<sys/sockë.h
>

7 
	#BUFLEN
 128

	)

8 
	#QLEN
 10

	)

10 #i‚de‡
HOST_NAME_MAX


11 
	#HOST_NAME_MAX
 256

	)

14 
öô£rvî
(, c⁄° 
sockaddr
 *, 
sockÀn_t
, );

17 
	$£rve
(
sockfd
)

19 
˛fd
;

20 
FILE
 *
Â
;

21 
buf
[
BUFLEN
];

23 
	`£t_˛€xec
(
sockfd
);

25 i‡((
˛fd
 = 
	`ac˚±
(
sockfd
, 
NULL
, NULL)) < 0) {

26 
	`sy¶og
(
LOG_ERR
, "ruptimed:ácceptÉrror: %s",

27 
	`°ªº‹
(
î∫o
));

28 
	`exô
(1);

30 
	`£t_˛€xec
(
˛fd
);

31 i‡((
Â
 = 
	`p›í
("/u§/bö/u±ime", "r")Ë=
NULL
) {

32 
	`•rötf
(
buf
, "îr‹: %s\n", 
	`°ªº‹
(
î∫o
));

33 
	`£nd
(
˛fd
, 
buf
, 
	`°æí
(buf), 0);

35 
	`fgës
(
buf
, 
BUFLEN
, 
Â
Ë!
NULL
)

36 
	`£nd
(
˛fd
, 
buf
, 
	`°æí
(buf), 0);

37 
	`p˛o£
(
Â
);

39 
	`˛o£
(
˛fd
);

41 
	}
}

44 
	$maö
(
¨gc
, *
¨gv
[])

46 
addröfo
 *
aûi°
, *
aù
;

47 
addröfo
 
höt
;

48 
sockfd
, 
îr
, 
n
;

49 *
ho°
;

51 i‡(
¨gc
 != 1)

52 
	`îr_quô
("usage:Ñuptimed");

53 i‡((
n
 = 
	`sysc⁄f
(
_SC_HOST_NAME_MAX
)) < 0)

54 
n
 = 
HOST_NAME_MAX
;

55 i‡((
ho°
 = 
	`mÆloc
(
n
)Ë=
NULL
)

56 
	`îr_sys
("mallocÉrror");

57 i‡(
	`gëho°«me
(
ho°
, 
n
) < 0)

58 
	`îr_sys
("gethostnameÉrror");

59 
	`d´m⁄ize
("ruptimed");

60 
	`mem£t
(&
höt
, 0, (hint));

61 
höt
.
ai_Êags
 = 
AI_CANONNAME
;

62 
höt
.
ai_sockty≥
 = 
SOCK_STREAM
;

63 
höt
.
ai_ˇn⁄«me
 = 
NULL
;

64 
höt
.
ai_addr
 = 
NULL
;

65 
höt
.
ai_√xt
 = 
NULL
;

66 i‡((
îr
 = 
	`gëaddröfo
(
ho°
, "ru±ime", &
höt
, &
aûi°
)) != 0) {

67 
	`sy¶og
(
LOG_ERR
, "ruptimed: getaddrinfoÉrror: %s",

68 
	`gai_°ªº‹
(
îr
));

69 
	`exô
(1);

71 
aù
 = 
aûi°
;áù !
NULL
;áù =áù->
ai_√xt
) {

72 i‡((
sockfd
 = 
	`öô£rvî
(
SOCK_STREAM
, 
aù
->
ai_addr
,

73 
aù
->
ai_addæí
, 
QLEN
)) >= 0) {

74 
	`£rve
(
sockfd
);

75 
	`exô
(0);

78 
	`exô
(1);

79 
	}
}

	@stdio/buf.c

1 
	~"≠ue.h
"

3 
¥_°dio
(c⁄° *, 
FILE
 *);

4 
is_unbuf„ªd
(
FILE
 *);

5 
is_löebuf„ªd
(
FILE
 *);

6 
buf„r_size
(
FILE
 *);

9 
	$maö
()

11 
FILE
 *
Â
;

13 
	`Âuts
("íã∏™y ch¨a˘î\n", 
°dout
);

14 i‡(
	`gëch¨
(Ë=
EOF
)

15 
	`îr_sys
("getcharÉrror");

16 
	`Âuts
("⁄êlöêtÿ°™d¨dÉº‹\n", 
°dîr
);

18 
	`¥_°dio
("°dö", 
°dö
);

19 
	`¥_°dio
("°dout", 
°dout
);

20 
	`¥_°dio
("°dîr", 
°dîr
);

22 i‡((
Â
 = 
	`f›í
("/ëc/∑sswd", "r")Ë=
NULL
)

23 
	`îr_sys
("fopenÉrror");

24 i‡(
	`gëc
(
Â
Ë=
EOF
)

25 
	`îr_sys
("getcÉrror");

26 
	`¥_°dio
("/ëc/∑sswd", 
Â
);

27 
	`exô
(0);

28 
	}
}

31 
	$¥_°dio
(c⁄° *
«me
, 
FILE
 *
Â
)

33 
	`¥ötf
("°ªam = %s, ", 
«me
);

34 i‡(
	`is_unbuf„ªd
(
Â
))

35 
	`¥ötf
("unbuffered");

36 i‡(
	`is_löebuf„ªd
(
Â
))

37 
	`¥ötf
("line buffered");

39 
	`¥ötf
("fully buffered");

40 
	`¥ötf
(", buf„∏sizê%d\n", 
	`buf„r_size
(
Â
));

41 
	}
}

47 #i‡
deföed
(
_IO_UNBUFFERED
)

50 
	$is_unbuf„ªd
(
FILE
 *
Â
)

52 (
Â
->
_Êags
 & 
_IO_UNBUFFERED
);

53 
	}
}

56 
	$is_löebuf„ªd
(
FILE
 *
Â
)

58 (
Â
->
_Êags
 & 
_IO_LINE_BUF
);

59 
	}
}

62 
	$buf„r_size
(
FILE
 *
Â
)

64 (
Â
->
_IO_buf_íd
 - fp->
_IO_buf_ba£
);

65 
	}
}

67 #ñi‡
deföed
(
__SNBF
)

70 
	$is_unbuf„ªd
(
FILE
 *
Â
)

72 (
Â
->
_Êags
 & 
__SNBF
);

73 
	}
}

76 
	$is_löebuf„ªd
(
FILE
 *
Â
)

78 (
Â
->
_Êags
 & 
__SLBF
);

79 
	}
}

82 
	$buf„r_size
(
FILE
 *
Â
)

84 (
Â
->
_bf
.
_size
);

85 
	}
}

87 #ñi‡
deföed
(
_IONBF
)

89 #ifde‡
_LP64


90 
	#_Êag
 
__∑d
[4]

	)

91 
	#_±r
 
__∑d
[1]

	)

92 
	#_ba£
 
__∑d
[2]

	)

96 
	$is_unbuf„ªd
(
FILE
 *
Â
)

98 (
Â
->
_Êag
 & 
_IONBF
);

99 
	}
}

102 
	$is_löebuf„ªd
(
FILE
 *
Â
)

104 (
Â
->
_Êag
 & 
_IOLBF
);

105 
	}
}

108 
	$buf„r_size
(
FILE
 *
Â
)

110 #ifde‡
_LP64


111 (
Â
->
_ba£
 - fp->
_±r
);

113 (
BUFSIZ
);

115 
	}
}

119 #îr‹ 
unknown
 
°dio
 
im∂emíèti⁄
!

	@stdio/fgetsfputs.c

1 
	~"≠ue.h
"

4 
	$maö
()

6 
buf
[
MAXLINE
];

8 
	`fgës
(
buf
, 
MAXLINE
, 
°dö
Ë!
NULL
)

9 i‡(
	`Âuts
(
buf
, 
°dout
Ë=
EOF
)

10 
	`îr_sys
("outputÉrror");

12 i‡(
	`„º‹
(
°dö
))

13 
	`îr_sys
("inputÉrror");

15 
	`exô
(0);

16 
	}
}

	@stdio/getcharbug.c

1 
	~<°dio.h
>

4 
	$maö
()

6 
c
;

8 (
c
 = 
	`gëch¨
()Ë!
EOF
)

9 
	`putch¨
(
c
);

10 
	}
}

	@stdio/getcputc.c

1 
	~"≠ue.h
"

4 
	$maö
()

6 
c
;

8 (
c
 = 
	`gëc
(
°dö
)Ë!
EOF
)

9 i‡(
	`putc
(
c
, 
°dout
Ë=
EOF
)

10 
	`îr_sys
("outputÉrror");

12 i‡(
	`„º‹
(
°dö
))

13 
	`îr_sys
("inputÉrror");

15 
	`exô
(0);

16 
	}
}

	@stdio/memstr.c

1 
	~"≠ue.h
"

3 
	#BSZ
 48

	)

6 
	$maö
()

8 
FILE
 *
Â
;

9 
buf
[
BSZ
];

11 
	`mem£t
(
buf
, 'a', 
BSZ
-2);

12 
buf
[
BSZ
-2] = '\0';

13 
buf
[
BSZ
-1] = 'X';

14 i‡((
Â
 = 
	`fmem›í
(
buf
, 
BSZ
, "w+")Ë=
NULL
)

15 
	`îr_sys
("fmemopen failed");

16 
	`¥ötf
("öôü»buf„∏c⁄ã¡s: %s\n", 
buf
);

17 
	`Ârötf
(
Â
, "hello, world");

18 
	`¥ötf
("bef‹êÊush: %s\n", 
buf
);

19 
	`fÊush
(
Â
);

20 
	`¥ötf
("a·î fÊush: %s\n", 
buf
);

21 
	`¥ötf
("À¿o‡°rög i¿bu‡%ld\n", ()
	`°æí
(
buf
));

23 
	`mem£t
(
buf
, 'b', 
BSZ
-2);

24 
buf
[
BSZ
-2] = '\0';

25 
buf
[
BSZ
-1] = 'X';

26 
	`Ârötf
(
Â
, "hello, world");

27 
	`f£ek
(
Â
, 0, 
SEEK_SET
);

28 
	`¥ötf
("a·î f£ek: %s\n", 
buf
);

29 
	`¥ötf
("À¿o‡°rög i¿bu‡%ld\n", ()
	`°æí
(
buf
));

31 
	`mem£t
(
buf
, 'c', 
BSZ
-2);

32 
buf
[
BSZ
-2] = '\0';

33 
buf
[
BSZ
-1] = 'X';

34 
	`Ârötf
(
Â
, "hello, world");

35 
	`f˛o£
(
Â
);

36 
	`¥ötf
("a·î f˛o£: %s\n", 
buf
);

37 
	`¥ötf
("À¿o‡°rög i¿bu‡%ld\n", ()
	`°æí
(
buf
));

40 
	}
}

	@stdio/mkstemp.c

1 
	~"≠ue.h
"

2 
	~<î∫o.h
>

4 
make_ãmp
(*
ãm∂©e
);

7 
	$maö
()

9 
good_ãm∂©e
[] = "/tmp/dirXXXXXX";

10 *
bad_ãm∂©e
 = "/tmp/dirXXXXXX";

12 
	`¥ötf
("tryingÅo create firstÅemp file...\n");

13 
	`make_ãmp
(
good_ãm∂©e
);

14 
	`¥ötf
("tryingÅo create secondÅemp file...\n");

15 
	`make_ãmp
(
bad_ãm∂©e
);

16 
	`exô
(0);

17 
	}
}

20 
	$make_ãmp
(*
ãm∂©e
)

22 
fd
;

23 
°©
 
sbuf
;

25 i‡((
fd
 = 
	`mk°emp
(
ãm∂©e
)) < 0)

26 
	`îr_sys
("can't createÅemp file");

27 
	`¥ötf
("ãm∞«mê%s\n", 
ãm∂©e
);

28 
	`˛o£
(
fd
);

29 i‡(
	`°©
(
ãm∂©e
, &
sbuf
) < 0) {

30 i‡(
î∫o
 =
ENOENT
)

31 
	`¥ötf
("file doesn'tÉxist\n");

33 
	`îr_sys
("stat failed");

35 
	`¥ötf
("fileÉxists\n");

36 
	`u∆ök
(
ãm∂©e
);

38 
	}
}

	@stdio/tempfiles.c

1 
	~"≠ue.h
"

4 
	$maö
()

6 
«me
[
L_tm≤am
], 
löe
[
MAXLINE
];

7 
FILE
 *
Â
;

9 
	`¥ötf
("%s\n", 
	`tm≤am
(
NULL
));

11 
	`tm≤am
(
«me
);

12 
	`¥ötf
("%s\n", 
«me
);

14 i‡((
Â
 = 
	`tmpfûe
()Ë=
NULL
)

15 
	`îr_sys
("tmpfileÉrror");

16 
	`Âuts
("⁄êlöêo‡ouçut\n", 
Â
);

17 
	`ªwöd
(
Â
);

18 i‡(
	`fgës
(
löe
, ÷öe), 
Â
Ë=
NULL
)

19 
	`îr_sys
("fgetsÉrror");

20 
	`Âuts
(
löe
, 
°dout
);

22 
	`exô
(0);

23 
	}
}

	@termios/csize.c

1 
	~"≠ue.h
"

2 
	~<ãrmios.h
>

5 
	$maö
()

7 
ãrmios
 
ãrm
;

9 i‡(
	`tcgë©å
(
STDIN_FILENO
, &
ãrm
) < 0)

10 
	`îr_sys
("tcgetattrÉrror");

12 
ãrm
.
c_cÊag
 & 
CSIZE
) {

13 
CS5
:

14 
	`¥ötf
("5 bits/byte\n");

16 
CS6
:

17 
	`¥ötf
("6 bits/byte\n");

19 
CS7
:

20 
	`¥ötf
("7 bits/byte\n");

22 
CS8
:

23 
	`¥ötf
("8 bits/byte\n");

26 
	`¥ötf
("unknown bits/byte\n");

29 
ãrm
.
c_cÊag
 &~
CSIZE
;

30 
ãrm
.
c_cÊag
 |
CS8
;

31 i‡(
	`tc£èâr
(
STDIN_FILENO
, 
TCSANOW
, &
ãrm
) < 0)

32 
	`îr_sys
("tcsetattrÉrror");

34 
	`exô
(0);

35 
	}
}

	@termios/ctermid.c

1 
	~<°dio.h
>

2 
	~<°rög.h
>

4 
	g˘îmid_«me
[
L_˘îmid
];

7 
	$˘îmid
(*
°r
)

9 i‡(
°r
 =
NULL
)

10 
°r
 = 
˘îmid_«me
;

11 (
	`°r˝y
(
°r
, "/dev/tty"));

12 
	}
}

	@termios/getpass.c

1 
	~<sig«l.h
>

2 
	~<°dio.h
>

3 
	~<ãrmios.h
>

5 
	#MAX_PASS_LEN
 8

	)

8 
	$gë∑ss
(c⁄° *
¥om±
)

10 
buf
[
MAX_PASS_LEN
 + 1];

11 *
±r
;

12 
sig£t_t
 
sig
, 
osig
;

13 
ãrmios
 
ts
, 
Ÿs
;

14 
FILE
 *
Â
;

15 
c
;

17 i‡((
Â
 = 
	`f›í
(
	`˘îmid
(
NULL
), "r+")) == NULL)

18 (
NULL
);

19 
	`£tbuf
(
Â
, 
NULL
);

21 
	`sigem±y£t
(&
sig
);

22 
	`sigadd£t
(&
sig
, 
SIGINT
);

23 
	`sigadd£t
(&
sig
, 
SIGTSTP
);

24 
	`sig¥ocmask
(
SIG_BLOCK
, &
sig
, &
osig
);

26 
	`tcgë©å
(
	`fûío
(
Â
), &
ts
);

27 
Ÿs
 = 
ts
;

28 
ts
.
c_lÊag
 &~(
ECHO
 | 
ECHOE
 | 
ECHOK
 | 
ECHONL
);

29 
	`tc£èâr
(
	`fûío
(
Â
), 
TCSAFLUSH
, &
ts
);

30 
	`Âuts
(
¥om±
, 
Â
);

32 
±r
 = 
buf
;

33 (
c
 = 
	`gëc
(
Â
)Ë!
EOF
 && c != '\n')

34 i‡(
±r
 < &
buf
[
MAX_PASS_LEN
])

35 *
±r
++ = 
c
;

36 *
±r
 = 0;

37 
	`putc
('\n', 
Â
);

39 
	`tc£èâr
(
	`fûío
(
Â
), 
TCSAFLUSH
, &
Ÿs
);

40 
	`sig¥ocmask
(
SIG_SETMASK
, &
osig
, 
NULL
);

41 
	`f˛o£
(
Â
);

42 (
buf
);

43 
	}
}

	@termios/isatty.c

1 
	~<ãrmios.h
>

4 
	$ißây
(
fd
)

6 
ãrmios
 
ts
;

8 (
	`tcgë©å
(
fd
, &
ts
) != -1);

9 
	}
}

	@termios/settty.c

1 
	~"≠ue.h
"

2 
	~<ãrmios.h
>

5 
	$maö
()

7 
ãrmios
 
ãrm
;

8 
vdißbÀ
;

10 i‡(
	`ißây
(
STDIN_FILENO
) == 0)

11 
	`îr_quô
("standard input isÇotáÅerminal device");

13 i‡((
vdißbÀ
 = 
	`Â©hc⁄f
(
STDIN_FILENO
, 
_PC_VDISABLE
)) < 0)

14 
	`îr_quô
("fpathconfÉrror or _POSIX_VDISABLEÇot inÉffect");

16 i‡(
	`tcgë©å
(
STDIN_FILENO
, &
ãrm
) < 0)

17 
	`îr_sys
("tcgetattrÉrror");

19 
ãrm
.
c_cc
[
VINTR
] = 
vdißbÀ
;

20 
ãrm
.
c_cc
[
VEOF
] = 2;

22 i‡(
	`tc£èâr
(
STDIN_FILENO
, 
TCSAFLUSH
, &
ãrm
) < 0)

23 
	`îr_sys
("tcsetattrÉrror");

25 
	`exô
(0);

26 
	}
}

	@termios/t_getpass.c

1 
	~"≠ue.h
"

3 *
gë∑ss
(const *);

6 
	$maö
()

8 *
±r
;

10 i‡((
±r
 = 
	`gë∑ss
("E¡îÖassw‹d:")Ë=
NULL
)

11 
	`îr_sys
("getpassÉrror");

12 
	`¥ötf
("∑ssw‹d: %s\n", 
±r
);

16 *
±r
 != 0)

17 *
±r
++ = 0;

18 
	`exô
(0);

19 
	}
}

	@termios/t_isatty.c

1 
	~"≠ue.h
"

4 
	$maö
()

6 
	`¥ötf
("fd 0: %s\n", 
	`ißây
(0) ? "tty" : "notáÅty");

7 
	`¥ötf
("fd 1: %s\n", 
	`ißây
(1) ? "tty" : "notáÅty");

8 
	`¥ötf
("fd 2: %s\n", 
	`ißây
(2) ? "tty" : "notáÅty");

9 
	`exô
(0);

10 
	}
}

	@termios/t_raw.c

1 
	~"≠ue.h
"

4 
	$sig_ˇtch
(
signo
)

6 
	`¥ötf
("signal caught\n");

7 
	`ây_ª£t
(
STDIN_FILENO
);

8 
	`exô
(0);

9 
	}
}

12 
	$maö
()

14 
i
;

15 
c
;

17 i‡(
	`sig«l
(
SIGINT
, 
sig_ˇtch
Ë=
SIG_ERR
)

18 
	`îr_sys
("signal(SIGINT)Érror");

19 i‡(
	`sig«l
(
SIGQUIT
, 
sig_ˇtch
Ë=
SIG_ERR
)

20 
	`îr_sys
("signal(SIGQUIT)Érror");

21 i‡(
	`sig«l
(
SIGTERM
, 
sig_ˇtch
Ë=
SIG_ERR
)

22 
	`îr_sys
("signal(SIGTERM)Érror");

24 i‡(
	`ây_øw
(
STDIN_FILENO
) < 0)

25 
	`îr_sys
("tty_rawÉrror");

26 
	`¥ötf
("EnterÑaw mode characters,Åerminate with DELETE\n");

27 (
i
 = 
	`ªad
(
STDIN_FILENO
, &
c
, 1)) == 1) {

28 i‡((
c
 &= 255) == 0177)

30 
	`¥ötf
("%o\n", 
c
);

32 i‡(
	`ây_ª£t
(
STDIN_FILENO
) < 0)

33 
	`îr_sys
("tty_resetÉrror");

34 i‡(
i
 <= 0)

35 
	`îr_sys
("readÉrror");

36 i‡(
	`ây_cbªak
(
STDIN_FILENO
) < 0)

37 
	`îr_sys
("tty_cbreakÉrror");

38 
	`¥ötf
("\nEnter cbreak mode characters,Åerminate with SIGINT\n");

39 (
i
 = 
	`ªad
(
STDIN_FILENO
, &
c
, 1)) == 1) {

40 
c
 &= 255;

41 
	`¥ötf
("%o\n", 
c
);

43 i‡(
	`ây_ª£t
(
STDIN_FILENO
) < 0)

44 
	`îr_sys
("tty_resetÉrror");

45 i‡(
i
 <= 0)

46 
	`îr_sys
("readÉrror");

48 
	`exô
(0);

49 
	}
}

	@termios/t_ttyname.c

1 
	~"≠ue.h
"

4 
	$maö
()

6 *
«me
;

7 i‡(
	`ißây
(0)) {

8 
«me
 = 
	`ây«me
(0);

9 i‡(
«me
 =
NULL
)

10 
«me
 = "undefined";

12 
«me
 = "notáÅty";

14 
	`¥ötf
("fd 0: %s\n", 
«me
);

16 i‡(
	`ißây
(1)) {

17 
«me
 = 
	`ây«me
(1);

18 i‡(
«me
 =
NULL
)

19 
«me
 = "undefined";

21 
«me
 = "notáÅty";

23 
	`¥ötf
("fd 1: %s\n", 
«me
);

25 i‡(
	`ißây
(2)) {

26 
«me
 = 
	`ây«me
(2);

27 i‡(
«me
 =
NULL
)

28 
«me
 = "undefined";

30 
«me
 = "notáÅty";

32 
	`¥ötf
("fd 2: %s\n", 
«me
);

34 
	`exô
(0);

35 
	}
}

	@termios/ttyname.c

1 
	~<sys/°©.h
>

2 
	~<dúít.h
>

3 
	~<limôs.h
>

4 
	~<°rög.h
>

5 
	~<ãrmios.h
>

6 
	~<uni°d.h
>

7 
	~<°dlib.h
>

9 
	sdevdú
 {

10 
devdú
 *
	md_√xt
;

11 *
	md_«me
;

14 
devdú
 *
	ghód
;

15 
devdú
 *
	gèû
;

16 
	g∑th«me
[
_POSIX_PATH_MAX
 + 1];

19 
	$add
(*
dú«me
)

21 
devdú
 *
ddp
;

22 
Àn
;

24 
Àn
 = 
	`°æí
(
dú«me
);

29 i‡((
dú«me
[
Àn
-1] == '.') && (dirname[len-2] == '/' ||

30 (
dú«me
[
Àn
-2] == '.' && dirname[len-3] == '/')))

32 i‡(
	`°rcmp
(
dú«me
, "/dev/fd") == 0)

34 i‡((
ddp
 = 
	`mÆloc
((
devdú
))Ë=
NULL
)

37 i‡((
ddp
->
d_«me
 = 
	`°rdup
(
dú«me
)Ë=
NULL
) {

38 
	`‰ì
(
ddp
);

42 
ddp
->
d_√xt
 = 
NULL
;

43 i‡(
èû
 =
NULL
) {

44 
hód
 = 
ddp
;

45 
èû
 = 
ddp
;

47 
èû
->
d_√xt
 = 
ddp
;

48 
èû
 = 
ddp
;

50 
	}
}

53 
	$˛ónup
()

55 
devdú
 *
ddp
, *
nddp
;

57 
ddp
 = 
hód
;

58 
ddp
 !
NULL
) {

59 
nddp
 = 
ddp
->
d_√xt
;

60 
	`‰ì
(
ddp
->
d_«me
);

61 
	`‰ì
(
ddp
);

62 
ddp
 = 
nddp
;

64 
hód
 = 
NULL
;

65 
èû
 = 
NULL
;

66 
	}
}

69 
	$£¨chdú
(*
dú«me
, 
°©
 *
fd°©p
)

71 
°©
 
dev°©
;

72 
DIR
 *
dp
;

73 
devÀn
;

74 
dúít
 *
dúp
;

76 
	`°r˝y
(
∑th«me
, 
dú«me
);

77 i‡((
dp
 = 
	`›ídú
(
dú«me
)Ë=
NULL
)

78 (
NULL
);

79 
	`°rˇt
(
∑th«me
, "/");

80 
devÀn
 = 
	`°æí
(
∑th«me
);

81 (
dúp
 = 
	`ªaddú
(
dp
)Ë!
NULL
) {

82 
	`°∫˝y
(
∑th«me
 + 
devÀn
, 
dúp
->
d_«me
,

83 
_POSIX_PATH_MAX
 - 
devÀn
);

88 i‡(
	`°rcmp
(
∑th«me
, "/dev/stdin") == 0 ||

89 
	`°rcmp
(
∑th«me
, "/dev/stdout") == 0 ||

90 
	`°rcmp
(
∑th«me
, "/dev/stderr") == 0)

92 i‡(
	`°©
(
∑th«me
, &
dev°©
) < 0)

94 i‡(
	`S_ISDIR
(
dev°©
.
°_mode
)) {

95 
	`add
(
∑th«me
);

98 i‡(
dev°©
.
°_öo
 =
fd°©p
->st_ino &&

99 
dev°©
.
°_dev
 =
fd°©p
->st_dev) {

100 
	`˛o£dú
(
dp
);

101 (
∑th«me
);

105 
	`˛o£dú
(
dp
);

106 (
NULL
);

107 
	}
}

110 
	$ây«me
(
fd
)

112 
°©
 
fd°©
;

113 
devdú
 *
ddp
;

114 *
rvÆ
;

116 i‡(
	`ißây
(
fd
) == 0)

117 (
NULL
);

118 i‡(
	`f°©
(
fd
, &
fd°©
) < 0)

119 (
NULL
);

120 i‡(
	`S_ISCHR
(
fd°©
.
°_mode
) == 0)

121 (
NULL
);

123 
rvÆ
 = 
	`£¨chdú
("/dev", &
fd°©
);

124 i‡(
rvÆ
 =
NULL
) {

125 
ddp
 = 
hód
; dd∞!
NULL
; dd∞ddp->
d_√xt
)

126 i‡((
rvÆ
 = 
	`£¨chdú
(
ddp
->
d_«me
, &
fd°©
)Ë!
NULL
)

130 
	`˛ónup
();

131 (
rvÆ
);

132 
	}
}

	@termios/winch.c

1 
	~"≠ue.h
"

2 
	~<ãrmios.h
>

3 #i‚def 
TIOCGWINSZ


4 
	~<sys/io˘l.h
>

8 
	$¥_wösize
(
fd
)

10 
wösize
 
size
;

12 i‡(
	`io˘l
(
fd
, 
TIOCGWINSZ
, (*Ë&
size
) < 0)

13 
	`îr_sys
("TIOCGWINSZÉrror");

14 
	`¥ötf
("%dÑows, %d cﬁumns\n", 
size
.
ws_row
, size.
ws_cﬁ
);

15 
	}
}

18 
	$sig_wöch
(
signo
)

20 
	`¥ötf
("SIGWINCHÑeceived\n");

21 
	`¥_wösize
(
STDIN_FILENO
);

22 
	}
}

25 
	$maö
()

27 i‡(
	`ißây
(
STDIN_FILENO
) == 0)

28 
	`exô
(1);

29 i‡(
	`sig«l
(
SIGWINCH
, 
sig_wöch
Ë=
SIG_ERR
)

30 
	`îr_sys
("signalÉrror");

31 
	`¥_wösize
(
STDIN_FILENO
);

33 
	`∑u£
();

34 
	}
}

	@threadctl/atfork.c

1 
	~"≠ue.h
"

2 
	~<±hªad.h
>

4 
±hªad_muãx_t
 
	glock1
 = 
PTHREAD_MUTEX_INITIALIZER
;

5 
±hªad_muãx_t
 
	glock2
 = 
PTHREAD_MUTEX_INITIALIZER
;

8 
	$¥ï¨e
()

10 
îr
;

12 
	`¥ötf
("preparingÜocks...\n");

13 i‡((
îr
 = 
	`±hªad_muãx_lock
(&
lock1
)) != 0)

14 
	`îr_c⁄t
(
îr
, "can'tÜockÜock1 inÖrepare handler");

15 i‡((
îr
 = 
	`±hªad_muãx_lock
(&
lock2
)) != 0)

16 
	`îr_c⁄t
(
îr
, "can'tÜockÜock2 inÖrepare handler");

17 
	}
}

20 
	$∑ª¡
()

22 
îr
;

24 
	`¥ötf
("parent unlockingÜocks...\n");

25 i‡((
îr
 = 
	`±hªad_muãx_u∆ock
(&
lock1
)) != 0)

26 
	`îr_c⁄t
(
îr
, "can't unlockÜock1 inÖarent handler");

27 i‡((
îr
 = 
	`±hªad_muãx_u∆ock
(&
lock2
)) != 0)

28 
	`îr_c⁄t
(
îr
, "can't unlockÜock2 inÖarent handler");

29 
	}
}

32 
	$chûd
()

34 
îr
;

36 
	`¥ötf
("child unlockingÜocks...\n");

37 i‡((
îr
 = 
	`±hªad_muãx_u∆ock
(&
lock1
)) != 0)

38 
	`îr_c⁄t
(
îr
, "can't unlockÜock1 in child handler");

39 i‡((
îr
 = 
	`±hªad_muãx_u∆ock
(&
lock2
)) != 0)

40 
	`îr_c⁄t
(
îr
, "can't unlockÜock2 in child handler");

41 
	}
}

44 
	$thr_‚
(*
¨g
)

46 
	`¥ötf
("thread started...\n");

47 
	`∑u£
();

49 
	}
}

52 
	$maö
()

54 
îr
;

55 
pid_t
 
pid
;

56 
±hªad_t
 
tid
;

58 i‡((
îr
 = 
	`±hªad_©f‹k
(
¥ï¨e
, 
∑ª¡
, 
chûd
)) != 0)

59 
	`îr_exô
(
îr
, "can't install fork handlers");

60 i‡((
îr
 = 
	`±hªad_¸óã
(&
tid
, 
NULL
, 
thr_‚
, 0)) != 0)

61 
	`îr_exô
(
îr
, "can't createÅhread");

63 
	`¶ìp
(2);

64 
	`¥ötf
("parentáboutÅo fork...\n");

66 i‡((
pid
 = 
	`f‹k
()) < 0)

67 
	`îr_quô
("fork failed");

68 i‡(
pid
 == 0)

69 
	`¥ötf
("childÑeturned from fork\n");

71 
	`¥ötf
("parentÑeturned from fork\n");

72 
	`exô
(0);

73 
	}
}

	@threadctl/detach.c

1 
	~"≠ue.h
"

2 
	~<±hªad.h
>

5 
makëhªad
(*(*
‚
)(*), *
¨g
)

7 
	gîr
;

8 
±hªad_t
 
	gtid
;

9 
±hªad_©å_t
 
	g©å
;

11 
	gîr
 = 
±hªad_©å_öô
(&
©å
);

12 i‡(
	gîr
 != 0)

13 (
îr
);

14 
	gîr
 = 
±hªad_©å_£tdëach°©e
(&
©å
, 
PTHREAD_CREATE_DETACHED
);

15 i‡(
	gîr
 == 0)

16 
îr
 = 
±hªad_¸óã
(&
tid
, &
©å
, 
‚
, 
¨g
);

17 
±hªad_©å_de°roy
(&
©å
);

18 (
	gîr
);

	@threadctl/getenv1.c

1 
	~<limôs.h
>

2 
	~<°rög.h
>

4 
	#MAXSTRINGSZ
 4096

	)

6 
	gívbuf
[
MAXSTRINGSZ
];

8 **
ívú⁄
;

11 
	$gëív
(c⁄° *
«me
)

13 
i
, 
Àn
;

15 
Àn
 = 
	`°æí
(
«me
);

16 
i
 = 0; 
ívú⁄
[i] !
NULL
; i++) {

17 i‡((
	`°∫cmp
(
«me
, 
ívú⁄
[
i
], 
Àn
) == 0) &&

18 (
ívú⁄
[
i
][
Àn
] == '=')) {

19 
	`°∫˝y
(
ívbuf
, &
ívú⁄
[
i
][
Àn
+1], 
MAXSTRINGSZ
-1);

20 (
ívbuf
);

23 (
NULL
);

24 
	}
}

	@threadctl/getenv2.c

1 
	~<°rög.h
>

2 
	~<î∫o.h
>

3 
	~<±hªad.h
>

4 
	~<°dlib.h
>

6 **
ívú⁄
;

8 
±hªad_muãx_t
 
	gív_muãx
;

10 
±hªad_⁄˚_t
 
	göô_d⁄e
 = 
PTHREAD_ONCE_INIT
;

13 
	$thªad_öô
()

15 
±hªad_muãx©å_t
 
©å
;

17 
	`±hªad_muãx©å_öô
(&
©å
);

18 
	`±hªad_muãx©å_£ây≥
(&
©å
, 
PTHREAD_MUTEX_RECURSIVE
);

19 
	`±hªad_muãx_öô
(&
ív_muãx
, &
©å
);

20 
	`±hªad_muãx©å_de°roy
(&
©å
);

21 
	}
}

24 
	$gëív_r
(c⁄° *
«me
, *
buf
, 
buÊí
)

26 
i
, 
Àn
, 
ﬁí
;

28 
	`±hªad_⁄˚
(&
öô_d⁄e
, 
thªad_öô
);

29 
Àn
 = 
	`°æí
(
«me
);

30 
	`±hªad_muãx_lock
(&
ív_muãx
);

31 
i
 = 0; 
ívú⁄
[i] !
NULL
; i++) {

32 i‡((
	`°∫cmp
(
«me
, 
ívú⁄
[
i
], 
Àn
) == 0) &&

33 (
ívú⁄
[
i
][
Àn
] == '=')) {

34 
ﬁí
 = 
	`°æí
(&
ívú⁄
[
i
][
Àn
+1]);

35 i‡(
ﬁí
 >
buÊí
) {

36 
	`±hªad_muãx_u∆ock
(&
ív_muãx
);

37 (
ENOSPC
);

39 
	`°r˝y
(
buf
, &
ívú⁄
[
i
][
Àn
+1]);

40 
	`±hªad_muãx_u∆ock
(&
ív_muãx
);

44 
	`±hªad_muãx_u∆ock
(&
ív_muãx
);

45 (
ENOENT
);

46 
	}
}

	@threadctl/getenv3.c

1 
	~<limôs.h
>

2 
	~<°rög.h
>

3 
	~<±hªad.h
>

4 
	~<°dlib.h
>

6 
	#MAXSTRINGSZ
 4096

	)

8 
±hªad_key_t
 
	gkey
;

9 
±hªad_⁄˚_t
 
	göô_d⁄e
 = 
PTHREAD_ONCE_INIT
;

10 
±hªad_muãx_t
 
	gív_muãx
 = 
PTHREAD_MUTEX_INITIALIZER
;

12 **
ívú⁄
;

15 
	$thªad_öô
()

17 
	`±hªad_key_¸óã
(&
key
, 
‰ì
);

18 
	}
}

21 
	$gëív
(c⁄° *
«me
)

23 
i
, 
Àn
;

24 *
ívbuf
;

26 
	`±hªad_⁄˚
(&
öô_d⁄e
, 
thªad_öô
);

27 
	`±hªad_muãx_lock
(&
ív_muãx
);

28 
ívbuf
 = (*)
	`±hªad_gë•ecific
(
key
);

29 i‡(
ívbuf
 =
NULL
) {

30 
ívbuf
 = 
	`mÆloc
(
MAXSTRINGSZ
);

31 i‡(
ívbuf
 =
NULL
) {

32 
	`±hªad_muãx_u∆ock
(&
ív_muãx
);

33 (
NULL
);

35 
	`±hªad_£t•ecific
(
key
, 
ívbuf
);

37 
Àn
 = 
	`°æí
(
«me
);

38 
i
 = 0; 
ívú⁄
[i] !
NULL
; i++) {

39 i‡((
	`°∫cmp
(
«me
, 
ívú⁄
[
i
], 
Àn
) == 0) &&

40 (
ívú⁄
[
i
][
Àn
] == '=')) {

41 
	`°∫˝y
(
ívbuf
, &
ívú⁄
[
i
][
Àn
+1], 
MAXSTRINGSZ
-1);

42 
	`±hªad_muãx_u∆ock
(&
ív_muãx
);

43 (
ívbuf
);

46 
	`±hªad_muãx_u∆ock
(&
ív_muãx
);

47 (
NULL
);

48 
	}
}

	@threadctl/suspend.c

1 
	~"≠ue.h
"

2 
	~<±hªad.h
>

4 
	gquôÊag
;

5 
sig£t_t
 
	gmask
;

7 
±hªad_muãx_t
 
	glock
 = 
PTHREAD_MUTEX_INITIALIZER
;

8 
±hªad_c⁄d_t
 
	gwaôloc
 = 
PTHREAD_COND_INITIALIZER
;

11 
	$thr_‚
(*
¨g
)

13 
îr
, 
signo
;

16 
îr
 = 
	`sigwaô
(&
mask
, &
signo
);

17 i‡(
îr
 != 0)

18 
	`îr_exô
(
îr
, "sigwait failed");

19 
signo
) {

20 
SIGINT
:

21 
	`¥ötf
("\ninterrupt\n");

24 
SIGQUIT
:

25 
	`±hªad_muãx_lock
(&
lock
);

26 
quôÊag
 = 1;

27 
	`±hªad_muãx_u∆ock
(&
lock
);

28 
	`±hªad_c⁄d_sig«l
(&
waôloc
);

32 
	`¥ötf
("u√x≥˘ed sig«»%d\n", 
signo
);

33 
	`exô
(1);

36 
	}
}

39 
	$maö
()

41 
îr
;

42 
sig£t_t
 
ﬁdmask
;

43 
±hªad_t
 
tid
;

45 
	`sigem±y£t
(&
mask
);

46 
	`sigadd£t
(&
mask
, 
SIGINT
);

47 
	`sigadd£t
(&
mask
, 
SIGQUIT
);

48 i‡((
îr
 = 
	`±hªad_sigmask
(
SIG_BLOCK
, &
mask
, &
ﬁdmask
)) != 0)

49 
	`îr_exô
(
îr
, "SIG_BLOCKÉrror");

51 
îr
 = 
	`±hªad_¸óã
(&
tid
, 
NULL
, 
thr_‚
, 0);

52 i‡(
îr
 != 0)

53 
	`îr_exô
(
îr
, "can't createÅhread");

55 
	`±hªad_muãx_lock
(&
lock
);

56 
quôÊag
 == 0)

57 
	`±hªad_c⁄d_waô
(&
waôloc
, &
lock
);

58 
	`±hªad_muãx_u∆ock
(&
lock
);

61 
quôÊag
 = 0;

64 i‡(
	`sig¥ocmask
(
SIG_SETMASK
, &
ﬁdmask
, 
NULL
) < 0)

65 
	`îr_sys
("SIG_SETMASKÉrror");

66 
	`exô
(0);

67 
	}
}

	@threadctl/timeout.c

1 
	~"≠ue.h
"

2 
	~<±hªad.h
>

3 
	~<time.h
>

4 
	~<sys/time.h
>

6 
makëhªad
(*(*)(*), *);

8 
	sto_öfo
 {

9 (*
	mto_‚
)(*);

10 *
	mto_¨g
;

11 
time•ec
 
	mto_waô
;

14 
	#SECTONSEC
 1000000000

	)

16 #i‡!
deföed
(
CLOCK_REALTIME
Ë|| deföed(
BSD
)

17 
	#˛ock_«no¶ìp
(
ID
, 
FL
, 
REQ
, 
REM
Ë
	`«no¶ìp
((REQ), (REM))

	)

20 #i‚de‡
CLOCK_REALTIME


21 
	#CLOCK_REALTIME
 0

	)

22 
	#USECTONSEC
 1000

	)

25 
	$˛ock_gëtime
(
id
, 
time•ec
 *
t•
)

27 
timevÆ
 
tv
;

29 
	`gëtimeofday
(&
tv
, 
NULL
);

30 
t•
->
tv_£c
 = 
tv
.tv_sec;

31 
t•
->
tv_n£c
 = 
tv
.
tv_u£c
 * 
USECTONSEC
;

32 
	}
}

36 
	$timeout_hñ≥r
(*
¨g
)

38 
to_öfo
 *
tù
;

40 
tù
 = (
to_öfo
 *)
¨g
;

41 
	`˛ock_«no¶ìp
(
CLOCK_REALTIME
, 0, &
tù
->
to_waô
, 
NULL
);

42 (*
tù
->
to_‚
)—ù->
to_¨g
);

43 
	`‰ì
(
¨g
);

45 
	}
}

48 
timeout
(c⁄° 
time•ec
 *
whí
, (*
func
)(*), *
¨g
)

50 
time•ec
 
now
;

51 
to_öfo
 *
tù
;

52 
îr
;

54 
	`˛ock_gëtime
(
CLOCK_REALTIME
, &
now
);

55 i‡((
whí
->
tv_£c
 > 
now
.tv_sec) ||

56 (
whí
->
tv_£c
 =
now
.tv_£¯&& whí->
tv_n£c
 >Çow.tv_nsec)) {

57 
tù
 = 
	`mÆloc
((
to_öfo
));

58 i‡(
tù
 !
NULL
) {

59 
tù
->
to_‚
 = 
func
;

60 
tù
->
to_¨g
 = 
¨g
;

61 
tù
->
to_waô
.
tv_£c
 = 
whí
->tv_£¯- 
now
.tv_sec;

62 i‡(
whí
->
tv_n£c
 >
now
.tv_nsec) {

63 
tù
->
to_waô
.
tv_n£c
 = 
whí
->tv_n£¯- 
now
.tv_nsec;

65 
tù
->
to_waô
.
tv_£c
--;

66 
tù
->
to_waô
.
tv_n£c
 = 
SECTONSEC
 - 
now
.tv_nsec +

67 
whí
->
tv_n£c
;

69 
îr
 = 
	`makëhªad
(
timeout_hñ≥r
, (*)
tù
);

70 i‡(
îr
 == 0)

73 
	`‰ì
(
tù
);

81 (*
func
)(
¨g
);

82 
	}
}

84 
±hªad_muãx©å_t
 
	g©å
;

85 
±hªad_muãx_t
 
	gmuãx
;

88 
	$ªåy
(*
¨g
)

90 
	`±hªad_muãx_lock
(&
muãx
);

94 
	`±hªad_muãx_u∆ock
(&
muãx
);

95 
	}
}

98 
	$maö
()

100 
îr
, 
c⁄dôi⁄
, 
¨g
;

101 
time•ec
 
whí
;

103 i‡((
îr
 = 
	`±hªad_muãx©å_öô
(&
©å
)) != 0)

104 
	`îr_exô
(
îr
, "pthread_mutexattr_init failed");

105 i‡((
îr
 = 
	`±hªad_muãx©å_£ây≥
(&
©å
,

106 
PTHREAD_MUTEX_RECURSIVE
)) != 0)

107 
	`îr_exô
(
îr
, "can't setÑecursiveÅype");

108 i‡((
îr
 = 
	`±hªad_muãx_öô
(&
muãx
, &
©å
)) != 0)

109 
	`îr_exô
(
îr
, "can't createÑecursive mutex");

113 
	`±hªad_muãx_lock
(&
muãx
);

119 i‡(
c⁄dôi⁄
) {

123 
	`˛ock_gëtime
(
CLOCK_REALTIME
, &
whí
);

124 
whí
.
tv_£c
 += 10;

125 
	`timeout
(&
whí
, 
ªåy
, (*)(()
¨g
));

127 
	`±hªad_muãx_u∆ock
(&
muãx
);

131 
	`exô
(0);

132 
	}
}

	@threads/badexit2.c

1 
	~"≠ue.h
"

2 
	~<±hªad.h
>

4 
	sfoo
 {

5 
	ma
, 
	mb
, 
	mc
, 
	md
;

9 
	$¥ötfoo
(c⁄° *
s
, c⁄° 
foo
 *
Â
)

11 
	`¥ötf
("%s", 
s
);

12 
	`¥ötf
(" såu˘uªáà0x%lx\n", ()
Â
);

13 
	`¥ötf
(" foo.®%d\n", 
Â
->
a
);

14 
	`¥ötf
(" foo.b = %d\n", 
Â
->
b
);

15 
	`¥ötf
(" foo.¯%d\n", 
Â
->
c
);

16 
	`¥ötf
(" foo.d = %d\n", 
Â
->
d
);

17 
	}
}

20 
	$thr_‚1
(*
¨g
)

22 
foo
 foo = {1, 2, 3, 4};

24 
	`¥ötfoo
("thªad 1:\n", &
foo
);

25 
	`±hªad_exô
((*)&
foo
);

26 
	}
}

29 
	$thr_‚2
(*
¨g
)

31 
	`¥ötf
("thªad 2: ID i†%lu\n", ()
	`±hªad_£lf
());

32 
	`±hªad_exô
((*)0);

33 
	}
}

36 
	$maö
()

38 
îr
;

39 
±hªad_t
 
tid1
, 
tid2
;

40 
foo
 *
Â
;

42 
îr
 = 
	`±hªad_¸óã
(&
tid1
, 
NULL
, 
thr_‚1
, NULL);

43 i‡(
îr
 != 0)

44 
	`îr_exô
(
îr
, "can't createÅhread 1");

45 
îr
 = 
	`±hªad_joö
(
tid1
, (*)&
Â
);

46 i‡(
îr
 != 0)

47 
	`îr_exô
(
îr
, "can't join withÅhread 1");

48 
	`¶ìp
(1);

49 
	`¥ötf
("parent starting secondÅhread\n");

50 
îr
 = 
	`±hªad_¸óã
(&
tid2
, 
NULL
, 
thr_‚2
, NULL);

51 i‡(
îr
 != 0)

52 
	`îr_exô
(
îr
, "can't createÅhread 2");

53 
	`¶ìp
(1);

54 
	`¥ötfoo
("∑ª¡:\n", 
Â
);

55 
	`exô
(0);

56 
	}
}

	@threads/barrier.c

1 
	~"≠ue.h
"

2 
	~<±hªad.h
>

3 
	~<limôs.h
>

4 
	~<sys/time.h
>

6 
	#NTHR
 8

	)

7 
	#NUMNUM
 8000000L

	)

8 
	#TNUM
 (
NUMNUM
/
NTHR
Ë

	)

10 
	gnums
[
NUMNUM
];

11 
	g¢ums
[
NUMNUM
];

13 
±hªad_b¨rõr_t
 
	gb
;

15 #ifde‡
SOLARIS


16 
	#hóps‹t
 
qs‹t


	)

18 
hóps‹t
(*, 
size_t
, size_t,

26 
	$com∂⁄g
(c⁄° *
¨g1
, c⁄° *
¨g2
)

28 
l1
 = *(*)
¨g1
;

29 
l2
 = *(*)
¨g2
;

31 i‡(
l1
 =
l2
)

33 i‡(
l1
 < 
l2
)

37 
	}
}

43 
	$thr_‚
(*
¨g
)

45 
idx
 = ()
¨g
;

47 
	`hóps‹t
(&
nums
[
idx
], 
TNUM
, (), 
com∂⁄g
);

48 
	`±hªad_b¨rõr_waô
(&
b
);

54 
	}
}

60 
	$mîge
()

62 
idx
[
NTHR
];

63 
i
, 
möidx
, 
sidx
, 
num
;

65 
i
 = 0; i < 
NTHR
; i++)

66 
idx
[
i
] = i * 
TNUM
;

67 
sidx
 = 0; sidx < 
NUMNUM
; sidx++) {

68 
num
 = 
LONG_MAX
;

69 
i
 = 0; i < 
NTHR
; i++) {

70 i‡((
idx
[
i
] < (i+1)*
TNUM
Ë&& (
nums
[idx[i]] < 
num
)) {

71 
num
 = 
nums
[
idx
[
i
]];

72 
möidx
 = 
i
;

75 
¢ums
[
sidx
] = 
nums
[
idx
[
möidx
]];

76 
idx
[
möidx
]++;

78 
	}
}

81 
	$maö
()

83 
i
;

84 
timevÆ
 
°¨t
, 
íd
;

85 
°¨tu£c
, 
ídu£c
;

86 
ñ≠£d
;

87 
îr
;

88 
±hªad_t
 
tid
;

93 
	`§™dom
(1);

94 
i
 = 0; i < 
NUMNUM
; i++)

95 
nums
[
i
] = 
	`øndom
();

100 
	`gëtimeofday
(&
°¨t
, 
NULL
);

101 
	`±hªad_b¨rõr_öô
(&
b
, 
NULL
, 
NTHR
+1);

102 
i
 = 0; i < 
NTHR
; i++) {

103 
îr
 = 
	`±hªad_¸óã
(&
tid
, 
NULL
, 
thr_‚
, (*)(
i
 * 
TNUM
));

104 i‡(
îr
 != 0)

105 
	`îr_exô
(
îr
, "can't createÅhread");

107 
	`±hªad_b¨rõr_waô
(&
b
);

108 
	`mîge
();

109 
	`gëtimeofday
(&
íd
, 
NULL
);

114 
°¨tu£c
 = 
°¨t
.
tv_£c
 * 1000000 + sèπ.
tv_u£c
;

115 
ídu£c
 = 
íd
.
tv_£c
 * 1000000 +Énd.
tv_u£c
;

116 
ñ≠£d
 = ()(
ídu£c
 - 
°¨tu£c
) / 1000000.0;

117 
	`¥ötf
("s‹àtook %.4‡£c⁄ds\n", 
ñ≠£d
);

118 
i
 = 0; i < 
NUMNUM
; i++)

119 
	`¥ötf
("%ld\n", 
¢ums
[
i
]);

120 
	`exô
(0);

121 
	}
}

	@threads/cleanup.c

1 
	~"≠ue.h
"

2 
	~<±hªad.h
>

5 
	$˛ónup
(*
¨g
)

7 
	`¥ötf
("˛ónup: %s\n", (*)
¨g
);

8 
	}
}

11 
	$thr_‚1
(*
¨g
)

13 
	`¥ötf
("thread 1 start\n");

14 
	`±hªad_˛ónup_push
(
˛ónup
, "thread 1 first handler");

15 
	`±hªad_˛ónup_push
(
˛ónup
, "thread 1 second handler");

16 
	`¥ötf
("thread 1Öush complete\n");

17 i‡(
¨g
)

19 
	`±hªad_˛ónup_p›
(0);

20 
	`±hªad_˛ónup_p›
(0);

22 
	}
}

25 
	$thr_‚2
(*
¨g
)

27 
	`¥ötf
("thread 2 start\n");

28 
	`±hªad_˛ónup_push
(
˛ónup
, "thread 2 first handler");

29 
	`±hªad_˛ónup_push
(
˛ónup
, "thread 2 second handler");

30 
	`¥ötf
("thread 2Öush complete\n");

31 i‡(
¨g
)

32 
	`±hªad_exô
((*)2);

33 
	`±hªad_˛ónup_p›
(0);

34 
	`±hªad_˛ónup_p›
(0);

35 
	`±hªad_exô
((*)2);

36 
	}
}

39 
	$maö
()

41 
îr
;

42 
±hªad_t
 
tid1
, 
tid2
;

43 *
åë
;

45 
îr
 = 
	`±hªad_¸óã
(&
tid1
, 
NULL
, 
thr_‚1
, (*)1);

46 i‡(
îr
 != 0)

47 
	`îr_exô
(
îr
, "can't createÅhread 1");

48 
îr
 = 
	`±hªad_¸óã
(&
tid2
, 
NULL
, 
thr_‚2
, (*)1);

49 i‡(
îr
 != 0)

50 
	`îr_exô
(
îr
, "can't createÅhread 2");

51 
îr
 = 
	`±hªad_joö
(
tid1
, &
åë
);

52 i‡(
îr
 != 0)

53 
	`îr_exô
(
îr
, "can't join withÅhread 1");

54 
	`¥ötf
("thªad 1Éxô codê%ld\n", ()
åë
);

55 
îr
 = 
	`±hªad_joö
(
tid2
, &
åë
);

56 i‡(
îr
 != 0)

57 
	`îr_exô
(
îr
, "can't join withÅhread 2");

58 
	`¥ötf
("thªad 2Éxô codê%ld\n", ()
åë
);

59 
	`exô
(0);

60 
	}
}

	@threads/condvar.c

1 
	~<±hªad.h
>

3 
	smsg
 {

4 
msg
 *
	mm_√xt
;

8 
msg
 *
	gw‹kq
;

10 
±hªad_c⁄d_t
 
	gqªady
 = 
PTHREAD_COND_INITIALIZER
;

12 
±hªad_muãx_t
 
	gqlock
 = 
PTHREAD_MUTEX_INITIALIZER
;

15 
	$¥o˚ss_msg
()

17 
msg
 *
mp
;

20 
	`±hªad_muãx_lock
(&
qlock
);

21 
w‹kq
 =
NULL
)

22 
	`±hªad_c⁄d_waô
(&
qªady
, &
qlock
);

23 
mp
 = 
w‹kq
;

24 
w‹kq
 = 
mp
->
m_√xt
;

25 
	`±hªad_muãx_u∆ock
(&
qlock
);

28 
	}
}

31 
	$íqueue_msg
(
msg
 *
mp
)

33 
	`±hªad_muãx_lock
(&
qlock
);

34 
mp
->
m_√xt
 = 
w‹kq
;

35 
w‹kq
 = 
mp
;

36 
	`±hªad_muãx_u∆ock
(&
qlock
);

37 
	`±hªad_c⁄d_sig«l
(&
qªady
);

38 
	}
}

	@threads/exitstatus.c

1 
	~"≠ue.h
"

2 
	~<±hªad.h
>

5 
	$thr_‚1
(*
¨g
)

7 
	`¥ötf
("thread 1Ñeturning\n");

9 
	}
}

12 
	$thr_‚2
(*
¨g
)

14 
	`¥ötf
("thread 2Éxiting\n");

15 
	`±hªad_exô
((*)2);

16 
	}
}

19 
	$maö
()

21 
îr
;

22 
±hªad_t
 
tid1
, 
tid2
;

23 *
åë
;

25 
îr
 = 
	`±hªad_¸óã
(&
tid1
, 
NULL
, 
thr_‚1
, NULL);

26 i‡(
îr
 != 0)

27 
	`îr_exô
(
îr
, "can't createÅhread 1");

28 
îr
 = 
	`±hªad_¸óã
(&
tid2
, 
NULL
, 
thr_‚2
, NULL);

29 i‡(
îr
 != 0)

30 
	`îr_exô
(
îr
, "can't createÅhread 2");

31 
îr
 = 
	`±hªad_joö
(
tid1
, &
åë
);

32 i‡(
îr
 != 0)

33 
	`îr_exô
(
îr
, "can't join withÅhread 1");

34 
	`¥ötf
("thªad 1Éxô codê%ld\n", ()
åë
);

35 
îr
 = 
	`±hªad_joö
(
tid2
, &
åë
);

36 i‡(
îr
 != 0)

37 
	`îr_exô
(
îr
, "can't join withÅhread 2");

38 
	`¥ötf
("thªad 2Éxô codê%ld\n", ()
åë
);

39 
	`exô
(0);

40 
	}
}

	@threads/maketimeout.c

1 
	~<sys/time.h
>

2 
	~<°dlib.h
>

5 
	$makëimeout
(
time•ec
 *
t•
, 
möuãs
)

7 
timevÆ
 
now
;

10 
	`gëtimeofday
(&
now
, 
NULL
);

11 
t•
->
tv_£c
 = 
now
.tv_sec;

12 
t•
->
tv_n£c
 = 
now
.
tv_u£c
 * 1000;

14 
t•
->
tv_£c
 +
möuãs
 * 60;

15 
	}
}

	@threads/mutex1.c

1 
	~<°dlib.h
>

2 
	~<±hªad.h
>

4 
	sfoo
 {

5 
	mf_cou¡
;

6 
±hªad_muãx_t
 
	mf_lock
;

7 
	mf_id
;

11 
foo
 *

12 
	$foo_Æloc
(
id
)

14 
foo
 *
Â
;

16 i‡((
Â
 = 
	`mÆloc
((
foo
))Ë!
NULL
) {

17 
Â
->
f_cou¡
 = 1;

18 
Â
->
f_id
 = 
id
;

19 i‡(
	`±hªad_muãx_öô
(&
Â
->
f_lock
, 
NULL
) != 0) {

20 
	`‰ì
(
Â
);

21 (
NULL
);

25 (
Â
);

26 
	}
}

29 
	$foo_hﬁd
(
foo
 *
Â
)

31 
	`±hªad_muãx_lock
(&
Â
->
f_lock
);

32 
Â
->
f_cou¡
++;

33 
	`±hªad_muãx_u∆ock
(&
Â
->
f_lock
);

34 
	}
}

37 
	$foo_ªÀ
(
foo
 *
Â
)

39 
	`±hªad_muãx_lock
(&
Â
->
f_lock
);

40 i‡(--
Â
->
f_cou¡
 == 0) {

41 
	`±hªad_muãx_u∆ock
(&
Â
->
f_lock
);

42 
	`±hªad_muãx_de°roy
(&
Â
->
f_lock
);

43 
	`‰ì
(
Â
);

45 
	`±hªad_muãx_u∆ock
(&
Â
->
f_lock
);

47 
	}
}

	@threads/mutex2.c

1 
	~<°dlib.h
>

2 
	~<±hªad.h
>

4 
	#NHASH
 29

	)

5 
	#HASH
(
id
Ë((()id)%
NHASH
)

	)

7 
foo
 *
	gfh
[
NHASH
];

9 
±hªad_muãx_t
 
	ghashlock
 = 
PTHREAD_MUTEX_INITIALIZER
;

11 
	sfoo
 {

12 
	mf_cou¡
;

13 
±hªad_muãx_t
 
	mf_lock
;

14 
	mf_id
;

15 
foo
 *
	mf_√xt
;

19 
foo
 *

20 
	$foo_Æloc
(
id
)

22 
foo
 *
Â
;

23 
idx
;

25 i‡((
Â
 = 
	`mÆloc
((
foo
))Ë!
NULL
) {

26 
Â
->
f_cou¡
 = 1;

27 
Â
->
f_id
 = 
id
;

28 i‡(
	`±hªad_muãx_öô
(&
Â
->
f_lock
, 
NULL
) != 0) {

29 
	`‰ì
(
Â
);

30 (
NULL
);

32 
idx
 = 
	`HASH
(
id
);

33 
	`±hªad_muãx_lock
(&
hashlock
);

34 
Â
->
f_√xt
 = 
fh
[
idx
];

35 
fh
[
idx
] = 
Â
;

36 
	`±hªad_muãx_lock
(&
Â
->
f_lock
);

37 
	`±hªad_muãx_u∆ock
(&
hashlock
);

39 
	`±hªad_muãx_u∆ock
(&
Â
->
f_lock
);

41 (
Â
);

42 
	}
}

45 
	$foo_hﬁd
(
foo
 *
Â
)

47 
	`±hªad_muãx_lock
(&
Â
->
f_lock
);

48 
Â
->
f_cou¡
++;

49 
	`±hªad_muãx_u∆ock
(&
Â
->
f_lock
);

50 
	}
}

52 
foo
 *

53 
	$foo_föd
(
id
)

55 
foo
 *
Â
;

57 
	`±hªad_muãx_lock
(&
hashlock
);

58 
Â
 = 
fh
[
	`HASH
(
id
)]; f∞!
NULL
; f∞Â->
f_√xt
) {

59 i‡(
Â
->
f_id
 =
id
) {

60 
	`foo_hﬁd
(
Â
);

64 
	`±hªad_muãx_u∆ock
(&
hashlock
);

65 (
Â
);

66 
	}
}

69 
	$foo_ªÀ
(
foo
 *
Â
)

71 
foo
 *
tÂ
;

72 
idx
;

74 
	`±hªad_muãx_lock
(&
Â
->
f_lock
);

75 i‡(
Â
->
f_cou¡
 == 1) {

76 
	`±hªad_muãx_u∆ock
(&
Â
->
f_lock
);

77 
	`±hªad_muãx_lock
(&
hashlock
);

78 
	`±hªad_muãx_lock
(&
Â
->
f_lock
);

80 i‡(
Â
->
f_cou¡
 != 1) {

81 
Â
->
f_cou¡
--;

82 
	`±hªad_muãx_u∆ock
(&
Â
->
f_lock
);

83 
	`±hªad_muãx_u∆ock
(&
hashlock
);

87 
idx
 = 
	`HASH
(
Â
->
f_id
);

88 
tÂ
 = 
fh
[
idx
];

89 i‡(
tÂ
 =
Â
) {

90 
fh
[
idx
] = 
Â
->
f_√xt
;

92 
tÂ
->
f_√xt
 !
Â
)

93 
tÂ
 =ÅÂ->
f_√xt
;

94 
tÂ
->
f_√xt
 = 
Â
->f_next;

96 
	`±hªad_muãx_u∆ock
(&
hashlock
);

97 
	`±hªad_muãx_u∆ock
(&
Â
->
f_lock
);

98 
	`±hªad_muãx_de°roy
(&
Â
->
f_lock
);

99 
	`‰ì
(
Â
);

101 
Â
->
f_cou¡
--;

102 
	`±hªad_muãx_u∆ock
(&
Â
->
f_lock
);

104 
	}
}

	@threads/mutex3.c

1 
	~<°dlib.h
>

2 
	~<±hªad.h
>

4 
	#NHASH
 29

	)

5 
	#HASH
(
id
Ë((()id)%
NHASH
)

	)

7 
foo
 *
	gfh
[
NHASH
];

8 
±hªad_muãx_t
 
	ghashlock
 = 
PTHREAD_MUTEX_INITIALIZER
;

10 
	sfoo
 {

11 
	mf_cou¡
;

12 
±hªad_muãx_t
 
	mf_lock
;

13 
	mf_id
;

14 
foo
 *
	mf_√xt
;

18 
foo
 *

19 
	$foo_Æloc
(
id
)

21 
foo
 *
Â
;

22 
idx
;

24 i‡((
Â
 = 
	`mÆloc
((
foo
))Ë!
NULL
) {

25 
Â
->
f_cou¡
 = 1;

26 
Â
->
f_id
 = 
id
;

27 i‡(
	`±hªad_muãx_öô
(&
Â
->
f_lock
, 
NULL
) != 0) {

28 
	`‰ì
(
Â
);

29 (
NULL
);

31 
idx
 = 
	`HASH
(
id
);

32 
	`±hªad_muãx_lock
(&
hashlock
);

33 
Â
->
f_√xt
 = 
fh
[
idx
];

34 
fh
[
idx
] = 
Â
;

35 
	`±hªad_muãx_lock
(&
Â
->
f_lock
);

36 
	`±hªad_muãx_u∆ock
(&
hashlock
);

38 
	`±hªad_muãx_u∆ock
(&
Â
->
f_lock
);

40 (
Â
);

41 
	}
}

44 
	$foo_hﬁd
(
foo
 *
Â
)

46 
	`±hªad_muãx_lock
(&
hashlock
);

47 
Â
->
f_cou¡
++;

48 
	`±hªad_muãx_u∆ock
(&
hashlock
);

49 
	}
}

51 
foo
 *

52 
	$foo_föd
(
id
)

54 
foo
 *
Â
;

56 
	`±hªad_muãx_lock
(&
hashlock
);

57 
Â
 = 
fh
[
	`HASH
(
id
)]; f∞!
NULL
; f∞Â->
f_√xt
) {

58 i‡(
Â
->
f_id
 =
id
) {

59 
Â
->
f_cou¡
++;

63 
	`±hªad_muãx_u∆ock
(&
hashlock
);

64 (
Â
);

65 
	}
}

68 
	$foo_ªÀ
(
foo
 *
Â
)

70 
foo
 *
tÂ
;

71 
idx
;

73 
	`±hªad_muãx_lock
(&
hashlock
);

74 i‡(--
Â
->
f_cou¡
 == 0) {

75 
idx
 = 
	`HASH
(
Â
->
f_id
);

76 
tÂ
 = 
fh
[
idx
];

77 i‡(
tÂ
 =
Â
) {

78 
fh
[
idx
] = 
Â
->
f_√xt
;

80 
tÂ
->
f_√xt
 !
Â
)

81 
tÂ
 =ÅÂ->
f_√xt
;

82 
tÂ
->
f_√xt
 = 
Â
->f_next;

84 
	`±hªad_muãx_u∆ock
(&
hashlock
);

85 
	`±hªad_muãx_de°roy
(&
Â
->
f_lock
);

86 
	`‰ì
(
Â
);

88 
	`±hªad_muãx_u∆ock
(&
hashlock
);

90 
	}
}

	@threads/rwlock.c

1 
	~<°dlib.h
>

2 
	~<±hªad.h
>

4 
	sjob
 {

5 
job
 *
	mj_√xt
;

6 
job
 *
	mj_¥ev
;

7 
±hªad_t
 
	mj_id
;

11 
	squeue
 {

12 
job
 *
	mq_hód
;

13 
job
 *
	mq_èû
;

14 
±hªad_rwlock_t
 
	mq_lock
;

21 
	$queue_öô
(
queue
 *
qp
)

23 
îr
;

25 
qp
->
q_hód
 = 
NULL
;

26 
qp
->
q_èû
 = 
NULL
;

27 
îr
 = 
	`±hªad_rwlock_öô
(&
qp
->
q_lock
, 
NULL
);

28 i‡(
îr
 != 0)

29 (
îr
);

32 
	}
}

38 
	$job_ö£π
(
queue
 *
qp
, 
job
 *
jp
)

40 
	`±hªad_rwlock_wæock
(&
qp
->
q_lock
);

41 
jp
->
j_√xt
 = 
qp
->
q_hód
;

42 
jp
->
j_¥ev
 = 
NULL
;

43 i‡(
qp
->
q_hód
 !
NULL
)

44 
qp
->
q_hód
->
j_¥ev
 = 
jp
;

46 
qp
->
q_èû
 = 
jp
;

47 
qp
->
q_hód
 = 
jp
;

48 
	`±hªad_rwlock_u∆ock
(&
qp
->
q_lock
);

49 
	}
}

55 
	$job_≠≥nd
(
queue
 *
qp
, 
job
 *
jp
)

57 
	`±hªad_rwlock_wæock
(&
qp
->
q_lock
);

58 
jp
->
j_√xt
 = 
NULL
;

59 
jp
->
j_¥ev
 = 
qp
->
q_èû
;

60 i‡(
qp
->
q_èû
 !
NULL
)

61 
qp
->
q_èû
->
j_√xt
 = 
jp
;

63 
qp
->
q_hód
 = 
jp
;

64 
qp
->
q_èû
 = 
jp
;

65 
	`±hªad_rwlock_u∆ock
(&
qp
->
q_lock
);

66 
	}
}

72 
	$job_ªmove
(
queue
 *
qp
, 
job
 *
jp
)

74 
	`±hªad_rwlock_wæock
(&
qp
->
q_lock
);

75 i‡(
jp
 =
qp
->
q_hód
) {

76 
qp
->
q_hód
 = 
jp
->
j_√xt
;

77 i‡(
qp
->
q_èû
 =
jp
)

78 
qp
->
q_èû
 = 
NULL
;

80 
jp
->
j_√xt
->
j_¥ev
 = jp->j_prev;

81 } i‡(
jp
 =
qp
->
q_èû
) {

82 
qp
->
q_èû
 = 
jp
->
j_¥ev
;

83 
jp
->
j_¥ev
->
j_√xt
 = jp->j_next;

85 
jp
->
j_¥ev
->
j_√xt
 = jp->j_next;

86 
jp
->
j_√xt
->
j_¥ev
 = jp->j_prev;

88 
	`±hªad_rwlock_u∆ock
(&
qp
->
q_lock
);

89 
	}
}

94 
job
 *

95 
	$job_föd
(
queue
 *
qp
, 
±hªad_t
 
id
)

97 
job
 *
jp
;

99 i‡(
	`±hªad_rwlock_rdlock
(&
qp
->
q_lock
) != 0)

100 (
NULL
);

102 
jp
 = 
qp
->
q_hód
; j∞!
NULL
; j∞jp->
j_√xt
)

103 i‡(
	`±hªad_equÆ
(
jp
->
j_id
, 
id
))

106 
	`±hªad_rwlock_u∆ock
(&
qp
->
q_lock
);

107 (
jp
);

108 
	}
}

	@threads/threadid.c

1 
	~"≠ue.h
"

2 
	~<±hªad.h
>

4 
±hªad_t
 
	g¡id
;

7 
	$¥ötids
(c⁄° *
s
)

9 
pid_t
 
pid
;

10 
±hªad_t
 
tid
;

12 
pid
 = 
	`gëpid
();

13 
tid
 = 
	`±hªad_£lf
();

14 
	`¥ötf
("%†pid %luÅid %lu (0x%lx)\n", 
s
, ()
pid
,

15 ()
tid
, ()tid);

16 
	}
}

19 
	$thr_‚
(*
¨g
)

21 
	`¥ötids
("newÅhread: ");

23 
	}
}

26 
	$maö
()

28 
îr
;

30 
îr
 = 
	`±hªad_¸óã
(&
¡id
, 
NULL
, 
thr_‚
, NULL);

31 i‡(
îr
 != 0)

32 
	`îr_exô
(
îr
, "can't createÅhread");

33 
	`¥ötids
("mainÅhread:");

34 
	`¶ìp
(1);

35 
	`exô
(0);

36 
	}
}

	@threads/timedlock.c

1 
	~"≠ue.h
"

2 
	~<±hªad.h
>

5 
	$maö
()

7 
îr
;

8 
time•ec
 
tout
;

9 
tm
 *
tmp
;

10 
buf
[64];

11 
±hªad_muãx_t
 
lock
 = 
PTHREAD_MUTEX_INITIALIZER
;

13 
	`±hªad_muãx_lock
(&
lock
);

14 
	`¥ötf
("mutex isÜocked\n");

15 
	`˛ock_gëtime
(
CLOCK_REALTIME
, &
tout
);

16 
tmp
 = 
	`loˇ…ime
(&
tout
.
tv_£c
);

17 
	`°r·ime
(
buf
, (buf), "%r", 
tmp
);

18 
	`¥ötf
("cuºíàtimêi†%s\n", 
buf
);

19 
tout
.
tv_£c
 += 10;

21 
îr
 = 
	`±hªad_muãx_timedlock
(&
lock
, &
tout
);

22 
	`˛ock_gëtime
(
CLOCK_REALTIME
, &
tout
);

23 
tmp
 = 
	`loˇ…ime
(&
tout
.
tv_£c
);

24 
	`°r·ime
(
buf
, (buf), "%r", 
tmp
);

25 
	`¥ötf
("thêtimêi†now %s\n", 
buf
);

26 i‡(
îr
 == 0)

27 
	`¥ötf
("mutexÜockedágain!\n");

29 
	`¥ötf
("ˇn'àlock muãxágaö: %s\n", 
	`°ªº‹
(
îr
));

30 
	`exô
(0);

31 
	}
}

	@
1
.
0
230
3832
advio/deadlock.c
advio/lockfile.c
advio/mandatory.c
advio/mcopy2.c
advio/nonblockw.c
advio/readn.c
advio/rot13a.c
advio/writen.c
daemons/init.c
daemons/reread.c
daemons/reread2.c
daemons/single.c
datafiles/getpwnam.c
datafiles/strftime.c
db/apue_db.h
db/db.c
db/t4.c
environ/cmd1.c
environ/cmd2.c
environ/doatexit.c
environ/echoarg.c
environ/getrlimit.c
environ/hello1.c
environ/opendata.c
environ/scope.c
environ/testjmp.c
exercises/asyncsocket.c
exercises/bo.c
exercises/fifo1.c
exercises/fmemopen.c
exercises/getlogin.c
exercises/getpw44bsd.c
exercises/getpwsvr4.c
exercises/goodexit.c
exercises/longpath.c
exercises/openmax.c
exercises/pendlock.c
exercises/pollmsg2.c
exercises/prtime.c
exercises/sizepipe.c
exercises/sleep.c
exercises/sleepus_poll.c
exercises/sleepus_select.c
exercises/vfork3.c
exercises/zombie.c
filedir/access.c
filedir/cdpwd.c
filedir/changemod.c
filedir/devrdev.c
filedir/filetype.c
filedir/ftw8.c
filedir/mycd.c
filedir/umask.c
filedir/unlink.c
filedir/zap.c
fileio/fileflags.c
fileio/hole.c
fileio/mycat.c
fileio/seek.c
fileio/setfl.c
include/apue.h
intro/getcputc.c
intro/hello.c
intro/ls1.c
intro/mycat.c
intro/shell1.c
intro/shell2.c
intro/testerror.c
intro/uidgid.c
ipc1/add2.c
ipc1/add2stdio.c
ipc1/devzero.c
ipc1/myuclc.c
ipc1/pipe1.c
ipc1/pipe2.c
ipc1/pipe4.c
ipc1/popen.c
ipc1/popen1.c
ipc1/popen2.c
ipc1/slock.c
ipc1/slock.h
ipc1/tellwait.c
ipc1/tshm.c
ipc2/bindunix.c
ipc2/open.fe/main.c
ipc2/open.fe/open.c
ipc2/open.fe/open.h
ipc2/open/main.c
ipc2/open/open.c
ipc2/open/open.h
ipc2/opend.fe/cliargs.c
ipc2/opend.fe/main.c
ipc2/opend.fe/opend.h
ipc2/opend.fe/request.c
ipc2/opend/cliargs.c
ipc2/opend/client.c
ipc2/opend/loop.poll.c
ipc2/opend/loop.select.c
ipc2/opend/main.c
ipc2/opend/opend.h
ipc2/opend/request.c
ipc2/pollmsg.c
ipc2/recvfd2.c
ipc2/sendfd2.c
ipc2/sendmsg.c
lib/Orecvfd.c
lib/bufargs.c
lib/cliconn.c
lib/clrfl.c
lib/daemonize.c
lib/error.c
lib/errorlog.c
lib/lockreg.c
lib/locktest.c
lib/nspipe.c
lib/openmax.c
lib/pathalloc.c
lib/popen.c
lib/prexit.c
lib/prmask.c
lib/ptyfork.c
lib/ptyopen.c
lib/readn.c
lib/recvfd.c
lib/semaph.c
lib/senderr.c
lib/sendfd.c
lib/servaccept.c
lib/servlisten.c
lib/setfd.c
lib/setfl.c
lib/signal.c
lib/signalintr.c
lib/sleep.c
lib/sleepus.c
lib/spipe.c
lib/strerror.c
lib/tellwait.c
lib/ttymodes.c
lib/writen.c
printer/ipp.h
printer/print.c
printer/print.h
printer/printd.c
printer/util.c
proc/echoall.c
proc/exec1.c
proc/exec2.c
proc/fork1.c
proc/fork2.c
proc/nice.c
proc/pracct.c
proc/pruids.c
proc/system.c
proc/systest1.c
proc/systest3.c
proc/tellwait1.c
proc/tellwait2.c
proc/test1.c
proc/times1.c
proc/vfork1.c
proc/wait1.c
pty/driver.c
pty/loop.c
pty/main.c
relation/orphan3.c
signals/abort.c
signals/child.c
signals/critical.c
signals/mask.c
signals/read1.c
signals/read2.c
signals/reenter.c
signals/setops.c
signals/sigtstp.c
signals/sigusr.c
signals/sleep1.c
signals/sleep2.c
signals/suspend1.c
signals/suspend2.c
signals/system.c
signals/systest2.c
signals/tsleep2.c
sockets/clconn.c
sockets/clconn2.c
sockets/findsvc.c
sockets/initsrv1.c
sockets/initsrv2.c
sockets/ruptime-dg.c
sockets/ruptime.c
sockets/ruptimed-dg.c
sockets/ruptimed-fd.c
sockets/ruptimed.c
stdio/buf.c
stdio/fgetsfputs.c
stdio/getcharbug.c
stdio/getcputc.c
stdio/memstr.c
stdio/mkstemp.c
stdio/tempfiles.c
termios/csize.c
termios/ctermid.c
termios/getpass.c
termios/isatty.c
termios/settty.c
termios/t_getpass.c
termios/t_isatty.c
termios/t_raw.c
termios/t_ttyname.c
termios/ttyname.c
termios/winch.c
threadctl/atfork.c
threadctl/detach.c
threadctl/getenv1.c
threadctl/getenv2.c
threadctl/getenv3.c
threadctl/suspend.c
threadctl/timeout.c
threads/badexit2.c
threads/barrier.c
threads/cleanup.c
threads/condvar.c
threads/exitstatus.c
threads/maketimeout.c
threads/mutex1.c
threads/mutex2.c
threads/mutex3.c
threads/rwlock.c
threads/threadid.c
threads/timedlock.c
